<!DOCTYPE html>




<script type="text/javascript" src="/js/src/dytitle.js"></script>
<html lang="zh-CN">
<head>
  <meta name="baidu-site-verification" content="vT6Jf980C0" />
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.4.0',
    exturl: false,
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":true},
    copycode: {"enable":true,"show_result":true,"style":"default"},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":true,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="BOHC is just a blog of hechao.">
<meta name="keywords" content="linux DEV OPS">
<meta property="og:type" content="website">
<meta property="og:title" content="BOHC!">
<meta property="og:url" content="http://hewanyue.com/index.html">
<meta property="og:site_name" content="BOHC!">
<meta property="og:description" content="BOHC is just a blog of hechao.">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="BOHC!">
<meta name="twitter:description" content="BOHC is just a blog of hechao.">
  <link rel="canonical" href="http://hewanyue.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>BOHC! - blog of hechao!</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="stylesheet" href="/assets/css/APlayer.min.css" class="aplayer-style-marker">
<script src="/assets/js/APlayer.min.js" class="aplayer-script-marker"></script>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <div class="container use-motion">
    <div class="headband"></div>
<a href="https://github.com/wudihechao/" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">BOHC!</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">blog of hechao!</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    
      
      
        
      
        
      
        
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-about">
      
    
      
      
        
      
        
      
        
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-tags">
      
    
      
      
        
      
        
      
        
          
        
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签<span class="badge">25</span></a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-categories">
      
    
      
      
        
      
        
          
        
      
        
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类<span class="badge">3</span></a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    
      
      
        
          
        
      
        
      
        
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档<span class="badge">16</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger">
        
          <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
      </li>
    
  </ul>

    

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <a class="book-mark-link book-mark-link-fixed" href="#"></a>

  <a href="https://github.com/wudihechao" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <div id="posts" class="posts-expand">
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://hewanyue.com/2019/10/07/自动化运维之Ansible/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Hechao">
      <meta itemprop="description" content="BOHC is just a blog of hechao.">
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BOHC!">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
            
            <a href="/2019/10/07/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E4%B9%8BAnsible/" class="post-title-link" itemprop="url">自动化运维之Ansible</a>
          
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-10-07 21:53:40" itemprop="dateCreated datePublished" datetime="2019-10-07T21:53:40+08:00">2019-10-07</time>
            </span>
          

          
            <span id="/2019/10/07/自动化运维之Ansible/" class="post-meta-item leancloud_visitors" data-flag-title="自动化运维之Ansible" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
              <span>℃</span>
            </span>
          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
        
      
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/10/07/自动化运维之Ansible/#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2019/10/07/自动化运维之Ansible/" itemprop="commentCount"></span></a>
  </span>
  
  
          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span>26k</span>
            </span>
          
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span>23 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="企业实际应用场景分析"><a href="#企业实际应用场景分析" class="headerlink" title="企业实际应用场景分析"></a>企业实际应用场景分析</h3><ul>
<li>Dev开发环境<br>&emsp;&emsp;使用者：程序员<br>&emsp;&emsp;功能：程序员开发软件，测试BUG的环境<br>&emsp;&emsp;管理者：程序员</li>
<li>测试环境<br>&emsp;&emsp;使用者：QA测试工程师<br>&emsp;&emsp;功能：测试经过Dev环境测试通过的软件的功能<br>&emsp;&emsp;管理者：运维<br>&emsp;&emsp;说明：测试环境往往有多套,测试环境满足测试功能即可，不宜过多<br>&emsp;&emsp;1、测试人员希望测试环境有多套,公司的产品多产品线并发，即多个版本，<br>意味着多个版本同步测试<br>&emsp;&emsp;2、通常测试环境有多少套和产品线数量保持一样</li>
<li>发布环境：代码发布机,有些公司为堡垒机（安全屏障）<br>&emsp;&emsp;使用者：运维<br>&emsp;&emsp;功能：发布代码至生产环境<br>&emsp;&emsp;管理者：运维（有经验）<br>&emsp;&emsp;发布机：往往需要有2台（主备）</li>
<li>生产环境<br>&emsp;&emsp;使用者：运维，少数情况开放权限给核心开发人员，极少数公司将权限完全<br>开放给开发人员并其维护<br>&emsp;&emsp;功能：对用户提供公司产品的服务<br>&emsp;&emsp;管理者：只能是运维<br>&emsp;&emsp;生产环境服务器数量：一般比较多，且应用非常重要。往往需要自动工具协<br>助部署配置应用<br>灰度环境（生产环境的一部分）<br>&emsp;&emsp;使用者：运维<br>&emsp;&emsp;功能：在全量发布代码前将代码的功能面向少量精准用户发布的环境,可基<br>于主机或用户执行灰度发布<br>&emsp;&emsp;案例：共100台生产服务器，先发布其中的10台服务器，这10台服务器就<br>是灰度服务器<br>&emsp;&emsp;管理者：运维<br>&emsp;&emsp;灰度环境：往往该版本功能变更较大，为保险起见特意先让一部分用户优化<br>体验该功能，待这部分用户使用没有重大问题的时候，再全量发布至所有服务器<h3 id="程序发布"><a href="#程序发布" class="headerlink" title="程序发布"></a>程序发布</h3></li>
<li>程序发布要求：<br>&emsp;&emsp;不能导致系统故障或造成系统完全不可用<br>&emsp;&emsp;不能影响用户体验</li>
<li>预发布验证：<br>&emsp;&emsp;新版本的代码先发布到服务器（跟线上环境配置完全相同，只是未接入到调度器）</li>
<li>灰度发布：<br>&emsp;&emsp;基于主机，用户，业务</li>
<li>发布路径：<br>&emsp;&emsp;/webapp/tuangou<br>&emsp;&emsp;/webapp/tuangou-1.1<br>&emsp;&emsp;/webapp/tuangou-1.2<ul>
<li>发布过程：在调度器上下线一批主机(标记为maintenance 状态) –> 关闭服务 –> 部<br>署新版本的应用程序 –> 启动服务 –> 在调度器上启用这一批服务器</li>
</ul>
</li>
<li>自动化灰度发布：脚本、发布平台<h3 id="自动化运维应用场景"><a href="#自动化运维应用场景" class="headerlink" title="自动化运维应用场景"></a>自动化运维应用场景</h3></li>
<li>文件传输</li>
<li>应用部署</li>
<li>配置管理</li>
<li>任务流编排<h3 id="常用自动化运维工具"><a href="#常用自动化运维工具" class="headerlink" title="常用自动化运维工具"></a>常用自动化运维工具</h3></li>
<li>Ansible：python，Agentless，中小型应用环境</li>
<li>Saltstack：python，一般需部署agent，执行效率更高</li>
<li>Puppet：ruby, 功能强大，配置复杂，重型,适合大型环境</li>
<li>Fabric：python，agentless</li>
<li>Chef：ruby，国内应用少</li>
<li>Cfengine</li>
<li>func<h3 id="Ansible简介"><a href="#Ansible简介" class="headerlink" title="Ansible简介"></a>Ansible简介</h3>
        <div id="aplayer-fwXIWGBL" class="aplayer aplayer-tag-marker" style="margin-bottom: 20px;">
            <pre class="aplayer-lrc-content"></pre>
        </div>
        <script>
          var ap = new APlayer({
            element: document.getElementById("aplayer-fwXIWGBL"),
            narrow: false,
            autoplay: true,
            showlrc: false,
            music: {
              title: "Coming Home",
              author: "Peter Jeremias",
              url: "https://win-web-rh00-sycdn.kuwo.cn/82085a53bb863deabb553b390e5932fb/5d9b449b/resource/n2/62/49/2900285534.mp3",
              pic: "http://img2.kuwo.cn/star/albumcover/120/5/34/683811610.jpg",
              lrc: ""
            }
          });
          window.aplayers || (window.aplayers = []);
          window.aplayers.push(ap);
        </script>
<h4 id="Ansible特性"><a href="#Ansible特性" class="headerlink" title="Ansible特性"></a>Ansible特性</h4></li>
<li>模块化：调用特定的模块，完成特定任务</li>
<li>Paramiko（python对ssh的实现），PyYAML，Jinja2（模板语言）三个关键模块</li>
<li>支持自定义模块</li>
<li>基于Python语言实现</li>
<li>部署简单，基于python和SSH(默认已安装)，agentless</li>
<li>安全，基于OpenSSH</li>
<li>支持playbook编排任务</li>
<li>幂等性：一个任务执行1遍和执行n遍效果一样，不因重复执行带来意外情况</li>
<li>无需代理不依赖PKI（无需ssl）</li>
<li>可使用任何编程语言写模块</li>
<li>YAML格式，编排任务，支持丰富的数据结构</li>
<li>较强大的多层解决方案<h4 id="Ansible架构"><a href="#Ansible架构" class="headerlink" title="Ansible架构"></a>Ansible架构</h4><img src="https://img-blog.csdnimg.cn/20191007171143415.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><h4 id="Ansible工作原理"><a href="#Ansible工作原理" class="headerlink" title="Ansible工作原理"></a>Ansible工作原理</h4><img src="https://img-blog.csdnimg.cn/20191007171304635.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><h4 id="Ansible主要组成部分"><a href="#Ansible主要组成部分" class="headerlink" title="Ansible主要组成部分"></a>Ansible主要组成部分</h4></li>
<li>ANSIBLE PLAYBOOKS：任务剧本（任务集），编排定义Ansible任务集的配置<br>文件，由Ansible顺序依次执行，通常是JSON格式的YML文件</li>
<li>INVENTORY：Ansible管理主机的清单/etc/anaible/hosts</li>
<li>MODULES：Ansible执行命令的功能模块，多数为内置核心模块，也可自定义</li>
<li>PLUGINS：模块功能的补充，如连接类型插件、循环插件、变量插件、过滤插<br>件等，该功能不常用</li>
<li>API：供第三方程序调用的应用程序编程接口</li>
<li>ANSIBLE：组合INVENTORY、API、MODULES、PLUGINS的绿框，可以理解<br>为是ansible命令工具，其为核心执行工具<h4 id="Ansible命令执行来源："><a href="#Ansible命令执行来源：" class="headerlink" title="Ansible命令执行来源："></a>Ansible命令执行来源：</h4></li>
<li>USER，普通用户，即SYSTEM ADMINISTRATOR</li>
<li>CMDB（配置管理数据库） API 调用</li>
<li>PUBLIC/PRIVATE CLOUD API调用</li>
<li>USER-> Ansible Playbook -> Ansibile<h4 id="利用ansible实现管理的方式："><a href="#利用ansible实现管理的方式：" class="headerlink" title="利用ansible实现管理的方式："></a>利用ansible实现管理的方式：</h4></li>
<li>Ad-Hoc 即ansible命令，主要用于临时命令使用场景</li>
<li>Ansible-playbook 主要用于长期规划好的，大型项目的场景，需要有前期<br>的规划过程</li>
</ul>
<h4 id="Ansible-playbook（剧本）执行过程"><a href="#Ansible-playbook（剧本）执行过程" class="headerlink" title="Ansible-playbook（剧本）执行过程"></a>Ansible-playbook（剧本）执行过程</h4><ul>
<li>将已有编排好的任务集写入Ansible-Playbook</li>
<li>通过ansible-playbook命令分拆任务集至逐条ansible命令，按预定规则逐<br>条执行<h4 id="Ansible主要操作对象"><a href="#Ansible主要操作对象" class="headerlink" title="Ansible主要操作对象"></a>Ansible主要操作对象</h4></li>
<li>HOSTS主机</li>
<li>NETWORKING网络设备<h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4>&emsp;&emsp;执行ansible的主机一般称为主控端，中控，master或堡垒机<br>&emsp;&emsp;主控端Python版本需要2.6或以上<br>&emsp;&emsp;被控端Python版本小于2.4需要安装python-simplejson<br>&emsp;&emsp;被控端如开启SELinux需要安装libselinux-python<br>&emsp;&emsp;windows不能做为主控端</li>
</ul>
<h3 id="安装Ansible"><a href="#安装Ansible" class="headerlink" title="安装Ansible"></a>安装Ansible</h3><h4 id="rpm包安装-EPEL源"><a href="#rpm包安装-EPEL源" class="headerlink" title="rpm包安装: EPEL源"></a>rpm包安装: EPEL源</h4><p><code>yum install ansible</code></p>
<h4 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装:"></a>编译安装:</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum -y install python-jinja2 PyYAML python-paramiko python-babel python-crypto</span><br><span class="line">wget https://releases.ansible.com/ansible/ansible-1.5.4.tar.gz</span><br><span class="line">tar xf ansible-1.5.4.tar.gz</span><br><span class="line">cd ansible-1.5.4</span><br><span class="line">python setup.py build</span><br><span class="line">python setup.py install</span><br><span class="line">mkdir /etc/ansible</span><br><span class="line">cp -r examples/* /etc/ansible</span><br></pre></td></tr></table></figure>

<h4 id="Git方式"><a href="#Git方式" class="headerlink" title="Git方式:"></a>Git方式:</h4> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone git://github.com/ansible/ansible.git --recursive</span><br><span class="line">cd ./ansible</span><br><span class="line">source ./hacking/env-setup</span><br></pre></td></tr></table></figure>

<h4 id="pip安装：-pip是安装Python包的管理器，类似yum"><a href="#pip安装：-pip是安装Python包的管理器，类似yum" class="headerlink" title="pip安装： pip是安装Python包的管理器，类似yum"></a>pip安装： pip是安装Python包的管理器，类似yum</h4> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install python-pip python-devel</span><br><span class="line">yum install gcc glibc-devel zibl-devel rpm-bulid openssl-devel</span><br><span class="line">pip install --upgrade pip</span><br><span class="line">pip install ansible --upgrade</span><br></pre></td></tr></table></figure>

<h4 id="确认安装："><a href="#确认安装：" class="headerlink" title="确认安装："></a>确认安装：</h4><p> <code>ansible --version</code></p>
<h3 id="配置Ansible"><a href="#配置Ansible" class="headerlink" title="配置Ansible"></a>配置Ansible</h3><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>&emsp;&emsp;<strong>/etc/ansible/ansible.cfg 主配置文件，配置ansible工作特性（一般保持默认）</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line"><span class="meta">#</span><span class="bash">inventory = /etc/ansible/hosts <span class="comment"># 主机列表配置文件</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">library = /usr/share/my_modules/ <span class="comment"># 库文件存放目录</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">remote_tmp = <span class="variable">$HOME</span>/.ansible/tmp <span class="comment">#临时py命令文件存放在远程主机目录</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">local_tmp = <span class="variable">$HOME</span>/.ansible/tmp <span class="comment"># 本机的临时命令执行目录</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">forks = 5 <span class="comment"># 默认并发数</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">sudo_user = root <span class="comment"># 默认sudo 用户</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ask_sudo_pass = True <span class="comment">#每次执行ansible命令是否询问ssh密码</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ask_pass = True</span></span><br><span class="line"><span class="meta">#</span><span class="bash">remote_port = 22</span></span><br><span class="line"><span class="meta">#</span><span class="bash">host_key_checking = False <span class="comment"># 检查对应服务器的host_key，建议取消注释</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">log_path=/var/<span class="built_in">log</span>/ansible.log <span class="comment">#日志文件</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">module_name = <span class="built_in">command</span> <span class="comment">#默认模块</span></span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;<strong>/etc/ansible/hosts Inventory 主机清单</strong><br>&emsp;&emsp;ansible的主要功用在于批量主机操作，为了便捷地使用其中的部分主机，可以在inventory file中将其分组命名</p>
<ul>
<li>默认的inventory file为/etc/ansible/hosts</li>
<li>inventory file可以有多个，且也可以通过Dynamic Inventory来动态生成<br>文件格式</li>
<li>inventory文件遵循INI文件风格，中括号中的字符为组名。可以将同一个主机<br>同时归并到多个不同的组中；此外，当如若目标主机使用了非默认的SSH端口，<br>还可以在主机名称之后使用冒号加端口号来标明<br>ntp.servers.com<br>[webservers]<br>www1.webservers.com:2222<br>www2.webservers.com<br>[dbservers]<br>db1.dbservers.com<br>db2.dbservers.com<br>db3.dbservers.com<br>主机清单inventory</li>
<li>如果主机名称遵循相似的命名模式，还可以使用列表的方式标识各主机</li>
<li>示例：<br>[websrvs]<br>www[1:100].example.com<br>[dbsrvs]<br>db-[a:f].example.com</li>
</ul>
<p>&emsp;&emsp;<strong>/etc/ansible/roles/ 存放角色的目录</strong></p>
<h4 id="程序"><a href="#程序" class="headerlink" title="程序"></a>程序</h4><p>&emsp;&emsp;/usr/bin/ansible 主程序，临时命令执行工具<br>&emsp;&emsp;/usr/bin/ansible-doc 查看配置文档，模块功能查看工具<br>&emsp;&emsp;/usr/bin/ansible-galaxy 下载/上传优秀代码或Roles模块的官网平台<br>&emsp;&emsp;/usr/bin/ansible-playbook 定制自动化任务，编排剧本工具<br>&emsp;&emsp;/usr/bin/ansible-pull 远程执行命令的工具<br>&emsp;&emsp;/usr/bin/ansible-vault 文件加密工具<br>&emsp;&emsp;/usr/bin/ansible-console 基于Console界面与用户交互的执行工具</p>
<h3 id="Ansible命令"><a href="#Ansible命令" class="headerlink" title="Ansible命令"></a>Ansible命令</h3><ul>
<li>ansible </li>
<li>ansible-doc</li>
<li>ansible-playbook</li>
<li>ansible-vault</li>
<li>ansible-console</li>
<li>ansible-galaxy</li>
<li>ansible-pull<h4 id="ansible-doc-显示模块帮助"><a href="#ansible-doc-显示模块帮助" class="headerlink" title="ansible-doc: 显示模块帮助"></a>ansible-doc: 显示模块帮助</h4><code>ansible-doc [options] [module...]</code><br>&emsp;&emsp;-l, –list 列出可用模块<br>&emsp;&emsp;-s, –snippet显示指定模块的playbook片段<br>示例：<br>&emsp;&emsp;ansible-doc -l 列出所有模块<br>&emsp;&emsp;ansible-doc ping 查看指定模块帮助用法<br>&emsp;&emsp;ansible-doc -s ping 查看指定模块帮助用法<h4 id="ansible"><a href="#ansible" class="headerlink" title="ansible"></a>ansible</h4>&emsp;&emsp;ansible通过ssh实现配置管理、应用部署、任务执行等功能，建议配置ansible端能基于密钥认证的方式联系各被管理节点<br><code>ansible <host-pattern> [-m module_name] [-a args]</code><h5 id="ansible选项"><a href="#ansible选项" class="headerlink" title="ansible选项"></a>ansible选项</h5>&emsp;&emsp;–version 显示版本<br>&emsp;&emsp;-m module 指定模块，默认为command<br>&emsp;&emsp;-v 详细过程 –vv -vvv更详细<br>&emsp;&emsp;–list-hosts 显示主机列表，可简写 –list<br>&emsp;&emsp;-k, –ask-pass 提示输入ssh连接密码，默认Key验证<br>&emsp;&emsp;-C, –check 检查，并不执行<br>&emsp;&emsp;-T, –timeout=TIMEOUT 执行命令的超时时间，默认10s<br>&emsp;&emsp;-u, –user=REMOTE_USER 执行远程执行的用户<br>&emsp;&emsp;-b, –become 代替旧版的sudo 切换<br>&emsp;&emsp;–become-user=USERNAME 指定sudo的runas用户，默认为root<br>&emsp;&emsp;-K, –ask-become-pass 提示输入sudo时的口令</li>
</ul>
<h5 id="ansible的Host-pattern"><a href="#ansible的Host-pattern" class="headerlink" title="ansible的Host-pattern"></a>ansible的Host-pattern</h5><p>匹配主机的列表</p>
<ul>
<li>All ：表示所有Inventory中的所有主机<br><code>ansible all –m ping</code></li>
<li>* :通配符<br><code>ansible "*" -m ping</code><br><code>ansible 192.168.1.* -m ping</code><br><code>ansible "*srvs" -m ping</code></li>
<li>或关系<br><code>ansible "websrvs:appsrvs" -m ping</code><br><code>ansible "192.168.1.10:192.168.1.20" -m ping</code></li>
<li>逻辑与<br><code>ansible "websrvs:&dbsrvs" –m ping</code><br>在websrvs组并且在dbsrvs组中的主机</li>
<li>逻辑非<br><code>ansible &#39;websrvs:!dbsrvs&#39; –m ping</code><br>在websrvs组，但不在dbsrvs组中的主机<br>注意：此处为单引号</li>
<li>综合逻辑<br><code>ansible &#39;websrvs:dbsrvs:&appsrvs:!ftpsrvs&#39; –m ping</code></li>
<li>正则表达式<br><code>ansible "websrvs:&dbsrvs" –m ping</code><br><code>ansible "~(web|db).*.servers.com" –m ping</code><h5 id="ansible常用模块"><a href="#ansible常用模块" class="headerlink" title="ansible常用模块"></a>ansible常用模块</h5>模块文档：<a href="https://docs.ansible.com/ansible/latest/modules/modules_by_category.html" target="_blank" rel="noopener">https://docs.ansible.com/ansible/latest/modules/modules_by_category.html</a></li>
<li>Command：在远程主机执行命令，<strong>默认模块，可忽略-m选项</strong><br><code>ansible srvs -m command -a &#39;service vsftpd start&#39;</code><br><code>ansible srvs -m command -a &#39;echo passwd |passwd --stdin user&#39;</code><strong>此命令不支持 $VARNAME < > | ; & 等，须用shell模块实现</strong></li>
<li>Shell：和command相似，用shell执行命令<figure class="highlight plain"><figcaption><span>srv -m shell -a ‘echo passwd |passwd –stdin user’``</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">&emsp;&emsp;调用bash执行命令 类似 cat /tmp/stanley.md | awk -F‘|’ ‘&#123;print $1,$2&#125;’</span><br><span class="line">&> /tmp/example.txt 这些复杂命令，即使使用shell也可能会失败，解决办</span><br><span class="line">法：写到脚本时，copy到远程，执行，再把需要的结果拉回执行命令的机器</span><br><span class="line">- Script：在远程主机上运行ansible服务器上的脚本</span><br><span class="line">``ansible <host-pattern> -m script -a "/PATH/TO/SCRIPT_FILE"``</span><br><span class="line">``ansible websrvs -m script -a /data/test.sh``</span><br><span class="line">- Copy：从主控端复制文件到远程主机</span><br><span class="line">``ansible srv -m copy -a "src=/root/test1.sh dest=/tmp/test2.sh</span><br><span class="line">owner=wang mode=600 backup=yes"``</span><br><span class="line"> 如目标存在，默认覆盖，此处指定先备份</span><br><span class="line">``ansible srv -m copy -a "content=&apos;test content\n&apos; dest=/tmp/test.txt"``</span><br><span class="line">指定内容，直接生成目标文件</span><br><span class="line">- Fetch：从远程主机提取文件至主控端，copy相反，目前不支持目录</span><br><span class="line">``ansible srv -m fetch -a &apos;src=/root/test.sh dest=/data/scripts&apos;``</span><br><span class="line">- File：设置文件属性</span><br><span class="line">``ansible srv -m file -a "path=/root/test.sh owner=wang mode=755“``</span><br><span class="line">``ansible srv -m file -a "path=/data/testdir state=directory"``</span><br><span class="line">``ansible srv -m file -a ‘src=/data/testfile dest=/data/testfile-link state=link’``</span><br><span class="line">-  unarchive：解包解压缩，有两种用法：</span><br><span class="line">1、将ansible主机上的压缩包传到远程主机后解压缩至特定目录，设置copy=yes.</span><br><span class="line">2、将远程主机上的某个压缩包解压缩到指定路径下，设置copy=no</span><br><span class="line"> 常见参数：</span><br><span class="line">copy：默认为yes，当copy=yes，拷贝的文件是从ansible主机复制到远程主机上，如果设置为copy=no，会在远程主机上寻找src源文件</span><br><span class="line">src：源路径，可以是ansible主机上的路径，也可以是远程主机上的路径，如果是远程主机上的路径，则需要设置copy=no</span><br><span class="line">dest：远程主机上的目标路径</span><br><span class="line">mode：设置解压缩后的文件权限</span><br><span class="line">示例：</span><br><span class="line">``ansible srv -m unarchive -a &apos;src=/data/foo.tgz dest=/var/lib/foo&apos;``</span><br><span class="line">``ansible srv -m unarchive -a &apos;src=/tmp/foo.zip dest=/data copy=no mode=0777&apos;``</span><br><span class="line">``ansible srv -m unarchive -a &apos;src=https://example.com/example.zip dest=/data copy=no&apos;``</span><br><span class="line">- Archive：打包压缩</span><br><span class="line">``ansible all -m archive -a &apos;path=/etc/sysconfig dest=/data/sysconfig.tar.bz2 format=bz2 owner=wang mode=0777&apos;``</span><br><span class="line">-Hostname：管理主机名</span><br><span class="line">``ansible node1 -m hostname -a "name=websrv"``</span><br><span class="line">- Cron：计划任务</span><br><span class="line"> 支持时间：minute，hour，day，month，weekday</span><br><span class="line">``ansible srv -m cron -a "minute=*/5 job=&apos;/usr/sbin/ntpdate</span><br><span class="line">172.16.0.1 &>/dev/null&apos; name=Synctime" ``创建任务</span><br><span class="line">``ansible srv -m cron -a &apos;state=absent name=Synctime&apos; ``删除任务</span><br><span class="line">- Yum：管理包</span><br><span class="line">``ansible srv -m yum -a &apos;name=httpd state=present&apos; ``安装</span><br><span class="line">``ansible srv -m yum -a &apos;name=httpd state=absent&apos; ``删除</span><br><span class="line">ansible常用模块</span><br><span class="line">-  Service：管理服务</span><br><span class="line">`` ansible srv -m service -a &apos;name=httpd state=stopped&apos;``</span><br><span class="line">``ansible srv -m service -a &apos;name=httpd state=started enabled=yes&apos;``</span><br><span class="line">``ansible srv -m service -a &apos;name=httpd state=reloaded&apos;``</span><br><span class="line">``ansible srv -m service -a &apos;name=httpd state=restarted&apos;``</span><br><span class="line">- User：管理用户</span><br><span class="line">``ansible srv -m user -a &apos;name=user1 comment="test user" uid=2048</span><br><span class="line">home=/app/user1 group=root&apos;``</span><br><span class="line">``ansible srv -m user -a &apos;name=sysuser1 system=yes home=/app/sysuser1&apos;``</span><br><span class="line">``ansible srv -m user -a &apos;name=user1 state=absent remove=yes&apos;``</span><br><span class="line"> 删除用户及家目录等数据</span><br><span class="line">-  Group：管理组</span><br><span class="line">``ansible srv -m group -a "name=testgroup system=yes"``</span><br><span class="line">``ansible srv -m group -a "name=testgroup state=absent"``</span><br><span class="line">##### ansible命令执行过程</span><br><span class="line">&emsp;&emsp;1. 加载自己的配置文件 默认/etc/ansible/ansible.cfg</span><br><span class="line">&emsp;&emsp;2. 加载自己对应的模块文件，如command</span><br><span class="line">&emsp;&emsp;3. 通过ansible将模块或命令生成对应的临时py文件，并将该文件传输至远程服</span><br><span class="line">务器的对应执行用户$HOME/.ansible/tmp/ansible-tmp-数字/XXX.PY文件</span><br><span class="line">&emsp;&emsp;4. 给文件+x执行</span><br><span class="line">&emsp;&emsp;5. 执行并返回结果</span><br><span class="line">&emsp;&emsp;6. 删除临时py文件，退出</span><br><span class="line">&emsp;&emsp;执行状态：</span><br><span class="line">&emsp;&emsp;&emsp;&emsp;绿色：执行成功并且不需要做改变的操作</span><br><span class="line">&emsp;&emsp;&emsp;&emsp;黄色：执行成功并且对目标主机做变更</span><br><span class="line">&emsp;&emsp;&emsp;&emsp;红色：执行失败</span><br><span class="line">#### ansible-galaxy</span><br><span class="line">&emsp;&emsp;连接 https://galaxy.ansible.com 下载相应的roles</span><br><span class="line">``ansible-galaxy``</span><br><span class="line">&emsp;&emsp;列出所有已安装的galaxy</span><br><span class="line">``ansible-galaxy list``</span><br><span class="line">&emsp;&emsp;安装galaxy</span><br><span class="line">``ansible-galaxy install geerlingguy.redis``</span><br><span class="line">&emsp;&emsp;删除galaxy</span><br><span class="line">``ansible-galaxy remove geerlingguy.redis``</span><br><span class="line">#### ansible-pull</span><br><span class="line">&emsp;&emsp;推送命令至远程，效率无限提升，对运维要求较高</span><br><span class="line">#### ansible-playbook</span><br><span class="line">&emsp;&emsp;执行playbook</span><br><span class="line">&emsp;&emsp; 示例：ansible-playbook hello.yml</span><br><span class="line">````yaml</span><br><span class="line">#hello world yml file</span><br><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">    - name: hello world</span><br><span class="line">      command: /usr/bin/wall hello world</span><br><span class="line"> `</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="ansible-vault"><a href="#ansible-vault" class="headerlink" title="ansible-vault"></a>ansible-vault</h4><p>&emsp;&emsp;功能：管理加密解密yml文件<br><code>ansible-vault [create|decrypt|edit|encrypt|rekey|view]</code><br><code>ansible-vault encrypt hello.yml</code> 加密<br><code>ansible-vault decrypt hello.yml</code> 解密<br><code>ansible-vault view hello.yml</code> 查看<br><code>ansible-vault edit hello.yml</code> 编辑加密文件<br><code>ansible-vault rekey hello.yml</code> 修改口令<br><code>ansible-vault create new.yml</code> 创建新文件</p>
<h4 id="Ansible-console"><a href="#Ansible-console" class="headerlink" title="Ansible-console"></a>Ansible-console</h4><p>&emsp;&emsp;ansible终端。2.0+新增，可交互执行命令，支持tab<br><code>root@test (2)[f:10] $</code><br> 执行用户@当前操作的主机组 (当前组的主机数量)[f:并发数]$</p>
<ul>
<li>设置并发数： forks n 例如： forks 10</li>
<li>切换组： cd 主机组 例如： cd web</li>
<li>列出当前组主机列表： list</li>
<li>列出所有的内置命令： ?或help</li>
<li>示例：<br>root@all (2)[f:5]$ list<br>root@all (2)[f:5]$ cd appsrvs<br>root@appsrvs (2)[f:5]$ list<br>root@appsrvs (2)[f:5]$ yum name=httpd state=present<br>root@appsrvs (2)[f:5]$ service name=httpd state=started<h3 id="playbook"><a href="#playbook" class="headerlink" title="playbook"></a>playbook</h3></li>
<li>playbook是由一个或多个“play”组成的列表</li>
<li>play的主要功能在于将预定义的一组主机，装扮成事先通过ansible中的task定义好的角色。Task实际是调用ansible的一个module，将多个play组织在一个playbook中，即可以让它们联合起来，按事先编排的机制执行预定义的动作</li>
<li>Playbook采用YAML语言编写</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20191007191809637.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h4 id="playbook核心元素"><a href="#playbook核心元素" class="headerlink" title="playbook核心元素"></a>playbook核心元素</h4><ul>
<li>Hosts 执行的远程主机列表</li>
<li>Tasks 任务集</li>
<li>Variables 内置变量或自定义变量在playbook中调用</li>
<li>Templates 模板，可替换模板文件中的变量并实现一些简单逻辑的文件</li>
<li>Handlers 和 notify 结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行</li>
<li>tags 标签 指定某条任务执行，用于选择运行playbook中的部分代码。ansible具有幂等性，因此会自动跳过没有变化的部分，即便如此，有些代码为测试其确实没有发生变化的时间依然会非常地长。此时，如果确信其没有变化，就可以通过tags跳过此些代码片断<br><code>ansible-playbook -t tagsname useradd.yml</code><h4 id="playbook基础组件"><a href="#playbook基础组件" class="headerlink" title="playbook基础组件"></a>playbook基础组件</h4></li>
<li>Hosts：<br>&emsp;&emsp;playbook中的每一个play的目的都是为了让特定主机以某个指定的用户身份执行任务。hosts用于指定要执行指定任务的主机，须事先定义在主机清单中。可以是如下形式：<br>one.example.com<br>one.example.com:two.example.com</li>
</ul>
<p>192.168.1.50<br>192.168.1.*<br>Websrvs:dbsrvs 或者，两个组的并集<br>Websrvs:&dbsrvs 与，两个组的交集<br>webservers:!phoenix 在websrvs组，但不在dbsrvs组<br> 示例: - hosts: websrvs：dbsrvs</p>
<ul>
<li><p>remote_user<br>&emsp;&emsp;remote_user: 可用于Host和task中。也可以通过指定其通过sudo的方式在远程主机上执行任务，其可用于play全局或某任务；此外，甚至可以在sudo时使用sudo_user指定sudo时切换的用户</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">test</span> <span class="string">connection</span></span><br><span class="line"><span class="attr">    ping:</span></span><br><span class="line"><span class="attr">    remote_user:</span> <span class="string">user</span></span><br><span class="line"><span class="attr">    sudo:</span> <span class="literal">yes</span>           <span class="string">默认sudo为root</span></span><br><span class="line"><span class="attr">    sudo_user:</span> <span class="string">wang</span>      <span class="string">sudo为wang</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>task列表和action<br>&emsp;&emsp;play的主体部分是task list，task list中的各任务按次序逐个在hosts中指定的所有主机上执行，即在所有主机上完成第一个任务后，再开始第二个任务<br>&emsp;&emsp;task的目的是使用指定的参数执行模块，而在模块参数中可以使用变量。模块执行是幂等的，这意味着多次执行是安全的，因为其结果均一致<br>&emsp;&emsp;每个task都应该有其name，用于playbook的执行结果输出，建议其内容能清晰地描述任务执行步骤。如果未提供name，则action的结果将用于输出playbook基础组件<br>&emsp;&emsp;tasks：任务列表<br>&emsp;&emsp;两种格式：<br>(1) action: module arguments<br>(2) module: arguments 建议使用<br>&emsp;&emsp;<strong>注意：shell和command模块后面跟命令，而非key=value</strong><br>&emsp;&emsp;某任务的状态在运行后为changed时，可通过“notify”通知给相应的handlers<br>&emsp;&emsp;任务可以通过”tags“打标签，可在ansible-playbook命令上使用-t指定进行调用<br>示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr"> - name:</span> <span class="string">disable</span> <span class="string">selinux</span></span><br><span class="line"><span class="attr">   command:</span> <span class="string">/sbin/setenforce</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>&emsp;&emsp;如果命令或脚本的退出码不为零，可以使用如下方式替代<br> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr"> - name:</span> <span class="string">run</span> <span class="string">this</span> <span class="string">command</span> <span class="string">and</span> <span class="string">ignore</span> <span class="string">the</span> <span class="string">result</span></span><br><span class="line"><span class="attr">   shell:</span> <span class="string">/usr/bin/somecommand</span> <span class="string">||</span> <span class="string">/bin/true</span></span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;或者使用ignore_errors来忽略错误信息<br> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">run</span> <span class="string">this</span> <span class="string">command</span> <span class="string">and</span> <span class="string">ignore</span> <span class="string">the</span> <span class="string">result</span></span><br><span class="line"><span class="attr">    shell:</span> <span class="string">/usr/bin/somecommand</span></span><br><span class="line"><span class="attr">    ignore_errors:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure></p>
<h4 id="运行playbook"><a href="#运行playbook" class="headerlink" title="运行playbook"></a>运行playbook</h4><ul>
<li>运行playbook的方式<br><code>ansible-playbook <filename.yml> ... [options]</code></li>
<li>常见选项</li>
<li>-check -C 只检测可能会发生的改变，但不真正执行操作</li>
<li>-list-hosts 列出运行任务的主机</li>
<li>-list-tags 列出tag</li>
<li>-list-tasks 列出task</li>
<li>-limit 主机列表 只针对主机列表中的主机执行</li>
<li>v -vv -vvv 显示过程</li>
<li>示例<br><code>ansible-playbook file.yml --check</code> 只检测<br><code>ansible-playbook file.yml</code><br><code>ansible-playbook file.yml --limit websrvs</code><br>&emsp;&emsp;可以<strong>对比下SHELL脚本VSPlaybook</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装Apache</span></span><br><span class="line">yum install --quiet -y httpd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 复制配置文件</span></span><br><span class="line">cp /tmp/httpd.conf /etc/httpd/conf/httpd.conf</span><br><span class="line">cp /tmp/vhosts.conf /etc/httpd/conf.d/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动Apache，并设置开机启动</span></span><br><span class="line">service httpd start</span><br><span class="line">chkconfig httpd on</span><br></pre></td></tr></table></figure>

</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">"安装Apache"</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">name=httpd</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">"复制配置文件"</span></span><br><span class="line"><span class="attr">    copy:</span> <span class="string">src=/tmp/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">"复制配置文件"</span></span><br><span class="line"><span class="attr">    copy:</span> <span class="string">src=/tmp/vhosts.conf</span> <span class="string">dest=/etc/httpd/conf.d/</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">"启动Apache，并设置开机启动"</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure>

<p><strong>示例：sysuser.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">create</span> <span class="string">mysql</span> <span class="string">user</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">name=mysql</span> <span class="string">system=yes</span> <span class="string">uid=36</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">create</span> <span class="string">a</span> <span class="string">group</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">name=httpd</span> <span class="string">system=yes</span></span><br></pre></td></tr></table></figure>

<p><strong>示例：httpd.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Install</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Install</span> <span class="string">configure</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    copy:</span> <span class="string">src=files/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure>

<h4 id="handlers和notify结合使用触发条件"><a href="#handlers和notify结合使用触发条件" class="headerlink" title="handlers和notify结合使用触发条件"></a>handlers和notify结合使用触发条件</h4><ul>
<li>Handlers是task列表，这些task与前述的task并没有本质上的不同,用于当关注的资源发生变化时，才会采取一定的操作</li>
<li>Notify此action可用于在每个play的最后被触发，这样可避免多次有改变发生时每次都执行指定的操作，仅在所有的变化发生完成后一次性地执行指定操作。<br>在notify中列出的操作称为handler，也即notify中调用handler中定义的操作<h4 id="Playbook中handlers使用"><a href="#Playbook中handlers使用" class="headerlink" title="Playbook中handlers使用"></a>Playbook中handlers使用</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Install</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Install</span> <span class="string">configure</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    copy:</span> <span class="string">src=files/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span></span><br><span class="line"><span class="attr">    notify:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br><span class="line"><span class="attr">    handlers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>示例</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">add</span> <span class="string">group</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    tags:</span> <span class="string">user</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">add</span> <span class="string">user</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span> <span class="string">group=nginx</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Install</span> <span class="string">Nginx</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">config</span></span><br><span class="line"><span class="attr">    copy:</span> <span class="string">src=/root/config.txt</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br><span class="line"><span class="attr">    notify:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">Restart</span> <span class="string">Nginx</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">Check</span> <span class="string">Nginx</span> <span class="string">Process</span></span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Restart</span> <span class="string">Nginx</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=nginx</span> <span class="string">state=restarted</span> <span class="string">enabled=yes</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Check</span> <span class="string">Nginx</span> <span class="string">process</span></span><br><span class="line"><span class="attr">      shell:</span> <span class="string">killall</span> <span class="bullet">-0</span> <span class="string">nginx</span> <span class="string">&></span> <span class="string">/tmp/nginx.log</span></span><br></pre></td></tr></table></figure>

<h4 id="Playbook中tags使用"><a href="#Playbook中tags使用" class="headerlink" title="Playbook中tags使用"></a>Playbook中tags使用</h4><p>示例：httpd.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Install</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Install</span> <span class="string">configure</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    copy:</span> <span class="string">src=files/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span></span><br><span class="line"><span class="attr">    tags:</span> <span class="string">conf</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">start</span> <span class="string">httpd</span> <span class="string">service</span></span><br><span class="line"><span class="attr">    tags:</span> <span class="string">service</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure>

<p> <code>ansible-playbook –t conf httpd.yml</code></p>
<h4 id="Playbook中变量使用"><a href="#Playbook中变量使用" class="headerlink" title="Playbook中变量使用"></a>Playbook中变量使用</h4><h5 id="变量名："><a href="#变量名：" class="headerlink" title="变量名："></a>变量名：</h5><p>&emsp;&emsp;仅能由字母、数字和下划线组成，且只能以字母开头</p>
<h5 id="变量来源："><a href="#变量来源：" class="headerlink" title="变量来源："></a>变量来源：</h5><ul>
<li><p>1 ansible setup facts 远程主机的所有变量都可直接调用</p>
</li>
<li><p>2 在/etc/ansible/hosts中定义<br>普通变量：主机组中主机单独定义，优先级高于公共变量<br>公共（组）变量：针对主机组中所有主机定义统一变量</p>
</li>
<li><p>3 通过命令行指定变量，优先级最高<br>ansible-playbook –e varname=value</p>
</li>
<li><p>4 在playbook中定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vars:</span><br><span class="line">  - var1: value1</span><br><span class="line">  - var2: value2</span><br></pre></td></tr></table></figure>
</li>
<li><p>5 在独立的变量YAML文件中定义</p>
</li>
<li><p>6 在role中定义</p>
</li>
</ul>
<h5 id="变量命名"><a href="#变量命名" class="headerlink" title="变量命名:"></a>变量命名:</h5><p>&emsp;&emsp; 变量名仅能由字母、数字和下划线组成，且只能以字母开头</p>
<h5 id="变量定义："><a href="#变量定义：" class="headerlink" title="变量定义："></a>变量定义：</h5><p>&emsp;&emsp;key=value<br>示例：http_port=80</p>
<h5 id="变量调用方式："><a href="#变量调用方式：" class="headerlink" title="变量调用方式："></a>变量调用方式：</h5><ul>
<li>通过 调用变量，且变量名前后必须有空格，有时用“”才生效</li>
<li>ansible-playbook –e 选项指定<br><code>ansible-playbook test.yml -e "hosts=www user=servers"</code><br>示例：使用setup变量<br>示例：var.yml<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">create</span> <span class="string">log</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    file:</span> <span class="string">name=/var/log/</span> <span class="string">&#123;&#123;</span> <span class="string">ansible_fqdn</span> <span class="string">&#125;&#125;</span> <span class="string">state=touch</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><code>ansible-playbook var.yml</code><br>示例：var.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">pkname</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br></pre></td></tr></table></figure>

<p><code>ansible-playbook –e pkname=httpd var.yml</code></p>
<p>示例：var.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">  - username:</span> <span class="string">user1</span></span><br><span class="line"><span class="attr">  - groupname:</span> <span class="string">group1</span></span><br><span class="line"><span class="attr">    tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">create</span> <span class="string">group</span></span><br><span class="line"><span class="attr">      group:</span> <span class="string">name=&#123;&#123;</span> <span class="string">groupname</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">create</span> <span class="string">user</span></span><br><span class="line"><span class="attr">      user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">username</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br></pre></td></tr></table></figure>

<p> <code>ansible-playbook var.yml</code><br><code>ansible-playbook -e "username=user2 groupname=group2” var2.yml</code></p>
<h5 id="变量来源"><a href="#变量来源" class="headerlink" title="变量来源:"></a>变量来源:</h5><ul>
<li><p>主机变量<br>&emsp;&emsp;可以在inventory中定义主机时为其添加主机变量以便于在playbook中使用<br>示例：<br>[websrvs]<br>www1.servers.com http_port=80 maxRequestsPerChild=808<br>www2.servers.com http_port=8080 maxRequestsPerChild=909</p>
</li>
<li><p>组变量<br>&emsp;&emsp;组变量是指赋予给指定组内所有主机上的在playbook中可用的变量<br>示例：<br>[websrvs]<br>www1.servers.com<br>www2.servers.com<br>[websrvs:vars]<br>ntp_server=ntp.servers.com<br>nfs_server=nfs.servers.com<br>示例：变量</p>
</li>
<li><p>普通变量<br>[websrvs]</p>
</li>
</ul>
<p>192.168.99.101 http_port=8080 hname=www1<br>192.168.99.102 http_port=80 hname=www2</p>
<ul>
<li>公共（组）变量<br>[websvrs:vars]<br>http_port=808<br>mark=“-”<br>[websrvs]</li>
</ul>
<p>192.168.99.101 http_port=8080 hname=www1<br>192.168.99.102 http_port=80 hname=www2<br>ansible websvrs –m hostname –a ‘name=’</p>
<ul>
<li>命令行指定变量：<br><code>ansible websvrs –e http_port=8000 –m hostname –a</code><br><code>&#39;name=&#39;</code></li>
<li>使用变量文件<br><code>cat vars.yml</code><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">var1:</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">var2:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><code>cat var.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars_files:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">vars.yml</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">create</span> <span class="string">httpd</span> <span class="string">log</span></span><br><span class="line"><span class="attr">    file:</span> <span class="string">name=/app/&#123;&#123;</span> <span class="string">var1</span> <span class="string">&#125;&#125;.log</span> <span class="string">state=touch</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">create</span> <span class="string">nginx</span> <span class="string">log</span></span><br><span class="line"><span class="attr">    file:</span> <span class="string">name=/app/&#123;&#123;</span> <span class="string">var2</span> <span class="string">&#125;&#125;.log</span> <span class="string">state=touch</span></span><br></pre></td></tr></table></figure>

<h3 id="模板template"><a href="#模板template" class="headerlink" title="模板template"></a>模板template</h3><ul>
<li>文本文件，嵌套有脚本（使用模板编程语言编写）</li>
<li>Jinja2语言，使用字面量，有下面形式<br>字符串：使用单引号或双引号<br>数字：整数，浮点数<br>列表：[item1, item2, …]<br>元组：(item1, item2, …)<br>字典：{key1:value1, key2:value2, …}<br>布尔型：true/false</li>
<li>算术运算：+, -, <em>, /, //, %, *</em></li>
<li>比较操作：==, !=, >, >=, <, <=</li>
<li>逻辑运算：and，or，not</li>
<li>流表达式：For，If，When</li>
</ul>
<h4 id="template功能："><a href="#template功能：" class="headerlink" title="template功能："></a>template功能：</h4><h5 id="根据模块文件动态生成对应的配置文件"><a href="#根据模块文件动态生成对应的配置文件" class="headerlink" title="根据模块文件动态生成对应的配置文件"></a>根据模块文件动态生成对应的配置文件</h5><ul>
<li>template文件必须存放于templates目录下，且命名为 .j2 结尾</li>
<li>yaml/yml 文件需和templates目录平级，目录结构如下：<br>./<br>├── temnginx.yml<br>└── templates<br>└── nginx.conf.j2</li>
</ul>
<p>template示例<br>示例：利用template 同步nginx配置文件</p>
<ul>
<li>准备templates/nginx.conf.j2文件<br><code>vim temnginx.yml</code><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">template</span> <span class="string">config</span> <span class="string">to</span> <span class="string">remote</span> <span class="string">hosts</span></span><br><span class="line"><span class="attr">      template:</span> <span class="string">src=nginx.conf.j2</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><code>ansible-playbook temnginx.yml</code></p>
<ul>
<li>Playbook中template变更替换<br>修改文件nginx.conf.j2 下面行为<br><code>worker_processes ;</code><br><code>cat temnginx2.yml</code><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">template</span> <span class="string">config</span> <span class="string">to</span> <span class="string">remote</span> <span class="string">hosts</span></span><br><span class="line"><span class="attr">      template:</span> <span class="string">src=nginx.conf.j2</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><code>ansible-playbook temnginx2.yml</code></p>
<h5 id="Playbook中template算术运算"><a href="#Playbook中template算术运算" class="headerlink" title="Playbook中template算术运算"></a>Playbook中template算术运算</h5><p>示例：<br><code>vim nginx.conf.j2</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">worker_processes</span> <span class="string">&#123;&#123;</span> <span class="string">ansible_processor_vcpus**2</span> <span class="string">&#125;&#125;;</span></span><br><span class="line"><span class="string">worker_processes</span> <span class="string">&#123;&#123;</span> <span class="string">ansible_processor_vcpus+2</span> <span class="string">&#125;&#125;;</span></span><br></pre></td></tr></table></figure>

<h4 id="template条件判断"><a href="#template条件判断" class="headerlink" title="template条件判断"></a>template条件判断</h4><h5 id="when"><a href="#when" class="headerlink" title="when"></a>when</h5><p>&emsp;&emsp;条件测试:如果需要根据变量、facts或此前任务的执行结果来做为某task执行与否的前提时要用到条件测试,通过when语句实现，在task中使用，jinja2的语法格式<br>when语句<br>&emsp;&emsp;在task后添加when子句即可使用条件测试；when语句支持Jinja2表达式语法<br>示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">"shutdown RedHat flavored systems"</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">/sbin/shutdown</span> <span class="bullet">-h</span> <span class="string">now</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"RedHat"</span></span><br></pre></td></tr></table></figure>

<p>示例：when条件判断</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">add</span> <span class="string">group</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      tags:</span> <span class="string">user</span></span><br><span class="line"><span class="attr">      user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">add</span> <span class="string">user</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span> <span class="string">group=nginx</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Install</span> <span class="string">Nginx</span></span><br><span class="line"><span class="attr">      yum:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">restart</span> <span class="string">Nginx</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=nginx</span> <span class="string">state=restarted</span></span><br><span class="line"><span class="attr">      when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">“6”</span></span><br></pre></td></tr></table></figure>

<p>示例：when条件判断</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">install</span> <span class="string">conf</span> <span class="string">file</span> <span class="string">to</span> <span class="string">centos7</span></span><br><span class="line"><span class="attr">    template:</span> <span class="string">src=nginx.conf.c7.j2</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">"7"</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">install</span> <span class="string">conf</span> <span class="string">file</span> <span class="string">to</span> <span class="string">centos6</span></span><br><span class="line"><span class="attr">    template:</span> <span class="string">src=nginx.conf.c6.j2</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">"6"</span></span><br></pre></td></tr></table></figure>

<h5 id="迭代：with-items"><a href="#迭代：with-items" class="headerlink" title="迭代：with_items"></a>迭代：with_items</h5><p>迭代：当有需要重复性执行的任务时，可以使用迭代机制</p>
<ul>
<li>对迭代项的引用，固定变量名为”item“</li>
<li>要在task中使用with_items给定要迭代的元素列表</li>
<li>列表格式：<br>&emsp;&emsp;字符串<br>&emsp;&emsp;字典<br>示例：<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">add</span> <span class="string">several</span> <span class="string">users</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span> <span class="string">groups=wheel</span></span><br><span class="line"><span class="attr">  with_items:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">testuser1</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">testuser2</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>&emsp;&emsp;上面语句的功能等同于下面的语句：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">add</span> <span class="string">user</span> <span class="string">testuser1</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">name=testuser1</span> <span class="string">state=present</span> <span class="string">groups=wheel</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">add</span> <span class="string">user</span> <span class="string">testuser2</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">name=testuser2</span> <span class="string">state=present</span> <span class="string">groups=wheel</span></span><br></pre></td></tr></table></figure>

<p>示例：将多个文件进行copy到被控端</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">testsrv</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Create</span> <span class="string">rsyncd</span> <span class="string">config</span></span><br><span class="line"><span class="attr">      copy:</span> <span class="string">src=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">dest=/etc/&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">      with_items:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">rsyncd.secrets</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">rsyncd.conf</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">copy</span> <span class="string">file</span></span><br><span class="line"><span class="attr">      copy:</span> <span class="string">src=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">dest=/tmp/&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">      with_items:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">file1</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">file2</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">file3</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">yum</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">      yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">      with_items:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">apr</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">apr-util</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">httpd</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">install</span> <span class="string">some</span> <span class="string">packages</span></span><br><span class="line"><span class="attr">      yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">      with_items:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">nginx</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">memcached</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">php-fpm</span></span><br></pre></td></tr></table></figure>

<p>示例：迭代嵌套子变量</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">hosts：websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">add</span> <span class="string">some</span> <span class="string">groups</span></span><br><span class="line"><span class="attr">      group:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">      with_items:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">group1</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">group2</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">group3</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">add</span> <span class="string">some</span> <span class="string">users</span></span><br><span class="line"><span class="attr">      user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item.name</span> <span class="string">&#125;&#125;</span> <span class="string">group=&#123;&#123;</span> <span class="string">item.group</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">      with_items:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'user1'</span><span class="string">,</span> <span class="attr">group:</span> <span class="string">'group1'</span> <span class="string">&#125;</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'user2'</span><span class="string">,</span> <span class="attr">group:</span> <span class="string">'group2'</span> <span class="string">&#125;</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'user3'</span><span class="string">,</span> <span class="attr">group:</span> <span class="string">'group3'</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="Playbook中template-for-if"><a href="#Playbook中template-for-if" class="headerlink" title="Playbook中template for if"></a>Playbook中template for if</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;%</span> <span class="string">for</span> <span class="string">vhost</span> <span class="string">in</span> <span class="string">nginx_vhosts</span> <span class="string">%&#125;</span></span><br><span class="line"><span class="string">server</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">listen</span> <span class="string">&#123;&#123;</span> <span class="string">vhost.listen</span> <span class="string">| default('80 default_server') &#125;&#125;;</span></span><br><span class="line"><span class="string">&#123;% if vhost.server_name is defined %&#125;</span></span><br><span class="line"><span class="string">server_name <span class="template-variable">&#123;&#123; vhost.server_name &#125;&#125;</span>;</span></span><br><span class="line"><span class="string">&#123;% endif %&#125;</span></span><br><span class="line"><span class="string">&#123;% if vhost.root is defined %&#125;</span></span><br><span class="line"><span class="string">root <span class="template-variable">&#123;&#123; vhost.root &#125;&#125;</span>;</span></span><br><span class="line"><span class="string">&#123;% endif %&#125;</span></span><br><span class="line"><span class="string">&#123;% endfor %&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="roles"><a href="#roles" class="headerlink" title="roles"></a>roles</h3><p>&emsp;&emsp;ansible自1.2版本引入的新特性，用于层次性、结构化地组织playbook。roles能够根据层次型结构自动装载变量文件、tasks以及handlers等。要使用roles只需要在playbook中使用include指令即可。简单来讲，roles就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并可以便捷地include它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中。<br>&emsp;&emsp;复杂场景：建议使用roles，代码复用度高</p>
<ul>
<li>变更指定主机或主机组</li>
<li>如命名不规范维护和传承成本大</li>
<li>某些功能需多个Playbook，通过includes即可实现<h4 id="roles-1"><a href="#roles-1" class="headerlink" title="roles"></a>roles</h4>角色(roles)：角色集合<br>roles/<br>&emsp;mysql/<br>&emsp;httpd/<br>&emsp;nginx/<br>&emsp;memcached/<h4 id="Ansible-Roles目录编排"><a href="#Ansible-Roles目录编排" class="headerlink" title="Ansible Roles目录编排"></a>Ansible Roles目录编排</h4><img src="https://img-blog.csdnimg.cn/20191007213354915.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><h4 id="roles目录结构"><a href="#roles目录结构" class="headerlink" title="roles目录结构"></a>roles目录结构</h4>&emsp;&emsp;每个角色，以特定的层级目录结构进行组织<br>roles目录结构：<br>playbook.yml<br>&emsp;roles/<br>&emsp;project/<br>&emsp;tasks/<br>&emsp;files/<br>&emsp;vars/<br>&emsp;templates/<br>&emsp;handlers/<br>&emsp;default/ 不常用<br>&emsp;meta/ 不常用<h4 id="Roles各目录作用"><a href="#Roles各目录作用" class="headerlink" title="Roles各目录作用"></a>Roles各目录作用</h4></li>
<li>/roles/project/ :项目名称,有以下子目录</li>
<li>files/ ：存放由copy或script模块等调用的文件</li>
<li>templates/：template模块查找所需要模板文件的目录</li>
<li>tasks/：定义task,role的基本元素，至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含</li>
<li>handlers/：至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含</li>
<li>vars/：定义变量，至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含</li>
<li>meta/：定义当前角色的特殊设定及其依赖关系,至少应该包含一个名为main.yml的文件，其它文件需在此文件中通过include进行包含</li>
<li>default/：设定默认变量时使用此目录中的main.yml文件<h4 id="创建role"><a href="#创建role" class="headerlink" title="创建role"></a>创建role</h4><h5 id="创建role的步骤"><a href="#创建role的步骤" class="headerlink" title="创建role的步骤"></a>创建role的步骤</h5>(1) 创建以roles命名的目录<br>(2) 在roles目录中分别创建以各角色名称命名的目录，如webservers等<br>(3) 在每个角色命名的目录中分别创建files、handlers、meta、tasks、templates和vars目录；用不到的目录可以创建为空目录，也可以不创建<br>(4) 在playbook文件中，调用各角色<h5 id="针对大型项目使用Roles进行编排"><a href="#针对大型项目使用Roles进行编排" class="headerlink" title="针对大型项目使用Roles进行编排"></a>针对大型项目使用Roles进行编排</h5>roles目录结构：<br>playbook.yml<br>roles/<br>&emsp;project/<br>&emsp;&emsp;tasks/<br>&emsp;&emsp;files/<br>&emsp;&emsp;vars/<br>&emsp;&emsp;templates/<br>&emsp;&emsp;handlers/<br>&emsp;&emsp;default/ # 不经常用<br>&emsp;&emsp;meta/ # 不经常用<br>示例：<br>nginx-role.yml<br>roles/<br>└── nginx<br>├── files<br>│ └── main.yml<br>├── tasks<br>│ ├── groupadd.yml<br>│ ├── install.yml<br>│ ├── main.yml<br>│ ├── restart.yml<br>│ └── useradd.yml<br>└── vars<br>└── main.yml<h4 id="playbook调用角色"><a href="#playbook调用角色" class="headerlink" title="playbook调用角色"></a>playbook调用角色</h4><h5 id="调用角色方法1："><a href="#调用角色方法1：" class="headerlink" title="调用角色方法1："></a>调用角色方法1：</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr"> remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr"> roles:</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">mysql</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">memcached</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="调用角色方法2："><a href="#调用角色方法2：" class="headerlink" title="调用角色方法2："></a>调用角色方法2：</h5><p>&emsp;&emsp;传递变量给角色</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span></span><br><span class="line"><span class="attr">  remote_user:</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">mysql</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">nginx,</span> <span class="attr">username:</span> <span class="string">nginx</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp; 键role用于指定角色名称<br>&emsp;&emsp; 后续的k/v用于传递变量给角色</p>
<h5 id="调用角色方法3："><a href="#调用角色方法3：" class="headerlink" title="调用角色方法3："></a>调用角色方法3：</h5><p>&emsp;&emsp;还可基于条件测试实现角色调用</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">roles:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">nginx,</span> <span class="attr">username:</span> <span class="string">nginx,</span> <span class="attr">when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">‘7’</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="roles-playbook-tags使用"><a href="#roles-playbook-tags使用" class="headerlink" title="roles playbook tags使用"></a>roles playbook tags使用</h4><p> roles playbook tags使用<br><code>ansible-playbook --tags="nginx,httpd,mysql" nginx-role.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//</span> <span class="string">nginx-role.yml</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">testweb</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">nginx</span> <span class="string">,tags:</span> <span class="string">[</span> <span class="string">'nginx'</span><span class="string">,</span> <span class="string">'web'</span> <span class="string">]</span> <span class="string">,when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">"6“ &#125;</span></span><br><span class="line"><span class="string">    - &#123; role: httpd ,tags: [ 'httpd', 'web' ] &#125;</span></span><br><span class="line"><span class="string">    - &#123; role: mysql ,tags: [ 'mysql', 'db' ] &#125;</span></span><br><span class="line"><span class="string">    - &#123; role: marridb ,tags: [ 'mysql', 'db' ] &#125;</span></span><br><span class="line"><span class="string">    - &#123; role: php &#125;</span></span><br></pre></td></tr></table></figure>


        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://hewanyue.com/2019/10/05/mysql数据库MHA实现高可用（多实例间实现）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Hechao">
      <meta itemprop="description" content="BOHC is just a blog of hechao.">
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BOHC!">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
            
            <a href="/2019/10/05/mysql%E6%95%B0%E6%8D%AE%E5%BA%93MHA%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%88%E5%A4%9A%E5%AE%9E%E4%BE%8B%E9%97%B4%E5%AE%9E%E7%8E%B0%EF%BC%89/" class="post-title-link" itemprop="url">myql数据库MHA实现高可用（多实例间实现）</a>
          
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-10-05 09:15:31" itemprop="dateCreated datePublished" datetime="2019-10-05T09:15:31+08:00">2019-10-05</time>
            </span>
          

          
            <span id="/2019/10/05/mysql数据库MHA实现高可用（多实例间实现）/" class="post-meta-item leancloud_visitors" data-flag-title="myql数据库MHA实现高可用（多实例间实现）" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
              <span>℃</span>
            </span>
          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
        
      
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/10/05/mysql数据库MHA实现高可用（多实例间实现）/#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2019/10/05/mysql数据库MHA实现高可用（多实例间实现）/" itemprop="commentCount"></span></a>
  </span>
  
  
          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span>11k</span>
            </span>
          
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span>10 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>&emsp;&emsp; MHA(master high   availability)目前是MySQL高可用方面是一个相对成熟的解决方案。在切换过程中，mha能做到0-30s内自动完成数据库的切换，并且在切换过程中最大的保持数据的一致性，以达到真正意义上的高可用</p>
<p>&emsp;&emsp; MHA的组成：</p>
<p>&emsp;&emsp; MHA Manager(管理节点)和MHA Node(数据节点)。MHA Manager可以独立部署在一台独立的机器上，管理多个集群，也可以部署在从从库上。</p>
<p>&emsp;&emsp; 当Master出现故障的时候，它可以自动将最新的数据的Slave提升为新的Master，然后将所有的Slave重新指向新的Master，整个故障转移过程是完全透明的。<br>&emsp;&emsp; 实验演示图如下：<br><img src="https://img-blog.csdnimg.cn/2019092709363970.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp; 操作如下：<br>&emsp;&emsp; 1、在192.168.32.71主机和192.168.32.72主机上搭建好1主3从的主从配置服务器；<br>&emsp;&emsp; 2、在192.168.32.7主机作为监控主机，安装mhamanager包和node包，192.168.32.71主机、192.168.32.72主机只安装node包；<br>&emsp;&emsp; 3、将三台主机的ssh公钥信息互相储存（或公用一个公钥私钥对），设置好相互之间的基于key验证免密登录。<strong>（因为用的是多实例数据库，SSH连通性验证时还会检查各个数据库之间的连通性，这就包括3307、3308、3309端口数据库之间的SSH连接，所以一定要在192.168.32.72主机家目录的.ssh/authorized_keys文件中加入192.168.32.72本机的公钥，否则会报错，切记，已踩坑）</strong><br>&emsp;&emsp; 4、编写mha配置文件，路径随意。<code>vim /etc/mha.cnf</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[server default]</span></span><br><span class="line"><span class="attr">user</span>=mhauser</span><br><span class="line"><span class="attr">password</span>=mhuser</span><br><span class="line"><span class="attr">manager_workdir</span>=/data/mastermha/group1/</span><br><span class="line"><span class="attr">manager_log</span>=/data/mastermha/group1/manager.log</span><br><span class="line"><span class="attr">remote_workdir</span>=/data/mastermha/group1/</span><br><span class="line"><span class="attr">ssh_user</span>=root</span><br><span class="line"><span class="attr">repl_user</span>=repluser</span><br><span class="line"><span class="attr">repl_password</span>=repluser</span><br><span class="line"><span class="attr">ping_interval</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">master_binlog_dir</span>=/data/mysql</span><br><span class="line"><span class="section">[server1]</span></span><br><span class="line"><span class="attr">hostname</span>=<span class="number">192.168</span>.<span class="number">32.71</span></span><br><span class="line"><span class="section">[server2]</span></span><br><span class="line"><span class="attr">hostname</span>=<span class="number">192.168</span>.<span class="number">32.72</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3307</span></span><br><span class="line"><span class="attr">candidate_master</span>=<span class="number">1</span></span><br><span class="line"><span class="section">[server3]</span></span><br><span class="line"><span class="attr">hostname</span>=<span class="number">192.168</span>.<span class="number">32.72</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3308</span></span><br><span class="line"><span class="section">[server4]</span></span><br><span class="line"><span class="attr">hostname</span>=<span class="number">192.168</span>.<span class="number">32.72</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3309</span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp; 5、在主数据库服务器也就是192.168.32.71主机上创建监控账号（user=mhauser password=mhauser）和复制帐号（repl_user=repluser repl_password=repluser）（要和配置文件相同,已有则无需创建，可以用现成的，权限符合即可）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> mhauser@<span class="string">'192.168.32.7%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'mhauser'</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">REPLICATION</span> <span class="keyword">SLAVE</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'repluser'</span>@<span class="string">'192.168.32.7%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'repluser'</span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp; 6、用MHA包自带工具进行测试<code>usr/bin/masterha_check_ssh --conf=/etc/mha.cnf</code></p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>CentOS7 ~]#/usr/bin/masterha_check_ssh --conf=/etc/mha.cnf</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">25</span> <span class="number">2019</span> - [warning] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">25</span> <span class="number">2019</span> - [info] Reading application <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/mha.cnf..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">25</span> <span class="number">2019</span> - [info] Reading server configuration <span class="keyword">from</span> /etc/mha.cnf..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">25</span> <span class="number">2019</span> - [info] Starting SSH connection tests..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">28</span> <span class="number">2019</span> - [debug] </span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">25</span> <span class="number">2019</span> - [debug]  Connecting via SSH <span class="keyword">from</span> <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">22</span>) to <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">22</span>)..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">25</span> <span class="number">2019</span> - [debug]   ok.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">25</span> <span class="number">2019</span> - [debug]  Connecting via SSH <span class="keyword">from</span> <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">22</span>) to <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">22</span>)..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">26</span> <span class="number">2019</span> - [debug]   ok.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">26</span> <span class="number">2019</span> - [debug]  Connecting via SSH <span class="keyword">from</span> <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">22</span>) to <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">22</span>)..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">27</span> <span class="number">2019</span> - [debug]   ok.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">28</span> <span class="number">2019</span> - [debug] </span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">26</span> <span class="number">2019</span> - [debug]  Connecting via SSH <span class="keyword">from</span> <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">22</span>) to <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">22</span>)..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">27</span> <span class="number">2019</span> - [debug]   ok.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">27</span> <span class="number">2019</span> - [debug]  Connecting via SSH <span class="keyword">from</span> <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">22</span>) to <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">22</span>)..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">28</span> <span class="number">2019</span> - [debug]   ok.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">28</span> <span class="number">2019</span> - [debug]  Connecting via SSH <span class="keyword">from</span> <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">22</span>) to <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">22</span>)..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">29</span> <span class="number">2019</span> - [info] All SSH connection tests passed successfully.</span><br></pre></td></tr></table></figure>

<p><code>usr/bin/masterha_check_repl --conf=/etc/mha.cnf</code></p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>CentOS7 ~]#/usr/bin/masterha_check_repl --conf=/etc/mha.cnf</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">12</span> <span class="number">2019</span> - [warning] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">12</span> <span class="number">2019</span> - [info] Reading application <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/mha.cnf..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">12</span> <span class="number">2019</span> - [info] Reading server configuration <span class="keyword">from</span> /etc/mha.cnf..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">12</span> <span class="number">2019</span> - [info] MHA::MasterMonitor version <span class="number">0.56</span>.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info] GTID failover mode = <span class="number">0</span></span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info] Dead Servers:</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info] Alive Servers:</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]   <span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">3306</span>)</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]   <span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">3307</span>)</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]   <span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">3308</span>)</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]   <span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">3309</span>)</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info] Alive Slaves:</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]   <span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">3307</span>)  Version=<span class="number">10.4</span><span class="number">.8</span>-MariaDB-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">3306</span>)</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]   <span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">3308</span>)  Version=<span class="number">10.4</span><span class="number">.8</span>-MariaDB-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">3306</span>)</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]   <span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">3309</span>)  Version=<span class="number">10.4</span><span class="number">.8</span>-MariaDB-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">3306</span>)</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info] Current Alive Master: <span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">3306</span>)</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info] Checking slave configurations..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info] Checking replication filtering settings..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]  Replication filtering check ok.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info] GTID (with <span class="built_in">auto</span>-pos) <span class="keyword">is</span> <span class="keyword">not</span> supported</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info] Starting SSH connection tests..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">17</span> <span class="number">2019</span> - [info] All SSH connection tests passed successfully.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">17</span> <span class="number">2019</span> - [info] Checking MHA Node version..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">18</span> <span class="number">2019</span> - [info]  Version check ok.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">18</span> <span class="number">2019</span> - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">18</span> <span class="number">2019</span> - [info] HealthCheck: SSH to <span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">18</span> <span class="number">2019</span> - [info] Master MHA Node version <span class="keyword">is</span> <span class="number">0.56</span>.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">18</span> <span class="number">2019</span> - [info] Checking recovery script configurations on <span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">3306</span>)..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">18</span> <span class="number">2019</span> - [info]   Executing command: save_binary_logs --command=test --start_pos=<span class="number">4</span> --binlog_dir=/data/mysql --output_file=/data/mastermha/group1<span class="comment">//save_binary_logs_test --manager_version=0.56 --start_file=master-bin.000012 </span></span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">18</span> <span class="number">2019</span> - [info]   Connecting to <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">22</span>).. </span><br><span class="line">  Creating /data/mastermha/group1 <span class="keyword">if</span> <span class="keyword">not</span> exists..    ok.</span><br><span class="line">  Checking output directory <span class="keyword">is</span> accessible <span class="keyword">or</span> <span class="keyword">not</span>..</span><br><span class="line">   ok.</span><br><span class="line">  Binlog found at /data/mysql, up to master-bin<span class="number">.000012</span></span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">19</span> <span class="number">2019</span> - [info] Binlog setting check done.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">19</span> <span class="number">2019</span> - [info] Checking SSH publickey authentication <span class="keyword">and</span> checking recovery script configurations on all alive slave servers..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">19</span> <span class="number">2019</span> - [info]   Executing command : apply_diff_relay_logs --command=test --slave_user=<span class="string">'mhauser'</span> --slave_host=<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span> --slave_ip=<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span> --slave_port=<span class="number">3307</span> --workdir=/data/mastermha/group1/ --target_version=<span class="number">10.4</span><span class="number">.8</span>-MariaDB-log --manager_version=<span class="number">0.56</span> --relay_log_info=/data/mysql3307/data/relay-log.info  --relay_dir=/data/mysql3307/data/  --slave_pass=xxx</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">19</span> <span class="number">2019</span> - [info]   Connecting to <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">22</span>).. </span><br><span class="line">  Checking slave recovery environment settings..</span><br><span class="line">    Opening /data/mysql3307/data/relay-log.info ... ok.</span><br><span class="line">    Relay log found at /data/mysql3307/data, up to relay-log<span class="number">.000034</span></span><br><span class="line">    Temporary relay log file <span class="keyword">is</span> /data/mysql3307/data/relay-log<span class="number">.000034</span></span><br><span class="line">    Testing mysql connection <span class="keyword">and</span> privileges.. done.</span><br><span class="line">    Testing mysqlbinlog output.. done.</span><br><span class="line">    Cleaning up test file(s).. done.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">19</span> <span class="number">2019</span> - [info]   Executing command : apply_diff_relay_logs --command=test --slave_user=<span class="string">'mhauser'</span> --slave_host=<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span> --slave_ip=<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span> --slave_port=<span class="number">3308</span> --workdir=/data/mastermha/group1/ --target_version=<span class="number">10.4</span><span class="number">.8</span>-MariaDB-log --manager_version=<span class="number">0.56</span> --relay_log_info=/data/mysql3308/data/relay-log.info  --relay_dir=/data/mysql3308/data/  --slave_pass=xxx</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">19</span> <span class="number">2019</span> - [info]   Connecting to <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">22</span>).. </span><br><span class="line">  Checking slave recovery environment settings..</span><br><span class="line">    Opening /data/mysql3308/data/relay-log.info ... ok.</span><br><span class="line">    Relay log found at /data/mysql3308/data, up to relay-log<span class="number">.000009</span></span><br><span class="line">    Temporary relay log file <span class="keyword">is</span> /data/mysql3308/data/relay-log<span class="number">.000009</span></span><br><span class="line">    Testing mysql connection <span class="keyword">and</span> privileges.. done.</span><br><span class="line">    Testing mysqlbinlog output.. done.</span><br><span class="line">    Cleaning up test file(s).. done.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [info]   Executing command : apply_diff_relay_logs --command=test --slave_user=<span class="string">'mhauser'</span> --slave_host=<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span> --slave_ip=<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span> --slave_port=<span class="number">3309</span> --workdir=/data/mastermha/group1/ --target_version=<span class="number">10.4</span><span class="number">.8</span>-MariaDB-log --manager_version=<span class="number">0.56</span> --relay_log_info=/data/mysql3309/data/relay-log.info  --relay_dir=/data/mysql3309/data/  --slave_pass=xxx</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [info]   Connecting to <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">22</span>).. </span><br><span class="line">  Checking slave recovery environment settings..</span><br><span class="line">    Opening /data/mysql3309/data/relay-log.info ... ok.</span><br><span class="line">    Relay log found at /data/mysql3309/data, up to relay-log<span class="number">.000009</span></span><br><span class="line">    Temporary relay log file <span class="keyword">is</span> /data/mysql3309/data/relay-log<span class="number">.000009</span></span><br><span class="line">    Testing mysql connection <span class="keyword">and</span> privileges.. done.</span><br><span class="line">    Testing mysqlbinlog output.. done.</span><br><span class="line">    Cleaning up test file(s).. done.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [info] Slaves settings check done.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [info] </span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">3306</span>) (current master)</span><br><span class="line"> +-<span class="number">-192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">3307</span>)</span><br><span class="line"> +-<span class="number">-192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">3308</span>)</span><br><span class="line"> +-<span class="number">-192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">3309</span>)</span><br><span class="line"></span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [info] Checking replication health on <span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [info]  ok.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [info] Checking replication health on <span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [info]  ok.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [info] Checking replication health on <span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [info]  ok.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [warning] master_ip_failover_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [info] Got exit code <span class="number">0</span> (Not master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication Health <span class="keyword">is</span> OK.</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp; 均显示测试成功~<br>&emsp;&emsp; 可以启动MHAmanager了，注意这是一个前端程序，如果检测到主数据库宕机，则会自动切换从数据为新的主服务器并使其他的从服务器从新的主服务器数据库上面复制数据，此后程序自动终止。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]#/usr/bin/masterha_manager <span class="attribute">--conf</span>=/etc/mha.cnf</span><br><span class="line">Fri Sep 27 11:35:37 2019 - [<span class="builtin-name">warning</span>] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Fri Sep 27 11:35:37 2019 - [<span class="builtin-name">info</span>] Reading application<span class="built_in"> default </span>configuration <span class="keyword">from</span> /etc/mha.cnf<span class="built_in">..</span></span><br><span class="line">Fri Sep 27 11:35:37 2019 - [<span class="builtin-name">info</span>] Reading<span class="built_in"> server </span>configuration <span class="keyword">from</span> /etc/mha.cnf<span class="built_in">..</span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp; 在主数据库上将mysql进程杀掉后，MHA进程自动结束。<br><img src="https://img-blog.csdnimg.cn/20190927123356815.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp; 在3307端口数据库上查询，已经没有从节点信息了。<img src="https://img-blog.csdnimg.cn/20190927124323317.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 在3308端口数据库以及3309端口数据上显示，主数据库已变为更为3307端口数据库，说明转换主从结构成功！<br><img src="https://img-blog.csdnimg.cn/20190927124330490.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp; PS：因为几个数据库都是源码编译安装，数据库路径和二进制文件储存位置都做出了调整，与默认位置不同，而yum安装的MHAmaster中如果配置文件中不写明master_binlog_dir的位置，则会默认去<code>/usr/bin/msyql/</code>目录下找主机二进制文件（当然，mysql数据库也是yum安装的可忽略这些配置，一切默认就好，而配置文件中添加server主机时，如果端口号不是默认3306，一定要记得写明port端口号，如本文中多实例用的不同端口，标记清楚即可。）</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://hewanyue.com/2019/09/25/mysql多实例实现主从级联复制及读写分离/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Hechao">
      <meta itemprop="description" content="BOHC is just a blog of hechao.">
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BOHC!">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
            
            <a href="/2019/09/25/mysql%E5%A4%9A%E5%AE%9E%E4%BE%8B%E5%AE%9E%E7%8E%B0%E4%B8%BB%E4%BB%8E%E7%BA%A7%E8%81%94%E5%A4%8D%E5%88%B6%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/" class="post-title-link" itemprop="url">mysql多实例实现主从级联复制及读写分离</a>
          
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-09-25 11:21:43" itemprop="dateCreated datePublished" datetime="2019-09-25T11:21:43+08:00">2019-09-25</time>
            </span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/数据库/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a></span>

                
                
              
            </span>
          

          
            <span id="/2019/09/25/mysql多实例实现主从级联复制及读写分离/" class="post-meta-item leancloud_visitors" data-flag-title="mysql多实例实现主从级联复制及读写分离" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
              <span>℃</span>
            </span>
          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
        
      
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/09/25/mysql多实例实现主从级联复制及读写分离/#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2019/09/25/mysql多实例实现主从级联复制及读写分离/" itemprop="commentCount"></span></a>
  </span>
  
  
          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span>10k</span>
            </span>
          
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span>9 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>一、多实例</strong></p>
<p>1、概述</p>
<p>&emsp;&emsp; MySQL多实例就是在一台机器上开启多个不同的服务端口（如：3306,3307），运行多个MySQL服务进程，通过不同的socket监听不同的服务端口来提供各自的服务</p>
<p>2.1、优点</p>
<p>1）有效利用服务器资源</p>
<p>&emsp;&emsp; 当单个服务器资源过剩时，可以充分利用剩余的资源来提供更多的服务；<br>2）节约服务器资源</p>
<p>&emsp;&emsp; 当公司资金紧张，但数据库又需要数据库之间各自提供服务时，并且还想使用主从同步等技术，此时多实例就再好不过了；<br>3）方便后期架构扩展</p>
<p>&emsp;&emsp; 当公司的某个项目才启动时，启动初期并不一定有很大的用户量，因此可以先用一组物理数据库服务器，在上面部署多个实例，方便后续架构扩展、迁移；</p>
<p>2.2、缺点</p>
<p>资源互相抢占问题</p>
<p>&emsp;&emsp; 当某个服务实例并发很高或者有慢查询时，整个实例会消耗更多的内存、CPU和IO资源，这将导致服务器上的其它实例提供服务的质量下降。这就比如说合租房的各个租客，每当早晨上班时，都会洗漱，此时卫生间的占用率就大，各个租客总会发生等待。</p>
<p>3、部署mysql多实例的两种方式</p>
<p>① 基于多配置文件</p>
<p>&emsp;&emsp; 通过使用多个配置文件来启动不同的进程，以此来实现多实例。</p>
<p>&emsp;&emsp; 优点：逻辑简单，配置简单</p>
<p>&emsp;&emsp; 缺点：管理起来不方便</p>
<p>② 基于mysqld_multi</p>
<p>&emsp;&emsp; 通过官方自带的 mysqld_multi 工具，使用单独配置文件来实现多实例</p>
<p>&emsp;&emsp; 优点： 便于集中管理管理</p>
<p>&emsp;&emsp; 缺点： 不方便针对每个实例配置进行定制</p>
<p>4、同一开发环境下安装两个数据库，必须处理以下问题</p>
<p>&emsp;&emsp; （1） 配置文件安装路径不能相同</p>
<p>&emsp;&emsp; （2）数据库目录不能相同</p>
<p>&emsp;&emsp; （3）启动脚本不能同名</p>
<p>&emsp;&emsp; （4）端口不能相同</p>
<p>&emsp;&emsp; （5）socket文件的生成路径不能相同<br>5、配置搭建<br>&emsp;&emsp; 实现目标：<img src="https://img-blog.csdnimg.cn/20190925114000429.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp; 1、源码编译安装或者二进制安装或者yum安装mysql或mariadb客户端以及server端,若没有创建mysql用户、组则创建。<br>&emsp;&emsp; 2、在指定路径下创建3个数据库目录<br>&emsp;&emsp;mkdir -p /data/mysql330{789}<br>&emsp;&emsp;挂载在不同的三块硬盘上</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mount /dev/sdb /data/mysql3307</span><br><span class="line">mount /dev/sdc /data/mysql3308</span><br><span class="line">mount /dev/sdd /data/mysql3309</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp; 3、用server端带的初始化脚本生成三个数据库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scripts/mariadb-install-db --datadir=/data/mysql3307/ --user=mysql</span><br><span class="line">scripts/mariadb-install-db --datadir=/data/mysql3308/ --user=mysql</span><br><span class="line">scripts/mariadb-install-db --datadir=/data/mysql3309/ --user=mysql</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp; 4、准备三个配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/my.cnf /data/mysql3307/my.cnf</span><br><span class="line">cp /etc/my.cnf /data/mysql3308/my.cnf</span><br><span class="line">cp /etc/my.cnf /data/mysql3309/my.cnf</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp; 修改分别其中配置（以下以实例3307为例，3308、3309将下面所有数字对应改成自己的端口号）</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line"><span class="comment">#password       = your_password</span></span><br><span class="line">port            = 3307</span><br><span class="line">socket          = /data/mysql3307/mysql.sock</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="attribute">datadir</span>=/data/mysql3307/</span><br><span class="line"><span class="attribute">innodb_file_per-table</span>=on</span><br><span class="line"><span class="attribute">skip_name_resolve</span>=on</span><br><span class="line">port            = 3307</span><br><span class="line">socket          = /data/mysql3307/mysql.sock</span><br><span class="line"><span class="attribute">log-bin</span>=mysql-bin</span><br><span class="line">log-slave-updates</span><br><span class="line">server-id       = 3307					        	#每个数据库server-id全局唯一</span><br><span class="line"><span class="attribute">default-character-set</span>=utf8</span><br><span class="line"></span><br><span class="line"><span class="attribute">read_only</span>=ON								#3307特有选项-开启中继日志</span><br><span class="line"><span class="attribute">relay_log</span>=relay-log							#3307特有选项</span><br><span class="line"><span class="attribute">relay_log_index</span>=relay-log.index						#3307特有选项</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp; 5、编写服务启动脚本（并加执行权限和修改PATH路径）</p>
<p>&emsp;&emsp;vim mysqld</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">port=$1</span><br><span class="line">mysql_user="root"</span><br><span class="line">mysql_pwd="password"</span><br><span class="line">cmd_path="/usr/local/mysql/bin"</span><br><span class="line">mysql_basedir="/data/mysql"</span><br><span class="line">mysql_sock="$&#123;mysql_basedir&#125;$&#123;port&#125;/mysql.sock"</span><br><span class="line"></span><br><span class="line">function_start_mysql()</span><br><span class="line">&#123;</span><br><span class="line">    if [ ! -e "$mysql_sock" ];then</span><br><span class="line">      printf "Starting MySQL...\n"</span><br><span class="line">      $&#123;cmd_path&#125;/mysqld_safe --defaults-file=$&#123;mysql_basedir&#125;$&#123;port&#125;/my.cnf  &> /dev/null  &</span><br><span class="line">    else</span><br><span class="line">      printf "MySQL is running...\n"</span><br><span class="line">      exit</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function_stop_mysql()</span><br><span class="line">&#123;</span><br><span class="line">    if [ ! -e "$mysql_sock" ];then</span><br><span class="line">       printf "MySQL is stopped...\n"</span><br><span class="line">       exit</span><br><span class="line">    else</span><br><span class="line">       printf "Stoping MySQL...\n"</span><br><span class="line">       $&#123;cmd_path&#125;/mysqladmin -u $&#123;mysql_user&#125; -p$&#123;mysql_pwd&#125; -S $&#123;mysql_sock&#125; shutdown</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function_restart_mysql()</span><br><span class="line">&#123;</span><br><span class="line">    printf "Restarting MySQL...\n"</span><br><span class="line">    function_stop_mysql</span><br><span class="line">    sleep 1</span><br><span class="line">    function_start_mysql</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if [ ! -n "$2" ];then</span><br><span class="line">	printf "Usage: $&#123;mysql_basedir&#125;$&#123;port&#125;/bin/mysqld [PORT] &#123;start|stop|restart&#125;\n"</span><br><span class="line">else</span><br><span class="line">	case $2 in</span><br><span class="line">	start)</span><br><span class="line">    	function_start_mysql</span><br><span class="line">	;;</span><br><span class="line">	stop)</span><br><span class="line">    	function_stop_mysql</span><br><span class="line">	;;</span><br><span class="line">	restart)</span><br><span class="line">    	function_restart_mysql</span><br><span class="line">	;;</span><br><span class="line">	*)</span><br><span class="line">    	printf "Usage: $&#123;mysql_basedir&#125;$&#123;port&#125;/bin/mysqld &#123;start|stop|restart&#125;\n"</span><br><span class="line">	esac</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp; 6、现在就可以实现执行mysqld 3307 start启动数据库服务了。启动三台数据库后（可运行安全加固脚本去掉test数据库以及多余账户），在主机数据库及这3个数据库中分别增加主从配置。<br>&emsp;&emsp; 192.168.32.71主机数据库:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]> GRANT REPLICATION SLAVE ON *.* TO &apos;repluser&apos;@&apos;192.168.32.72&apos; IDENTIFIED BY &apos;replpasswd&apos;;</span><br><span class="line">MariaDB [(none)]> SHOW MASTER STATUS;</span><br></pre></td></tr></table></figure>

<p>MariaDB [(none)]> show master status;<br>+———————-+—————–+——————-+————————-+<br>|&emsp;&emsp; &emsp;File&emsp;&emsp;&emsp;&emsp;      | &emsp;Position &emsp;| Binlog_Do_DB | Binlog_Ignore_DB |<br>+———————-+—————–+——————-+————————-+<br>| mysql-bin.000026 | &emsp; 1136 &emsp;&emsp;|&emsp;&emsp; &emsp;&emsp;&emsp;&emsp;&emsp;|&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp; |<br>+———————-+—————–+——————-+————————-+</p>
<p>&emsp;&emsp; 查看并记录主机当前二进制日志文件信息及位置。<br>&emsp;&emsp; 用mysqldump (或者物理备份)，并还原至3个从节点。<br>&emsp;&emsp; <strong>192.168.32.71主机:</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -ppassword -A --default-character-set=utf8 --master-data=1 --hex-blob  >/data/fullbak_`date +%F`.sql</span><br><span class="line">scp /data/fullbak_`date +%F`.sql 192.168.32.72:/data/</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp; <strong>192.168.32.72主机:</strong></p>
<p>&emsp;&emsp; 启动3个实例的服务</p>
<p>&emsp;&emsp;mysqld 3307 start；mysqld 3308 start；mysqld 3309 start</p>
<p>&emsp;&emsp; 连接3307实例</p>
<p>&emsp;&emsp;mysql -S /data/mysql3307/mysql.sock</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]> source /data/fullbak_XXX.sql</span><br><span class="line">MariaDB [(none)]> SHOW MASTER STATUS;</span><br></pre></td></tr></table></figure>

<p>MariaDB [(none)]> show master status;<br>+———————–+—————-+——————-+————————-+<br>|&emsp;&emsp; &emsp;File&emsp;&emsp;&emsp;&emsp;      | &emsp;Position &emsp;| Binlog_Do_DB | Binlog_Ignore_DB |<br>+———————–+—————-+——————-+————————-+<br>| mysql-bin.000006 | &emsp; 1167 &emsp;&emsp;|&emsp;&emsp; &emsp;&emsp;&emsp;&emsp;&emsp;|&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp; |<br>+———————–+—————-+——————-+————————-+</p>
<p>&emsp;&emsp; 记录3307实例的当前二进制日志文件信息及位置。</p>
<p>&emsp;&emsp; 在从节点3307添加主节点配置信息。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]> change master <span class="keyword">to</span> <span class="attribute">master_host</span>=<span class="string">'192.168.32.71'</span>,</span><br><span class="line"><span class="attribute">master_user</span>=<span class="string">'repluser'</span>,</span><br><span class="line"><span class="attribute">master_password</span>=<span class="string">'replpasswd'</span>,</span><br><span class="line"><span class="attribute">master_port</span>=3306,</span><br><span class="line"><span class="attribute">master_log_file</span>=<span class="string">'mysql-bin.000026'</span>,master_log_pos=1136;</span><br><span class="line">MariaDB [(none)]>start slave;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp; 连接3308实例mysql -S /data/mysql3308/mysql.sock<br>&emsp;&emsp; 在从节点3308添加主节点配置信息。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]> source /data/fullbak_XXX.sql</span><br><span class="line">MariaDB [(none)]> change master <span class="keyword">to</span> <span class="attribute">master_host</span>=<span class="string">'192.168.32.72,</span></span><br><span class="line"><span class="string">master_user='</span>repluser',</span><br><span class="line"><span class="attribute">master_password</span>=<span class="string">'replpasswd'</span>,</span><br><span class="line"><span class="attribute">master_port</span>=3307,</span><br><span class="line"><span class="attribute">master_log_file</span>=<span class="string">'mysql-bin.000006'</span>,master_log_pos=1167;</span><br><span class="line">MariaDB [(none)]>start slave;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp; 连接3309实例mysql -S /data/mysql3309/mysql.sock<br>&emsp;&emsp; 在从节点3309添加主节点配置信息。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]> source /data/fullbak_XXX.sql</span><br><span class="line">MariaDB [(none)]> change master <span class="keyword">to</span> <span class="attribute">master_host</span>=<span class="string">'192.168.32.72,</span></span><br><span class="line"><span class="string">master_user='</span>repluser',</span><br><span class="line"><span class="attribute">master_password</span>=<span class="string">'replpasswd'</span>,</span><br><span class="line"><span class="attribute">master_port</span>=3307,</span><br><span class="line"><span class="attribute">master_log_file</span>=<span class="string">'mysql-bin.000006'</span>,master_log_pos=1167;</span><br><span class="line">MariaDB [(none)]>start slave;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp; 三个从节点数据库依次<br>&emsp;&emsp;show slave status\G<br>查看主从状态信息，确认主从配置无误且均已启动，至此，多实例主从级联配置就完成了。<br>&emsp;&emsp;<br><strong>二、读写分离</strong><br>1、什么是读写分离？</p>
<p>&emsp;&emsp; 读写分离，基本的原理是让主数据库处理事务性增、改、删操作（INSERT、UPDATE、DELETE），而从数据库处理SELECT查询操作。数据库复制被用来把事务性操作导致的变更同步到集群中的从数据库。 </p>
<p>2、为什么要实现读写分离？</p>
<p>&emsp;&emsp; 因为数据库的“写”（写10000条数据到oracle可能要3分钟）操作是比较耗时的。<br>&emsp;&emsp; 但是数据库的“读”（从oracle读10000条数据可能只要5秒钟）。<br>所以读写分离，解决的是，数据库的写入，影响了查询的效率。 </p>
<p> 3、什么时候要读写分离？ </p>
<p>&emsp;&emsp; 数据库不一定要读写分离，如果程序使用数据库较多时，而更新少，查询多的情况下会考虑使用，利用数据库 主从同步 。可以减少数据库压力，提高性能。当然，数据库也有其它优化方案。memcache 或是 表折分，或是搜索引擎。都是解决方法。 </p>
<p>4、部署读写分离<br>&emsp;&emsp; 本次使用proxy实现读写分离，最终实现下图所示<br><img src="https://img-blog.csdnimg.cn/20190925164049740.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp; 1、部署代理机ip：192.168.32.70<br>&emsp;&emsp; 安装proxy及mysql客户端</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/yum.repos.d/proxysql.repo <<EOF </span><br><span class="line">[proxysql_repo]</span><br><span class="line">name= ProxySQL YUM repository</span><br><span class="line">baseurl=http://repo.proxysql.com/ProxySQL/proxysql-1.4.x/centos/\$releasever</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://repo.proxysql.com/ProxySQL/repo_pub_key</span><br><span class="line">EOF</span><br><span class="line">yum install proxysql -y</span><br><span class="line">yum install mysql -y</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp; 修改代理机配置文件端口号 6033 改为 3306（方便客户机连接,其他保持默认）</p>
<p>&emsp;&emsp;sed -ri ‘s@(interfaces=”0.0.0.0:)6033@\13306@’ /etc/proxysql.cnf</p>
<p>&emsp;&emsp; 登陆proxysql数据库</p>
<p>&emsp;&emsp;mysql -uadmin -padmin -P6032 -h127.0.0.1</p>
<p>&emsp;&emsp; 在代理服务器上增加主机信息</p>
<p>&emsp;&emsp; MySQL [(none)]> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">insert into mysql_servers(hostgroup_id,hostname,port) 	values(10,&apos;192.168.32.71&apos;,3306),</span><br><span class="line">(10,&apos;192.168.32.72&apos;,3307),</span><br><span class="line">(10,&apos;192.168.32.72&apos;,3308),</span><br><span class="line">(10,&apos;192.168.32.72&apos;,3309);</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp; 加载:MySQL [(none)]> load mysql servers to runtime<br>&emsp;&emsp; 保存:MySQL [(none)]> save mysql servers to disk</p>
<p>&emsp;&emsp; #设置监控帐号（使用默认监控账号(账号:密码=monitor:monitor)的话，此步可跳过）<br>&emsp;&emsp; MySQL [(none)]></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set mysql-monitor_username=&apos;username&apos;</span><br><span class="line">set mysql-monitor_password=&apos;password&apos;</span><br><span class="line">MySQL [(none)]> load mysql variables to runtime;</span><br><span class="line">MySQL [(none)]> save mysql variables to disk;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp; 2、在主服务器上增加创建proxy的监控帐号并授权(从节点会自动复制创建，无需再创)</p>
<p>&emsp;&emsp; MySQL [(none)]> grant replication client on <em>.</em> to monitor@’192.168.32.71’identified by ‘monitor’;</p>
<p>&emsp;&emsp; 3、在代理机上查看监控连接是否正常的 (对connect指标的监控)：<br>&emsp;&emsp; 如果connect_error的结果为NULL则表示正常<br>&emsp;&emsp; MySQL>select * from mysql_server_connect_log;<br>&emsp;&emsp; 查看监控心跳信息 (对ping指标的监控)：<br>&emsp;&emsp; MySQL> select * from mysql_server_ping_log;<br>&emsp;&emsp; (如果显示连接失败，可尝试在从节点刷新权限<strong>flush privileges;</strong>)<br>&emsp;&emsp; 4、设置分组信息<br>&emsp;&emsp;  需要修改的是main库中的mysql_replication_hostgroups表，该表有3个字段：writer_hostgroup，reader_hostgroup，comment, 指定写组的id为10，读组的id为20<br>&emsp;&emsp; MySQL>insert into mysql_replication_hostgroups values(10,20,”CentOS7”);<br>&emsp;&emsp; 将mysql_replication_hostgroups表的修改加载到RUNTIME生效<br>&emsp;&emsp; MySQL> load mysql servers to runtime;<br>&emsp;&emsp; MySQL> save mysql servers to disk;<br>&emsp;&emsp; Monitor模块监控后端的read_only值，按照read_only的值将节点自动移动到读/写组<br>&emsp;&emsp;查看添加的主机分组表，应该已经自动分组了：<br>&emsp;&emsp;  MySQL>select hostgroup_id,hostname,port,status,weight from mysql_servers;<br><img src="https://img-blog.csdnimg.cn/2019092521480589.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 5、在proxysql上配置路由规则，实现读写分离<br>&emsp;&emsp; 与规则有关的表：mysql_query_rules和mysql_query_rules_fast_routing，后者是前者的扩展表，1.4.7之后支持<br>&emsp;&emsp; 插入路由规则：将select语句分离到20的读组，select语句中有一个特殊语句<br>&emsp;&emsp; SELECT…FOR UPDATE它会申请写锁，应路由到10的写组<br>&emsp;&emsp; MySQL>insert into mysql_query_rules(rule_id,active,match_digest,destination_hostgroup,apply) VALUES(1,1,’^SELECT.<em>FOR UPDATE$’,10,1),(2,1,’^SELECT’,20,1);<br>&emsp;&emsp; MySQL> load mysql query rules to runtime;<br>&emsp;&emsp; MySQL> save mysql query rules to disk;<br>*</em>注意：因ProxySQL根据rule_id顺序进行规则匹配，select … for update规则的rule_id必须要小于普通的select规则的rule_id**</p>
<p>&emsp;&emsp;在代理机上用命令测试相应读写的是哪个数据库：<br>&emsp;&emsp;mysql -uroot -pPASSWORD -P3306 -h127.0.0.1 -e ‘start transaction;select @@server_id;commit;select @@server_id’<br>+———————+<br>| @@server_id&emsp;  |<br>+———————+<br>|      &emsp; &emsp;   3306&emsp; &emsp;  |<br>+———————+<br>+———————+<br>| @@server_id&emsp;  |<br>+———————+<br>|      &emsp; &emsp;   3307 &emsp; &emsp; |<br>+———————+<br>&emsp;&emsp;说明读写分离，在两个终端上成功实现~</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://hewanyue.com/2019/09/18/关于mariadb10-4-8二进制安装及源码编译后设置密码无效的一些发现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Hechao">
      <meta itemprop="description" content="BOHC is just a blog of hechao.">
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BOHC!">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
            
            <a href="/2019/09/18/%E5%85%B3%E4%BA%8Emariadb10-4-8%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E5%8F%8A%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%90%8E%E8%AE%BE%E7%BD%AE%E5%AF%86%E7%A0%81%E6%97%A0%E6%95%88%E7%9A%84%E4%B8%80%E4%BA%9B%E5%8F%91%E7%8E%B0/" class="post-title-link" itemprop="url">关于mariadb10.4.8二进制安装及源码编译后设置密码无效的一些发现</a>
          
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-09-18 19:35:12" itemprop="dateCreated datePublished" datetime="2019-09-18T19:35:12+08:00">2019-09-18</time>
            </span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/数据库/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a></span>

                
                
              
            </span>
          

          
            <span id="/2019/09/18/关于mariadb10-4-8二进制安装及源码编译后设置密码无效的一些发现/" class="post-meta-item leancloud_visitors" data-flag-title="关于mariadb10.4.8二进制安装及源码编译后设置密码无效的一些发现" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
              <span>℃</span>
            </span>
          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
        
      
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/09/18/关于mariadb10-4-8二进制安装及源码编译后设置密码无效的一些发现/#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2019/09/18/关于mariadb10-4-8二进制安装及源码编译后设置密码无效的一些发现/" itemprop="commentCount"></span></a>
  </span>
  
  
          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span>6k</span>
            </span>
          
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span>5 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>&emsp;&emsp;之前安装了最新版的mariadb10.4.8后，无论是二进制编译安装还是源码编译安装，设定完密码之后启动mysqld服务，结果都不需要密码就可以登陆进去，无论怎么执行<strong>mysql_secure_installation</strong>数据库初始化脚本或者<strong>mysql_secure_installation</strong>安全加固脚本，进入mysql都无需密码，用命令直接设置密码也无效，都是直接一敲mysql就可以进入数据库了。my.cnf配置文件查看了无数遍，也没发现任何蛛丝马迹。今天终于在无意中查看mysql数据库权限时意外有所收获，写出来与大家分享，让大家少走弯路。<br>&emsp;&emsp;当我进入mysql数据库，打开user表时，查看了下用户没有任何问题。<br><strong>MariaDB [mysql]> select user,host,password from user;</strong><br>+———-+————+———————————————————–+<br>| user &emsp;&emsp;| host &emsp;&emsp;    |  &emsp;  password            &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;      |<br>+———-+————+———————————————————–+<br>| &emsp;root&emsp; | localhost | <em>54D9A58CB44735F80AC5AD29961814D6D12B8746  |<br>| &emsp;root &emsp;| 127.0.0.1 | <em>54D9A58CB44735F80AC5AD29961814D6D12B8746  |<br>| &emsp;root&emsp; | ::1 &emsp;&emsp;&emsp; | *54D9A58CB44735F80AC5AD29961814D6D12B8746 |<br>+———-+————+———————————————————–+<br>3 rows in set (0.001 sec)<br>|user  | host    |password   |<br>|–|–|–|<br>|root  | localhost | *54D9A58CB44735F80AC5AD29961814D6D12B8746 |<br>|root  | 127.0.0.1 | *54D9A58CB44735F80AC5AD29961814D6D12B8746 |<br>|root  |::1| *54D9A58CB44735F80AC5AD29961814D6D12B8746 |<br><img src="https://img-blog.csdnimg.cn/20190918203111766.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;可当我突发奇想打算看看他们这几个用户有什么权限上的区别时，就发现问题了：<br>*</em>MariaDB [mysql]> show grants for ‘root’@’localhost’;**<br>+—————————————————————————————————————+<br>| &emsp;Grants for root@localhost&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp; |<br>+—————————————————————————————————————+<br>| GRANT ALL PRIVILEGES ON *.</em> TO ‘root’@’localhost’ IDENTIFIED VIA mysql_native_password USING ‘invalid’ OR unix_socket WITH GRANT OPTION &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;|<br>| GRANT PROXY ON ‘’@’%’ TO ‘root’@’localhost’ WITH GRANT OPTION                                                                           &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;|<br>+—————————————————————————————————————+<br>2 rows in set (0.000 sec)<br><strong>MariaDB [mysql]> show grants for ‘root’@’127.0.0.1’;</strong><br>ERROR 1141 (42000): There is no such grant defined for user ‘root’ on host ‘127.0.0.1’<br><strong>MariaDB [mysql]> show grants for ‘root’@’::1’;</strong><br>ERROR 1141 (42000): There is no such grant defined for user ‘root’ on host ‘::1’<br>MariaDB [mysql]><br><img src="https://img-blog.csdnimg.cn/20190918202258915.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;root用户竟然查不到权限，这就很奇怪了。在之前的mariadb10.2.27上尝试了下，都是正常的，如下图所示：<br><img src="https://img-blog.csdnimg.cn/20190918202923735.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;于是我就尝试对那两个异常的用户账号授权。<br><img src="https://img-blog.csdnimg.cn/20190918210814239.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;竟然也无法授权。这种情况跟我之前尝试过的直接用insert命令向user表中加的user条目情况有点相似。当时我用</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert<span class="built_in"> user </span><span class="builtin-name">set</span> <span class="attribute">Host</span>=<span class="string">'192.168.32.7'</span>,User='root',Password='54D9A58CB44735F80AC5AD29961814D6D12B8746',ssl_cipher='',x509_subject='',x509_issuer='',authentication_string='';</span><br></pre></td></tr></table></figure>

<p>命令在user表中创建了一个用户条目‘root’@’192.168.32.7’。<br><img src="https://img-blog.csdnimg.cn/20190918212605283.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;这个条目看起来和真正的用户一样，可等到授权时就发现没法授权了，且这个用户也没法远程在192.168.32.7主机登录，尝试insert了一个新的非root用户，也是同样的情况。说明create user 命令不单单只是在这个表上创建了新的用户条目，在其他关联的表上也有条目的增加。OK ，话题扯远了，继续说之前的无法加密的问题。<br>&emsp;&emsp;既然是同样的情况，我想到会不会是说明我这个新装好的mariadb上的这两个用户没有创建成功，是不是像上面提到的两个异常用户只是在这表中“徒有其表”呢？<br>&emsp;&emsp;那就尝试创建用户，并查看了下权限。<br><img src="https://img-blog.csdnimg.cn/20190918215852938.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">&emsp;&emsp;竟然创建用户成功了，而且权限也显示出来了（我记得我还没有授权呢啊！！！看来是root用户不用授权）。好像一切都恢复正常了。<br>&emsp;&emsp;赶紧退出看下是不是真的恢复正常了，结果失望的发现还是<strong>一敲mysql就可以登陆进去了！！！</strong><img src="https://img-blog.csdnimg.cn/20190918221520326.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;不过又尝试了下 用127.0.0.1登陆，发现竟然需要密码验证了，且用之前设置的密码才可以登录。我好像发现了什么~<br>&emsp;&emsp;删除用户‘root’@’localhost’，不让删，需要至少一个有CREATE USER权限用户，看来之前的‘root’@’127.0.0.1’用户没有权限。<br><img src="https://img-blog.csdnimg.cn/20190919154941254.png" alt="在这里插入图片描述"><br>&emsp;&emsp;那就先给‘root’@’127.0.0.1’用户授权</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'root'</span>@<span class="string">'127.0.0.1</span></span><br><span class="line"><span class="string">'</span>;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;再删除用户‘root’@’localhost’，成功了，再重新创建‘root’@’localhost’用户并指定密码，再授权。OK，退出重新登陆一下。<br><img src="https://img-blog.csdnimg.cn/20190919155616216.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;果然数据库加密成功了<del>！问题解决！<br>**——————————————-（以上封存，警醒自己的无知</del>）——————————————–**<br>&emsp;&emsp;<br>&emsp;&emsp;<br>&emsp;&emsp;<br>&emsp;&emsp;<strong>后记</strong>：<br>&emsp;&emsp;原来是mariadb10.4.8版本默认是可以本地使用使用unix_socket登陆无需密码，才导致密码无效，在上面的图片里显示得清清楚楚。<br><strong>MariaDB [mysql]> show grants for ‘root’@’localhost’;</strong></p>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+---------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| <span class="variable">&emsp</span>;Grants for root@localhost<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>; |</span><br><span class="line">+---------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| GRANT ALL PRIVILEGES <span class="meta">ON</span> <span class="comment">*.* TO 'root'@'localhost' IDENTIFIED VIA mysql_native_password USING 'invalid' **OR unix_socket** WITH GRANT OPTION &emsp;</span><span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;|</span><br><span class="line">| GRANT PROXY <span class="meta">ON</span> <span class="string">''</span>@<span class="string">'%'</span> TO <span class="string">'root'</span>@<span class="string">'localhost'</span> WITH GRANT OPTION                                                                           <span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;<span class="variable">&emsp</span>;|</span><br><span class="line">+---------------------------------------------------------------------------------------------------------------+</span><br><span class="line">2 rows <span class="meta">in</span> <span class="meta">set</span> (0.000 sec)</span><br><span class="line"><span class="comment">**MariaDB [mysql]> show grants for 'root'@'127.0.0.1';</span><span class="comment">**</span></span><br><span class="line"><span class="comment">ERROR 1141 (42000): There is no such grant defined for user 'root' on host '127.0.0.1'</span></span><br><span class="line"><span class="comment">**MariaDB [mysql]> show grants for 'root'@'::1';</span><span class="comment">**</span></span><br><span class="line"><span class="comment">ERROR 1141 (42000): There is no such grant defined for user 'root' on host '::1'</span></span><br></pre></td></tr></table></figure>

<p>MariaDB [mysql]><br><img src="https://img-blog.csdnimg.cn/20190918202258915.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;当然，也存在用户不存在，而user表中有条目的情况。所以想最终解决这个问题，实际上最直接的命令是：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'root'</span>@<span class="string">'localhost'</span> <span class="keyword">IDENTIFIED</span> VIA mysql_native_password <span class="keyword">USING</span> <span class="string">'*54D9A58CB44735F80AC5AD29961814D6D12B8746'</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> <span class="keyword">OPTION</span>;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;重新对root@localhost用户授权取消unix_sock登陆，并设置密码。<br>&emsp;&emsp;至此，问题才真正解决。<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;后记写于 2019.9.23。</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://hewanyue.com/2019/09/15/二进制安装及源码编译安装mariadb数据库/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Hechao">
      <meta itemprop="description" content="BOHC is just a blog of hechao.">
      <meta itemprop="image" content="/images/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BOHC!">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
            
            <a href="/2019/09/15/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E5%8F%8A%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85mariadb%E6%95%B0%E6%8D%AE%E5%BA%93/" class="post-title-link" itemprop="url">二进制安装及源码编译安装mariadb数据库</a>
          
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-09-15 10:29:05" itemprop="dateCreated datePublished" datetime="2019-09-15T10:29:05+08:00">2019-09-15</time>
            </span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/数据库/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a></span>

                
                
              
            </span>
          

          
            <span id="/2019/09/15/二进制安装及源码编译安装mariadb数据库/" class="post-meta-item leancloud_visitors" data-flag-title="二进制安装及源码编译安装mariadb数据库" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
              <span>℃</span>
            </span>
          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
        
      
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/09/15/二进制安装及源码编译安装mariadb数据库/#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2019/09/15/二进制安装及源码编译安装mariadb数据库/" itemprop="commentCount"></span></a>
  </span>
  
  
          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span>5.2k</span>
            </span>
          
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span>5 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>&emsp;&emsp;MariaDB数据库管理系统是MySQL的一个分支，主要由开源社区在维护，采用GPL授权许可 MariaDB的目的是完全兼容MySQL，包括API和命令行，使之能轻松成为MySQL的代替品。在存储引擎方面，使用XtraDB（英语：XtraDB）来代替MySQL的InnoDB。 MariaDB由MySQL的创始人Michael Widenius（英语：Michael Widenius）主导开发，他早前曾以10亿美元的价格，将自己创建的公司MySQL AB卖给了SUN，此后，随着SUN被甲骨文收购，MySQL的所有权也落入Oracle的手中。MariaDB名称来自Michael Widenius的女儿Maria的名字。<br>&emsp;&emsp;MariaDB基于事务的Maria存储引擎，替换了MySQL的MyISAM存储引擎，它使用了Percona的 XtraDB，InnoDB的变体，分支的开发者希望提供访问即将到来的MySQL 5.4 InnoDB性能。这个版本还包括了 PrimeBase XT (PBXT) 和 FederatedX存储引擎。<br>&emsp;&emsp;开发这个分支的原因之一是：甲骨文公司收购了MySQL后，有将MySQL闭源的潜在风险，因此社区采用分支的方式来避开这个风险。 过去一年中，大型互联网用户以及Linux发行商纷纷抛弃MySQL，转投MariaDB阵营。MariaDB是目前最受关注的MySQL数据库衍生版，也被视为开源数据库MySQL的替代品。<br>&emsp;&emsp;MariaDB虽然被视为MySQL数据库的替代品，但它在扩展功能、存储引擎以及一些新的功能改进方面都强过MySQL。而且从MySQL迁移到MariaDB也是非常简单的：<br>&emsp;&emsp;1、数据和表定义文件（.frm）是二进制兼容的<br>&emsp;&emsp;2、所有客户端API、协议和结构都是完全一致的<br>&emsp;&emsp;3、所有文件名、二进制、路径、端口等都是一致的<br>&emsp;&emsp;4、所有的MySQL连接器，比如PHP、Perl、Python、Java、.NET、MyODBC、Ruby以及MySQL C connector等在MariaDB中都保持不变<br>&emsp;&emsp;5、mysql-client包在MariaDB服务器中也能够正常运行<br>&emsp;&emsp;6、共享的客户端库与MySQL也是二进制兼容的<br>也就是说，在大多数情况下，你完全可以卸载MySQL然后安装MariaDB，然后就可以像之前一样正常的运行。(以上摘自百度百科)<br>&emsp;&emsp;作为目前比较热门的开源数据库软件，一般常见有三种安装方式：yum或rpm包安装、二进制安装以及源码包安装，包安装过于简单，也很难符合一般企业定制需要，故不做叙述，本文详细讲述后两种安装方式。</p>
<h4 id="二进制安装"><a href="#二进制安装" class="headerlink" title="二进制安装"></a>二进制安装</h4><p>1.先<strong>创建mysql用户及mysql组</strong>，并制定家目录为/data/mysql</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">groupadd -r -g <span class="number">306</span> mysql   #指定属组gid为<span class="number">306</span></span><br><span class="line">useradd -r -g <span class="number">306</span> -u <span class="number">306</span> -d /data/mysql mysql    #指定属主uid为<span class="number">306</span>，家目录为/data/mysql</span><br></pre></td></tr></table></figure>

<p>2.<strong>准备数据目录(mysq用户家目录)</strong>,并修正权限</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="regexp">/data/</span>mysql;chown <span class="string">mysql:</span>mysql <span class="regexp">/data/</span>mysql</span><br></pre></td></tr></table></figure>

<p>3.去官网下载mariadb 二进制tar包（链接是CentOS7X86_64的10.4.8稳定版）<br>&emsp;&emsp;<a href="http://ftp.igh.cnrs.fr/pub/mariadb//mariadb-10.4.8/bintar-linux-systemd-x86_64/mariadb-10.4.8-linux-systemd-x86_64.tar.gz" target="_blank" rel="noopener">http://ftp.igh.cnrs.fr/pub/mariadb//mariadb-10.4.8/bintar-linux-systemd-x86_64/mariadb-10.4.8-linux-systemd-x86_64.tar.gz</a><br>4.<strong>解压tar包</strong>指/usr/local目录下,递归改属主为root、属组为mysql，并在/usr/local目录下创建一个名为mysql的软链接指向解压好的mariadb目录</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar xzf mariadb<span class="number">-10.4</span><span class="number">.8</span>-linux-systemd-x86_64.tar.gz -c <span class="regexp">/usr/</span>local</span><br><span class="line">cd <span class="regexp">/usr/</span>local</span><br><span class="line">ln -sv mariadb<span class="number">-10.4</span><span class="number">.8</span>-linux-systemd-x86_64 mysql</span><br><span class="line">`chown -R <span class="string">root:</span>mysql <span class="regexp">/usr/</span>local<span class="regexp">/mysql/</span></span><br></pre></td></tr></table></figure>

<p>5.<strong>创建配置文件</strong>,并修改</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="string">/etc/mysql/</span></span><br><span class="line">cp <span class="string">/etc/my.cnf</span> <span class="string">/etc/mysql/my.cnf</span></span><br><span class="line">sed -ri '<span class="string">/datadir=</span>\<span class="string">//s</span>@<span class="params">(.*=)</span>.*@\1\<span class="string">/data</span>\<span class="string">/mysql</span>@' <span class="string">/etc/mysql/my.cnf</span>    <span class="comment">#修改配置文件，指定数据库储存路径</span></span><br><span class="line">sed -ri '<span class="string">/datadir/a</span>\innodb_file_per-table=on\nskip_name_resolve=on' <span class="string">/etc/mysql/my.cnf</span>     <span class="comment">#设置每个表独立文件 和 禁用主机名解析</span></span><br></pre></td></tr></table></figure>

<p>6.<strong>创建数据库文件</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/scripts/mysql_install_db <span class="attribute">--datadir</span>=/data/mysql <span class="attribute">--user</span>=mysql</span><br></pre></td></tr></table></figure>

<p>7.<strong>创建服务脚本并启动服务</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/support-files/mysql.server /etc/rc.d/init.d/mysqld</span><br><span class="line">chkconfig --<span class="builtin-name">add</span> mysqld</span><br><span class="line">service mysqld start</span><br></pre></td></tr></table></figure>

<p>8.<strong>增加PATH环境变量</strong>路径,并生效。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">'PATH=/usr/local/mysql/bin:$PATH'</span> >/etc/<span class="keyword">profile</span>.d/mysql.<span class="keyword">sh</span></span><br><span class="line">. /etc/<span class="keyword">profile</span>.d/mysql.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure>

<p>9.<strong>运行安全初始化脚本</strong>，设置root口令、禁用匿名登陆、禁用远程主机登陆、删除test数据库，并立即生效(根据提示操作)。</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /var/<span class="class"><span class="keyword">lib</span>/<span class="title">mysql</span>/<span class="title">mysql</span>.<span class="title">sock</span> /<span class="title">tmp</span></span></span><br><span class="line">/usr/local/mysql/bin/mysql_secure_installation</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;至此，二进制安装mariadb数据库就完成了~</p>
<h4 id="源码编译安装"><a href="#源码编译安装" class="headerlink" title="源码编译安装"></a>源码编译安装</h4><p>1.先<strong>创建mysql用户及mysql组</strong>，并制定家目录为/data/mysql</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">groupadd -r -g <span class="number">306</span> mysql   #指定属组gid为<span class="number">306</span></span><br><span class="line">useradd -r -g <span class="number">306</span> -u <span class="number">306</span> -d /data/mysql mysql    #指定属主uid为<span class="number">306</span>，家目录为/data/mysql</span><br></pre></td></tr></table></figure>

<p>2.<strong>准备数据目录(mysq用户家目录)</strong>,并修正权限</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="regexp">/data/</span>mysql;chown <span class="string">mysql:</span>mysql <span class="regexp">/data/</span>mysql</span><br></pre></td></tr></table></figure>

<p>3.去官网<strong>下载mariadb 源码tar包</strong>（链接是CentOS7X86_64的10.4.8稳定版）<br>&emsp;&emsp;<a href="http://ftp.igh.cnrs.fr/pub/mariadb//mariadb-10.4.8/source/mariadb-10.4.8.tar.gz" target="_blank" rel="noopener">http://ftp.igh.cnrs.fr/pub/mariadb//mariadb-10.4.8/source/mariadb-10.4.8.tar.gz</a><br>4.<strong>解压源码包</strong>，并进入源码包目录</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar xvf mariadb<span class="number">-10.4</span><span class="number">.8</span>.tar.gz</span><br><span class="line">cd mariadb<span class="number">-10.4</span><span class="number">.8</span>/l</span><br></pre></td></tr></table></figure>

<p>5.<strong>CMAKE编译</strong>源码包<br>&emsp;&emsp;需要的依赖包有cmake openssldevel ncurses-devel bison bison-devel zlib-devel libcurl-devel libarchive-devel boostdevel gcc gcc-c++   gnutls-devel libxml2-devel  libevent-devel libaio-devel ，一口气yum装上。</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install </span>cmake openssldevel ncurses-devel <span class="keyword">bison </span><span class="keyword">bison-devel </span>zlib-devel libcurl-devel libarchive-devel <span class="keyword">boostdevel </span>gcc gcc-c++   gnutls-devel libxml2-devel  libevent-devel libaio-devel</span><br></pre></td></tr></table></figure>

<p>然后编译</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cmake . \</span><br><span class="line"><span class="attribute">-DCMAKE_INSTALL_PREFIX</span>=/data/apps/mysql \</span><br><span class="line"><span class="attribute">-DMYSQL_DATADIR</span>=/data/mysql/ \</span><br><span class="line"><span class="attribute">-DSYSCONFDIR</span>=/etc/ \</span><br><span class="line"><span class="attribute">-DMYSQL_USER</span>=mysql \</span><br><span class="line"><span class="attribute">-DWITH_INNOBASE_STORAGE_ENGINE</span>=1 \</span><br><span class="line"><span class="attribute">-DWITH_ARCHIVE_STORAGE_ENGINE</span>=1 \</span><br><span class="line"><span class="attribute">-DWITH_BLACKHOLE_STORAGE_ENGINE</span>=1 \</span><br><span class="line"><span class="attribute">-DWITH_PARTITION_STORAGE_ENGINE</span>=1 \</span><br><span class="line"><span class="attribute">-DWITHOUT_MROONGA_STORAGE_ENGINE</span>=1 \</span><br><span class="line"><span class="attribute">-DWITH_DEBUG</span>=0 \</span><br><span class="line"><span class="attribute">-DWITH_READLINE</span>=1 \</span><br><span class="line"><span class="attribute">-DWITH_SSL</span>=system \</span><br><span class="line"><span class="attribute">-DWITH_ZLIB</span>=system \</span><br><span class="line"><span class="attribute">-DWITH_LIBWRAP</span>=0 \</span><br><span class="line"><span class="attribute">-DENABLED_LOCAL_INFILE</span>=1 \</span><br><span class="line"><span class="attribute">-DMYSQL_UNIX_ADDR</span>=/data/mysql/mysql.sock \</span><br><span class="line"><span class="attribute">-DDEFAULT_CHARSET</span>=utf8 \</span><br><span class="line"><span class="attribute">-DDEFAULT_COLLATION</span>=utf8_general_ci</span><br></pre></td></tr></table></figure>

<p>6.<strong>安装</strong></p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">make</span> -j <span class="number">4</span> && <span class="built_in">make</span> install</span><br></pre></td></tr></table></figure>

<p>7.<strong>创建配置文件</strong>,并修改</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="string">/etc/mysql/</span></span><br><span class="line">cp <span class="string">/etc/my.cnf</span> <span class="string">/etc/mysql/my.cnf</span></span><br><span class="line">sed -ri '<span class="string">/datadir=</span>\<span class="string">//s</span>@<span class="params">(.*=)</span>.*@\1\<span class="string">/data</span>\<span class="string">/mysql</span>@' <span class="string">/etc/mysql/my.cnf</span>    <span class="comment">#修改配置文件，指定数据库储存路径</span></span><br><span class="line">sed -ri '<span class="string">/datadir/a</span>\innodb_file_per-table=on\nskip_name_resolve=on' <span class="string">/etc/mysql/my.cnf</span>     <span class="comment">#设置每个表独立文件 和 禁用主机名解析</span></span><br></pre></td></tr></table></figure>

<p>8.<strong>创建数据库文件</strong></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chown -R <span class="string">root:</span>mysql <span class="regexp">/data/</span>apps<span class="regexp">/mysql/</span></span><br><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/scripts/</span>mysql_install_db --datadir=<span class="regexp">/data/</span>mysql --user=mysql</span><br></pre></td></tr></table></figure>

<p>9.<strong>创建服务脚本并启动服务</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp /data/apps/mysql/support-files/mysql.server /etc/rc.d/init.d/mysqld</span><br><span class="line">chkconfig --<span class="builtin-name">add</span> mysqld</span><br><span class="line">service mysqld start</span><br></pre></td></tr></table></figure>

<p>10.<strong>增加PATH环境变量</strong>路径,并生效。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">'PATH=/data/apps/mysql/bin:$PATH'</span> >/etc/<span class="keyword">profile</span>.d/mysql.<span class="keyword">sh</span></span><br><span class="line">. /etc/<span class="keyword">profile</span>.d/mysql.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure>

<p>11.<strong>运行安全初始化脚本</strong>，设置root口令、禁用匿名登陆、禁用远程主机登陆、删除test数据库，并立即生效(根据提示操作)。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/data/</span>apps<span class="regexp">/mysql/</span>bin<span class="regexp">/mysql_secure_installation</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/20190915210957797.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;报错：<strong>Can’t connect to local MySQL server through socket ‘/data/mysql/mysql.sock’ (2)</strong><br>&emsp;&emsp;用ll看了下/data/mysql/mysql.sock确实不存在，而我记得我配置文件/etc/mysql/my.cnf中定义的sosck是在   下<br><img src="https://img-blog.csdnimg.cn/20190915211426790.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;那就把/var/lib/mysql/mysql.sock文件创建一个软链接至/data/mysql/目录</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ln -s /var/<span class="class"><span class="keyword">lib</span>/<span class="title">mysql</span>/<span class="title">mysql</span>.<span class="title">sock</span> /<span class="title">data</span>/<span class="title">mysql</span>/</span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;再次尝试安全初始化脚本。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/data/</span>apps<span class="regexp">/mysql/</span>bin<span class="regexp">/mysql_secure_installation</span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;果然成功了。<br>&emsp;&emsp;至此，源码编译安装mariadb数据库就完成了~</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
      src="/images/touxiang.jpg"
      alt="Hechao">
  <p class="site-author-name" itemprop="name">Hechao</p>
  <div class="site-description" itemprop="description">BOHC is just a blog of hechao.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">16</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          <a href="/categories/">
        
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span>
        
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>
</div>
  <div class="chat motion-element">
    <a onclick="Chatra('openChat', true)">
  <i class="fa fa-comment"></i>
    Chat
  </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
      
      
      
        
      
        <a href="https://github.com/wudihechao" title="GitHub &rarr; https://github.com/wudihechao" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i></a>
      </span>
    
      <span class="links-of-author-item">
      
      
      
        
      
        <a href="mailto:wudihechao@163.com" title="E-Mail &rarr; mailto:wudihechao@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i></a>
      </span>
    
      <span class="links-of-author-item">
      
      
      
        
      
        <a href="https://weibo.com/1050367191" title="Weibo &rarr; https://weibo.com/1050367191" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i></a>
      </span>
    
  </div>
  <div class="cc-license motion-element" itemprop="license">
    
  
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>
<div id="show_date_time"></div>

<div id="show_date_time"></div>
  <script>
    function show_date_time(){
      window.setTimeout("show_date_time()"， 1000);
      BirthDay=new Date("10/1/2019 0:0:0");
      today=new Date();
      timeold=(today.getTime()-BirthDay.getTime());
      sectimeold=timeold/1000
      secondsold=Math.floor(sectimeold);
      msPerDay=24*60*60*1000
      e_daysold=timeold/msPerDay
      daysold=Math.floor(e_daysold);
      e_hrsold=(e_daysold-daysold)*24;
      hrsold=setzero(Math.floor(e_hrsold));
      e_minsold=(e_hrsold-hrsold)*60;
      minsold=setzero(Math.floor((e_hrsold-hrsold)*60));
      seconds=setzero(Math.floor((e_minsold-minsold)*60));
      document.getElementById('days').innerHTML="已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";
    }
    function setzero(i){
      if (i<10)
      {i="0" + i};
      return i;
    }
    show_date_time();
  </script>


      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
      

      
      
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user-circle-o"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hechao</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">104k</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
  
    <span class="post-meta-divider">|</span>
  
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
  
</div>












        
      </div>
    </footer>
  </div>

  
    
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script size="300" alpha="0.3" zIndex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.0"></script><script src="/js/motion.js?v=7.4.0"></script>
<script src="/js/schemes/muse.js?v=7.4.0"></script>
<script src="/js/next-boot.js?v=7.4.0"></script><script src="/js/bookmark.js?v=7.4.0"></script>



  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>








  <script src="/js/local-search.js?v=7.4.0"></script>



  <script>
    (function(d, w, c) {
      w.ChatraID = 'EKKArjPKncvLRsxfR';
      var s = d.createElement('script');
      w[c] = w[c] || function() {
        (w[c].q = w[c].q || []).push(arguments);
      };
      s.async = true;
      s.src = 'https://call.chatra.io/chatra.js';
      if (d.head) d.head.appendChild(s);
    })(document, window, 'Chatra');
  </script>











  

  

  


<script>
NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail';
  guest = guest.split(',').filter(item => {
    return GUEST.includes(item);
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 'AVtPtVan0Ky5u33XhUzJlFKp-gzGzoHsz',
    appKey: 'nx3XTnRJmaMQR3aLWYiigkgJ',
    placeholder: 'Just Say Something~!',
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: true,
    lang: 'zh-cn' || 'zh-cn',
    path: location.pathname
  });
}, window.Valine);
</script>

<link rel="stylesheet" href="/dist/APlayer.min.css">
<div id="aplayer"></div>
<script type="text/javascript" src="/dist/APlayer.min.js"></script>
<script type="text/javascript" src="/dist/music.js"></script>
</body>
</html>
  <!-- 页面点击小红心 -->
  <script type="text/javascript" src="/js/src/love.js"></script>
  <script type="text/javascript" src="/js/src/dytitle.js"></script>
  <script type="text/javascript" src="/js/src/crash_cheat.js"></script>
