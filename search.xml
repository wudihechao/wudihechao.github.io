<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>KVM虚拟化</title>
      <link href="//blog/f989902e.html"/>
      <url>//blog/f989902e.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;KVM 是Kernel-based Virtual Machine的简称，是一个开源的系统虚拟化模块，自Linux 2.6.20之后集成在Linux的各个主要发行版本中，KVM目前已成为学术界的主流 VMM (virtual machine monitor，虚拟机监视器，也称为hypervisor)之一。 </p><a id="more"></a><p>&emsp;&emsp;可参考红帽官方对kvm的定义：<a href="https://www.redhat.com/zh/topics/virtualization/what-is-KVM" rel="noopener" target="_blank">https://www.redhat.com/zh/topics/virtualization/what-is-KVM</a><br>&emsp;&emsp;KVM的虚拟化需要硬件支持（如Intel VT技术或者AMD V技术)，是基于硬件的完全虚拟化，而Xen早期则是基于软件模拟的半虚拟化，新版本则是支持基于硬件支持的完全虚拟化，但Xen本身有自己的进程调度器，存储管理模块等，所以代码较为庞大，广为流传的商业系统虚拟化软件VMware ESXI系列是Full-Virtualization，（IBM文档：<a href="http://www.ibm.com/developerworks/cn/linux/l-using-kvm/" rel="noopener" target="_blank">http://www.ibm.com/developerworks/cn/linux/l-using-kvm/</a> ）<br>&emsp;&emsp;简单地说，KVM就是基于硬件支持实现，将单台主机，分隔成多个互不干扰的虚拟主机的技术，不受困于底层操作系统，可以为每个主机提供单独的、所需的的运行环境，如下图所示：<br><img src="https://img-blog.csdnimg.cn/20191129111043897.png" alt="KVM示意图"><br>&emsp;&emsp;如果每个节点都是用共享存储如NAS，则可实现跨主机的虚拟机快速迁移，这也是我们在生产环境中经常采用的架构。本文将以下面架构，来具体展示KVM在实际生产中的应用。<br><img src="https://img-blog.csdnimg.cn/20191129142617354.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="KVMweb负载均衡">&emsp;&emsp;三个主机，其中两个主机node1和node2上运行KVM，另一台是NAS共享存储服务器，通过10.0.0.0/16网段内网连接。在node1上的用KVM构建虚拟机H1和W1分别运行haproxy+keepalived服务和nginx服务，其中H1桥接方式到node1的两块网卡上，W1桥接到内网网卡eth1上。node2节点中也是如此。于是，将Client端请求通过haproxy反向代理只内网的web服务集群中，保证负载均衡和高可用，哪怕一个物理节点服务器down掉也不影响客户服务访问。<br>&emsp;&emsp;NAS服务器的搭建很容易，这里就先不详细介绍了，本文之后主要介绍KVM服务的配置及虚拟机集群的搭建。</p><h2 id="宿主机环境准备："><a href="#宿主机环境准备：" class="headerlink" title="宿主机环境准备："></a>宿主机环境准备：</h2><p>&emsp;&emsp;KVM需要宿主机CPU必须支持虚拟化功能，因此如果是在vmware workstation上使用虚拟机做宿主机，那么必须要在虚拟机配置界面的处理器选项中开启虚拟机化功能（VMware支持嵌套虚拟化，而KVM不支持，大部分云服务器如阿里云就是基于KVM技术二次研发制作的，所以云服务器都不支持从中再建虚拟机）。<br>&emsp;&emsp;KVM模块因为已经被集成到linux内核之中，所以我们只需要安装KVM管理工具就可以直接使用KVM创建虚拟机了。<br>&emsp;&emsp;可用命令验证是否开启虚拟化（也可通过lscpu命令,grep -o选项只看匹配词本身，也可以用egrep代替grep -E）</p><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# grep -Eo <span class="string">"vmx|svm"</span> /<span class="keyword">proc</span>/cpuinfo |<span class="title"> wc</span> -l</span><br><span class="line">vmx</span><br><span class="line">vmx</span><br></pre></td></tr></table></figure><h3 id="KVM软件包安装"><a href="#KVM软件包安装" class="headerlink" title="KVM软件包安装"></a>KVM软件包安装</h3><p>&emsp;&emsp;在Ubuntu 18.04中：<br>&emsp;&emsp;可参考官网<a href="https://ubuntu.com/server/docs/virtualization-libvirt" rel="noopener" target="_blank">https://ubuntu.com/server/docs/virtualization-libvirt</a></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">apt <span class="keyword">install</span> qemu-kvm virt-manager libvirt-daemon-<span class="keyword">system</span></span><br><span class="line">kvm-ok <span class="comment">#验证是否支持kvm</span></span><br></pre></td></tr></table></figure><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">INFO:</span> <span class="meta-keyword">/dev/</span>kvm exists</span><br><span class="line">KVM acceleration can be used</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;CentOS 7.X：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> qemu-kvm qemu-kvm-tools libvirt libvirt-<span class="keyword">client</span> virt-manager virt-<span class="keyword">install</span></span><br></pre></td></tr></table></figure><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="keyword">start</span> libvirtd</span><br><span class="line">systemctl <span class="keyword">enable</span> libvirtd</span><br></pre></td></tr></table></figure><h3 id="网络环境配置"><a href="#网络环境配置" class="headerlink" title="网络环境配置"></a>网络环境配置</h3><p>&emsp;&emsp;为了让三个节点间虚拟机可以直接相互之间通信，需要将KVM上的虚拟机以桥接模式与宿主机的网卡连接，这就需要我们提前在宿主机上配置好网桥。<br>&emsp;&emsp;<strong>若宿主机为Ubuntu18.04：</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/netplan/<span class="number">01</span>-netcfg.yaml</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This file describes the network interfaces available on your system</span></span><br><span class="line"><span class="comment"># For more information, see netplan(5).</span></span><br><span class="line"><span class="attr">network:</span></span><br><span class="line"><span class="attr">  version:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  renderer:</span> <span class="string">networkd</span></span><br><span class="line"><span class="attr">  ethernets:</span></span><br><span class="line"><span class="attr">    eth0:</span></span><br><span class="line"><span class="attr">      dhcp4:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      dhcp6:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">    eth1:</span></span><br><span class="line"><span class="attr">      dhcp4:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      dhcp6:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">  bridges:</span></span><br><span class="line"><span class="attr">    br0:</span></span><br><span class="line"><span class="attr">      dhcp4:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      dhcp6:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      addresses:</span> <span class="string">[172.18.0.75/16]</span></span><br><span class="line"><span class="attr">      gateway4:</span> <span class="number">172.18</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="attr">      nameservers:</span></span><br><span class="line"><span class="attr">        addresses:</span> <span class="string">[180.76.76.76]</span></span><br><span class="line"><span class="attr">      interfaces:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">eth0</span></span><br><span class="line"><span class="attr">    br1:</span></span><br><span class="line"><span class="attr">      dhcp4:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      dhcp6:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      addresses:</span> <span class="string">[10.0.0.75/16]</span></span><br><span class="line"><span class="attr">      interfaces:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">eth1</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;修改网卡配置后，使用<code>netplan apply</code>命令使配置文件的修改生效</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netplan <span class="built_in">apply</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;<strong>若宿主机为CentOS：</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="regexp">/etc/</span>sysconfig<span class="regexp">/network-scripts/</span></span><br></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">vim</span> ifcfg-eh0</span><br></pre></td></tr></table></figure><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">TYPE</span>=Ethernet</span><br><span class="line"><span class="attr">BOOTPROTO</span>=static</span><br><span class="line"><span class="attr">NAME</span>=eth0</span><br><span class="line"><span class="attr">DEVICE</span>=eth0</span><br><span class="line"><span class="attr">ONBOOT</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">BRIDGE</span>=br0</span><br></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">vim</span> ifcfg-eh1</span><br></pre></td></tr></table></figure><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">TYPE</span>=Ethernet</span><br><span class="line"><span class="attr">BOOTPROTO</span>=static</span><br><span class="line"><span class="attr">NAME</span>=eth1</span><br><span class="line"><span class="attr">DEVICE</span>=eth1</span><br><span class="line"><span class="attr">ONBOOT</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">BRIDGE</span>=br1</span><br></pre></td></tr></table></figure><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ifcfg-<span class="keyword">br</span><span class="number">0</span></span><br></pre></td></tr></table></figure><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">TYPE</span>=Bridge</span><br><span class="line"><span class="attr">BOOTPROTO</span>=static</span><br><span class="line"><span class="attr">NAME</span>=br0</span><br><span class="line"><span class="attr">DEVICE</span>=br0</span><br><span class="line"><span class="attr">ONBOOT</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">IPADDR</span>=<span class="number">172.18</span>.<span class="number">32.75</span></span><br><span class="line"><span class="attr">NETMASK</span>=<span class="number">255.255</span>.<span class="number">0.0</span></span><br><span class="line"><span class="attr">GATEWAY</span>=<span class="number">172.18</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">DNS1</span>=<span class="number">180.76</span>.<span class="number">76.76</span></span><br></pre></td></tr></table></figure><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ifcfg-<span class="keyword">br</span><span class="number">1</span></span><br></pre></td></tr></table></figure><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">TYPE</span>=Bridge</span><br><span class="line"><span class="attr">BOOTPROTO</span>=static</span><br><span class="line"><span class="attr">NAME</span>=br1</span><br><span class="line"><span class="attr">DEVICE</span>=br1</span><br><span class="line"><span class="attr">ONBOOT</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">IPADDR</span>=<span class="number">10.0</span>.<span class="number">0.75</span></span><br><span class="line"><span class="attr">NETMASK</span>=<span class="number">255.255</span>.<span class="number">0.0</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;重启网络服务，生效配置</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">systemctl restart network</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;<code>ip a</code>命令或<code>ifconfig</code>查看桥接网卡是否生效</p><h2 id="KVM虚拟机创建"><a href="#KVM虚拟机创建" class="headerlink" title="KVM虚拟机创建"></a>KVM虚拟机创建</h2><h3 id="创建虚拟磁盘"><a href="#创建虚拟磁盘" class="headerlink" title="创建虚拟磁盘"></a>创建虚拟磁盘</h3><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@localhost</span> ~]<span class="meta"># ll /var/lib/libvirt/images/ #默认保存虚拟机磁盘的路径</span></span><br><span class="line">total <span class="number">0</span></span><br><span class="line">[root<span class="symbol">@localhost</span> ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;使用<code>qemu-img create</code>命令可以创建磁盘,如果创建raw格式磁盘文件，则理解占据实际大小，若创建qcow2稀疏格式磁盘，则磁盘文件会随着使用的增大而增大</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img create -f raw /var/<span class="class"><span class="keyword">lib</span>/<span class="title">libvirt</span>/<span class="title">images</span>/<span class="title">CentOS7</span>.<span class="title">raw</span> 10<span class="title">G</span>建磁盘</span></span><br></pre></td></tr></table></figure><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ll -h /var/<span class="class"><span class="keyword">lib</span>/<span class="title">libvirt</span>/<span class="title">images</span>/<span class="title">CentOS7</span>.<span class="title">raw</span></span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">10</span>G Nov <span class="number">29</span> <span class="number">16</span>:<span class="number">34</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">libvirt</span>/<span class="title">images</span>/<span class="title">centos</span>.<span class="title">raw</span></span></span><br></pre></td></tr></table></figure><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img create -f qcow2 /var/<span class="class"><span class="keyword">lib</span>/<span class="title">libvirt</span>/<span class="title">images</span>/<span class="title">CentOS7</span>.<span class="title">qcow2</span> 10<span class="title">G</span></span></span><br></pre></td></tr></table></figure><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ll -h /var/<span class="class"><span class="keyword">lib</span>/<span class="title">libvirt</span>/<span class="title">images</span>/<span class="title">CentOS7</span>.<span class="title">qcow2</span></span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">193</span>K Nov <span class="number">29</span> <span class="number">16</span>:<span class="number">36</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">libvirt</span>/<span class="title">images</span>/<span class="title">centos</span>.<span class="title">qcow2</span></span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;我们选用qcow2格式的磁盘，先创建H1虚拟机，</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img create -f qcow2 /var/<span class="class"><span class="keyword">lib</span>/<span class="title">libvirt</span>/<span class="title">images</span>/<span class="title">H1</span>.<span class="title">qcow2</span> 10<span class="title">G</span></span></span><br></pre></td></tr></table></figure><h3 id="创建虚拟机"><a href="#创建虚拟机" class="headerlink" title="创建虚拟机"></a>创建虚拟机</h3><p>&emsp;&emsp;先导入ISO光盘镜像文件,可以使用共享存储上的ISO文件，也可本机导入，本机上传的话一般习惯性放到<code>/usr/local/src/</code>目录下<br>&emsp;&emsp;使用<code>virt-install</code>命令创建虚拟机，参数可<code>virt-install --help</code>查看帮助信息</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virt-<span class="keyword">install</span> <span class="comment">--help</span></span><br></pre></td></tr></table></figure><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line">usage: virt-install <span class="params">--name</span> NAME <span class="params">--ram</span> RAM STORAGE INSTALL [options]</span><br><span class="line">使用指定安装介质新建虚拟机。</span><br><span class="line">optional arguments:</span><br><span class="line">-h, <span class="params">--help</span> show this <span class="keyword">help</span> message and exit</span><br><span class="line"><span class="params">--version</span> show program's <span class="keyword">version</span> number and exit</span><br><span class="line"><span class="params">--connect</span> URI 使用 libvirt URI 连接到 hypervisor</span><br><span class="line">通用选项:</span><br><span class="line">-n NAME, <span class="params">--name</span> NAME 客户端事件名称</span><br><span class="line"><span class="params">--memory</span> MEMORY 配置虚拟机内存分配。例如：</span><br><span class="line"><span class="params">--memory</span> 1024 <span class="params">(in MiB)</span></span><br><span class="line"><span class="params">--memory</span> 512,maxmemory=1024</span><br><span class="line"><span class="params">--vcpus</span> VCPUS 为虚拟机配置的 vcpus 数。例如：</span><br><span class="line"><span class="params">--vcpus</span> 5</span><br><span class="line"><span class="params">--vcpus</span> 5,maxcpus=10,cpuset=1-4,6,8</span><br><span class="line"><span class="params">--vcpus</span> sockets=2,cores=4,threads=2,</span><br><span class="line"><span class="params">--cpu</span> CPU CPU 型号及功能。例如：</span><br><span class="line"><span class="params">--cpu</span> coreduo,+x2apic</span><br><span class="line"><span class="params">--cpu</span> host</span><br><span class="line"><span class="params">--metadata</span> METADATA 配置虚拟机元数据。例如：</span><br><span class="line"><span class="params">--metadata</span> name=foo,title=<span class="string">"My pretty title"</span>,uuid=<span class="string">...</span></span><br><span class="line"><span class="params">--metadata</span> description=<span class="string">"My nice long description"</span></span><br><span class="line">安装方法选项:</span><br><span class="line"><span class="params">--cdrom</span> CDROM 光驱安装介质</span><br><span class="line">-l LOCATION, <span class="params">--location</span> LOCATION</span><br><span class="line">安装源<span class="params">(例如：nfs:host:/path、http://host/path</span></span><br><span class="line"><span class="params">ftp://host/path)</span></span><br><span class="line"><span class="params">--pxe</span> 使用 PXE 协议从网络引导</span><br><span class="line"><span class="params">--import</span> 在磁盘映像中构建虚拟机</span><br><span class="line"><span class="params">--livecd</span> 将光驱介质视为 Live CD</span><br><span class="line">-x EXTRA_ARGS, <span class="params">--extra-args</span> EXTRA_ARGS</span><br><span class="line">附加到使用 <span class="params">--location</span> 引导的内核的参数</span><br><span class="line"><span class="params">--initrd-inject</span> INITRD_INJECT</span><br><span class="line">使用 <span class="params">--location</span> 为 initrd 的 root</span><br><span class="line">添加给定文件</span><br><span class="line"><span class="params">--os-variant</span> DISTRO_VARIANT</span><br><span class="line">在其中安装 OS 变体的虚拟机，比如</span><br><span class="line">'fedora18'、'rhel6'、'winxp' 等等。</span><br><span class="line"><span class="params">--boot</span> BOOT 配置虚拟机引导设置。例如：</span><br><span class="line"><span class="params">--boot</span> hd,cdrom,menu=on</span><br><span class="line"><span class="params">--boot</span> init=<span class="string">/sbin/init</span> <span class="params">(for containers)</span></span><br><span class="line"><span class="params">--idmap</span> IDMAP 为 LXC 容器启用用户名称空间。例如：</span><br><span class="line"><span class="params">--idmap</span> uid_start=0,uid_target=1000,uid_count=10</span><br><span class="line">设备选项:</span><br><span class="line"><span class="params">--disk</span> DISK 使用不同选项指定存储。例如：</span><br><span class="line"><span class="params">--disk</span> size=10 <span class="params">(new 10GiB image in default location)</span></span><br><span class="line"><span class="params">--disk</span> <span class="string">/my/existing/disk</span>,cache=none</span><br><span class="line"><span class="params">--disk</span> device=cdrom,bus=scsi</span><br><span class="line"><span class="params">--disk=</span>?</span><br><span class="line">-w NETWORK, <span class="params">--network</span> NETWORK</span><br><span class="line">配置虚拟机网络接口。例如：</span><br><span class="line"><span class="params">--network</span> bridge=mybr0</span><br><span class="line"><span class="params">--network</span> network=my_libvirt_virtual_net</span><br><span class="line"><span class="params">--network</span> network=mynet,model=virtio,mac=00<span class="function">:11...</span></span><br><span class="line"><span class="params">--network</span> none</span><br><span class="line"><span class="params">--network</span> <span class="keyword">help</span></span><br><span class="line"><span class="params">--graphics</span> GRAPHICS 配置虚拟机显示设置。例如：</span><br><span class="line"><span class="params">--graphics</span> vnc</span><br><span class="line"><span class="params">--graphics</span> spice,port=5901,tlsport=5902</span><br><span class="line"><span class="params">--graphics</span> none</span><br><span class="line"><span class="params">--graphics</span> vnc,password=foobar,port=5910,keymap=ja</span><br><span class="line"><span class="params">--controller</span> CONTROLLER</span><br><span class="line">配置虚拟机控制程序设备。例如：</span><br><span class="line"><span class="params">--controller</span> type=usb,model=ich9-ehci1</span><br><span class="line"><span class="params">--input</span> INPUT 配置虚拟机输入设备。例如：</span><br><span class="line"><span class="params">--input</span> tablet</span><br><span class="line"><span class="params">--input</span> keyboard,bus=usb</span><br><span class="line"><span class="params">--serial</span> SERIAL 配置虚拟机串口设备</span><br><span class="line"><span class="params">--parallel</span> PARALLEL 配置虚拟机并口设备</span><br><span class="line"><span class="params">--channel</span> CHANNEL 配置虚拟机沟通频道</span><br><span class="line"><span class="params">--console</span> CONSOLE 配置虚拟机与主机之间的文本控制台连接</span><br><span class="line"><span class="params">--hostdev</span> HOSTDEV 将物理 USB/PCI/etc</span><br><span class="line">主机设备配置为与虚拟机共享</span><br><span class="line"><span class="params">--filesystem</span> FILESYSTEM</span><br><span class="line">将主机目录传递给虚拟机。例如：</span><br><span class="line"><span class="params">--filesystem</span> <span class="string">/my/source/dir</span>,<span class="string">/dir/in/guest</span></span><br><span class="line"><span class="params">--filesystem</span> template_name,/,type=template</span><br><span class="line"><span class="params">--sound</span> [SOUND] 配置虚拟机声音设备模拟</span><br><span class="line"><span class="params">--watchdog</span> WATCHDOG 配置虚拟机 watchdog 设备</span><br><span class="line"><span class="params">--video</span> VIDEO 配置虚拟机视频硬件。</span><br><span class="line"><span class="params">--smartcard</span> SMARTCARD</span><br><span class="line">配置虚拟机智能卡设备。例如：</span><br><span class="line"><span class="params">--smartcard</span> mode=passthrough</span><br><span class="line"><span class="params">--redirdev</span> REDIRDEV 配置虚拟机重定向设备。例如：</span><br><span class="line"><span class="params">--redirdev</span> usb,type=tcp,server=192.168.1.1<span class="function">:4000</span></span><br><span class="line"><span class="params">--memballoon</span> MEMBALLOON</span><br><span class="line">配置虚拟机 memballoon 设备。例如：</span><br><span class="line"><span class="params">--memballoon</span> model=virtio</span><br><span class="line"><span class="params">--tpm</span> TPM 配置虚拟机 TPM 设备。例如：</span><br><span class="line"><span class="params">--tpm</span> <span class="string">/dev/tpm</span></span><br><span class="line"><span class="params">--rng</span> RNG 配置虚拟机 RNG 设备。例如：</span><br><span class="line"><span class="params">--rng</span> <span class="string">/dev/random</span></span><br><span class="line"><span class="params">--panic</span> PANIC 配置虚拟机 panic 设备。例如：</span><br><span class="line"><span class="params">--panic</span> default</span><br><span class="line">虚拟机配置选项:</span><br><span class="line"><span class="params">--security</span> SECURITY 设定域安全驱动器配置。</span><br><span class="line"><span class="params">--numatune</span> NUMATUNE 为域进程调整 NUMA 策略。</span><br><span class="line"><span class="params">--memtune</span> MEMTUNE 为域进程调整内粗策略。</span><br><span class="line"><span class="params">--blkiotune</span> BLKIOTUNE</span><br><span class="line">为域进程调整 blkio 策略。</span><br><span class="line"><span class="params">--memorybacking</span> MEMORYBACKING</span><br><span class="line">为域进程设置内存后备策略。例如：</span><br><span class="line"><span class="params">--memorybacking</span> hugepages=on</span><br><span class="line"><span class="params">--features</span> FEATURES 设置域 &lt;features&gt; XML。例如：</span><br><span class="line"><span class="params">--features</span> acpi=off</span><br><span class="line"><span class="params">--features</span> apic=on,eoi=on</span><br><span class="line"><span class="params">--clock</span> CLOCK 设置域 &lt;clock&gt; XML。例如：</span><br><span class="line"><span class="params">--clock</span> offset=localtime,rtc_tickpolicy=catchup</span><br><span class="line"><span class="params">--pm</span> PM 配置 VM 电源管理功能</span><br><span class="line"><span class="params">--events</span> EVENTS 配置 VM 生命周期管理策略</span><br><span class="line"><span class="params">--resource</span> RESOURCE 配置 VM 资源分区（cgroups）</span><br><span class="line">虚拟化平台选项:</span><br><span class="line">-v, <span class="params">--hvm</span> 客户端应该是一个全虚拟客户端</span><br><span class="line">-p, <span class="params">--paravirt</span> 这个客户端一个是一个半虚拟客户端</span><br><span class="line"><span class="params">--container</span> 这台虚拟机需要一个容器客户端</span><br><span class="line"><span class="params">--virt-type</span> HV_TYPE 要使用的管理程序名称<span class="params">(kvm、qemu、xen</span></span><br><span class="line"><span class="params">等等)</span></span><br><span class="line"><span class="params">--arch</span> ARCH 模拟的 CPU 构架</span><br><span class="line"><span class="params">--machine</span> MACHINE 要模拟的机器类型</span><br><span class="line">其它选项:</span><br><span class="line"><span class="params">--autostart</span> 引导主机时自动启动域。</span><br><span class="line"><span class="params">--wait</span> WAIT 等待安装完成的分钟数。</span><br><span class="line"><span class="params">--noautoconsole</span> 不要自动尝试连接到客户端控制台</span><br><span class="line"><span class="params">--noreboot</span> 完成安装后不要引导虚拟机。</span><br><span class="line"><span class="params">--print-xml</span> [XMLONLY]</span><br><span class="line">输出所生成域 XML，而不是创建虚拟机。</span><br><span class="line"><span class="params">--dry-run</span> 完成安装步骤，但不要创建设备或者定义</span><br><span class="line">虚拟机。</span><br><span class="line"><span class="params">--check</span> CHECK 启用或禁用验证检查。例如：</span><br><span class="line"><span class="params">--check</span> path_in_use=off</span><br><span class="line"><span class="params">--check</span> all=off</span><br><span class="line">-q, <span class="params">--quiet</span> 禁止无错误输出</span><br><span class="line">-d, <span class="params">--debug</span> 输入故障排除信息</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;我们使用命令创建虚拟机(网卡配置选择default的话默认是nat模式)</p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">virt-install --virt-type kvm \</span><br><span class="line">-<span class="ruby">-name H1 --ram <span class="number">1024</span> --vcpus <span class="number">2</span> \</span></span><br><span class="line"><span class="ruby">--cdrom=<span class="regexp">/usr/local</span><span class="regexp">/src/</span>CentOS-<span class="number">7</span>-x86_64-Minimal-<span class="number">1908</span>.iso \</span></span><br><span class="line"><span class="ruby">--disk=<span class="regexp">/var/lib</span><span class="regexp">/libvirt/images</span><span class="regexp">/H1.qcow2 \</span></span></span><br><span class="line"><span class="ruby">--network network=default \</span></span><br><span class="line"><span class="ruby">--graphics vnc,listen=<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span> \</span></span><br><span class="line"><span class="ruby">--noautoconsole</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;输入<code>virt-manage</code>r可开启xshellmanager的终端窗口如下图<img src="https://img-blog.csdnimg.cn/20191129164736147.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="H"><br>&emsp;&emsp;双击图标打开，可以看到已经开始自动从光盘启动安装了，配置完毕，手动安装CentOS7系统。<br>如果输入<code>virt-manage</code>不能启动xmanager的窗口，检查一下项目</p><ul><li>确认已经安装xmanager</li><li>xshell文件—属性—连接—隧道—设置转发x11到xmanager</li><li>ssh服务配置文件是否开启X11Forwarding选项 设置为yes</li></ul><p>&emsp;&emsp;以上都没问题，建议重装xmanager，我就是配置都对，但是输入<code>virt-manage</code>命令没反应，重装了一下xmanager和xshell之后就可以正常使用了。</p><p>&emsp;&emsp;安装好CentOS7系统重启后，在vrit-manager的窗口中点击虚拟机info，给H1虚拟机添加一块网卡，并将两块网卡分别选择为主机的桥接网卡br0和br1，如下图所示<br><img src="https://img-blog.csdnimg.cn/20191129173237598.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="H1net"><br>&emsp;&emsp;在虚拟机中配置两个网卡的IP，配置分别如下</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysconfig/network-scripts/ifcfg-eth0</span><br><span class="line">TYPE=<span class="string">"Ethernet"</span></span><br><span class="line">BOOTPROTO=<span class="string">"static"</span></span><br><span class="line">IPADDR=<span class="string">"172.18.32.85"</span></span><br><span class="line">GATEWAY=<span class="string">"172.18.0.1"</span></span><br><span class="line">DNS1=<span class="string">"180.76.76.76"</span></span><br><span class="line">DEFROUTE=<span class="string">"yes"</span></span><br><span class="line">NAME=<span class="string">"eth0"</span></span><br><span class="line">DEVICE=<span class="string">"eth0"</span></span><br><span class="line">ONBOOT=<span class="string">"yes"</span></span><br></pre></td></tr></table></figure><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysconfig/network-scripts/ifcfg-eth1</span><br><span class="line">TYPE=<span class="string">"Ethernet"</span></span><br><span class="line">BOOTPROTO=<span class="string">"static"</span></span><br><span class="line">IPADDR=<span class="string">"10.0.0.85"</span></span><br><span class="line">DEFROUTE=<span class="string">"no"</span></span><br><span class="line">NAME=<span class="string">"eth1"</span></span><br><span class="line">DEVICE=<span class="string">"eth1"</span></span><br><span class="line">ONBOOT=<span class="string">"yes"</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;此时H1的基本配置就算完成了。<br>&emsp;&emsp;查看<code>/var/lib/libvirt/images/</code>目录下，看到已经有一个镜像了了</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>localhost ~]# ll /var/lib/libvirt/images/</span><br><span class="line">total <span class="number">1594308</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1632632832</span> Nov <span class="number">29</span> <span class="number">18</span>:<span class="number">54</span> H1.qcow2</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;可以直接将此文件cp一份来当web1的磁盘文件</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /var/<span class="class"><span class="keyword">lib</span>/<span class="title">libvirt</span>/<span class="title">images</span>/</span></span><br><span class="line">cp H1.qcow2 W1.qcow2</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;也可以在node2节点上的H2和web2虚拟机的磁盘文件。<br>我们直接拷贝改名后，执行<code>virt-install</code>命令，创建另外三个虚拟机。</p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">virt-install --virt-type kvm \</span><br><span class="line">-<span class="ruby">-name W1 --ram <span class="number">1024</span> --vcpus <span class="number">2</span> \</span></span><br><span class="line"><span class="ruby">--cdrom=<span class="regexp">/usr/local</span><span class="regexp">/src/</span>CentOS-<span class="number">7</span>-x86_64-Minimal-<span class="number">1908</span>.iso \</span></span><br><span class="line"><span class="ruby">--disk=<span class="regexp">/var/lib</span><span class="regexp">/libvirt/images</span><span class="regexp">/W1.qcow2 \</span></span></span><br><span class="line"><span class="ruby">--network network=default \</span></span><br><span class="line"><span class="ruby">--graphics vnc,listen=<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span> \</span></span><br><span class="line"><span class="ruby">--noautoconsole</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;然后将W1强制终止，因为第一次是默认从光驱启动的，我们已经有系统了，不需要重装，重启后就发现已经是装好的系统，与H1一模一样的。<br>&emsp;&emsp;然后修改主机名为web1，将网卡桥接在eth1上,修改网卡配置。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">TYPE</span>=<span class="string">"Ethernet"</span></span><br><span class="line"><span class="attr">BOOTPROTO</span>=<span class="string">"static"</span></span><br><span class="line"><span class="attr">IPADDR</span>=<span class="string">"10.0.0.175"</span></span><br><span class="line"><span class="attr">PREFIX</span>=<span class="string">"16"</span></span><br><span class="line"><span class="attr">DEFROUTE</span>=<span class="string">"yes"</span></span><br><span class="line"><span class="attr">NAME</span>=<span class="string">"eth0"</span></span><br><span class="line"><span class="attr">DEVICE</span>=<span class="string">"eth0"</span></span><br><span class="line"><span class="attr">ONBOOT</span>=<span class="string">"yes"</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;对node2上的两个虚拟机采用同样方式创建。<br>&emsp;&emsp;之后分别通过脚本装HAProxy+keepadlived服务和nginx+PHP服务。<br>&emsp;&emsp;修改完几个服务的配置文件(可参考之前文章<a href="https://blog.csdn.net/MicePro/article/details/102901024" rel="noopener" target="_blank">企业级应用：负载均衡层——haproxy(一)</a>)之后，就可以将通过客户机就可以访问，后端web服务器了。</p><h2 id="附一键安装脚本"><a href="#附一键安装脚本" class="headerlink" title="附一键安装脚本"></a>附一键安装脚本</h2><h3 id="HAProxy一键安装脚本"><a href="#HAProxy一键安装脚本" class="headerlink" title="HAProxy一键安装脚本"></a>HAProxy一键安装脚本</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@HAProxy1 haproxy]</span># <span class="selector-tag">tree</span></span><br><span class="line">.</span><br><span class="line">├── <span class="selector-tag">haproxy-2</span><span class="selector-class">.0</span><span class="selector-class">.8</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">├── <span class="selector-tag">haproxy84</span><span class="selector-class">.cfg</span></span><br><span class="line">├── <span class="selector-tag">haproxy</span><span class="selector-class">.cfg</span></span><br><span class="line">├── <span class="selector-tag">haproxy</span><span class="selector-class">.service</span></span><br><span class="line">├── <span class="selector-tag">haproxy</span><span class="selector-class">.sh</span></span><br><span class="line">└── <span class="selector-tag">lua-5</span><span class="selector-class">.3</span><span class="selector-class">.5</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line"></span><br><span class="line">0 <span class="selector-tag">directories</span>, 6 <span class="selector-tag">files</span></span><br><span class="line"><span class="selector-attr">[root@HAProxy1 haproxy]</span># <span class="selector-tag">bash</span> <span class="selector-tag">haproxy</span><span class="selector-class">.sh</span></span><br></pre></td></tr></table></figure><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">DST=<span class="string">"/apps"</span></span><br><span class="line">[ -a haproxy.cfg ] || &#123; echo <span class="string">' the absence of haproxy.conf'</span> ;exit <span class="number">1</span>;&#125;</span><br><span class="line">[ -a haproxy-<span class="number">2.0</span>.<span class="number">8</span>.tar.gz ] || &#123; echo <span class="string">' the absence of haproxy-2.0.8.tar.gz'</span> ;exit <span class="number">1</span>;&#125;</span><br><span class="line">[ -a haproxy.service ] || &#123; echo <span class="string">' the absence of haproxy.service'</span> ;exit <span class="number">2</span>;&#125;</span><br><span class="line">[ -a /usr/<span class="class"><span class="keyword">lib</span>/<span class="title">systemd</span>/<span class="title">system</span>/<span class="title">haproxy</span>.<span class="title">service</span> ] &amp;&amp; &#123; <span class="title">echo</span> ' <span class="title">haproxy</span> <span class="title">is</span> <span class="title">aready</span> <span class="title">installed</span>' ;</span>exit <span class="number">3</span>;&#125;</span><br><span class="line">id haproxy &amp;&gt;<span class="regexp">/dev/null</span> &amp;&amp; &#123; echo <span class="string">'user haproxy is exist'</span> ; exit <span class="number">4</span>;&#125; || useradd -r -s /sbin/nologin -u <span class="number">79</span> haproxy</span><br><span class="line">yum install -y libtermcap-devel ncurses-devel libevent-devel readline-devel gcc make</span><br><span class="line">[ -a lua-<span class="number">5.3</span>.<span class="number">5</span>.tar.gz ] || wget <span class="symbol">http:</span>/<span class="regexp">/www.lua.org/ftp</span><span class="regexp">/lua-5.3.5.tar.gz</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">tar xvf lua-5.3.5.tar.gz</span></span><br><span class="line"><span class="regexp">cd lua-5.3.5</span></span><br><span class="line"><span class="regexp">make linux test</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">yum install gcc gcc-c++ glibc glibc-devel pcre pcre-devel openssl openssl-devel systemd-devel -y</span></span><br><span class="line"><span class="regexp">mkdir -p $DST/haproxy</span></span><br><span class="line"><span class="comment">#[ -a haproxy-2.0.8.tar.gz ] || wget http://www.haproxy.org/download/2.0/src/haproxy-2.0.8.tar.gz</span></span><br><span class="line">cd ..</span><br><span class="line">tar xvf haproxy-<span class="number">2.0</span>.<span class="number">8</span>.tar.gz</span><br><span class="line">sleep <span class="number">1</span></span><br><span class="line">cd haproxy-<span class="number">2.0</span>.<span class="number">8</span></span><br><span class="line"></span><br><span class="line">make ARCH=x86_64 \</span><br><span class="line">TARGET=linux-glibc USE_PCRE=<span class="number">1</span> \</span><br><span class="line">USE_OPENSSL=<span class="number">1</span> \</span><br><span class="line">USE_ZLIB=<span class="number">1</span> \</span><br><span class="line">USE_SYSTEMD=<span class="number">1</span> \</span><br><span class="line">USE_CPU_AFFINITY=<span class="number">1</span> \</span><br><span class="line">USE_LUA=<span class="number">1</span> \</span><br><span class="line">LUA_INC=../lua-<span class="number">5.3</span>.<span class="number">5</span>/src/ \</span><br><span class="line">LUA_LIB=../lua-<span class="number">5.3</span>.<span class="number">5</span>/src/ \</span><br><span class="line">PREFIX=$DST/haproxy</span><br><span class="line">make install PREFIX=$DST/haproxy</span><br><span class="line"></span><br><span class="line">cat &gt; <span class="regexp">/usr/lib</span><span class="regexp">/systemd/system</span><span class="regexp">/haproxy.service &lt;&lt; "END"</span></span><br><span class="line"><span class="regexp">[Unit]</span></span><br><span class="line"><span class="regexp">Description=HAProxy Load Balancer</span></span><br><span class="line"><span class="regexp">After=syslog.target network.target</span></span><br><span class="line"><span class="regexp">[Service]</span></span><br><span class="line"><span class="regexp">ExecStartPre=/usr</span><span class="regexp">/sbin/haproxy</span> -f /etc/haproxy/haproxy.cfg -c -q</span><br><span class="line">ExecStart=<span class="regexp">/usr/sbin</span><span class="regexp">/haproxy -Ws -f /etc</span><span class="regexp">/haproxy/haproxy</span>.cfg -p /var/<span class="class"><span class="keyword">lib</span>/<span class="title">haproxy</span>/<span class="title">haproxy</span>.<span class="title">pid</span></span></span><br><span class="line">ExecReload=<span class="regexp">/bin/kill</span> -USR2 $MAINPID</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target\</span><br><span class="line">END</span><br><span class="line">sed -i <span class="string">"s@/usr@$DST/haproxy@"</span> /usr/<span class="class"><span class="keyword">lib</span>/<span class="title">systemd</span>/<span class="title">system</span>/<span class="title">haproxy</span>.<span class="title">service</span></span></span><br><span class="line"></span><br><span class="line">mkdir -p /etc/haproxy</span><br><span class="line">cd ..</span><br><span class="line">cp haproxy.cfg /etc/haproxy/</span><br><span class="line">sed -i <span class="string">"s@chroot /apps/haproxy@chroot $DST/haproxy@"</span> /etc/haproxy/haproxy.cfg</span><br><span class="line">mkdir -p /var/<span class="class"><span class="keyword">lib</span>/<span class="title">haproxy</span></span></span><br><span class="line">chown <span class="number">99.99</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">haproxy</span>/ -<span class="title">R</span></span></span><br><span class="line"></span><br><span class="line">cat &gt;&gt; <span class="regexp">/etc/sysctl</span>.conf &lt;&lt; END</span><br><span class="line">net.ipv4.ip_forward = <span class="number">1</span></span><br><span class="line">net.ipv4.ip_nonlocal_bind = <span class="number">1</span></span><br><span class="line">END</span><br><span class="line">sysctl -p <span class="comment">#修改内核参数之后生效，systemctl daemon-reload 是重读启动脚本</span></span><br><span class="line"></span><br><span class="line">systemctl enable --now haproxy</span><br><span class="line">systemctl status haproxy</span><br></pre></td></tr></table></figure><h3 id="Nginx-PHP一键安装脚本"><a href="#Nginx-PHP一键安装脚本" class="headerlink" title="Nginx+PHP一键安装脚本"></a>Nginx+PHP一键安装脚本</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@Web1 web]</span># <span class="selector-tag">tree</span></span><br><span class="line">.</span><br><span class="line">├── <span class="selector-tag">nginx</span></span><br><span class="line">│   ├── <span class="selector-tag">nginx-1</span><span class="selector-class">.16</span><span class="selector-class">.1</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">│   ├── <span class="selector-tag">nginx</span><span class="selector-class">.conf</span></span><br><span class="line">│   ├── <span class="selector-tag">nginx</span><span class="selector-class">.service</span></span><br><span class="line">│   └── <span class="selector-tag">nginx</span><span class="selector-class">.sh</span></span><br><span class="line">├── <span class="selector-tag">php-fpm</span></span><br><span class="line">│   ├── <span class="selector-tag">php-7</span><span class="selector-class">.3</span><span class="selector-class">.10</span><span class="selector-class">.tar</span><span class="selector-class">.xz</span></span><br><span class="line">│   └── <span class="selector-tag">php-fpm</span><span class="selector-class">.sh</span></span><br><span class="line">└── <span class="selector-tag">web</span><span class="selector-class">.sh</span></span><br><span class="line"></span><br><span class="line">2 <span class="selector-tag">directories</span>, 7 <span class="selector-tag">files</span></span><br><span class="line"><span class="selector-attr">[root@Web1 web]</span># <span class="selector-tag">bash</span> <span class="selector-tag">web</span><span class="selector-class">.sh</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim web.sh</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">cd</span> nginx</span><br><span class="line">bash nginx.sh</span><br><span class="line"><span class="built_in">cd</span> ../php-fpm</span><br><span class="line">bash php-fpm.sh</span><br></pre></td></tr></table></figure><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vim nginx/nginx.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">DST=<span class="string">"/apps"</span></span><br><span class="line">[ -a nginx.conf ] || &#123; echo <span class="string">' the absence of nginx.conf'</span> ;exit <span class="number">1</span>;&#125;</span><br><span class="line">[ -a nginx.service ] || &#123; echo <span class="string">' the absence of nginx.service'</span> ;exit <span class="number">2</span>;&#125;</span><br><span class="line">[ -a /usr/<span class="class"><span class="keyword">lib</span>/<span class="title">systemd</span>/<span class="title">system</span>/<span class="title">nginx</span>.<span class="title">service</span> ] &amp;&amp; &#123; <span class="title">echo</span> ' <span class="title">nginx</span> <span class="title">is</span> <span class="title">aready</span> <span class="title">installed</span>' ;</span>exit <span class="number">3</span>;&#125;</span><br><span class="line">id nginx &amp;&gt;<span class="regexp">/dev/null</span> &amp;&amp; &#123; echo <span class="string">'user nginx is exist'</span> ; exit <span class="number">4</span>;&#125; || useradd -r -s /sbin/nologin -u <span class="number">80</span> nginx</span><br><span class="line">yum install -y gcc gcc-c++ glibc glibc-devel pcre pcre-devel openssl openssl-devel systemd-devel net-tools iotop bc zip unzip zlib-devel bash-completion nfs-utils automake libxml2 libxml2-devel libxslt libxslt-devel perl perl-ExtUtils-Embed   vim lrzsz tree psmisc wget || &#123; echo <span class="string">'Dependencies is not installed'</span>;exit <span class="number">5</span>;&#125;</span><br><span class="line"><span class="comment">#mkdir -p $DST/nginx</span></span><br><span class="line">mkdir -p /data/apps/nginx</span><br><span class="line">ln -s /data/apps/  <span class="regexp">/apps</span></span><br><span class="line"><span class="regexp">[ -a nginx-1.16.1.tar.gz ] || wget https:/</span><span class="regexp">/nginx.org/download</span><span class="regexp">/nginx-1.16.1.tar.gz</span></span><br><span class="line"><span class="regexp">tar xvf nginx-1.16.1.tar.gz</span></span><br><span class="line"><span class="regexp">cd nginx-1.16.1</span></span><br><span class="line"><span class="regexp">./configure</span> --prefix=$DST/nginx --user=nginx --group=nginx --<span class="keyword">with</span>-http_ssl_module --<span class="keyword">with</span>-http_v2_module --<span class="keyword">with</span>-http_realip_module --<span class="keyword">with</span>-http_stub_status_module --<span class="keyword">with</span>-http_gzip_static_module --<span class="keyword">with</span>-pcre --<span class="keyword">with</span>-stream --<span class="keyword">with</span>-stream_ssl_module --<span class="keyword">with</span>-stream_realip_module --<span class="keyword">with</span>-select_module --<span class="keyword">with</span>-file-aio</span><br><span class="line">make -j <span class="number">4</span> &amp;&amp; make install</span><br><span class="line">cp ../nginx.conf $DST/nginx/conf/</span><br><span class="line">cp ../nginx.service /usr/<span class="class"><span class="keyword">lib</span>/<span class="title">systemd</span>/<span class="title">system</span>/</span></span><br><span class="line">systemctl enable --now nginx</span><br><span class="line">systemctl status nginx</span><br></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vim nginx/nginx.service</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=The nginx HTTP <span class="keyword">and</span> reverse<span class="built_in"> proxy </span>server</span><br><span class="line"><span class="attribute">After</span>=network.target remote-fs.target nss-lookup.target</span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">Type</span>=forking</span><br><span class="line"><span class="attribute">PIDFile</span>=/apps/nginx/logs/nginx.pid</span><br><span class="line"><span class="comment"># Nginx will fail to start if /run/nginx.pid already exists but has the wrong</span></span><br><span class="line"><span class="comment"># SELinux context. This might happen when running `nginx -t` from the cmdline.</span></span><br><span class="line"><span class="comment"># https://bugzilla.redhat.com/show_bug.cgi?id=1268621</span></span><br><span class="line"><span class="attribute">ExecStartPre</span>=/usr/bin/rm -f /apps/nginx/logs/nginx.pid</span><br><span class="line"><span class="attribute">ExecStartPre</span>=/apps/nginx/sbin/nginx -t</span><br><span class="line"><span class="attribute">ExecStart</span>=/apps/nginx/sbin/nginx</span><br><span class="line"><span class="attribute">ExecReload</span>=/bin/kill -s HUP <span class="variable">$MAINPID</span></span><br><span class="line"><span class="attribute">KillSignal</span>=SIGQUIT</span><br><span class="line"><span class="attribute">TimeoutStopSec</span>=5</span><br><span class="line"><span class="attribute">KillMode</span>=process</span><br><span class="line"><span class="attribute">PrivateTmp</span>=<span class="literal">true</span></span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">vim</span> nginx/nginx.conf</span><br><span class="line">user  nginx;</span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">2</span>;</span><br><span class="line"><span class="attribute">worker_cpu_affinity</span> <span class="number">0001</span> <span class="number">0010</span>;</span><br><span class="line"><span class="attribute">worker_priority</span> -<span class="number">10</span>;</span><br><span class="line"><span class="attribute">error_log</span>  logs/error.log  <span class="literal">info</span>;</span><br><span class="line"><span class="attribute">error_log</span>  /apps/nginx/logs/error.log  <span class="literal">error</span>;</span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">65536</span>;</span><br><span class="line">    <span class="attribute">use</span> <span class="literal">epoll</span>;</span><br><span class="line">    <span class="attribute">accept_mutex</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">multi_accept</span> <span class="literal">on</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line">    <span class="attribute">log_format</span> access_json <span class="string">'&#123;"<span class="variable">@timestamp</span>":"<span class="variable">$time_iso8601</span>",'</span></span><br><span class="line">        <span class="string">'"host":"<span class="variable">$server_addr</span>",'</span></span><br><span class="line">        <span class="string">'"clientip":"<span class="variable">$remote_addr</span>",'</span></span><br><span class="line">        <span class="string">'"size":<span class="variable">$body_bytes_sent</span>,'</span></span><br><span class="line">        <span class="string">'"responsetime":<span class="variable">$request_time</span>,'</span></span><br><span class="line">        <span class="string">'"upstreamtime":"<span class="variable">$upstream_response_time</span>",'</span></span><br><span class="line">        <span class="string">'"upstreamhost":"<span class="variable">$upstream_addr</span>",'</span></span><br><span class="line">        <span class="string">'"http_host":"<span class="variable">$host</span>",'</span></span><br><span class="line">        <span class="string">'"uri":"<span class="variable">$uri</span>",'</span></span><br><span class="line">        <span class="string">'"domain":"<span class="variable">$host</span>",'</span></span><br><span class="line">        <span class="string">'"xff":"<span class="variable">$http_x_forwarded_for</span>",'</span></span><br><span class="line">        <span class="string">'"referer":"<span class="variable">$http_referer</span>",'</span></span><br><span class="line">        <span class="string">'"tcp_xff":"<span class="variable">$proxy_protocol_addr</span>",'</span></span><br><span class="line">        <span class="string">'"http_user_agent":"<span class="variable">$http_user_agent</span>",'</span></span><br><span class="line">        <span class="string">'"status":"<span class="variable">$status</span>"&#125;'</span>;</span><br><span class="line">    <span class="attribute">access_log</span>  /apps/nginx/logs/access_json.log  access_json;</span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span> <span class="number">65</span>;</span><br><span class="line">    <span class="attribute">server_tokens</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line">    <span class="attribute">gzip</span>  <span class="literal">on</span>;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  www.example.net;</span><br><span class="line">        <span class="attribute">location</span> = / &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">        <span class="attribute">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="attribute">location</span> <span class="regexp">~ ^/(status|ping)$</span> &#123;</span><br><span class="line">             <span class="attribute">include</span> fastcgi_params;</span><br><span class="line">             <span class="attribute">fastcgi_pass</span> <span class="number">127.0.0.1:9000</span>;</span><br><span class="line">             <span class="attribute">fastcgi_param</span> PATH_TRANSLATED <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">             <span class="attribute">fastcgi_hide_header</span> X-Powered-By;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="attribute">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line">            <span class="attribute">root</span>           html;</span><br><span class="line">            <span class="attribute">fastcgi_pass</span>   <span class="number">127.0.0.1:9000</span>;</span><br><span class="line">            <span class="attribute">fastcgi_index</span>  index.php;</span><br><span class="line">            <span class="attribute">fastcgi_param</span>  SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">            <span class="attribute">include</span>        fastcgi_params;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">vim php-fpm/php-fpm.sh</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">DST=<span class="string">"/apps"</span></span><br><span class="line">[ -a php-*.tar.* ] || &#123; <span class="built_in">echo</span> <span class="string">' the absence of php-7.3.10.tar.xz'</span> ;<span class="built_in">exit</span> 1;&#125;</span><br><span class="line">[ -a /usr/lib/systemd/system/php-fpm.service ] &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">' php-fpm is aready installed'</span> ;<span class="built_in">exit</span> 2;&#125;</span><br><span class="line">[ -a <span class="variable">$DST</span>/php* ] &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">' php is aready installed'</span> ;<span class="built_in">exit</span> 2;&#125;</span><br><span class="line">mkdir -p <span class="variable">$DST</span>/php</span><br><span class="line">yum install libxml2-devel bzip2-devel libmcrypt-devel -y || &#123; <span class="built_in">echo</span> <span class="string">'Dependencies is not installed'</span>;<span class="built_in">exit</span> 5;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#wget https://www.php.net/distributions/php-7.3.10.tar.xz</span></span><br><span class="line">tar xvf php-*.tar.*</span><br><span class="line"><span class="built_in">cd</span> php-7.3.10</span><br><span class="line"></span><br><span class="line">./configure \</span><br><span class="line">--prefix=<span class="variable">$DST</span>/php \</span><br><span class="line">--<span class="built_in">enable</span>-mysqlnd \</span><br><span class="line">--with-mysqli=mysqlnd \</span><br><span class="line">--with-pdo-mysql=mysqlnd \</span><br><span class="line">--with-openssl \</span><br><span class="line">--with-freetype-dir \</span><br><span class="line">--with-jpeg-dir \</span><br><span class="line">--with-png-dir \</span><br><span class="line">--with-zlib \</span><br><span class="line">--with-libxml-dir=/usr \</span><br><span class="line">--with-config-file-path=/etc \</span><br><span class="line">--with-config-file-scan-dir=/etc/php.d \</span><br><span class="line">--<span class="built_in">enable</span>-mbstring \</span><br><span class="line">--<span class="built_in">enable</span>-xml \</span><br><span class="line">--<span class="built_in">enable</span>-sockets \</span><br><span class="line">--<span class="built_in">enable</span>-fpm \</span><br><span class="line">--<span class="built_in">enable</span>-maintainer-zts \</span><br><span class="line">--<span class="built_in">disable</span>-fileinfo</span><br><span class="line"></span><br><span class="line"> make -j 4 &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">cp php.ini-production  /etc/php.ini</span><br><span class="line">cp sapi/fpm/php-fpm.service /usr/lib/systemd/system/</span><br><span class="line"></span><br><span class="line">cp <span class="variable">$DST</span>/php/etc/php-fpm.conf.default  <span class="variable">$DST</span>/php/etc/php-fpm.conf</span><br><span class="line">cp <span class="variable">$DST</span>/php/etc/php-fpm.d/www.conf.default <span class="variable">$DST</span>/php/etc/php-fpm.d/www.conf</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">'s@nobody@nginx@g'</span> <span class="variable">$DST</span>/php/etc/php-fpm.d/www.conf</span><br><span class="line">sed -i <span class="string">'/#/!s@index  index.html index.htm@index index.php index.html index.htm@'</span> <span class="variable">$DST</span>/nginx/conf/nginx.conf</span><br><span class="line">sed -i <span class="string">'s@/scripts$fastcgi_script_name@$document_root$fastcgi_script_name@g'</span> <span class="variable">$DST</span>/nginx/conf/nginx.conf</span><br><span class="line"><span class="variable">$DST</span>/nginx/sbin/nginx -s reload</span><br><span class="line">systemctl <span class="built_in">enable</span> --now php-fpm</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> KVM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 一键安装 </tag>
            
            <tag> KVM </tag>
            
            <tag> 虚拟化 </tag>
            
            <tag> ubuntu </tag>
            
            <tag> 网卡配置 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenVPN的搭建</title>
      <link href="//blog/2c6b894f.html"/>
      <url>//blog/2c6b894f.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;企业中，必不可少的应用就是VPN了，它可以帮助员工在外网中访问公司内网，常见开源实现方案有OpenVPN和jumpserver。<br>&emsp;&emsp;OpenVPN是采用了端口转发的原理实现，是基于IP+端口的4层代理机制，一般是用于出差员工访问公司内部ERP系统等使用，而jumpserver是7层代理，所以功能更加强大却也更加复杂，一般适合运维人员管理维护企业内部服务器。对于中小公司日常使用，OpenVPN就已经完全足够了，当然，也可用于科学，你懂得。本文将对linux环境下（CentOS），OpenVPN的安装配置做一个详细的介绍。</p><a id="more"></a><h1 id="部署OpenVPN"><a href="#部署OpenVPN" class="headerlink" title="部署OpenVPN"></a>部署OpenVPN</h1><h2 id="部署OpenVPN服务器"><a href="#部署OpenVPN服务器" class="headerlink" title="部署OpenVPN服务器"></a>部署OpenVPN服务器</h2><h3 id="下载安装OpenVPN"><a href="#下载安装OpenVPN" class="headerlink" title="下载安装OpenVPN"></a>下载安装OpenVPN</h3><p>&emsp;&emsp;OpenVPN的rpm包可以在epel源中直接下载安装，所以我们需要先配置epel源，推荐选用阿里的epel源，<code>CentOS67</code>命令如下：</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/yum.repos.d/aliyunepel.repo &lt;&lt; <span class="string">"END"</span></span><br><span class="line">[aliyun-epel]</span><br><span class="line">name=aliyun-epel</span><br><span class="line">baseurl=https://mirrors.aliyun.com/epel/$releasever/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/epel/RPM-GPG-KEY-EPEL-$releasever</span><br><span class="line">enabled=1</span><br><span class="line">END</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;<code>CentOS8</code>路径有所变化，命令如下：</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/yum.repos.d/aliyunepel.repo &lt;&lt; <span class="string">"END"</span></span><br><span class="line">[aliyun-epel]</span><br><span class="line">name=aliyun-epel</span><br><span class="line">baseurl=https://mirrors.aliyun.com/epel/$releasever/Everything/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/epel/RPM-GPG-KEY-EPEL-$releasever</span><br><span class="line">enabled=1</span><br><span class="line">END</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;或者直接安装官方的epel源(6、7、8通用）。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> epel-<span class="keyword">release</span> -y</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;配置好epel源之后，直接yum安装服务器端软件和证书管理工具就可以了。</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> openvpn -y <span class="comment">#openvpn服务端</span></span><br><span class="line">yum <span class="keyword">install</span> easy-rsa -y <span class="comment">#证书管理工具</span></span><br></pre></td></tr></table></figure><h3 id="OpenVPN配置"><a href="#OpenVPN配置" class="headerlink" title="OpenVPN配置"></a>OpenVPN配置</h3><p>&emsp;&emsp;将模版配置文件及证书管理工具复制到指定目录</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>openvpn<span class="number">-2.4</span><span class="number">.8</span><span class="meta-keyword">/sample/</span>sample-config-files/server.conf <span class="meta-keyword">/etc/</span>openvpn/  <span class="meta">#openvpn server 配置文件</span></span><br><span class="line">cp -r <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/easy-rsa/</span> <span class="meta-keyword">/etc/</span>openvpn/easyrsa-server <span class="meta">#证书管理工具</span></span><br><span class="line">cp <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>easy-rsa<span class="number">-3.0</span><span class="number">.6</span>/vars.example <span class="meta-keyword">/etc/</span>openvpn<span class="meta-keyword">/easyrsa-server/</span><span class="number">3</span>/vars</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;配置文件模版如果没有，那可能是在路径为<code>/usr/share/doc/openvpn/sample/sample-config-files/server.conf</code>，easy-rsa如果CentOS8yum安装不上，只能去github上<code>https://github.com/OpenVPN/easy-rsa</code>下载，将里面的easyrsa3目录复制出来就是证书管理工具,并且不需要复制<code>vars.example</code>文件，里面已经有了,改个名字就可以。</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cp</span> -r easyrsa3 /etc/openvpn/easyrsa-server</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;先进入证书管理工具目录（若github上下载的则是<code>cd /etc/openvpn/easyrsa-server/</code>，之后则都没有3的子目录，或者也创建一个3的子目录保持一致性）</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="regexp">/etc/</span>openvpn<span class="regexp">/easyrsa-server/</span><span class="number">3</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;若easyrsa为github下载的话，目录结果如下</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@aws-host easyrsa-server]#tree</span><br><span class="line">.</span><br><span class="line">├── easyrsa</span><br><span class="line">├── openssl-easyrsa.cnf</span><br><span class="line">├── vars.example</span><br><span class="line">└── x509-types</span><br><span class="line">    ├── ca</span><br><span class="line">    ├── client</span><br><span class="line">    ├── code-signing</span><br><span class="line">    ├── COMMON</span><br><span class="line">    ├── email</span><br><span class="line">    ├── server</span><br><span class="line">    └── serverClient</span><br><span class="line"></span><br><span class="line">1 directory, 10 files</span><br><span class="line">[root@aws-host easyrsa-server]#</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;OpenVPN的server端配置文件如下：</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/openvpn/server.conf</span><br><span class="line">local <span class="number">172.18</span><span class="number">.200</span><span class="number">.101</span> #本机监听IP,写公网IP</span><br><span class="line">port <span class="number">1194</span> #端口</span><br><span class="line"># TCP or UDP server?</span><br><span class="line">proto tcp #协议，指定OpenVPN创建的通信隧道类型</span><br><span class="line">#proto udp</span><br><span class="line">#dev tap：创建一个以太网隧道，以太网使用tap</span><br><span class="line">dev tun：创建一个路由IP隧道，互联网使用tun一个TUN设备大多时候，被用于基于IP协议的通讯。一个TAP设备允许完整的以太网帧通过Openvpn隧道，因此提供非ip协议的支持，比如IPX协议和AppleTalk协议</span><br><span class="line">#dev-node MyTap #TAP-Win32适配器。非windows不需要</span><br><span class="line">#topology subnet #网络拓扑，不需要配置</span><br><span class="line">server <span class="number">10.8</span><span class="number">.0</span><span class="number">.0</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> #客户端连接后分配IP的地址池，服务器默认会占用第一个IP <span class="number">10.8</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">#ifconfig-pool-persist ipp.txt #为客户端分配固定IP，不需要配置</span><br><span class="line">#server-bridge <span class="number">10.8</span><span class="number">.0</span><span class="number">.4</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> <span class="number">10.8</span><span class="number">.0</span><span class="number">.50</span> <span class="number">10.8</span><span class="number">.0</span><span class="number">.100</span> #配置网桥模式，不需要</span><br><span class="line">push <span class="string">"route 10.20.0.0 255.255.0.0"</span> #给客户端生成的静态路由表，下一跳为openvpn服务器的<span class="number">10.8</span><span class="number">.0</span><span class="number">.1</span>,地址段为openvpn服务器后的公司内部网络，可以是多个网段</span><br><span class="line">push <span class="string">"route 172.31.0.0 255.255.248.0"</span></span><br><span class="line">;client-config-dir ccd #为指定的客户端添加路由，改路由通常是客户端后面的内网网段而不是服务端的，也不需要设置</span><br><span class="line">;route <span class="number">192.168</span><span class="number">.40</span><span class="number">.128</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.248</span></span><br><span class="line">;client-config-dir ccd</span><br><span class="line">;route <span class="number">10.9</span><span class="number">.0</span><span class="number">.0</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.252</span></span><br><span class="line">;learn-address ./script #运行外部脚本，创建不同组的iptables 规则，不配置</span><br><span class="line">;push <span class="string">"redirect-gateway def1 bypass-dhcp"</span> #启用后，客户端所有流量都将通过VPN服务器，因此不需要配置</span><br><span class="line">#;push <span class="string">"dhcp-option DNS 208.67.222.222"</span> #推送DNS服务器，不需要配置</span><br><span class="line">#;push <span class="string">"dhcp-option DNS 208.67.220.220"</span></span><br><span class="line">#client-to-client #允许不同的client通过openvpn server直接通信，不开启</span><br><span class="line">#;duplicate-cn #多个用户共用一个账户，一般用于测试环境，生产环境都是一个用户一个证书</span><br><span class="line">keepalive <span class="number">10</span> <span class="number">120</span> #设置服务端检测的间隔和超时时间，默认为每 <span class="number">10</span> 秒 ping一次，如果 <span class="number">120</span> 秒没有回应则认为对方已经 down</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;所以最终配置如下</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">local 172.18.32.71    #写公网IP，测试环境无所谓</span><br><span class="line">port 1194</span><br><span class="line">proto tcp</span><br><span class="line">dev tun</span><br><span class="line">ca /etc/openvpn/certs/ca.crt</span><br><span class="line">cert /etc/openvpn/certs/server.crt</span><br><span class="line">key /etc/openvpn/certs/server.key  # This file should be kept secret</span><br><span class="line">dh /etc/openvpn/certs/dh.pem</span><br><span class="line">server 10.8.0.0 255.255.255.0   #默认设置，不需要修改</span><br><span class="line">push <span class="string">"route 10.0.0.0 255.255.255.0"</span>    #内网网段，需要修改，科学上网，则推送路由 <span class="string">"route 0.0.0.0"</span></span><br><span class="line">client-to-client</span><br><span class="line">keepalive 10 120</span><br><span class="line">cipher AES-256-CBC</span><br><span class="line">max-clients 100</span><br><span class="line">user nobody</span><br><span class="line">group nobody</span><br><span class="line">persist-tun</span><br><span class="line">status openvpn-status.log</span><br><span class="line">log-append  /var/log/openvpn/openvpn.log</span><br><span class="line">verb 9</span><br><span class="line">mute 20</span><br></pre></td></tr></table></figure><h3 id="搭建CA并签发证书"><a href="#搭建CA并签发证书" class="headerlink" title="搭建CA并签发证书"></a>搭建CA并签发证书</h3><p>&emsp;&emsp;初始化pki环境</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">./easyrsa</span> init-pki <span class="comment">#生成pki目录用于保存证书</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;创建CA签发机构，然后<code>直接回车</code></p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./easyrsa <span class="keyword">build-ca </span><span class="keyword">nopass </span>#创建ca并不使用密码</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;创建服务端证书(私钥)，<code>直接回车</code></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./easyrsa gen-req<span class="built_in"> server </span>nopass #生成server证书且不使用密码</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;然后使用自建ca签发服务器证书，即生成服务端crt公钥。crt公钥后期将用户发送给客户端，从而实现与openvpnserver端加密传输数据。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./easyrsa sign<span class="built_in"> server server </span>#签发服务端证书，备注信息为server</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;然后输入<code>yes</code>输入。</p><h3 id="创建非对称秘钥对"><a href="#创建非对称秘钥对" class="headerlink" title="创建非对称秘钥对"></a>创建非对称秘钥对</h3><p>&emsp;&emsp;还在easyrsa-server目录下，生成秘钥，这可能会花费一段时间。</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">./easyrsa</span> gen-dh</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;到此服务端证书环境配置完成，下面是配置客户端证书配置</p><h3 id="创建客户端证书及配置文件"><a href="#创建客户端证书及配置文件" class="headerlink" title="创建客户端证书及配置文件"></a>创建客户端证书及配置文件</h3><p>&emsp;&emsp;证书还是使用easyrsa工具，（github下载的也还是那个目录<code>easyrsa3</code>，不需要复制<code>vars.example</code>文件,改个名字就可以）</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp -r <span class="regexp">/usr/</span>share<span class="regexp">/easy-rsa/</span> <span class="regexp">/etc/</span>openvpn<span class="regexp">/easyrsa-client/</span></span><br><span class="line">cp <span class="regexp">/usr/</span>share<span class="regexp">/doc/</span>easy-rsa-<span class="number">3.0</span>.<span class="number">6</span><span class="regexp">/vars.example /</span>etc<span class="regexp">/openvpn/</span>easyrsa-client<span class="regexp">/3/</span>vars</span><br></pre></td></tr></table></figure><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> <span class="string">/etc/openvpn/easyrsa-client/3</span></span><br><span class="line"><span class="string">./easyrsa</span> init-pki</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;例如员工为Mice，则创建名为Mice的证书</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">./easyrsa</span> gen-req Mice nopass <span class="comment">#客户证书为Mice，没有设置密码</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;然后<code>直接回车</code>，便生成了Mice的证书申请和私钥。<strong>进入easyrsa的server目录中</strong>，(注意，<code>一定要进入easyrsa-server目录</code>，否则会报错)，导入证书申请并给客户端的证书请求签发证书,记得输入<code>yes</code>确认。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./easyrsa import-req /etc/openvpn/easyrsa-client/3/pki/reqs/Mice.req Mice</span><br><span class="line">./easyrsa sign<span class="built_in"> client </span>Mice</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;复制证书到server目录：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="regexp">/etc/</span>openvpn/certs</span><br><span class="line">cd <span class="regexp">/etc/</span>openvpn<span class="regexp">/certs/</span></span><br><span class="line">cp <span class="regexp">/etc/</span>openvpn<span class="regexp">/easyrsa-server/</span><span class="number">3</span><span class="regexp">/pki/</span>dh.pem .</span><br><span class="line">cp <span class="regexp">/etc/</span>openvpn<span class="regexp">/easyrsa-server/</span><span class="number">3</span><span class="regexp">/pki/</span>ca.crt .</span><br><span class="line">cp <span class="regexp">/etc/</span>openvpn<span class="regexp">/easyrsa-server/</span><span class="number">3</span><span class="regexp">/pki/</span>issued/server.crt .</span><br><span class="line">cp <span class="regexp">/etc/</span>openvpn<span class="regexp">/easyrsa-server/</span><span class="number">3</span><span class="regexp">/pki/</span><span class="keyword">private</span>/server.key .</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;创建客户端配置文件</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="meta-keyword">/etc/</span>openvpn<span class="meta-keyword">/client/</span>Mice/</span><br><span class="line">vim <span class="meta-keyword">/etc/</span>openvpn<span class="meta-keyword">/client/</span>Mice/client.ovpn</span><br></pre></td></tr></table></figure><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">client #声明自己是个客户端</span><br><span class="line">dev tun #接口类型，必须和服务端保持一致</span><br><span class="line">proto tcp #使用的协议，必须和服务端保持一致</span><br><span class="line">remote <span class="number">172.18</span><span class="number">.32</span><span class="number">.71</span> <span class="number">1194</span> #server端的ip和端口，可以写域名但是需要可以解析成IP</span><br><span class="line">resolv-retry infinite #如果是写的server端的域名，那么就始终解析，如果域名发生变化，会重新连接到新&gt;的域名对应的IP</span><br><span class="line">nobind #本机不绑定监听端口，客户端是随机打开端口连接到服务端的<span class="number">1194</span></span><br><span class="line">persist-<span class="type">key</span> #</span><br><span class="line">persist-tun</span><br><span class="line">ca ca.crt</span><br><span class="line">cert Mice.crt</span><br><span class="line"><span class="type">key</span> Mice.<span class="type">key</span></span><br><span class="line">remote-cert-tls server #指定采用服务器校验方式</span><br><span class="line">#tls-auth ta.<span class="type">key</span> <span class="number">1</span></span><br><span class="line">cipher AES<span class="number">-256</span>-CBC</span><br><span class="line">verb <span class="number">3</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;对签发的客户端证书及配置文件进行归档,并打包发送给客户端主机。</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="regexp">/etc/</span>openvpn<span class="regexp">/client/</span>Mice/</span><br><span class="line">cp <span class="regexp">/etc/</span>openvpn<span class="regexp">/easyrsa-server/</span><span class="number">3</span><span class="regexp">/pki/</span>ca.crt .</span><br><span class="line">cp <span class="regexp">/etc/</span>openvpn<span class="regexp">/easyrsa-server/</span><span class="number">3</span><span class="regexp">/pki/</span>issued/Mice.crt .</span><br><span class="line">cp <span class="regexp">/etc/</span>openvpn<span class="regexp">/easyrsa-client/</span><span class="number">3</span><span class="regexp">/pki/</span><span class="keyword">private</span>/Mice.key .</span><br><span class="line">tar czvf  Mice.tar.gz *</span><br></pre></td></tr></table></figure><h3 id="配置防火墙转发规则"><a href="#配置防火墙转发规则" class="headerlink" title="配置防火墙转发规则"></a>配置防火墙转发规则</h3><p>&emsp;&emsp;开启路由转发功能：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/sysctl.conf</span></span><br><span class="line"><span class="comment"># sysctl -p</span></span><br><span class="line"><span class="attr">net.ipv4.ip_forward</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;先清除现有防火墙策略以免发生干扰，如果CentOS7/8或Redhat7/8没有iptables命令就<code>yum install -y iptables-services</code>安装一个，之后设置IP伪装需要用到。<br>&emsp;&emsp;清空已有规则</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables -F</span><br><span class="line">iptables -X</span><br><span class="line">iptables -Z</span><br><span class="line">iptables -t<span class="built_in"> nat </span>-F</span><br><span class="line">iptables -t<span class="built_in"> nat </span>-X</span><br><span class="line">iptables -t<span class="built_in"> nat </span>-Z</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;创建iptables 规则：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -t<span class="built_in"> nat </span>-A POSTROUTING -s 10.8.0.0/24 -j MASQUERADE #此IP是server端默认ip，不要改</span><br><span class="line">iptables -A INPUT -p TCP --dport 1194 -j ACCEPT</span><br><span class="line">iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;CentOS6/7的话可以用保存iptables规则（适用未安装iptables-services，俩方式选一个就好）:</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">service iptables save</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;显示OK说明保存成功</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables: Saving<span class="built_in"> firewall </span>rules <span class="keyword">to</span> /etc/sysconfig/iptables:[ OK ]</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;如果用的services，则<code>systemctl enable --now iptables</code>（会自动从/etc/sysconfig/iptables文件中读取防火墙策略）</p><p>&emsp;&emsp;创建日志目录并授权：</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /<span class="built_in">var</span>/<span class="built_in">log</span>/openvpn</span><br><span class="line">chown nobody.nobody /<span class="built_in">var</span>/<span class="built_in">log</span>/openvpn</span><br></pre></td></tr></table></figure><h3 id="启动OpenVPN服务"><a href="#启动OpenVPN服务" class="headerlink" title="启动OpenVPN服务"></a>启动OpenVPN服务</h3><p>&emsp;&emsp;启动openvpn服务</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">systemctl</span> enable --now openvpn<span class="variable">@server</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;如果没有<a href="mailto:openvpn@server.service" rel="noopener" target="_blank">openvpn@server.service</a>文件，那就自己编写一个吧</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/<span class="class"><span class="keyword">lib</span>/<span class="title">systemd</span>/<span class="title">system</span>/<span class="title">openvpn</span>@.<span class="title">service</span></span></span><br></pre></td></tr></table></figure><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=OpenVPN Robust And Highly Flexible Tunneling Application <span class="literal">On</span> %I</span><br><span class="line"><span class="attr">After</span>=network.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=notify</span><br><span class="line"><span class="attr">PrivateTmp</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">ExecStart</span>=/usr/sbin/openvpn --cd /etc/openvpn/ --config %i.conf</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;验证日志：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">tail /var/log/openvpn/openvpn.log</span><br><span class="line">Tue Nov <span class="number">19</span> <span class="number">13</span>:<span class="number">27</span>:<span class="number">27</span> <span class="number">2019</span> Socket Buffers: R=[<span class="number">87380</span>-&gt;<span class="number">87380</span>] S=[<span class="number">16384</span>-&gt;<span class="number">16384</span>]</span><br><span class="line">Tue Nov <span class="number">19</span> <span class="number">13</span>:<span class="number">27</span>:<span class="number">27</span> <span class="number">2019</span> Listening <span class="keyword">for</span> incoming TCP connection on</span><br><span class="line">[AF_INET]<span class="number">172.18</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">1194</span></span><br><span class="line">Tue Nov <span class="number">19</span> <span class="number">13</span>:<span class="number">27</span>:<span class="number">27</span> <span class="number">2019</span> TCPv4_SERVER link local (bound):</span><br><span class="line">[AF_INET]<span class="number">172.18</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">1194</span></span><br><span class="line">Tue Nov <span class="number">19</span> <span class="number">13</span>:<span class="number">27</span>:<span class="number">27</span> <span class="number">2019</span> TCPv4_SERVER link remote: [AF_UNSPEC]</span><br><span class="line">Tue Nov <span class="number">19</span> <span class="number">13</span>:<span class="number">27</span>:<span class="number">27</span> <span class="number">2019</span> GID <span class="keyword">set</span> to root</span><br><span class="line">Tue Nov <span class="number">19</span> <span class="number">13</span>:<span class="number">27</span>:<span class="number">27</span> <span class="number">2019</span> UID <span class="keyword">set</span> to root</span><br><span class="line">Tue Nov <span class="number">19</span> <span class="number">13</span>:<span class="number">27</span>:<span class="number">27</span> <span class="number">2019</span> MULTI: multi_init called, r=<span class="number">256</span> v=<span class="number">256</span></span><br><span class="line">Tue Nov <span class="number">19</span> <span class="number">13</span>:<span class="number">27</span>:<span class="number">27</span> <span class="number">2019</span> IFCONFIG POOL: base=<span class="number">10.8</span><span class="number">.0</span><span class="number">.4</span> size=<span class="number">62</span>, ipv6=<span class="number">0</span></span><br><span class="line">Tue Nov <span class="number">19</span> <span class="number">13</span>:<span class="number">27</span>:<span class="number">27</span> <span class="number">2019</span> MULTI: TCP INIT maxclients=<span class="number">4096</span> maxevents=<span class="number">4100</span></span><br><span class="line">Tue Nov <span class="number">19</span> <span class="number">13</span>:<span class="number">27</span>:<span class="number">27</span> <span class="number">2019</span> Initialization Sequence Completed</span><br></pre></td></tr></table></figure><h2 id="OpenVPN客户端"><a href="#OpenVPN客户端" class="headerlink" title="OpenVPN客户端"></a>OpenVPN客户端</h2><p>&emsp;&emsp;官方客户端下载地址： <a href="https://openvpn.net/community-downloads/" rel="noopener" target="_blank">https://openvpn.net/community-downloads/</a><br>&emsp;&emsp;非官方地址：<a href="https://sourceforge.net/projects/securepoint/files/" rel="noopener" target="_blank">https://sourceforge.net/projects/securepoint/files/</a><br>&emsp;&emsp;如果是默认安装路径的话，保存证书到openvpn 客户端安装目录：C:\Program Files\OpenVPN\config<br>&emsp;&emsp;之后就可以直接启动OpenVPN。此时就可以用浏览器直接访问内网IP或者直接ssh登陆内部服务器了。</p>]]></content>
      
      
      <categories>
          
          <category> linux进阶 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 经验分享 </tag>
            
            <tag> OpenVPN </tag>
            
            <tag> SSH </tag>
            
            <tag> 科学上网 </tag>
            
            <tag> 企业级应用 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MSM实现tomcat集群的session共享</title>
      <link href="//blog/6254cc16.html"/>
      <url>//blog/6254cc16.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;tomcat作为一个应用服务器，单机性能上都是无法满足生产中需要的，而想要解决高并发场景，光靠提升单机性能，成本与效果肯定都是无法让人接受的，而此时我们一般都采用tomcat集群的方式，用多台tomcat服务器来共同支撑我们的业务。<br>&emsp;&emsp;但这时就出现了一个新的问题，那就是会话保持。因为每台tomcat服务器的session是独立的，当客户端被调度到一个新的tomcat服务器时，他无法识别之前一台的tomcat服务器分配的sessionID，于是对于此次访问，之前的会话信息就都没有了，这表现在用户的客户端就相当于，点开一个新的链接，就发现需要重新登陆，或者之前的购物车里的商品都不见了等等。这样的客户访问体验绝对不是我们想要的，所以我们需要实现会话保持功能！</p><a id="more"></a><h2 id="会话保持实现"><a href="#会话保持实现" class="headerlink" title="会话保持实现"></a>会话保持实现</h2><p>&emsp;&emsp;一般tomcat的会话保持有三种方案实现：</p><ul><li>nginx、httpd或者haproxy的调度实现session绑定,一般是源地址哈希方式实现<br>优点:简单易配置<br>缺点：<br>①如果目标服务器故障后,没有做持久化的话就会丢失session;<br>②即便做了持久化,当服务器故障后,nginx或者haproxy会不得不重新分配一个tomcat服务器,而这时因为新的tomcat服务器上没有原来的sessionID,所以无法找到相应会话信息,会重新分配一个sessionID给客户端,就算原来的tomcat服务器重新上线,又被分配到原来的tomcat服务器中,可此时客户端已经有了新的sessionID,也不会去读取最开始的session信息,那些会话信息就相当于永远丢失了。</li><li>session复制集群,官方给出的tomcat会话共享解决方案<br>&emsp;&emsp;tomcat自己提供的多播集群，通过多播将任何一台的session同步到其他节点。<br>缺点：<br>①tomcat的同步节点不宜过多，互相即时通信session需要太多带宽；<br>②每一台tomcat服务器都拥有全部session信息，内存占用太多。</li><li>session server<br>&emsp;&emsp;session 共享服务器，一般使用memcached、redis做共享的session服务器。<br>目前最理想的解决方案，不过会需要额外的机器来配置共享服务器。<h3 id="反向代理的session绑定"><a href="#反向代理的session绑定" class="headerlink" title="反向代理的session绑定"></a>反向代理的session绑定</h3>&emsp;&emsp;这种实现session保持的方案，一般是使用的不多，一般用于公司内部中的会话保持场景。只需在haproxy或者nginx中的调度算法中，加入基于源地址hash即可（调度算法参考<a href="https://hewanyue.com/blog/5aeb7732.html#haproxy调度算法">之前博客</a>）。于是，用户每次访问都会被调度到同一台tomcat服务器上，上面已有他的session信息，便实现了会话保持。<h4 id="配置实现"><a href="#配置实现" class="headerlink" title="配置实现"></a>配置实现</h4>&emsp;&emsp;我们用一台nginx服务器做反向代理，两台tomcat服务器来演示实现过程。</li></ul><p>&amp;gt nginx主机ip：192.168.32.207<br>&amp;gt tomcat主机1ip：192.168.32.231<br>&amp;gt tomcat主机2ip：192.168.32.232</p><p>&emsp;&emsp;将3台机子中的nginx或tomcat服务启动之后，分别检查80端口和8080端口是否都已监听，确保服务启动。</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">iptables</span> <span class="string">-F</span></span><br><span class="line"><span class="attr">getenforce</span> <span class="string">0</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;确保防火墙和SELinux设置不会干扰我们几台主机间的相互通信。<br>&emsp;&emsp;nginx主机反向代理的配置</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">upstream tomcat &#123;</span><br><span class="line">    #ip_hash; #先关闭原地址iphash，观察效果</span><br><span class="line">    server <span class="number">192.168</span><span class="number">.32</span><span class="number">.231</span>:<span class="number">8080</span> weight=<span class="number">1</span> fail_timeout=<span class="number">5</span>s max_fails=<span class="number">3</span>;</span><br><span class="line">    server <span class="number">192.168</span><span class="number">.32</span><span class="number">.232</span>:<span class="number">8080</span> weight=<span class="number">1</span> fail_timeout=<span class="number">5</span>s max_fails=<span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    index index.jsp</span><br><span class="line">#    server_name www.example.net;</span><br><span class="line">#    location ~* \.(jsp|<span class="keyword">do</span>)$ &#123;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http:<span class="comment">//tomcat;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;可启用主机名，也可不启用直接用端口访问。用域名访问还需要改DNS或者hosts设置，比较麻烦，我们就直接通过IP+端口访问就可以了。<br>&emsp;&emsp;tomcat服务器中可以新建一个host，也可使用原先的localhost默认主机。我们这次不用之前的localhost，而是自己新创建一个host标签，指定appBase在/data/myapp目录下。两个tomcat服务器都要执行如下操作：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim <span class="regexp">/apps/</span>tomcat<span class="regexp">/conf/</span>server.xml</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;找到<code>Engine标签</code>，将默认主机修改为<code>myapp</code></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;ltEngine <span class="attribute">name</span>=<span class="string">"Catalina"</span> <span class="attribute">defaultHost</span>=<span class="string">"myapp"</span>&amp;gt</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;找到<code>localhost</code>的<code>&amp;lt/Host&amp;gt</code>标签，在下面创建新的主机<code>myapp</code>,指定appBase为/data/myapp</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&amp;ltHost <span class="attribute">name</span>=<span class="string">"myapp"</span>  <span class="attribute">appBase</span>=<span class="string">"/data/myapp"</span></span><br><span class="line">      <span class="attribute">unpackWARs</span>=<span class="string">"true"</span> <span class="attribute">autoDeploy</span>=<span class="string">"true"</span>&amp;gt</span><br><span class="line">&amp;lt/Host&amp;gt</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;PS：Host name一般为主机域名，当一个tomcat中有多个host服务时，就是通过http报文请求头部的host信息来判断去访问哪个host服务的，当找不到对应的主机之后才访问<code>defaultHost</code>，我们这里因为只有启用了一个host，且为defaultHost，所以就无所谓，可以任意命名了，只需对应上就好。<br>&emsp;&emsp;之后我们要在/data/myapp目录下创建一个<code>ROOT</code>目录来作为tomcat访问的默认目录，注意<code>ROOT</code>是大写的。</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">mkdir</span> -p /<span class="class"><span class="keyword">data</span>/myapp/<span class="type">ROOT</span></span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;为了方便我们看到效果，我们编写index.jsp时，调用一些函数，方便我们看到我们访问的tomcat主机的IP和端口、sessionID、访问时间。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim <span class="regexp">/data/my</span>app<span class="regexp">/ROOT/i</span>ndex.jsp</span><br></pre></td></tr></table></figure><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">&amp;lt</span>%@ <span class="meta">page</span> import=<span class="string">"java.util.*"</span> %<span class="variable">&amp;gt</span></span><br><span class="line"><span class="variable">&amp;lt</span>!DOCTYPE html<span class="variable">&amp;gt</span></span><br><span class="line"><span class="variable">&amp;lthtml</span> lang=<span class="string">"en"</span><span class="variable">&amp;gt</span></span><br><span class="line"><span class="variable">&amp;lthead</span><span class="variable">&amp;gt</span></span><br><span class="line"><span class="variable">&amp;ltmeta</span> charset=<span class="string">"UTF-8"</span><span class="variable">&amp;gt</span></span><br><span class="line"><span class="variable">&amp;lttitle</span><span class="variable">&amp;gtlbjsptest</span><span class="variable">&amp;lt</span>/<span class="meta">title</span><span class="variable">&amp;gt</span></span><br><span class="line"><span class="variable">&amp;lt</span>/head<span class="variable">&amp;gt</span></span><br><span class="line"><span class="variable">&amp;ltbody</span><span class="variable">&amp;gt</span></span><br><span class="line"><span class="variable">&amp;ltdiv</span><span class="variable">&amp;gtOn</span> <span class="variable">&amp;lt</span>%=request.getServerName() %<span class="variable">&amp;gt</span><span class="variable">&amp;lt</span>/div<span class="variable">&amp;gt</span></span><br><span class="line"><span class="variable">&amp;ltdiv</span><span class="variable">&amp;gt</span><span class="variable">&amp;lt</span>%=request.getLoca<span class="meta">lAddr(</span>) + <span class="string">":"</span> + request.getLocalPort() %<span class="variable">&amp;gt</span><span class="variable">&amp;lt</span>/div<span class="variable">&amp;gt</span></span><br><span class="line"><span class="variable">&amp;ltdiv</span><span class="variable">&amp;gtSessionID</span> = <span class="variable">&amp;ltspan</span> style=<span class="string">"color:blue"</span><span class="variable">&amp;gt</span><span class="variable">&amp;lt</span>%=session.getId() %<span class="variable">&amp;gt</span><span class="variable">&amp;lt</span>/span<span class="variable">&amp;gt</span><span class="variable">&amp;lt</span>/div<span class="variable">&amp;gt</span></span><br><span class="line"><span class="variable">&amp;lt</span>%=new<span class="meta"> Date(</span>)%<span class="variable">&amp;gt</span></span><br><span class="line"><span class="variable">&amp;lt</span>/body<span class="variable">&amp;gt</span></span><br><span class="line"><span class="variable">&amp;lt</span>/html<span class="variable">&amp;gt</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;此时，我们访问nginx的80端口，就可以被反向代理到后端的两个tomcat服务器上去。而这时，是轮询的调度方式，也就是一边一次，可以看到访问的主机和sessionID都是一直在变化的。<br>效果如下图所示：<br><img src="https://img-blog.csdnimg.cn/20191122152145219.gif" alt="nginx轮询tomcat"></p><p>&emsp;&emsp;每一次的sessionID都没有重复过，这肯定不满足我们的需要。所以我们将nginx配置中#ip_hash;的#注释去掉，重启nginx服务，再看效果，如下图所示：<br><img src="https://img-blog.csdnimg.cn/20191122152346465.gif" alt="在这里插入图片描述"><br>&emsp;&emsp;可以看到，每次刷新，主机IP和sessionID都不再变化，说明绑定session成功。</p><h3 id="session复制集群"><a href="#session复制集群" class="headerlink" title="session复制集群"></a>session复制集群</h3><p>&emsp;&emsp;这是tomcat官方提供的解决方案，所有tomcat上都有全量的session，不过同步session信息会消耗带宽，而且所有服务器保存所有session信息也比较占用资源，对于tomcat这种本身就处于效率瓶颈的服务来说，高并发场景下超过若五个tomcat服务器，就不再建议使用。<br>&emsp;&emsp;配置详细可以参见<a href="https://tomcat.apache.org/tomcat-8.5-doc/cluster-howto.html" rel="noopener" target="_blank">官网配置说明</a>。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&amp;ltCluster <span class="attribute">className</span>=<span class="string">"org.apache.catalina.ha.tcp.SimpleTcpCluster"</span></span><br><span class="line">         <span class="attribute">channelSendOptions</span>=<span class="string">"8"</span>&amp;gt</span><br><span class="line"></span><br><span class="line">  &amp;ltManager <span class="attribute">className</span>=<span class="string">"org.apache.catalina.ha.session.DeltaManager"</span></span><br><span class="line">           <span class="attribute">expireSessionsOnShutdown</span>=<span class="string">"false"</span></span><br><span class="line">           <span class="attribute">notifyListenersOnReplication</span>=<span class="string">"true"</span>/&amp;gt</span><br><span class="line"></span><br><span class="line">  &amp;ltChannel <span class="attribute">className</span>=<span class="string">"org.apache.catalina.tribes.group.GroupChannel"</span>&amp;gt</span><br><span class="line">    &amp;ltMembership <span class="attribute">className</span>=<span class="string">"org.apache.catalina.tribes.membership.McastService"</span></span><br><span class="line">                <span class="attribute">address</span>=<span class="string">"228.0.0.4"</span></span><br><span class="line">                <span class="attribute">port</span>=<span class="string">"45564"</span></span><br><span class="line">                <span class="attribute">frequency</span>=<span class="string">"500"</span></span><br><span class="line">                <span class="attribute">dropTime</span>=<span class="string">"3000"</span>/&amp;gt</span><br><span class="line">    &amp;ltReceiver <span class="attribute">className</span>=<span class="string">"org.apache.catalina.tribes.transport.nio.NioReceiver"</span></span><br><span class="line">              <span class="attribute">address</span>=<span class="string">"auto"</span></span><br><span class="line">              <span class="attribute">port</span>=<span class="string">"4000"</span></span><br><span class="line">              <span class="attribute">autoBind</span>=<span class="string">"100"</span></span><br><span class="line">              <span class="attribute">selectorTimeout</span>=<span class="string">"5000"</span></span><br><span class="line">              <span class="attribute">maxThreads</span>=<span class="string">"6"</span>/&amp;gt</span><br><span class="line"></span><br><span class="line">    &amp;ltSender <span class="attribute">className</span>=<span class="string">"org.apache.catalina.tribes.transport.ReplicationTransmitter"</span>&amp;gt</span><br><span class="line">      &amp;ltTransport <span class="attribute">className</span>=<span class="string">"org.apache.catalina.tribes.transport.nio.PooledParallelSender"</span>/&amp;gt</span><br><span class="line">    &amp;lt/Sender&amp;gt</span><br><span class="line">    &amp;ltInterceptor <span class="attribute">className</span>=<span class="string">"org.apache.catalina.tribes.group.interceptors.TcpFailureDetector"</span>/&amp;gt</span><br><span class="line">    &amp;ltInterceptor <span class="attribute">className</span>=<span class="string">"org.apache.catalina.tribes.group.interceptors.MessageDispatchInterceptor"</span>/&amp;gt</span><br><span class="line">  &amp;lt/Channel&amp;gt</span><br><span class="line"></span><br><span class="line">  &amp;ltValve <span class="attribute">className</span>=<span class="string">"org.apache.catalina.ha.tcp.ReplicationValve"</span></span><br><span class="line">         <span class="attribute">filter</span>=<span class="string">""</span>/&amp;gt</span><br><span class="line">  &amp;ltValve <span class="attribute">className</span>=<span class="string">"org.apache.catalina.ha.session.JvmRouteBinderValve"</span>/&amp;gt</span><br><span class="line"></span><br><span class="line">  &amp;ltDeployer <span class="attribute">className</span>=<span class="string">"org.apache.catalina.ha.deploy.FarmWarDeployer"</span></span><br><span class="line">            <span class="attribute">tempDir</span>=<span class="string">"/tmp/war-temp/"</span></span><br><span class="line">            <span class="attribute">deployDir</span>=<span class="string">"/tmp/war-deploy/"</span></span><br><span class="line">            <span class="attribute">watchDir</span>=<span class="string">"/tmp/war-listen/"</span></span><br><span class="line">            <span class="attribute">watchEnabled</span>=<span class="string">"false"</span>/&amp;gt</span><br><span class="line"></span><br><span class="line">  &amp;ltClusterListener <span class="attribute">className</span>=<span class="string">"org.apache.catalina.ha.session.ClusterSessionListener"</span>/&amp;gt</span><br><span class="line">&amp;lt/Cluster&amp;gt</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;将官网上的这段集群配置，插入到两个tomcat服务器中我们创建的host标签中（也可插入引擎标签中，就相当于所有主机都生效），即<code>&amp;ltHost name</code>标签与<code>&amp;lt/Host&amp;gt</code>标签的中间。<br>&emsp;&emsp;配置说明：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Cluster</span> <span class="string">集群配置</span></span><br><span class="line"><span class="attr">Manager</span> <span class="string">会话管理器配置</span></span><br><span class="line"><span class="attr">Channel</span> <span class="string">信道配置</span></span><br><span class="line">        <span class="attr">Membership</span> <span class="string">成员判定。使用什么多播地址、端口多少、间隔时长ms、超时时长ms。同一个多播地址和端口认为同属一个组。使用时修改这个多播地址，以防冲突</span></span><br><span class="line">        <span class="attr">Receiver</span> <span class="string">接收器，多线程接收多个其他节点的心跳、会话信息。默认会从4000到4100依次尝试可用端口。</span></span><br><span class="line">        <span class="attr">address</span>=<span class="string">"auto"，auto可能绑定到127.0.0.1上，所以一定要改为可以用的IP上去</span></span><br><span class="line">        <span class="attr">Sender</span> <span class="string">多线程发送器，内部使用了tcp连接池。</span></span><br><span class="line">        <span class="attr">Interceptor</span> <span class="string">拦截器</span></span><br><span class="line"><span class="attr">ReplicationValve</span> <span class="string">检测哪些请求需要检测Session，Session数据是否有了变化，需要启动复制过程</span></span><br><span class="line"><span class="attr">ClusterSessionListener</span> <span class="string">集群session侦听器</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;复制完官方文档里的配置，我们还需要修改接收器的ip为本机ip，不能使用<code>auto</code>，否则会无法同步session信息。<br>&emsp;&emsp;此外，还需要在应用的web.xml文件中最后一行<code>&amp;lt/web-app&amp;gt</code>标签的上面一行插入子标签<code>&amp;ltdistributable/&amp;gt</code>表示可分配。<br>&emsp;&emsp;操作如下：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="regexp">/data/</span>myapp<span class="regexp">/ROOT/</span>WEB-INF</span><br><span class="line">cp <span class="regexp">/apps/</span>tomcat<span class="regexp">/conf/</span>web.xml <span class="regexp">/data/</span>myapp<span class="regexp">/ROOT/</span>WEB-INF/</span><br><span class="line">sed -i <span class="string">'/&amp;lt\/web-app&amp;gt/i&amp;ltdistributable/&amp;gt'</span> <span class="regexp">/data/</span>myapp<span class="regexp">/ROOT/</span>WEB-INF/web.xml</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;此时，如果我们将前端Nginx或者其他反向代理服务器中的源地址hash去掉，我们就可以看到，虽然访问的tomcat服务器在变化（服务器ip变化），而sessionID却是不变的，因为每个tomcat服务器上都有全量的相同的session信息。<br><img src="https://img-blog.csdnimg.cn/2019112217482979.gif" alt="集群tomcat"></p><h3 id="session-共享服务器"><a href="#session-共享服务器" class="headerlink" title="session 共享服务器"></a>session 共享服务器</h3><p>&emsp;&emsp;这种实现方式其实才是本文标题中真正的session共享，毕竟共享经济炒的很热，我们都知道，所谓共享，共用才叫共享，前面提到的那种tomcat集群里会话信息人手一份可不能称作是共享。于是乎，我们想到用将session放到外部存储，所有的tomcat服务器都去外部存储中去查找sessionID。<br>&emsp;&emsp;储存session信息肯定不能存储在磁盘文件中，这样的读取写入性能都会很慢，放在mysql数据库中或者以硬盘文件的方式保存，高并发场景下的读取写入速度都将会大打折扣。所以我们要使用类似memcached或者redis这种Key/Value的非关系型数据库里，也被称作NoSQL。<br>&emsp;&emsp;memcached和redis这种键值对型数据库的数据信息都是存储在内存中的，读写效率都很高，而且由于没有复杂的表关系，采用的是哈希算法，他们对于信息的查找都是O(1)，而不是类似mysql等数据库的O(n)，意思就是说耗时/耗空间与总数据量大小无关，不会随着数据量的增大导致查找时间几何倍数的增长。<br>&emsp;&emsp;但也因为memcached和redis的数据都是储存在内存中的，而且memcached还不支持持久化，所以我们一定要做好高可用，一旦发生故障，会话信息将立即丢失，几乎没有恢复的可能。<br>&emsp;&emsp;要实现tomcat共享session服务器，首先，我们要让tomcat将session储存到memcached或者redis等外部存储上，这就需要我们对tomcat进行配置，其次我们要将session信息序列化为变为字节流以便能储存在session服务器中，还要能将session服务器中的数据反序列化为可以识别的session信息，最后，当然我们还需要一个客户端来跟后端的session服务器通信，才能将数据写入和读取。<br>&emsp;&emsp;这想实现确实也比较复杂，不过在github已有开源解决方案（网址是<a href="https://github.com/magro/memcached-session-manager" rel="noopener" target="_blank">https://github.com/magro/memcached-session-manager</a>），memcached-session-manager，简称msm，后端采用memcached或者redis都可以（之前只支持memcached，因而得名msm，后来支持redis后，人们还是习惯叫它msm），且已经完成了对tomcat的session共享的配置支持（支持tomcat6.X、7.X、8.X、9.X），我们直接去下载对应版本的去使用就可以了。<br>&emsp;&emsp;根据项目的介绍文档，我们知道，想实现tomcat的session共享，我们至少需要配套的工具有：</p><ul><li>tomcat的session管理工具 memcached-session-manager</li><li>与session服务器通信的客户端<br>如果是memcached，则建议使用spymemcached.jar<br>如果是redis，则建议使用jedis.jar</li><li>将session信息序列化的工具，作者推荐使用kryo。</li></ul><p>&emsp;&emsp;这些工具官网上也都提供了下载链接，我们直接下载下来即可。<br>&emsp;&emsp;kryo如下图所示<br><img src="https://img-blog.csdnimg.cn/20191122212611125.png" alt="kryo"><br>&emsp;&emsp;其他工具包如下图所示<br><img src="https://img-blog.csdnimg.cn/20191122212642803.png" alt="msm"><br>&emsp;&emsp;将这些jar包统统拷贝到tomcat服务器的lib目录下（改变lib目录下的jar包需重启tomcat服务才能生效）<br>&emsp;&emsp;使用msm搭建session共享服务器，如果后端为memcached，则有两种模式可以选，分别是sticky模式和non-sticky模式，后端为redis，则使用类似non-sticky模式。</p><h4 id="sticky模式"><a href="#sticky模式" class="headerlink" title="sticky模式"></a>sticky模式</h4><p>&emsp;&emsp;以两台服务器为例，将tomcat1和memcached1部署在一台服务器上（简称为t1、m1），tomcat2和memcached2部署在另一台服务器上（简称为t2、m2）为例，结构图如下图所示。</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">&amp;ltt1</span><span class="variable">&amp;gt</span>   <span class="variable">&amp;ltt2</span><span class="variable">&amp;gt</span></span><br><span class="line">  . \ / .</span><br><span class="line">  .  <span class="meta">X</span>  .</span><br><span class="line">  . / \ .</span><br><span class="line"><span class="variable">&amp;ltm1</span><span class="variable">&amp;gt</span>   <span class="variable">&amp;ltm2</span><span class="variable">&amp;gt</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;实现原理：当请求结束时Tomcat的session会送给memcached备份。即Tomcat session为主session，memcached session为备session，使用memcached相当于备份了一份Session。查询Session时Tomcat会优先使用自己内存的Session，Tomcat通过jvmRoute发现不是自己的Session，便从memcached中找到该Session，更新本机Session，请求完成后更新memcached。<br>&emsp;&emsp;可能有的朋友看的一头雾水，这到底是个什么结构。其实很简单，sticky模式就是t1的session信息还是储存在t1上，不过以m2为备用数据库，t2的session信息也是放在t2中储存，以m1服务器为备用服务器。这就意味着，用户在访问t1时，是从t1获取session信息，当t1挂掉或者整个节点1服务器挂掉之后，用户会被调度到t2上，而t2本地中没有session信息时，就会去m2中上找相关sessionID，而m2因为是t1的备用存储，所以有跟t1完全相同的session信息，于是用户的sessionID就可以被t2识别；而当m2备用存储服务挂掉之后，t1服务会通过检测发现自己没有备用存储，就会自动将m1也指定为自己的备用存储，将备份信息也同步至m1中，于是用户若再从t2访问时，虽然因为m2挂掉，其中的数据都无法访问，但t2就可以从m1上读取到对应的sessionID并同步到t2本身的存储中，也可以保持之前的会话信息。<br>&emsp;&emsp;修改的配置也很简单，依照官网说明，将下面的代码标签插入<code>/conf/context.xml</code>文件中的<code>context标签</code>结尾就可以了</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&amp;ltManager className=<span class="string">"de.javakaffee.web.msm.MemcachedBackupSessionManager"</span></span><br><span class="line">memcachedNodes=<span class="string">"n1:192.168.32.231:11211,n2:192.168.32.232:11211"</span></span><br><span class="line">failoverNodes=<span class="string">"n1"</span></span><br><span class="line">requestUriIgnorePattern=<span class="string">".*\.(ico|png|gif|jpg|css|js)$"</span></span><br><span class="line">transcoderFactoryClass=<span class="string">"de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory"</span></span><br><span class="line">/&amp;gt</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;n1、n2只是memcached的节点别名，可以重新命名。<br>failoverNodes是指故障转移节点，也就是发生故障之后的备用节点，所以在n1节点上，n1是备用节点，n2是主存储节点。另一台Tomcat中配置将failoverNodes改为n2，意思是其主节点是n1，备用节点是n2。<br>若配置成功，在/apps/tomcat/log/catalina.out文件中看到如下信息。</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -n <span class="number">20</span> /apps/tomcat/logs/catalina.<span class="keyword">out</span></span><br></pre></td></tr></table></figure><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">23-Nov-2019 13:35:54.187 INFO [myapp-startStop-1] de.javakaffee.web.msm.MemcachedSessionService.startInternal --------</span><br><span class="line"><span class="bullet">-  </span>finished initialization:</span><br><span class="line"><span class="bullet">- </span>sticky: true</span><br><span class="line"><span class="bullet">- </span>operation timeout: 1000</span><br><span class="line"><span class="bullet">- </span>node ids: [n1]</span><br><span class="line"><span class="bullet">- </span>failover node ids: [n2]</span><br><span class="line"><span class="bullet">- </span>storage key prefix: null</span><br><span class="line"><span class="bullet">- </span>locking mode: null (expiration: 5s)</span><br><span class="line">--------</span><br></pre></td></tr></table></figure><p>此时在访问我们的前端代理（取消ipHASH绑定）就会看到下面界面，将节点2 关机，可以看到访问ip固定为192.168.32.231，而使用的memcached变成了n1节点。<br><img src="https://img-blog.csdnimg.cn/20191123194433405.gif" alt="tomcatsticky"></p><h4 id="non-sticky模式"><a href="#non-sticky模式" class="headerlink" title="non-sticky模式"></a>non-sticky模式</h4><p>&emsp;&emsp;从msm 1.4.0之后开始支持non-sticky模式。<br>Tomcat session为中转Session，如果n1为主session，n2为备session，则产生的新的Session会发送给主、备memcached，并清除本地Session，也就是说tomcat本身不储存session信息，只负责产生session。<br>&emsp;&emsp;需要注意的是，如果n1下线，n2转换为主节点。n1再次上线，n2依然是主Session存储节点。<br>&emsp;&emsp;配置方法与sticky大致相同，不过在<code>/conf/context.xml</code>文件中的<code>context标签</code>结尾插入代码略有不同，具体代码如下</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&amp;ltManager className=<span class="string">"de.javakaffee.web.msm.MemcachedBackupSessionManager"</span></span><br><span class="line">memcachedNodes=<span class="string">"n1:192.168.32.231:11211,n2:192.168.32.232:11211"</span></span><br><span class="line">sticky=<span class="string">"false"</span></span><br><span class="line">sessionBackupAsync=<span class="string">"false"</span></span><br><span class="line">lockingMode=<span class="string">"uriPattern:/path1|/path2"</span></span><br><span class="line">requestUriIgnorePattern=<span class="string">".*\.(ico|png|gif|jpg|css|js)$"</span></span><br><span class="line">transcoderFactoryClass=<span class="string">"de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory"</span></span><br><span class="line">/&amp;gt</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;重启tomcat服务后生效。此时在/apps/tomcat/log/catalina.out文件中看到如下信息。</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -n <span class="number">20</span> /apps/tomcat/logs/catalina.<span class="keyword">out</span></span><br></pre></td></tr></table></figure><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">23-Nov-2019 13:43:05.863 INFO [myapp-startStop-1] de.javakaffee.web.msm.MemcachedSessionService.startInternal --------</span><br><span class="line"><span class="bullet">-  </span>finished initialization:</span><br><span class="line"><span class="bullet">- </span>sticky: false</span><br><span class="line"><span class="bullet">- </span>operation timeout: 1000</span><br><span class="line"><span class="bullet">- </span>node ids: [n1, n2]</span><br><span class="line"><span class="bullet">- </span>failover node ids: []</span><br><span class="line"><span class="bullet">- </span>storage key prefix: null</span><br><span class="line"><span class="bullet">- </span>locking mode: uriPattern:/path1|/path2 (expiration: 5s)</span><br><span class="line">--------</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;再次尝试访问负载代理服务器，发现同样实现了访问tomcatIP变化，sessionID不变，说明配置成功。<br>&emsp;&emsp;而后端使用redis作为session共享服务器时，仅支持non-stricky模式。建议用另外的服务器安装redis服务，并修改监听IP后启动，tomcat服务器中将<code>jedis.jar</code>jar包拷贝至tomcat安装路径下<code>lib目录</code>，同样在<code>/conf/context.xml</code>文件中的<code>context标签</code>结尾插入下面的代码即可（例如redis服务器IP端口为192.168.32.233:6379，可配置redis集群，可参考我之前博客<a href="https://hewanyue.com/blog/14b8983d.html">redis高可用配置</a>）。</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&amp;ltManager className=<span class="string">"de.javakaffee.web.msm.MemcachedBackupSessionManager"</span></span><br><span class="line">memcachedNodes=<span class="string">"redis://192.168.32.233:6379"</span></span><br><span class="line">sticky=<span class="string">"false"</span></span><br><span class="line">sessionBackupAsync=<span class="string">"false"</span></span><br><span class="line">lockingMode=<span class="string">"uriPattern:/path1|/path2"</span></span><br><span class="line">requestUriIgnorePattern=<span class="string">".*\.(ico|png|gif|jpg|css|js)$"</span></span><br><span class="line">transcoderFactoryClass=<span class="string">"de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory"</span></span><br><span class="line">/&amp;gt</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> tomcat </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tomcat </tag>
            
            <tag> redis </tag>
            
            <tag> 集群 </tag>
            
            <tag> MSM </tag>
            
            <tag> session </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux上部署与配置tomcat</title>
      <link href="//blog/b365780e.html"/>
      <url>//blog/b365780e.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;Tomcat 服务器是一个免费的开放源代码的Web 应用服务器，属于轻量级应用服务器。因为Tomcat 技术先进、性能稳定，而且免费，因而深受Java 爱好者的喜爱并得到了部分软件开发商的认可，成为目前比较流行的Web 应用服务器。本文将详细讲解tomcat在linux环境(以CentOS为例)中的安装与配置。</p><a id="more"></a><h3 id="安装jdk"><a href="#安装jdk" class="headerlink" title="安装jdk"></a>安装jdk</h3><p>&emsp;&emsp;JDK是java Development Kit的缩写，即java语言的软件开发包，是javac、javap、jdb等开发、调试、编译工具。<br>&emsp;&emsp;OpenJDK是Sun公司采用GPL v2协议发布的JDK开源版本，可以用于商业用途，于2009年正式发布。它是基于JDK7的beta版开发，但为了也将java SE 6开源，从OpenJDK7的b20构建反向分之开发，从中剥离了不符合java SE 6规范的代码，发布了OpenJDK 6。所以OpenJDK6和JDK6没有关系。<br>&emsp;&emsp;在CentOS中，可以选择yum安装openjdk</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install java<span class="number">-1.8</span><span class="number">.0</span>-openjdk</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;通过<code>java -version</code>可以看到版本信息为</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openjdk version <span class="string">"1.8.0_212"</span></span><br><span class="line">OpenJDK Runtime Environment (build 1.8,0_212-b04)</span><br><span class="line">OpenJDK 64-Bit<span class="built_in"> Server </span>VM (build 25.212-b04,mixed mode)</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;也可以去Oracle官网下载JDK 8的rpm包安装（需要注册）</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install jdk<span class="number">-8</span>u191-linux-x64,rpm</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;而通过<code>java -version</code>看到版本信息为</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]#  java -version</span><br><span class="line">java version <span class="string">"1.8.0_231"</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_231-b11)</span><br><span class="line">Java HotSpot(TM) 64-Bit<span class="built_in"> Server </span>VM (build 25.231-b11, mixed mode)</span><br></pre></td></tr></table></figure><h3 id="部署tomcat"><a href="#部署tomcat" class="headerlink" title="部署tomcat"></a>部署tomcat</h3><p>&emsp;&emsp;确定JDK版本之后，我们就可以准备开始部署tomcat了。<br>&emsp;&emsp;首先要去<a href="https://tomcat.apache.org/" rel="noopener" target="_blank">官网</a>下载源码包，国内用的是清华大学的镜像下载地址，下载速度还是可以接受的。<br>&emsp;&emsp;生产中我们一般不会选用最新版的tomcat9，而是选用tomcat8更为稳妥。tomcat8的下载链接是<a href="http://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-8/v8.5.47/bin/apache-tomcat-8.5.47.tar.gz" rel="noopener" target="_blank">http://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-8/v8.5.47/bin/apache-tomcat-8.5.47.tar.gz</a></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="regexp">//mi</span>rrors.tuna.tsinghua.edu.cn<span class="regexp">/apache/</span>tomcat<span class="regexp">/tomcat-8/</span>v8.<span class="number">5.47</span><span class="regexp">/bin/</span>apache-tomcat-<span class="number">8.5</span>.<span class="number">47</span>.tar.gz</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;解压到想要安装的任意指定目录，例如<code>/apps/tomcat/</code>目录</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xvf apache-tomcat-<span class="number">8.5</span>.<span class="number">47</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span> -C /apps/</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;更改目录名称(也可以用软连接方式)。</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /apps/apache-tomcat<span class="number">-8.5</span><span class="number">.47</span> /apps/tomcat</span><br></pre></td></tr></table></figure><h3 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h3><p>&emsp;&emsp;jdk需要配置环境变量才可以找到，否则会无法访问jsp文件。<br>&emsp;&emsp;需要在环境变量配置文件中加入</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">JAVA_HOME</span>=/usr/java/default</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">PATH</span>=<span class="variable">$JAVA_HOME</span>/bin:$PATH</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;于是，运行下面命令即可</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/profile.d/jdk.sh &lt;&lt;<span class="string">"END"</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">JAVA_HOME</span>=/usr/java/default</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">PATH</span>=<span class="variable">$JAVA_HOME</span>/bin:$PATH</span><br><span class="line">END</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;运行命令使环境变量生效</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">. /etc/<span class="keyword">profile</span>.d/jdk.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure><h3 id="修改进程属主"><a href="#修改进程属主" class="headerlink" title="修改进程属主"></a>修改进程属主</h3><p>&emsp;&emsp;一般来说，tomcat服务如果以root身份启动，风险还是很高的，因为tomcat本身bug还是有不少的，如果被别有用心之人加以利用，入侵进来，就可以获得root权限，这造成的后果绝对是灾难级的，这甚至会威胁到其他服务器的安全。为了规避这一风险，我们一般都会将tomcat服务以一个系统用户的身份启动，例如java用户。<br>&emsp;&emsp;创建java用户<code>useradd -r java</code><br>&emsp;&emsp;更改服务目录的属主属组<code>chown -R tomcat/*</code><br>&emsp;&emsp;启动服务时，我们使用命令<code>su - java -c &#39;/apps/tomcat/bin/startup.sh&#39;</code>来启动，就可以以java用户的身份来启动进程了。</p><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>&emsp;&emsp;tomcat中配置文件目录在tomcat/conf/server.xml,其中需要注意的是：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Server <span class="attribute">port</span>=<span class="string">"8005"</span> <span class="attribute">shutdown</span>=<span class="string">"SHUTDOWN"</span>&gt;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;这代表管理端监听在8005端口，向管理端发送<code>SHUTDOWN</code>指令就会是tomcat直接终止，而且这是不需要密码权限控制的。如果在生产环境中，如果有任何人有意或者无意向tomcat服务器的8005端口发送了SHUTDOWN指令，整个服务都会被终止掉，，而且还不需要密码验证，这对我们的影响无疑是巨大的，所以我们通常都会将此处的管理监听端口改掉，或将shutdown指令设为别的复杂口令，让别人无法轻易或不小心将我们的服务器shutdown~<br>&emsp;&emsp;可采取MD5值的方式，选任一文件做MD5运算后得到的随机数值即为口令。</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">"s@SHUTDOWN@`md5sum /root/.ssh/authorized_keys |cut -d' ' -f1`@"</span> tomcat/conf/server.xml</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;此时，就可以通过安装目录下的<code>tomcat/bin/startup.sh</code>来启动tomcat服务了。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">su</span> - java -c <span class="string">' /apps/tomcat/bin/startup.sh'</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;然后查看端口</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ss -tanl</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;即可看到8080端口已经处于监听状态了</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>localhost ~]# ss -tanl</span><br><span class="line">State       Recv-Q Send-Q                     Local Address:Port                                    Peer Address:Port              </span><br><span class="line">LISTEN      <span class="number">0</span>      <span class="number">128</span>                                    *:<span class="number">22</span>                                                 *:*                  </span><br><span class="line">LISTEN      <span class="number">0</span>      <span class="number">100</span>                            <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">25</span>                                                 *:*                  </span><br><span class="line">LISTEN      <span class="number">0</span>      <span class="number">100</span>                                   :::<span class="number">8009</span>                                              :::*                  </span><br><span class="line">LISTEN      <span class="number">0</span>      <span class="number">100</span>                                   :::<span class="number">8080</span>                                              :::*                  </span><br><span class="line">LISTEN      <span class="number">0</span>      <span class="number">128</span>                                   :::<span class="number">22</span>                                                :::*                  </span><br><span class="line">LISTEN      <span class="number">0</span>      <span class="number">100</span>                                  ::<span class="number">1</span>:<span class="number">25</span>                                                :::*                  </span><br><span class="line">LISTEN      <span class="number">0</span>      <span class="number">1</span>                       ::ffff:<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8005</span>                                              :::*                  </span><br><span class="line">[<span class="symbol">root@</span>localhost ~]#</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;访问tomcat服务器的ip的8080端口，可看到如下图所示界面，即表示tomcat安装成功。<br><img src="https://img-blog.csdnimg.cn/20191121170929214.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;不过，想使用tomcat自带的Manager App及Host Manager工具，还需要做一些额外的配置,此时如果直接访问会显示403权限拒绝，如下图所示。<br><img src="https://img-blog.csdnimg.cn/20191121192147674.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h4 id="修改应用访问控制"><a href="#修改应用访问控制" class="headerlink" title="修改应用访问控制"></a>修改应用访问控制</h4><p>&emsp;&emsp;错误提示说明已经说得很明白了，首先确保已经修改了应用的反问控制权限，，如果还没有，you’ll need to edit the Manager’s <code>context.xml</code> file。<br>&emsp;&emsp;那这个context.xml在哪里呢？它是指应用的上下文设置文件，路径就是tomcat目录下的<code>webapps/manager/META-INF/context.xml</code>文件，另一个应用Host Manager的路径就是tomcat目录下的<code>webapps/host-manager/META-INF/context.xml</code><br>&emsp;&emsp;所以我们要修改这两个配置文件中的访问控制，将我们的访问IP加到里面，这样我们的访问IP才有权限去访问这两个管理应用。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Context <span class="attribute">antiResourceLocking</span>=<span class="string">"false"</span> <span class="attribute">privileged</span>=<span class="string">"true"</span> &gt;</span><br><span class="line">  &lt;Valve <span class="attribute">className</span>=<span class="string">"org.apache.catalina.valves.RemoteAddrValve"</span></span><br><span class="line">         <span class="attribute">allow</span>=<span class="string">"127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1|172.18.*|192.168.32.*"</span> /&gt;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;在<code>allow=</code>标签后面，加上我们的ip，支持通配符写法和PCRE格式的正则表达式写法，用<code>|</code>隔开。两个应用的配置文件都要修改。</p><h4 id="创建权限角色"><a href="#创建权限角色" class="headerlink" title="创建权限角色"></a>创建权限角色</h4><p>光将我们的来访IP加入许可白名单还是不够的，我们还需要一个有权限的账户才可以访问这些管理工具<br>路径是tomcat目录下的<code>conf/tomcat-users.xml</code>文件。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;tomcat-users <span class="attribute">xmlns</span>=<span class="string">"http://tomcat.apache.org/xml"</span></span><br><span class="line">              xmlns:<span class="attribute">xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">              xsi:<span class="attribute">schemaLocation</span>=<span class="string">"http://tomcat.apache.org/xml tomcat-users.xsd"</span></span><br><span class="line">              <span class="attribute">version</span>=<span class="string">"1.0"</span>&gt;</span><br><span class="line">    &lt;role <span class="attribute">rolename</span>=<span class="string">"manager-gui"</span>/&gt;</span><br><span class="line">    &lt;role <span class="attribute">rolename</span>=<span class="string">"admin-gui"</span>/&gt;</span><br><span class="line">    &lt;user <span class="attribute">username</span>=<span class="string">"admin"</span> <span class="attribute">password</span>=<span class="string">"123456"</span> <span class="attribute">roles</span>=<span class="string">"manager-gui,admin-gui"</span>/&gt;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;在下面加入后三行，先创建角色<code>&quot;manager-gui&quot;</code>和<code>&quot;admin-gui&quot;</code>,分别是Manager App的管理员和Host Manager的管理员。然后设置用户名密码及其所处的角色，也可以设置两个不同的用户来分别充当这两个角色。用户名密码可自行设置。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;role <span class="attribute">rolename</span>=<span class="string">"manager-gui"</span>/&gt;</span><br><span class="line">&lt;role <span class="attribute">rolename</span>=<span class="string">"admin-gui"</span>/&gt;</span><br><span class="line">&lt;user <span class="attribute">username</span>=<span class="string">"admin"</span> <span class="attribute">password</span>=<span class="string">"123456"</span> <span class="attribute">roles</span>=<span class="string">"manager-gui,admin-gui"</span>/&gt;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;有了管理员权限的账户，在被允许的客户端上就可以访问<code>Manager App</code>和<code>Host Manager</code>这两个工具了。点击图标访问，出现如下图所示的提示输入用户名密码弹窗，说明配置正确。<br><img src="https://img-blog.csdnimg.cn/20191121185100783.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h3 id="附-一键部署tomcat脚本"><a href="#附-一键部署tomcat脚本" class="headerlink" title="附:一键部署tomcat脚本"></a>附:一键部署tomcat脚本</h3><p>&emsp;&emsp;附上我自己用的tomcat脚本供大家参考(未配置管理工具)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">DST=<span class="string">"/apps"</span></span><br><span class="line">[ -a jdk-8u231-linux-x64.rpm ] || &#123; <span class="built_in">echo</span> <span class="string">' the absence of jdk'</span> ;<span class="built_in">exit</span> 1;&#125;</span><br><span class="line">[ -d <span class="variable">$DST</span>/*tomcat* ] &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">"tomcat is aready installed into <span class="variable">$DST</span>/tomcat"</span> ;<span class="built_in">exit</span> 2;&#125;</span><br><span class="line">id java &amp;&gt;/dev/null &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">'user java is exist,redis is aready installed'</span> ; <span class="built_in">exit</span> 3;&#125;</span><br><span class="line">iptables -F</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line">sed -i <span class="string">'@SELINUX=enforcing@SELINUX=disabled@'</span> /etc/selinux/config</span><br><span class="line">setenforce 0</span><br><span class="line">mkdir -p /data<span class="variable">$DST</span></span><br><span class="line"><span class="comment">#mkdir -p $DST</span></span><br><span class="line">ln -s /data<span class="variable">$DST</span> <span class="variable">$DST</span></span><br><span class="line">yum install jdk-8u231-linux-x64.rpm</span><br><span class="line">tar xf *tomcat-*.tar.* -C <span class="variable">$DST</span>/</span><br><span class="line">mv <span class="variable">$DST</span>/*tomcat-* <span class="variable">$DST</span>/tomcat</span><br><span class="line">sed -i <span class="string">"s@SHUTDOWN@`md5sum /root/.ssh/authorized_keys |cut -d' ' -f1`@"</span> <span class="variable">$DST</span>/tomcat/conf/server.xml</span><br><span class="line">cat &gt; /etc/profile.d/jdk.sh &lt;&lt;<span class="string">"END"</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/java/default</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line">END</span><br><span class="line">. /etc/profile.d/jdk.sh</span><br><span class="line">useradd -r java</span><br><span class="line">chown -R java.java <span class="variable">$DST</span>/tomcat/*</span><br><span class="line">su - java -c <span class="string">'$DST/tomcat/bin/startup.sh'</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> tomcat </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> 企业级应用 </tag>
            
            <tag> tomcat </tag>
            
            <tag> 一键安装 </tag>
            
            <tag> JAVA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redis高可用配置</title>
      <link href="//blog/14b8983d.html"/>
      <url>//blog/14b8983d.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;redis高可用一般有两种方式实现：哨兵和集群。在哨兵 sentinel 机制中，可以解决 redis 高可用的问题， 即当 master 故障后可以自动将 slave 提升为 master 从而可以保证 redis 服务的正常使用，但是无法解决 redis 单机写入的瓶颈问题， 即单机的 redis 写入性能受限于单机的内存大小、 并发数量、 网卡速率等因素。<br>&emsp;&emsp;redis 官方在 redis 3.0 版本之后推出了无中心架构的 redis cluster机制， 在无中心的 redis 集群当中，其每个节点保存当前节点数据和整个集群状态,每个节点都和其他所有节点连接， 特点如下：</p><a id="more"></a><p>&emsp;&emsp;1：所有 Redis 节点使用(PING 机制)互联。<br>&emsp;&emsp;2：集群中某个节点的失效， 是整个集群中超过半数的节点监测都失效才算真正的失效（类似Sdown和Odown） 。<br>&emsp;&emsp;3：客户端不需要 proxy 即可直接连接 redis， 应用程序需要写全部的 redis 服务器 IP。<br>&emsp;&emsp;4：redis cluster 把所有的 redis node 映射到 0-16383 个槽位(slot)上， 读写需要到指定的 redis node 上进行操作，因此有多少个 reids node 相当于 redis 并发扩展了多少倍。<br>&emsp;&emsp;5：Redis cluster 预先分配 16384 个(slot)槽位，当需要在 redis 集群中写入一个 key -value 的时候，会使用 CRC16(key) mod 16384 之后的值，决定将 key 写入值哪一个槽位从而决定写入哪一个 Redis 节点上， 从而有效解决单机瓶颈。</p><h3 id="Sentinel-哨兵"><a href="#Sentinel-哨兵" class="headerlink" title="Sentinel(哨兵)"></a>Sentinel(哨兵)</h3><h4 id="手动配置主从"><a href="#手动配置主从" class="headerlink" title="手动配置主从"></a>手动配置主从</h4><p>&emsp;&emsp;需要手动先指定某一台 Redis 服务器为 master，然后将其他 slave 服务器修改配置文件或使用命令配置为 master 服务器的 slave。哨兵的前提是已经手动实现了一个 redis master-slave 的运行环境。<br>&emsp;&emsp;例如我们将192.168.32.81上的redis服务设置为master，192.168.32.82、192.168.32.83设置为slave，192.168.32.81中配置文件masterauth 设置为123456<br>&emsp;&emsp;在192.168.32.82上设置主节点信息<code>SLAVEOF 192.168.32.81 6379</code>(redis5版本命令为<code>REPLICAOF 192.168.7.101 6379</code>)</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">192.168.32.82:6379&gt; SLAVEOF 192.168.32.81 6379</span><br><span class="line">OK</span><br><span class="line">192.168.32.82:6379&gt;<span class="built_in"> CONFIG </span><span class="builtin-name">SET</span> masterauth <span class="string">"123456"</span></span><br><span class="line">OK</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;同样,192.168.32.83也要设置主节点信息及密码</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">192.168.7.103:6379&gt; SLAVEOF 192.168.7.101 6379</span><br><span class="line">OK</span><br><span class="line">192.168.7.103:6379&gt;<span class="built_in"> CONFIG </span><span class="builtin-name">SET</span> masterauth <span class="string">"123456"</span></span><br><span class="line">OK</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;此时通过<code>info Replication</code>命令，在两个从节点上可以看到角色已变更为slave,且<code>master_link_status</code>状态要为up，说明主从结构配置完成。</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; info Replication</span><br><span class="line"># Replication</span><br><span class="line">role:slave</span><br><span class="line">master_host:<span class="number">192.168</span><span class="number">.32</span><span class="number">.81</span></span><br><span class="line">master_port:<span class="number">6379</span></span><br><span class="line">master_link_status:up</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;需要注意的是：不同的 redis 版本之间存在兼容性问题， 因此各 master 和 slave 之间必须保持版本一致，且redis slave 也要开启持久化并设置和 master 同样的连接密码，此外，如果开启了安全模式，未设置密码的话也会导致主从无法连接。</p><h4 id="配置Sentinel"><a href="#配置Sentinel" class="headerlink" title="配置Sentinel"></a>配置Sentinel</h4><p>&emsp;&emsp;哨兵可以不和 Redis 服务器部署在一起。可以使用另外不同的机子，一般采用单数个哨兵（至少3个）。不过为了节约服务器，我们还是和redis服务器部署到一起。<br>&emsp;&emsp;3个机子都手动添加Sentinel配置文件<br>&emsp;&emsp;<code>vim /apps/redis/etc/sentinel.conf</code></p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">bind <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">port <span class="number">26379</span></span><br><span class="line">daemonize yes</span><br><span class="line">pidfile <span class="string">"redis-sentinel.pid"</span></span><br><span class="line">logfile <span class="string">"sentinel_26379.log"</span></span><br><span class="line">dir <span class="string">"/usr/local/redis"</span></span><br><span class="line">sentinel monitor mymaster <span class="number">192.168</span><span class="number">.32</span><span class="number">.81</span> <span class="number">6379</span> <span class="number">2</span> #法定人数限制(quorum)，即有几个slave 认为 master down 了就进行故障转移</span><br><span class="line">sentinel auth-pass mymaster <span class="number">123456</span></span><br><span class="line">sentinel down-after-milliseconds mymaster <span class="number">30000</span> #(SDOWN)主观下线的时间</span><br><span class="line">sentinel parallel-syncs mymaster <span class="number">1</span> #发生故障转移时候同时向新 master 同步数据的slave 数量， 数字越小总同步时间越长</span><br><span class="line">sentinel failover-timeout mymaster <span class="number">180000</span> #所有 slaves 指向新的 master 所需的超时时间</span><br><span class="line">sentinel deny-scripts-reconfig yes #禁止修改脚本</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;通过<code>/apps/redis/bin/redis-sentinel /apps/redis/etc/sentinel.conf</code>命令指定配置文件，启动哨兵，此时通过<code>ss -tanl</code>命令可以看到已监听26379端口，说明哨兵服务已启动。</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>CentOS8 ~]# redis-cli -h <span class="number">192.168</span><span class="number">.32</span><span class="number">.81</span> -p <span class="number">26379</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.81</span>:<span class="number">26379</span>&gt; info Sentinel</span><br><span class="line"># Sentinel</span><br><span class="line">sentinel_masters:<span class="number">1</span></span><br><span class="line">sentinel_tilt:<span class="number">0</span></span><br><span class="line">sentinel_running_scripts:<span class="number">0</span></span><br><span class="line">sentinel_scripts_queue_length:<span class="number">0</span></span><br><span class="line">sentinel_simulate_failure_flags:<span class="number">0</span></span><br><span class="line">master0:name=mymaster,status=ok,address=<span class="number">192.168</span><span class="number">.32</span><span class="number">.81</span>:<span class="number">6379</span>,slaves=<span class="number">2</span>,sentinels=<span class="number">3</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;可以通过<code>redis-cli</code>指定26379端口连接哨兵服务器，<code>info Sentinel</code>查看哨兵状态，显示<code>status=ok，slaves=2，sentinels=3</code>，与我们之前设计的相同，说明哨兵服务正常。<br>&emsp;&emsp;此时，当master故障后，哨兵会通过投票机制，选举一个slave作为新的master，继续实现主从结构，而程序应用也会在主从切换的时候收到通知，Jedis 会进行连接的切换（在 JedisPool 中添加了 Sentinel 和MasterName 参数， JRedis Sentinel 底层基于 Redis 订阅实现 Redis 主从服务的切换通知， 当 Reids 发生主从切换时， Sentinel 会发送通知主动通知 Jedis 进行连接的切换， JedisSentinelPool 在每次从连接池中获取链接对象的时候,都要对连接对象进行检测,如果此链接和 Sentinel 的 Master 服务连接参数不一致,则会关闭此连接,重新获取新的 Jedis 连接对象。），实现redis的高可用。</p><h3 id="Redis-Cluster"><a href="#Redis-Cluster" class="headerlink" title="Redis Cluster"></a>Redis Cluster</h3><p>&emsp;&emsp;在哨兵 sentinel 机制中，可以解决 redis 高可用的问题， 即当 master 故障后可以自动将 slave 提升为 master 从而可以保证 redis 服务的正常使用，但是无法解决 redis 单机写入的瓶颈问题， 即单机的 redis 写入性能受限于单机的内存大小、 并发数量、 网卡速率等因素，所以Redis自带的Cluster就是很好的一个解决方案。</p><h4 id="集群前提"><a href="#集群前提" class="headerlink" title="集群前提"></a>集群前提</h4><p>&emsp;&emsp;1.每个 redis node 节点采用相同的硬件配置、相同的密码、 相同的 redis 版本。<br>&emsp;&emsp;2.每个节点必须开启的参数<br>cluster-enabled yes #必须开启集群状态， 开启后 redis 进程会有 cluster 显示cluster-config-file nodes-6380.conf #此文件有 redis cluster 集群自动创建和维护，不需<br>要任何手动操作<br>&emsp;&emsp;3.所有 redis 服务器必须没有任何数据<br>&emsp;&emsp;4.先启动为单机 redis 且没有任何 key value</p><h4 id="集群部署"><a href="#集群部署" class="headerlink" title="集群部署"></a>集群部署</h4><h5 id="Redis-3、4"><a href="#Redis-3、4" class="headerlink" title="Redis 3、4"></a>Redis 3、4</h5><p>&emsp;&emsp;Redis 3 和 4 版本需要使用到集群管理工具 redis-trib.rb，这个工具是 redis 官方推出的管理 redis 集群的工具，集成在 redis 的源码 src 目录下，是基于 redis 提供的集群命令封装成简单、便捷、实用的操作工具， redis-trib.rb 是 redis 作者用 ruby 开发完成的。所以需要有ruby环境，如果系统自带的ruby版本较低（需要Ruby version &gt;= 2.3.0），那就需要重新编译安装更高版本。</p><h6 id="编译安装ruby"><a href="#编译安装ruby" class="headerlink" title="编译安装ruby"></a>编译安装ruby</h6><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> yum <span class="built_in">remove</span> <span class="keyword">ruby</span> rubygems -<span class="keyword">y</span></span><br><span class="line">wget http<span class="variable">s:</span>//cache.<span class="keyword">ruby</span>-lang.org/pub/<span class="keyword">ruby</span>/<span class="number">2.5</span>/<span class="keyword">ruby</span>-<span class="number">2.5</span>.<span class="number">5</span>.tar.gz</span><br></pre></td></tr></table></figure><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar xf ruby<span class="number">-2.5</span><span class="number">.5</span>.tar.gz</span><br><span class="line">cd ruby<span class="number">-2.5</span><span class="number">.5</span></span><br><span class="line">./configure</span><br><span class="line"> make -j <span class="number">4</span> &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;安装redis的gem包（Gem是一个管理Ruby库和程序的标准包，它通过Ruby Gem（如 <a href="http://rubygems.org/" rel="noopener" target="_blank">http://rubygems.org/</a> ）源来查找、安装、升级和卸载软件包，非常的便捷）。<br> <figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem <span class="keyword">install</span> redis</span><br></pre></td></tr></table></figure></p><p>&emsp;&emsp;之后就可以使用<code>redis-trib.rb</code>命令来创建管理集群了。</p><h6 id="集群创建"><a href="#集群创建" class="headerlink" title="集群创建"></a>集群创建</h6><p>&emsp;&emsp;通过命令<code>redis-trib.rb create</code>来创建集群，选项–replicas <arg> 指定 master 的slave数量.<br>&emsp;&emsp;需要注意的是，集群至少也需要3台master，（–replicas 指定的slave数量可以为0，不过一般不建议），如果指定slave数量为2的话就至少需要9个redis服务器了（3主6从），比较浪费资源，所以我们一般设置replicas数值为1。<br>&emsp;&emsp;如果设置<strong>slave数量为0</strong>，则所有的6个服务器均为master，无法实现高可，集群信息如下图所示：</arg></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; cluster nodes</span><br><span class="line">c65ab2a5e9d8a9435d54f0ef7db302c62b6f9308 <span class="number">192.168</span><span class="number">.32</span><span class="number">.82</span>:<span class="symbol">6379@</span><span class="number">16379</span> master - <span class="number">0</span> <span class="number">1573794294000</span> <span class="number">3</span> connected <span class="number">5461</span><span class="number">-8191</span></span><br><span class="line">a13d711b6b54909e5aed44cc8f75195915bbfb95 <span class="number">192.168</span><span class="number">.32</span><span class="number">.85</span>:<span class="symbol">6379@</span><span class="number">16379</span> master - <span class="number">0</span> <span class="number">1573794293235</span> <span class="number">6</span> connected <span class="number">13653</span><span class="number">-16383</span></span><br><span class="line"><span class="number">5</span>d614e18da36f9d7b3536566205281743adc95c5 <span class="number">192.168</span><span class="number">.32</span><span class="number">.8</span>:<span class="symbol">6379@</span><span class="number">16379</span> myself,master - <span class="number">0</span> <span class="number">1573794294000</span> <span class="number">1</span> connected <span class="number">0</span><span class="number">-2730</span></span><br><span class="line"><span class="number">6fe42</span>df7ea9c4dbb00d9bae6f7e4238367b1089b <span class="number">192.168</span><span class="number">.32</span><span class="number">.81</span>:<span class="symbol">6379@</span><span class="number">16379</span> master - <span class="number">0</span> <span class="number">1573794292212</span> <span class="number">2</span> connected <span class="number">2731</span><span class="number">-5460</span></span><br><span class="line">e3beb9f45b73b265050499ee093ed1a473a3d566 <span class="number">192.168</span><span class="number">.32</span><span class="number">.83</span>:<span class="symbol">6379@</span><span class="number">16379</span> master - <span class="number">0</span> <span class="number">1573794295286</span> <span class="number">4</span> connected <span class="number">8192</span><span class="number">-10922</span></span><br><span class="line"><span class="number">8</span>ae323030e3ae28519a27058c6592b94d1aae734 <span class="number">192.168</span><span class="number">.32</span><span class="number">.84</span>:<span class="symbol">6379@</span><span class="number">16379</span> master - <span class="number">0</span> <span class="number">1573794295000</span> <span class="number">5</span> connected <span class="number">10923</span><span class="number">-13652</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;如果设置slave数量为2，若创建集群是加入的服务器数量不够9台，则<strong>会报错：</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>CentOS8 ~]#redis-trib.rb create --replicas <span class="number">2</span> \</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.8</span>:<span class="number">6379</span> \</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.81</span>:<span class="number">6379</span> \</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.82</span>:<span class="number">6379</span> \</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.83</span>:<span class="number">6379</span> \</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.84</span>:<span class="number">6379</span> \</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.85</span>:<span class="number">6379</span></span><br><span class="line">&gt;&gt;&gt; Creating cluster</span><br><span class="line">*** ERROR: Invalid configuration <span class="keyword">for</span> cluster creation.</span><br><span class="line">*** Redis Cluster requires at least <span class="number">3</span> master nodes.</span><br><span class="line">*** This <span class="keyword">is</span> <span class="keyword">not</span> possible with <span class="number">6</span> nodes <span class="keyword">and</span> <span class="number">2</span> replicas per node.</span><br><span class="line">*** At least <span class="number">9</span> nodes are required.</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;若之前有创建集群失败的一些操作，或集群中有的redis服务器中有数据信息的话，也是无法创建成功的。会报类似如下如下信息：</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/share/gems/gems/redis-<span class="number">4.1</span>.<span class="number">3</span>/<span class="class"><span class="keyword">lib</span>/<span class="title">redis</span>/<span class="title">client</span>.<span class="title">rb</span>:126:<span class="title">in</span> `<span class="title">call</span>': <span class="title">ERR</span> <span class="title">Slot</span> 2823 <span class="title">is</span> <span class="title">already</span> <span class="title">busy</span> (<span class="title">Redis::CommandError</span>)</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;所以我们一般在创建集群之前，先连上redis服务器清空数据，并重置集群关系，确保所有的redis服务器都没有数据且都为单机master。</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FLUSHALL</span><br><span class="line"><span class="keyword">cluster</span> <span class="keyword">reset</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;然后执行创建集群命令</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb create --replicas <span class="number">1</span> \</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.8</span>:<span class="number">6379</span> \</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.81</span>:<span class="number">6379</span> \</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.82</span>:<span class="number">6379</span> \</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.83</span>:<span class="number">6379</span> \</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.84</span>:<span class="number">6379</span> \</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.85</span>:<span class="number">6379</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;即可成功创建集群。连接redis，登陆，即可看到集群主从关系。</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>CentOS8 ~]#redis-cli</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; cluster nodes</span><br><span class="line">NOAUTH Authentication required.</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; auth <span class="number">123456</span></span><br><span class="line">OK</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; cluster nodes</span><br><span class="line">c65ab2a5e9d8a9435d54f0ef7db302c62b6f9308 <span class="number">192.168</span><span class="number">.32</span><span class="number">.82</span>:<span class="symbol">6379@</span><span class="number">16379</span> master - <span class="number">0</span> <span class="number">1573798716854</span> <span class="number">3</span> connected <span class="number">10923</span><span class="number">-16383</span></span><br><span class="line">a13d711b6b54909e5aed44cc8f75195915bbfb95 <span class="number">192.168</span><span class="number">.32</span><span class="number">.85</span>:<span class="symbol">6379@</span><span class="number">16379</span> slave <span class="number">6fe42</span>df7ea9c4dbb00d9bae6f7e4238367b1089b <span class="number">0</span> <span class="number">1573798715000</span> <span class="number">6</span> connected</span><br><span class="line"><span class="number">5</span>d614e18da36f9d7b3536566205281743adc95c5 <span class="number">192.168</span><span class="number">.32</span><span class="number">.8</span>:<span class="symbol">6379@</span><span class="number">16379</span> myself,master - <span class="number">0</span> <span class="number">1573798716000</span> <span class="number">1</span> connected <span class="number">0</span><span class="number">-5460</span></span><br><span class="line"><span class="number">6fe42</span>df7ea9c4dbb00d9bae6f7e4238367b1089b <span class="number">192.168</span><span class="number">.32</span><span class="number">.81</span>:<span class="symbol">6379@</span><span class="number">16379</span> master - <span class="number">0</span> <span class="number">1573798717877</span> <span class="number">2</span> connected <span class="number">5461</span><span class="number">-10922</span></span><br><span class="line"><span class="number">8</span>ae323030e3ae28519a27058c6592b94d1aae734 <span class="number">192.168</span><span class="number">.32</span><span class="number">.84</span>:<span class="symbol">6379@</span><span class="number">16379</span> slave <span class="number">5</span>d614e18da36f9d7b3536566205281743adc95c5 <span class="number">0</span> <span class="number">1573798715834</span> <span class="number">5</span> connected</span><br><span class="line">e3beb9f45b73b265050499ee093ed1a473a3d566 <span class="number">192.168</span><span class="number">.32</span><span class="number">.83</span>:<span class="symbol">6379@</span><span class="number">16379</span> slave c65ab2a5e9d8a9435d54f0ef7db302c62b6f9308 <span class="number">0</span> <span class="number">1573798716000</span> <span class="number">4</span> connected</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;监控集群状态</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb<span class="built_in"> check </span>192.168.32.8:6379</span><br></pre></td></tr></table></figure><h5 id="Redis-5"><a href="#Redis-5" class="headerlink" title="Redis 5"></a>Redis 5</h5><p>&emsp;&emsp;Redis 5 版本可以直接用redis-cli客户端命令加各种命令参数来管理创建集群(配置文件中如果已配置正确的密码，则不需要-a 选项，-a选项会有warning警告)。<br>&emsp;&emsp;创建集群</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a <span class="number">123456</span> --cluster create --cluster-replicas <span class="number">1</span> \</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.8</span>:<span class="number">6379</span> \</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.81</span>:<span class="number">6379</span> \</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.82</span>:<span class="number">6379</span> \</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.83</span>:<span class="number">6379</span> \</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.84</span>:<span class="number">6379</span> \</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.85</span>:<span class="number">6379</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;监控集群状态</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a 123456 --cluster<span class="built_in"> check </span>192.168.32.8:6379</span><br></pre></td></tr></table></figure><h4 id="集群管理维护"><a href="#集群管理维护" class="headerlink" title="集群管理维护"></a>集群管理维护</h4><p>&emsp;&emsp;集群运行时间长久之后，难免由于硬件故障、网络规划、 业务增长等原因对已有集群进行相应的调整， 比如增加 Redis node 节点、 减少节点、 节点迁移、更换服务器等。</p><h5 id="动态添加节点"><a href="#动态添加节点" class="headerlink" title="动态添加节点"></a>动态添加节点</h5><p>&emsp;&emsp;同步之前 Redis node 的配置文件到 192.168.32.86 Redis 编译安装目录， 注意修改配置文件的监听 IP。</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp redis.conf <span class="number">192.168</span>.<span class="number">32.86</span><span class="symbol">:/apps/redis/etc/</span></span><br><span class="line">scp redis_638<span class="number">0</span>.conf <span class="number">192.168</span>.<span class="number">32.86</span><span class="symbol">:/apps/redis/etc/</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;对预备加入的redis服务器清除数据并执行集群重置</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FLUSHALL</span><br><span class="line"><span class="keyword">cluster</span> <span class="keyword">reset</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;<strong>redis3、4</strong> 中添加节点（Adding node 192.168.32.87:6379 to cluster 192.168.32.8:6379）</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb<span class="built_in"> add-node </span>192.168.32.87:6379 192.168.32.8:6379</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;<strong>redis5</strong> 中添加节点（Adding node 192.168.32.87:6379 to cluster 192.168.32.8:6379）</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster<span class="built_in"> add-node </span>192.168.32.87:6379 192.168.32.8:6379</span><br></pre></td></tr></table></figure><h5 id="重新分配槽位"><a href="#重新分配槽位" class="headerlink" title="重新分配槽位"></a>重新分配槽位</h5><p>&emsp;&emsp;集群槽位迁移时，迁出的服务器中不能有数据，否则会迁移失败并终止，且<strong>需要修复集群</strong>，才可以进行第二次迁移。<br>&emsp;&emsp;<strong>redis3、4</strong> 中对新加的主机重新分配槽位(后可跟集群中任意主机ip:port):</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">redis-trib</span><span class="selector-class">.rb</span> <span class="selector-tag">reshard</span> 192<span class="selector-class">.168</span><span class="selector-class">.32</span><span class="selector-class">.8</span><span class="selector-pseudo">:6379</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;<strong>redis5</strong> 对新加的主机重新分配槽位(后可跟集群中任意主机ip:port):</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster reshard <span class="number">192.168</span><span class="number">.32</span><span class="number">.8</span>:<span class="number">6379</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;输入命令后根据提示输入</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">How many slots <span class="keyword">do</span> you want <span class="keyword">to</span> <span class="keyword">move</span> (<span class="keyword">from</span> <span class="number">1</span> <span class="keyword">to</span> <span class="number">16384</span>)? <span class="number">4096</span>  <span class="comment">#需要迁移多少槽位</span></span><br><span class="line">What <span class="keyword">is</span> the receiving node <span class="keyword">ID</span>? <span class="number">5</span>d614e18da36f9d7b3536566205281743adc95c5 <span class="comment">#选择迁移到哪个redis主机</span></span><br><span class="line">What <span class="keyword">is</span> the receiving node <span class="keyword">ID</span>? <span class="number">6</span>bffc0037eea959f0dcc11aca657f928d86cfc75</span><br><span class="line">Please enter <span class="keyword">all</span> the <span class="keyword">source</span> node IDs.</span><br><span class="line">  <span class="keyword">Type</span> <span class="string">'all'</span> <span class="keyword">to</span> <span class="keyword">use</span> <span class="keyword">all</span> the nodes <span class="keyword">as</span> <span class="keyword">source</span> nodes <span class="keyword">for</span> the <span class="keyword">hash</span> slots.</span><br><span class="line">  <span class="keyword">Type</span> <span class="string">'done'</span> once you entered <span class="keyword">all</span> the <span class="keyword">source</span> nodes IDs.</span><br><span class="line"><span class="keyword">Source</span> node <span class="comment">#1:6bffc0037eea959f0dcc11aca657f928d86cfc75   #选择从哪个主机迁出</span></span><br><span class="line"><span class="keyword">Source</span> node <span class="comment">#2:done             #输入done结束选择</span></span><br><span class="line"><span class="keyword">Do</span> you want <span class="keyword">to</span> proceed <span class="keyword">with</span> the proposed reshard plan (yes/<span class="keyword">no</span>)? yes  <span class="comment">#是否执行，yes确认，之后就会迁移完毕</span></span><br></pre></td></tr></table></figure><h5 id="修复集群"><a href="#修复集群" class="headerlink" title="修复集群"></a>修复集群</h5><p>&emsp;&emsp;如果迁移失败，则需要修复集群。</p><p>&emsp;&emsp;<strong>redis3、4</strong> 中对对报错redis服务器进行单独修复(后跟需要修复的主机ip:port):</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">redis-trib</span><span class="selector-class">.rb</span> <span class="selector-tag">fix</span> 192<span class="selector-class">.168</span><span class="selector-class">.32</span><span class="selector-class">.82</span><span class="selector-pseudo">:6379</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;<strong>redis5</strong> 中对对报错redis服务器进行单独修复(后跟需要修复的主机ip:port):</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster fix <span class="number">192.168</span><span class="number">.32</span><span class="number">.82</span>:<span class="number">6379</span></span><br></pre></td></tr></table></figure><h5 id="配置主从关系"><a href="#配置主从关系" class="headerlink" title="配置主从关系"></a>配置主从关系</h5><p>&emsp;&emsp;在整个 Redis cluster 集群中，每个 master 至少有一个 slave。也可以有多个，但是至少要有一个提供数据备份和服务高可用。<br>&emsp;&emsp;<code>redis-trib.rb info 192.168.32.8:6379</code></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>CentOS8 ~]#redis-trib.rb info <span class="number">192.168</span><span class="number">.32</span><span class="number">.8</span>:<span class="number">6379</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.8</span>:<span class="number">6379</span> (<span class="number">5</span>d614e18...) -&gt; <span class="number">0</span> keys | <span class="number">4096</span> slots | <span class="number">1</span> slaves.</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.82</span>:<span class="number">6379</span> (c65ab2a5...) -&gt; <span class="number">0</span> keys | <span class="number">4096</span> slots | <span class="number">0</span> slaves.</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.81</span>:<span class="number">6379</span> (<span class="number">6fe42</span>df7...) -&gt; <span class="number">0</span> keys | <span class="number">4096</span> slots | <span class="number">1</span> slaves.</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.87</span>:<span class="number">6379</span> (<span class="number">6</span>bffc003...) -&gt; <span class="number">0</span> keys | <span class="number">4096</span> slots | <span class="number">1</span> slaves.</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.86</span>:<span class="number">6379</span> (e06732b2...) -&gt; <span class="number">0</span> keys | <span class="number">0</span> slots | <span class="number">0</span> slaves.</span><br><span class="line">[OK] <span class="number">0</span> keys <span class="keyword">in</span> <span class="number">5</span> masters.</span><br><span class="line"><span class="number">0.00</span> keys per slot on average.</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;我们看到之前的3主3从结构因为我们加了两个服务器变成了5主3从，新加的两个服务器，我们需要将它们设置为一主一从来实现高可用。于是我们要将192.168.32.86变为192.168.32.82的slave。<br>&emsp;&emsp;连接登陆192.168.32.86上的redis服务器，先查好192.168。32.82的ID为c65ab2a5e9d8a9435d54f0ef7db302c62b6f9308，执行</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster replicate <span class="keyword">c</span><span class="number">65</span>ab<span class="number">2</span>a<span class="number">5e9</span>d<span class="number">8</span>a<span class="number">9435</span>d<span class="number">54</span>f<span class="number">0</span>ef<span class="number">7</span>db<span class="number">302</span><span class="keyword">c</span><span class="number">62</span>b<span class="number">6</span>f<span class="number">9308</span></span><br></pre></td></tr></table></figure><h5 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h5><p>&emsp;&emsp;<strong>删除节点，需要先将redis主机上的槽位都迁移到其他主机上才可以操作。</strong><br>&emsp;&emsp;迁移完成后，<strong>redis3、4</strong> 删除节点（要删除的redis主机要写节点号，集群可以写集群中任意主机ip+port）</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>CentOS8 ~]#redis-trib.rb del-node <span class="number">192.168</span><span class="number">.32</span><span class="number">.8</span>:<span class="number">6379</span> <span class="number">6</span>bffc0037eea959f0dcc11aca657f928d86cfc75</span><br><span class="line">&gt;&gt;&gt; Removing node <span class="number">6</span>bffc0037eea959f0dcc11aca657f928d86cfc75 <span class="keyword">from</span> cluster <span class="number">192.168</span><span class="number">.32</span><span class="number">.8</span>:<span class="number">6379</span></span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</span><br><span class="line">&gt;&gt;&gt; SHUTDOWN the node.</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;<strong>redis5</strong> 删除节点</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster del-node <span class="number">192.168</span><span class="number">.32</span><span class="number">.8</span>:<span class="number">6379</span> <span class="number">6</span>bffc0037eea959f0dcc11aca657f928d86cfc75</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;主节点被删除之后，其之前它的 slave 自动称为了 Redis 集群中其他 master的 slave，此节点如果不需要也可以一并删除。</p>]]></content>
      
      
      <categories>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 企业级应用 </tag>
            
            <tag> 高可用 </tag>
            
            <tag> redis </tag>
            
            <tag> 集群 </tag>
            
            <tag> Sentinel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一键源码编译安装redis</title>
      <link href="//blog/f2c1a89e.html"/>
      <url>//blog/f2c1a89e.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;Redis 和 Memcached 是非关系型数据库也称为 NoSQL 数据库， MySQL、 Mariadb、 SQLServer、 PostgreSQL、 Oracle 数据库属于关系型数据(RDBMS, Relational Database Management System)。<br>&emsp;&emsp;Redis(Remote Dictionary Server)在 2009 年发布， 开发者 Salvatore Sanfilippo 是意大利开发者， 他本想为自己的公司开发一个用于替换 MySQL 的产品 Redis， 但是没有想到他把 Redis 开源后大受欢迎，短短几年， Redis 就有了很大的用户群体，目前国内外使用的公司有知乎&gt;网、新浪微博、 GitHub 等。<br>&emsp;&emsp;redis 是一个开源的、 遵循 BSD 协议的、 基于内存的而且目前比较流行的键值数据库(key-value database)，是一个非关系型数据库，redis 提供将内存通过网络远程共享的一种服务，提供类似功能的还有 memcache，但相比 memcache， redis 还提供了易扩展、高性能、 具备数据持久性等功能。<br>&emsp;&emsp;Redis 在高并发、低延迟环境要求比较高的环境使用量非常广泛， 目前 redis 在 DBEngine 月排行榜 <a href="https://db-engines.com/en/ranking" rel="noopener" target="_blank">https://db-engines.com/en/ranking</a> 中一直比较靠前，而且一直是键值型存储类的首位。</p><a id="more"></a><h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><p>&emsp;&emsp;redis在centos版本自带的yum源中版本比较低，一般都需要我们编译安装更高版本的redis。</p><h4 id="准备源码包"><a href="#准备源码包" class="headerlink" title="准备源码包"></a>准备源码包</h4><p>&emsp;&emsp;可以先用下载工具去官网下载好源码包，下载链接为 <a href="https://db-engines.com/en/ranking" rel="noopener" target="_blank">https://db-engines.com/en/ranking</a>  。<br>&emsp;&emsp;出于稳定性要求，一般来说实际生产中不会选用最新版的redis，避免因为漏洞造成服务器的安全隐患，所以本次演示，我们选用目前redis4的最新版本，redis-4.0.14来安装。</p><h4 id="编译安装-1"><a href="#编译安装-1" class="headerlink" title="编译安装"></a>编译安装</h4><p>&emsp;&emsp;<code>tar xf redis-4.0.14..tar.gz</code><br>&emsp;&emsp;<code>cd redis-4.0.14</code><br>&emsp;&emsp;编译安装redis的依赖包不多，有make和gcc就够了。</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> make gcc -y</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;如果是最小化安装的新系统，忘记安装gcc的话直接去尝试编译安装redis，就会遇到报错：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">make[<span class="number">3</span>]: Entering directory <span class="string">'/root/redis-4.0.14/deps/hiredis'</span></span><br><span class="line">gcc -std=c99 -pedantic -c -O3 -fPIC  -Wall -W -Wstrict-prototypes -Wwrite-<span class="built_in">string</span>s -g -ggdb  net.c</span><br><span class="line">make[<span class="number">3</span>]: gcc: Command <span class="keyword">not</span> found</span><br><span class="line">make[<span class="number">3</span>]: *** [Makefile:<span class="number">156</span>: net.o] Error <span class="number">127</span></span><br><span class="line">make[<span class="number">3</span>]: Leaving directory <span class="string">'/root/redis-4.0.14/deps/hiredis'</span></span><br><span class="line">make[<span class="number">2</span>]: *** [Makefile:<span class="number">46</span>: hiredis] Error <span class="number">2</span></span><br><span class="line">make[<span class="number">2</span>]: Leaving directory <span class="string">'/root/redis-4.0.14/deps'</span></span><br><span class="line">make[<span class="number">1</span>]: [Makefile:<span class="number">180</span>: persist-settings] Error <span class="number">2</span> (ignored)</span><br><span class="line">    CC adlist.o</span><br><span class="line">/bin/sh: cc: command <span class="keyword">not</span> found</span><br><span class="line">make[<span class="number">1</span>]: *** [Makefile:<span class="number">228</span>: adlist.o] Error <span class="number">127</span></span><br><span class="line">make[<span class="number">1</span>]: Leaving directory <span class="string">'/root/redis-4.0.14/src'</span></span><br><span class="line">make: *** [Makefile:<span class="number">9</span>: install] Error <span class="number">2</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;提示没装gcc，再回头补上,<code>yum install gcc -y</code>，也还是会报错的。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS8 redis-4.0.14]<span class="comment">#make PREFIX=/apps/redis install</span></span><br><span class="line">cd src &amp;&amp; make <span class="keyword">install</span></span><br><span class="line">make[<span class="number">1</span>]: Entering <span class="keyword">directory</span> <span class="string">'/root/redis-4.0.14/src'</span></span><br><span class="line">    CC adlist.o</span><br><span class="line"><span class="keyword">In</span> <span class="keyword">file</span> included <span class="keyword">from</span> adlist.c:<span class="number">34</span>:</span><br><span class="line">zmalloc.h:<span class="number">50</span>:<span class="number">10</span>: fatal <span class="keyword">error</span>: jemalloc/jemalloc.h: <span class="keyword">No</span> such <span class="keyword">file</span> <span class="keyword">or</span> <span class="keyword">directory</span></span><br><span class="line"> <span class="comment">#include &lt;jemalloc/jemalloc.h&gt;</span></span><br><span class="line">          ^~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">compilation terminated.</span><br><span class="line">make[<span class="number">1</span>]: *** [Makefile:<span class="number">228</span>: adlist.o] <span class="keyword">Error</span> <span class="number">1</span></span><br><span class="line">make[<span class="number">1</span>]: Leaving <span class="keyword">directory</span> <span class="string">'/root/redis-4.0.14/src'</span></span><br><span class="line">make: *** [Makefile:<span class="number">9</span>: <span class="keyword">install</span>] <span class="keyword">Error</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;这是因为上次的编译失败，有残留的文件，我们需要清理下，<code>make distclean</code>，然后重新编译就可以了，<code>make PREFIX=/apps/redis install</code>。<br>&emsp;&emsp;网上也有说可以通过加选项make MALLOC=libc来解决，不过其实是有一些隐患的。首先我们要知道redis 需要使用内存分配器的， 默认是指定内存分配器为 jemalloc ，make MALLOC=libc 就是指定内存分配器为 libc ，而jemalloc 内存分配器在实践中处理内存碎片是要比libc 好的，而且在README.md 文档也说明到了，jemalloc内存分配器也是包含在源码包里面的，可以在deps 目录下看到 jemalloc 目录。<br>&emsp;&emsp;编译完成后，接下来我们还需要几步操作。<br>&emsp;&emsp;创建目录结构<code>mkdir /apps/redis/{etc,logs,data,run}</code><br>&emsp;&emsp;从源码包中复制配置文件<code>cp redis.conf /apps/redis/etc/</code><br>&emsp;&emsp;创建systemctl服务启动脚本，为了避免安全隐患，我们还要将redis服务设为以redis身份启动，所以还要修改目录权限</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/redis.service &lt;&lt;<span class="string">"END"</span></span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Redis persistent key-value database</span><br><span class="line"><span class="attribute">After</span>=network.target</span><br><span class="line"><span class="attribute">After</span>=network-online.target</span><br><span class="line"><span class="attribute">Wants</span>=network-online.target</span><br><span class="line">[Service]</span><br><span class="line"><span class="comment">#ExecStart=/usr/bin/redis-server /etc/redis.conf --supervised systemd</span></span><br><span class="line"><span class="attribute">ExecStart</span>=/apps/redis/bin/redis-server /apps/redis/etc/redis.conf --supervised systemd</span><br><span class="line"><span class="attribute">ExecReload</span>=/bin/kill -s HUP <span class="variable">$MAINPID</span></span><br><span class="line"><span class="attribute">ExecStop</span>=/bin/kill -s QUIT <span class="variable">$MAINPID</span></span><br><span class="line"><span class="attribute">Type</span>=notify</span><br><span class="line"><span class="attribute">User</span>=redis</span><br><span class="line"><span class="attribute">Group</span>=redis</span><br><span class="line"><span class="attribute">RuntimeDirectory</span>=redis</span><br><span class="line"><span class="attribute">RuntimeDirectoryMode</span>=0755</span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">END</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;创建redis用户，并修改redis目录属主属组。</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">groupadd -g <span class="number">379</span> redis &amp;&amp; useradd -u <span class="number">379</span> -g <span class="number">379</span> redis -s /sbin/nologin</span><br><span class="line">chown redis.redis -R /apps/redis</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;修改PATH变量或者直接用软链接的方式(用一个即可，效果一样)，方便执行redis命令。<br>&emsp;&emsp;<code>ln -sv /apps/redis/bin/* /usr/local/bin/</code>(软链接)<br>&emsp;&emsp;<code>echo &quot;PATH=/apps/redis/bin:$PATH&quot; &gt; /etc/profile.d/redis.sh；. /etc/profile.d/redis.sh</code>(改PATH变量)</p><h3 id="修改内核参数"><a href="#修改内核参数" class="headerlink" title="修改内核参数"></a>修改内核参数</h3><p>&emsp;&emsp;这时redis服务就其实已经搭建完成了，已经可以通过服务脚本进行启动了。可是如果直接启动会有一些[warning]信息，而且很有可能在高并发的时候导致redis崩溃。</p><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">13636</span>:M <span class="number">13</span> Nov <span class="number">10</span>:<span class="number">37</span>:<span class="number">06.195</span> # WARNING: The TCP backlog setting of <span class="number">511</span> cannot be enforced because /<span class="keyword">proc</span>/sys/net/core/somaxconn<span class="title"> is</span> set<span class="title"> to</span> the<span class="title"> lower</span> value<span class="title"> of</span> 128.</span><br><span class="line">13636:M 13<span class="title"> Nov</span> 10:37:06.195 #<span class="title"> Server</span> initialized</span><br><span class="line">13636:M 13<span class="title"> Nov</span> 10:37:06.195 #<span class="title"> WARNING</span> overcommit_memory<span class="title"> is</span> set<span class="title"> to</span> 0!<span class="title"> Background</span> save<span class="title"> may</span> fail<span class="title"> under</span> low<span class="title"> memory</span> condition.<span class="title"> To</span> fix<span class="title"> this</span> issue<span class="title"> add</span> 'vm.overcommit_memory = 1'<span class="title"> to</span> /etc/sysctl.conf<span class="title"> and</span> then<span class="title"> reboot</span> or<span class="title"> run</span> the<span class="title"> command</span> 'sysctl<span class="title"> vm.overcommit_memory=1'</span> for<span class="title"> this</span> to<span class="title"> take</span> effect.</span><br><span class="line">13636:M 13<span class="title"> Nov</span> 10:37:06.195 #<span class="title"> WARNING</span> you<span class="title"> have</span> Transparent<span class="title"> Huge</span> Pages (THP)<span class="title"> support</span> enabled<span class="title"> in</span> your<span class="title"> kernel.</span> This<span class="title"> will</span> create<span class="title"> latency</span> and<span class="title"> memory</span> usage<span class="title"> issues</span> with<span class="title"> Redis.</span> To<span class="title"> fix</span> this<span class="title"> issue</span> run<span class="title"> the</span> command 'echo<span class="title"> never</span> &gt; /sys/kernel/mm/transparent_hugepage/enabled'<span class="title"> as</span> root,<span class="title"> and</span> add<span class="title"> it</span> to<span class="title"> your</span> /etc/rc.local<span class="title"> in</span> order<span class="title"> to</span> retain<span class="title"> the</span> setting<span class="title"> after</span> a<span class="title"> reboot.</span> Redis<span class="title"> must</span> be<span class="title"> restarted</span> after<span class="title"> THP</span> is<span class="title"> disabled.</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;我们可以通过修改一些内核参数来避免这一风险。</p><ul><li>TCP backlog 参数控制的是三次握手的时候 server 端收到 client ack 确认号之后的队列值，redis默认为511。我们需要将内核的net.core.somaxconn值(系统默认128)更改为大于511，或将redis的队列之修改小于128.</li><li>将vm.overcommit_memory值改为1<br>0、表示内核将检查是否有足够的可用内存供应用进程使用；如果有足够的可用内存，内存申请允许；否则，内存申请失败，并把错误返回给应用进程。<br>1、表示内核允许分配所有的物理内存，而不管当前的内存状态如何。<br>2、表示内核允许分配超过所有物理内存和交换空间总和的内存</li><li>transparent hugepage：<br>开启大页内存动态分配，需要关闭让 redis 负责内存管理。</li></ul><p>&emsp;&emsp;所以，我们执行下面操作</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/sysctl<span class="selector-class">.conf</span> &lt;&lt; END</span><br><span class="line">net<span class="selector-class">.core</span><span class="selector-class">.somaxconn</span> = <span class="number">512</span></span><br><span class="line">vm<span class="selector-class">.overcommit_memory</span> = <span class="number">1</span></span><br><span class="line">END</span><br></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo never &gt; <span class="regexp">/sys/</span>kernel<span class="regexp">/mm/</span>transparent_hugepage<span class="regexp">/enabled</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;至此，redis就正式调试完成，可以正常使用了。</p><h3 id="附：一键编译安装redis脚本"><a href="#附：一键编译安装redis脚本" class="headerlink" title="附：一键编译安装redis脚本"></a>附：一键编译安装redis脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">DST=<span class="string">"/apps"</span></span><br><span class="line"><span class="comment">#[ -d $DST ] || &#123; echo "install into $DST fail,No such file or directory" ;exit 10;&#125;</span></span><br><span class="line">[ -a redis-*.tar.* ] || &#123; <span class="built_in">echo</span> <span class="string">' the absence of redis.tar.gz'</span> ;<span class="built_in">exit</span> 1;&#125;</span><br><span class="line">[ -a /usr/lib/systemd/system/redis.service ] &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">'redis.service is exist,redis is aready installed'</span> ;<span class="built_in">exit</span> 2;&#125;</span><br><span class="line">[ -d <span class="variable">$DST</span>/redis* ] &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">"redis is aready installed into <span class="variable">$DST</span>/redis"</span> ;<span class="built_in">exit</span> 3;&#125;</span><br><span class="line">id redis &amp;&gt;/dev/null &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">'user redis is exist,redis is aready installed'</span> ; <span class="built_in">exit</span> 4;&#125; || &#123; groupadd -g 379 redis &amp;&amp; useradd -u 379 -g 379 redis -s /sbin/nologin || &#123; <span class="built_in">echo</span> user 379 is exist ;<span class="built_in">exit</span> 5; &#125; &#125;</span><br><span class="line">mkdir -p <span class="variable">$DST</span>/redis</span><br><span class="line">yum  install  -y make gcc</span><br><span class="line"><span class="comment">#yum  install  -y make gcc wget</span></span><br><span class="line"><span class="comment">#wget http://download.redis.io/releases/redis-4.0.14.tar.gz</span></span><br><span class="line">tar xf redis-*.tar.*</span><br><span class="line">PTH=`find . -name <span class="string">"redis*"</span> -<span class="built_in">type</span> d |head -n1`</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$PTH</span></span><br><span class="line">make PREFIX=<span class="variable">$DST</span>/redis install</span><br><span class="line">mkdir <span class="variable">$DST</span>/redis/&#123;etc,logs,data,run&#125;</span><br><span class="line">cp redis.conf /apps/redis/etc/</span><br><span class="line">chown redis.redis -R /apps/redis</span><br><span class="line">cat &gt; /usr/lib/systemd/system/redis.service &lt;&lt; END</span><br><span class="line">[Unit]</span><br><span class="line">Description=Redis persistent key-value database</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">[Service]</span><br><span class="line"><span class="comment">#ExecStart=/usr/bin/redis-server /etc/redis.conf --supervised systemd</span></span><br><span class="line">ExecStart=<span class="variable">$DST</span>/redis/bin/redis-server <span class="variable">$DST</span>/redis/etc/redis.conf --supervised systemd</span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> -s HUP \<span class="variable">$MAINPID</span></span><br><span class="line">ExecStop=/bin/<span class="built_in">kill</span> -s QUIT \<span class="variable">$MAINPID</span></span><br><span class="line">Type=notify</span><br><span class="line">User=redis</span><br><span class="line">Group=redis</span><br><span class="line">RuntimeDirectory=redis</span><br><span class="line">RuntimeDirectoryMode=0755</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">END</span><br><span class="line"></span><br><span class="line">ln -sv <span class="variable">$DST</span>/redis/bin/* /usr/<span class="built_in">local</span>/bin/</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /etc/sysctl.conf &lt;&lt; END</span><br><span class="line">net.core.somaxconn = 512</span><br><span class="line">vm.overcommit_memory = 1</span><br><span class="line">END</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> --now redis</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 企业级应用 </tag>
            
            <tag> 一键安装 </tag>
            
            <tag> redis </tag>
            
            <tag> 源码编译 </tag>
            
            <tag> 内核参数 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>故障:/etc/fstab中NFS自动挂载失败</title>
      <link href="//blog/219b1607.html"/>
      <url>//blog/219b1607.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;之前配置了一个web集群(其实就3个服务器)，想实现数据共享和动静分离，感觉配置分布式存储比较复杂，也没必要，就打算在搭建一个NFS服务器，共享几个目录，挂载在几个web服务器上。<br>&emsp;&emsp;搭建NFS服务过程很顺利，手动挂载也没问题，然后打算将挂载信息写进<code>/etc/fstab</code>配置文件，实现开机自动挂载。</p><a id="more"></a><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># /etc/fstab</span><br><span class="line"># Created by anaconda on Wed Oct  <span class="number">9</span> <span class="number">08</span>:<span class="number">35</span>:<span class="number">16</span> <span class="number">2019</span></span><br><span class="line">#</span><br><span class="line"># Accessible filesystems, by <span class="built_in">ref</span>erence, are maintained under <span class="string">'/dev/disk/'</span>.</span><br><span class="line"># See man pages fstab(<span class="number">5</span>), findfs(<span class="number">8</span>), mount(<span class="number">8</span>) <span class="keyword">and</span>/<span class="keyword">or</span> blkid(<span class="number">8</span>) <span class="keyword">for</span> more info.</span><br><span class="line">#</span><br><span class="line"># After editing <span class="keyword">this</span> file, run <span class="string">'systemctl daemon-reload'</span> to update systemd</span><br><span class="line"># units generated <span class="keyword">from</span> <span class="keyword">this</span> file.</span><br><span class="line">#</span><br><span class="line">/dev/mapper/cl-root     /                       xfs     defaults        <span class="number">0</span> <span class="number">0</span></span><br><span class="line">UUID=<span class="number">100</span>a90e3<span class="number">-01</span>ac<span class="number">-43</span>aa-b6da-a10a6c105282 /boot                   ext4    defaults        <span class="number">1</span> <span class="number">2</span></span><br><span class="line">/dev/mapper/cl-data     /data                   xfs     defaults        <span class="number">0</span> <span class="number">0</span></span><br><span class="line">/dev/mapper/swap-swap   swap                    swap    defaults        <span class="number">0</span> <span class="number">0</span></span><br><span class="line">/dev/sr0                /cdrom                  iso9660 defaults        <span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.85</span>:/data/nfsshare /apps/nginx/html/wordpress/wp-content/uploads nfs defaults,_netdev  <span class="number">0</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;以为一切万事大吉之后，重启了机子测试下,<code>df</code>命令一看，发现竟然没有显示，用<code>mount -l</code>命令看了下，也没有挂载信息——竟然没有自动挂载。<br>&emsp;&emsp;开始以为配置文件格式写错了，结果尝试一下<code>mount -a</code>发现一下就挂载成功了。<br>&emsp;&emsp;这就很奇怪了，说明配置文件格式也没问题。<br>&emsp;&emsp;NFS服务器也没任何报错，应该跟NFS服务器没有关系，只是出于某种原因不能自动挂载而已。<br>&emsp;&emsp;可是本地光盘确实可以开机正常挂载的，于是我怀疑是参数写的有问题，不过仔细确认了下，之前参数就是这样的也是可以成功挂载的，抑或是CentOS8有些新特性和改动。上面确实提示<code>After editing this file, run &#39;systemctl daemon-reload&#39; to update systemd units generated from this file</code>，我也尝试了，没有效果，不过既然其他挂载项都没问题，说明问题就在NFS这一行。<br>&emsp;&emsp;于是去查看下系统日志，发现了问题的端倪</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="symbol">CentOS8</span> ~]#tail /var/log/boot.log</span><br><span class="line"><span class="symbol">See</span> <span class="string">'systemctl status "apps-nginx-html-wordpress-wp\\x2dcontent-uploads.mount"'</span> for details.</span><br><span class="line">[<span class="symbol">DEPEND</span>] <span class="symbol">Dependency</span> failed for <span class="symbol">Remote</span> <span class="symbol">File</span> <span class="symbol">Systems</span>.</span><br><span class="line">         <span class="symbol">Starting</span> <span class="symbol">Permit</span> <span class="symbol">User</span> <span class="symbol">Sessions</span>...</span><br><span class="line">         <span class="symbol">Starting</span> <span class="symbol">The</span> nginx <span class="symbol">HTTP</span> and reverse proxy server...</span><br><span class="line">         <span class="symbol">Starting</span> <span class="symbol">Crash</span> recovery kernel arming...</span><br><span class="line">[  <span class="symbol">OK</span>  ] <span class="symbol">Started</span> <span class="symbol">OpenSSH</span> server daemon.</span><br><span class="line">[  <span class="symbol">OK</span>  ] <span class="symbol">Started</span> <span class="symbol">Permit</span> <span class="symbol">User</span> <span class="symbol">Sessions</span>.</span><br><span class="line">         <span class="symbol">Starting</span> <span class="symbol">Terminate</span> <span class="symbol">Plymouth</span> <span class="symbol">Boot</span> <span class="symbol">Screen</span>...</span><br><span class="line">         <span class="symbol">Starting</span> <span class="symbol">Hold</span> until boot process finishes up...</span><br><span class="line">[  <span class="symbol">OK</span>  ] <span class="symbol">Started</span> <span class="symbol">Command</span> <span class="symbol">Scheduler</span>.</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;显示远程服务系统也就是NFS服务挂载失败，查看详细信息。</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>CentOS8 ~]#systemctl status <span class="string">"apps-nginx-html-wordpress-wp\\x2dcontent-uploads.mount"</span></span><br><span class="line">● apps-nginx-html-wordpress-wp\x2dcontent-uploads.mount - /apps/nginx/html/wordpress/wp-content/uploads</span><br><span class="line">   Loaded: loaded (/etc/fstab; generated)</span><br><span class="line">   Active: failed (Result: resources)</span><br><span class="line">    Where: /apps/nginx/html/wordpress/wp-content/uploads</span><br><span class="line">     What: <span class="number">192.168</span><span class="number">.32</span><span class="number">.85</span>:/data/nfsshare</span><br><span class="line">     Docs: man:fstab(<span class="number">5</span>)</span><br><span class="line">           man:systemd-fstab-generator(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">Nov <span class="number">11</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">39</span> CentOS8 systemd[<span class="number">1</span>]: apps-nginx-html-wordpress-wp\x2dcontent-uploads.mount: Mount path /apps/nginx/html/wordpress/wp-content/uploads <span class="keyword">is</span> <span class="keyword">not</span> canonical (contains a symlink).</span><br><span class="line">Nov <span class="number">11</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">39</span> CentOS8 systemd[<span class="number">1</span>]: apps-nginx-html-wordpress-wp\x2dcontent-uploads.mount: Failed to run <span class="string">'mount'</span> task: Too many levels of symbolic links</span><br><span class="line">Nov <span class="number">11</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">39</span> CentOS8 systemd[<span class="number">1</span>]: apps-nginx-html-wordpress-wp\x2dcontent-uploads.mount: Failed with result <span class="string">'resources'</span>.</span><br><span class="line">Nov <span class="number">11</span> <span class="number">16</span>:<span class="number">02</span>:<span class="number">39</span> CentOS8 systemd[<span class="number">1</span>]: Failed to mount /apps/nginx/html/wordpress/wp-content/uploads.</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;说挂载失败，挂载路径不符合规范<code>is not canonical (contains a symlink).</code>。路径写法应该没问题的，难道是因为<code>Too many levels of symbolic links</code>，层级太多了吗？我记得之前挂载点目录层级结构，比这还长都可以挂载成功的，难道又要归结为CentOS8的新特性了么。<br>&emsp;&emsp;一通百度、google之后，竟然没有人和我遇到的问题一样，挂载点的最大层级数是多大也没人提到过，官方文档也没有查到。<br>&emsp;&emsp;正当我打算将层数改小一些再尝试下的时候，突然看到一篇博客提到<code>Too many levels of symbolic links</code>，不过是在软链接中的报错。我突然想起来，当时我安装完系统后，规划的是讲文档和应用都装在/data目录下，可是我实际操作中比较习惯使用/apps/目录来找各种应用，于是之前编译安装nginx及php之前，我创建了一个软链接<code>ln -s /data/apps /apps</code>，以便/apps下的数据跟系统分区隔离开，在一个单独分区。或许这个<code>is not canonical (contains a symlink).</code>中的symlink说的就是指软链接。<br>&emsp;&emsp;将配置文件修改为<code>192.168.32.85:/data/nfsshare /data/apps/nginx/html/wordpress/wp-content/uploads nfs defaults,_netdev  0 0</code>后，再次重启。<code>df</code>命令查看</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>CentOS8 ~]#df</span><br><span class="line">Filesystem                   <span class="number">1</span>K-blocks    Used Available Use% Mounted on</span><br><span class="line">devtmpfs                        <span class="number">393080</span>       <span class="number">0</span>    <span class="number">393080</span>   <span class="number">0</span>% /dev</span><br><span class="line">tmpfs                           <span class="number">408620</span>       <span class="number">0</span>    <span class="number">408620</span>   <span class="number">0</span>% /dev/shm</span><br><span class="line">tmpfs                           <span class="number">408620</span>    <span class="number">5816</span>    <span class="number">402804</span>   <span class="number">2</span>% /run</span><br><span class="line">tmpfs                           <span class="number">408620</span>       <span class="number">0</span>    <span class="number">408620</span>   <span class="number">0</span>% /sys/fs/cgroup</span><br><span class="line">/dev/mapper/cl-root           <span class="number">52399108</span> <span class="number">2700076</span>  <span class="number">49699032</span>   <span class="number">6</span>% /</span><br><span class="line">/dev/sr0                       <span class="number">6967726</span> <span class="number">6967726</span>         <span class="number">0</span> <span class="number">100</span>% /cdrom</span><br><span class="line">/dev/nvme0n1p1                 <span class="number">8191416</span>  <span class="number">163348</span>   <span class="number">7592256</span>   <span class="number">3</span>% /boot</span><br><span class="line">/dev/mapper/cl-data           <span class="number">41926656</span>  <span class="number">585412</span>  <span class="number">41341244</span>   <span class="number">2</span>% /data</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.85</span>:/data/nfsshare  <span class="number">41926656</span>  <span class="number">535040</span>  <span class="number">41391616</span>   <span class="number">2</span>% /data/apps/nginx/html/wordpress/wp-content/uploads</span><br><span class="line">tmpfs                            <span class="number">81724</span>       <span class="number">0</span>     <span class="number">81724</span>   <span class="number">0</span>% /run/user/<span class="number">0</span></span><br><span class="line">[<span class="symbol">root@</span>CentOS8 ~]#</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;挂载成功~问题解决！原来纯属自己挖的坑！<br>&emsp;&emsp;记录一下，也算，增长点见识，吸取些教训。</p>]]></content>
      
      
      <categories>
          
          <category> 故障记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 故障 </tag>
            
            <tag> 记录 </tag>
            
            <tag> 排错 </tag>
            
            <tag> NFS </tag>
            
            <tag> 挂载 </tag>
            
            <tag> 软链接 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>企业级应用：负载均衡层——haproxy(二)</title>
      <link href="//blog/f5daec50.html"/>
      <url>//blog/f5daec50.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;继续讲解HAProxy的一些进阶配置及用法，包括报文修改，日志配置，压缩功能，后端服务器状态监测及ACL等功能应用。配置环境及配置文件均延续上一篇<a href="https://hewanyue.com/blog/5aeb7732.html">《企业级应用：负载均衡层——haproxy(一)》</a>,有任何疑问可以先看上一篇博客。</p><a id="more"></a><h3 id="haproxy的进阶配置"><a href="#haproxy的进阶配置" class="headerlink" title="haproxy的进阶配置"></a>haproxy的进阶配置</h3><h4 id="haproxy报文修改"><a href="#haproxy报文修改" class="headerlink" title="haproxy报文修改"></a>haproxy报文修改</h4><p>&emsp;&emsp;在http模式下，基于实际需求修改客户端的请求报文与响应报文，通过reqadd和reqdel在请求报文添加删除字段，通过rspadd与rspidel在响应报文中添加与删除字段。</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">在请求报文尾部添加指定首部</span><br><span class="line">    reqadd <span class="variable">&amp;ltstring</span><span class="variable">&amp;gt</span> [&#123;<span class="meta">if</span> | unless&#125; <span class="variable">&amp;ltcond</span><span class="variable">&amp;gt</span>]</span><br><span class="line">从请求报文中删除匹配正则表达式的首部</span><br><span class="line">    reqdel <span class="variable">&amp;ltsearch</span><span class="variable">&amp;gt</span> [&#123;<span class="meta">if</span> | unless&#125; <span class="variable">&amp;ltcond</span><span class="variable">&amp;gt</span>]</span><br><span class="line">    reqidel <span class="variable">&amp;ltsearch</span><span class="variable">&amp;gt</span> [&#123;<span class="meta">if</span> | unless&#125; <span class="variable">&amp;ltcond</span><span class="variable">&amp;gt</span>]</span><br><span class="line">在响应报文尾部添加指定首部</span><br><span class="line">    rspadd <span class="variable">&amp;ltstring</span><span class="variable">&amp;gt</span> [&#123;<span class="meta">if</span> | unless&#125; <span class="variable">&amp;ltcond</span><span class="variable">&amp;gt</span>]</span><br><span class="line">示例：</span><br><span class="line">    rspadd <span class="meta">X</span>-Via:\ HAPorxy</span><br><span class="line">从响应报文中删除匹配正则表达式的首部</span><br><span class="line">    rspdel <span class="variable">&amp;ltsearch</span><span class="variable">&amp;gt</span> [&#123;<span class="meta">if</span> | unless&#125; <span class="variable">&amp;ltcond</span><span class="variable">&amp;gt</span>]</span><br><span class="line">    rspidel <span class="variable">&amp;ltsearch</span><span class="variable">&amp;gt</span> [&#123;<span class="meta">if</span> | unless&#125; <span class="variable">&amp;ltcond</span><span class="variable">&amp;gt</span>]</span><br><span class="line">示例：</span><br><span class="line">    rspidel server.<span class="comment">* #从相应报文删除server信息</span></span><br><span class="line"><span class="comment">    rspidel X-Powered-By:.* #从响应报文删除X-Powered-By信息</span></span><br></pre></td></tr></table></figure><h4 id="HAProxy日志"><a href="#HAProxy日志" class="headerlink" title="HAProxy日志"></a>HAProxy日志</h4><h5 id="HAProxy日志配置"><a href="#HAProxy日志配置" class="headerlink" title="HAProxy日志配置"></a>HAProxy日志配置</h5><p>&emsp;&emsp;需在HAProxy和Rsyslog中分别配置。</p><ul><li>HAProxy配置<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">在global配置项定义：</span><br><span class="line">log <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> local&#123;<span class="number">1</span><span class="number">-7</span>&#125; info #基于syslog记录日志到指定设备，级别有(err、warning、info、debug)</span><br><span class="line">listen web_port</span><br><span class="line">bind <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">80</span></span><br><span class="line">mode http</span><br><span class="line">log global</span><br><span class="line">server web1 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br></pre></td></tr></table></figure></li></ul><p>&emsp;&emsp;然后重启HAProxy<code>systemctl restart haproxy</code></p><ul><li>Rsyslog配置</li></ul><p>&emsp;&emsp;编辑配置文件<code>vim /etc/rsyslog.conf</code></p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="meta-keyword">$ModLoad</span> imudp</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">$UDPServerRun</span> 514</span></span><br><span class="line">local3.* /var/<span class="built-in">log</span>/haproxy.<span class="built-in">log</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;然后重启Rsyslog<code>systemctl restart rsyslog</code></p><h5 id="HAProxy日志格式"><a href="#HAProxy日志格式" class="headerlink" title="HAProxy日志格式"></a>HAProxy日志格式</h5><p>&emsp;&emsp;将特定信息记录在日志中<br>&emsp;&emsp;配置选项：<br>&emsp;&emsp;<code>capture cookie &amp;ltname&amp;gt len &amp;ltlength&amp;gt</code> #捕获请求和响应报文中的 cookie并记录日志<br>&emsp;&emsp;<code>capture request header &amp;ltname&amp;gt len &amp;ltlength&amp;gt</code> #捕获请求报文中指定的首部内容和长度并记录日志<br>&emsp;&emsp;<code>capture response header &amp;ltname&amp;gt len &amp;ltlength&amp;gt</code> #捕获响应报文中指定的内容和长度首部并记录日志<br>&emsp;&emsp;示例：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">capture request <span class="selector-tag">header</span> Host len <span class="number">256</span></span><br><span class="line">capture request <span class="selector-tag">header</span> User-Agent len <span class="number">512</span></span><br><span class="line">capture request <span class="selector-tag">header</span> Referer len <span class="number">15</span></span><br></pre></td></tr></table></figure><h5 id="配置示例"><a href="#配置示例" class="headerlink" title="配置示例"></a>配置示例</h5><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line">    bind <span class="number">172.18</span><span class="number">.32</span><span class="number">.249</span>:<span class="number">80</span></span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    log global</span><br><span class="line">    option httplog #日志格式选项</span><br><span class="line">    capture request header X-Forwarded-For len <span class="number">15</span></span><br><span class="line">    capture request header User-Agent len <span class="number">512</span></span><br><span class="line">    cookie SERVER-COOKIE insert indirect nocache</span><br><span class="line">    server web1 <span class="number">192.168</span><span class="number">.32</span><span class="number">.81</span>:<span class="number">80</span> cookie web1 check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">3</span> rise <span class="number">5</span></span><br><span class="line">    server web2 <span class="number">192.168</span><span class="number">.32</span><span class="number">.82</span>:<span class="number">80</span> cookie web2 check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">3</span> rise <span class="number">5</span></span><br></pre></td></tr></table></figure><h4 id="压缩功能"><a href="#压缩功能" class="headerlink" title="压缩功能"></a>压缩功能</h4><p>&emsp;&emsp;启用功能可以对响应给客户端的报文进行压缩，以节省网络带宽，但是会占用部分CPU性能。</p><h5 id="配置选项"><a href="#配置选项" class="headerlink" title="配置选项"></a>配置选项</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">compression algo #启用http协议中的压缩机制，常用算法有gzip deflate</span><br><span class="line">   <span class="built_in"> identity </span>#调试使用的压缩方式</span><br><span class="line">    gzip #常用的压缩方式，与各浏览器兼容较好</span><br><span class="line">    deflate #有些浏览器不支持</span><br><span class="line">    raw-deflate #新出的压缩方式</span><br><span class="line">compression<span class="built_in"> type </span>#要压缩的文件类型</span><br></pre></td></tr></table></figure><h5 id="配置示例-1"><a href="#配置示例-1" class="headerlink" title="配置示例"></a>配置示例</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line">    bind 172.18.32.249:80</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    log global</span><br><span class="line">    option httplog</span><br><span class="line"><span class="comment">#    capture request header X-Forwarded-For len 15</span></span><br><span class="line"><span class="comment">#    capture request header User-Agent len 512</span></span><br><span class="line">    compression algo gzip</span><br><span class="line">    compression<span class="built_in"> type </span>compression<span class="built_in"> type </span>text/plain text/html text/css text/xml text/javascript application/javascript</span><br><span class="line">cookie SERVER-COOKIE insert indirect nocache</span><br><span class="line">server web1 192.168.32.81:80 cookie web1 check inter 3000 fall 3 rise 5</span><br><span class="line">server web2 192.168.32.82:80 cookie web2 check inter 3000 fall 3 rise 5</span><br></pre></td></tr></table></figure><h3 id="后端服务器状态监测"><a href="#后端服务器状态监测" class="headerlink" title="后端服务器状态监测"></a>后端服务器状态监测</h3><p>&emsp;&emsp;haproxy能对后端服务器状态进行检测，如果发现后端服务器异常，可以自动将该服务器下线，实现高可用。<br>&emsp;&emsp;haproxy对后端服务器有三种检测方式：</p><ul><li>基于四层的传输端口做状态监测</li><li>基于指定URI 做状态监测</li><li>基于指定URI的request请求头部内容做状态监测<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">option httpchk</span><br><span class="line">option httpchk <span class="variable">&amp;lturi</span><span class="variable">&amp;gt</span></span><br><span class="line">option httpchk <span class="variable">&amp;ltmethod</span><span class="variable">&amp;gt</span> <span class="variable">&amp;lturi</span><span class="variable">&amp;gt</span></span><br><span class="line">option httpchk <span class="variable">&amp;ltmethod</span><span class="variable">&amp;gt</span> <span class="variable">&amp;lturi</span><span class="variable">&amp;gt</span> <span class="variable">&amp;ltversion</span><span class="variable">&amp;gt</span></span><br></pre></td></tr></table></figure></li></ul><p>&emsp;&emsp;之前我们的配置都是基于传输IP加端口对检测，所以status状态页的后端检测状态里显示的是L4，基于指定URI做状态监测，需要持续从服务器get指定页面，会占用消耗一些带宽资源，所以基于指定URI的request请求头部内容做状态监测最为合理，配置如下：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line">    bind <span class="number">172.18</span><span class="number">.32</span><span class="number">.249</span>:<span class="number">80</span></span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    log global</span><br><span class="line">    option httplog</span><br><span class="line">#    option httpchk GET /app/monitor/check.html HTTP/<span class="number">1.0</span></span><br><span class="line">    option httpchk HEAD /app/monitor/check.html HTTP/<span class="number">1.0</span>\r\nHost:\ <span class="number">192.168</span><span class="number">.7</span><span class="number">.102</span></span><br><span class="line">    cookie SERVER-COOKIE insert indirect nocache</span><br><span class="line">    server web1 <span class="number">192.168</span><span class="number">.32</span><span class="number">.81</span>:<span class="number">80</span> cookie web1 check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">3</span> rise <span class="number">5</span></span><br><span class="line">    server web2 <span class="number">192.168</span><span class="number">.32</span><span class="number">.82</span>:<span class="number">80</span> cookie web2 check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">3</span> rise <span class="number">5</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;这时再去看9999端口的status页，就会看到后端服务器的检测状态为L7OK了</p><h3 id="HAProxy的ACL功能"><a href="#HAProxy的ACL功能" class="headerlink" title="HAProxy的ACL功能"></a>HAProxy的ACL功能</h3><p>&emsp;&emsp;访问控制列表（ACL，Access Control Lists）是一种基于包过滤的访问控制技术，它可以根据设定的条件对经过服务器传输的数据包进行过滤(条件匹配)，即对接收到的报文进行匹配和过滤，基于请求报文头部中的源地址、源端口、目标地址、目标端口、请求方法、URL、文件后缀等信息内容进行匹配并执行进一步操作，允许其通过或丢弃。</p><h4 id="ACL配置选项："><a href="#ACL配置选项：" class="headerlink" title="ACL配置选项："></a>ACL配置选项：</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">acl <span class="variable">&amp;ltaclname</span><span class="variable">&amp;gt</span> <span class="variable">&amp;ltcriterion</span><span class="variable">&amp;gt</span> [flags] [operator] [<span class="variable">&amp;ltvalue</span><span class="variable">&amp;gt</span>]</span><br><span class="line">acl 名称 匹配规范 匹配模式 具体操作符 操作对象类型</span><br></pre></td></tr></table></figure><h5 id="ACL-Name"><a href="#ACL-Name" class="headerlink" title="ACL-Name"></a>ACL-Name</h5><p>&emsp;&emsp;实例：<code>acl image_service hdr_dom(host) -i img.example.com</code><br>&emsp;&emsp;ACL名称，可以使用大字母A-Z、小写字母a-z、数字0-9、冒号：、点.、中横线和下划线，并且严格区分大小写，比如Image_site和image_site完全是两个acl。</p><h5 id="ACL-criterion"><a href="#ACL-criterion" class="headerlink" title="ACL-criterion"></a>ACL-criterion</h5><p>&emsp;&emsp;定义ACL匹配规范</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">hdr（[<span class="variable">&amp;ltname</span><span class="variable">&amp;gt</span> [，<span class="variable">&amp;ltocc</span><span class="variable">&amp;gt</span>]]）：完全匹配字符串</span><br><span class="line">hdr_beg（[<span class="variable">&amp;ltname</span><span class="variable">&amp;gt</span> [，<span class="variable">&amp;ltocc</span><span class="variable">&amp;gt</span>]]）：前缀匹配</span><br><span class="line">hdr_dir（[<span class="variable">&amp;ltname</span><span class="variable">&amp;gt</span> [，<span class="variable">&amp;ltocc</span><span class="variable">&amp;gt</span>]]）：路径匹配</span><br><span class="line">hdr_dom（[<span class="variable">&amp;ltname</span><span class="variable">&amp;gt</span> [，<span class="variable">&amp;ltocc</span><span class="variable">&amp;gt</span>]]）：域匹配</span><br><span class="line">hdr_end（[<span class="variable">&amp;ltname</span><span class="variable">&amp;gt</span> [，<span class="variable">&amp;ltocc</span><span class="variable">&amp;gt</span>]]）：后缀匹配</span><br><span class="line">hdr_len（[<span class="variable">&amp;ltname</span><span class="variable">&amp;gt</span> [，<span class="variable">&amp;ltocc</span><span class="variable">&amp;gt</span>]]）：长度匹配</span><br><span class="line">hdr_reg（[<span class="variable">&amp;ltname</span><span class="variable">&amp;gt</span> [，<span class="variable">&amp;ltocc</span><span class="variable">&amp;gt</span>]]）：正则表达式匹配</span><br><span class="line">hdr_sub（[<span class="variable">&amp;ltname</span><span class="variable">&amp;gt</span> [，<span class="variable">&amp;ltocc</span><span class="variable">&amp;gt</span>]]）：子串匹配</span><br><span class="line">dst 目标IP</span><br><span class="line">dst_port 目标PORT</span><br><span class="line">src 源IP</span><br><span class="line">src_port 源PORT</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;示例:</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hdr &amp;ltstring&amp;gt用于测试请求头部首部指定内容</span><br><span class="line"><span class="function"><span class="title">hdr_dom</span><span class="params">(host)</span></span> 请求的host名称，如 www<span class="selector-class">.example</span><span class="selector-class">.com</span></span><br><span class="line"><span class="function"><span class="title">hdr_beg</span><span class="params">(host)</span></span> 请求的host开头，如 www. <span class="selector-tag">img</span>. <span class="selector-tag">video</span>. download. ftp.</span><br><span class="line"><span class="function"><span class="title">hdr_end</span><span class="params">(host)</span></span> 请求的host结尾，如 <span class="selector-class">.com</span> <span class="selector-class">.net</span> .cn</span><br><span class="line">path_beg 请求的URL开头，如/static、/images、/img、/css</span><br><span class="line">path_end 请求的URL中资源的结尾，如 <span class="selector-class">.gif</span> <span class="selector-class">.png</span> <span class="selector-class">.css</span> <span class="selector-class">.js</span> <span class="selector-class">.jpg</span> .jpeg</span><br></pre></td></tr></table></figure><h5 id="ACL-flags"><a href="#ACL-flags" class="headerlink" title="ACL-flags"></a>ACL-flags</h5><p>&emsp;&emsp;ACL匹配模式<br>&emsp;&emsp;&emsp;&emsp;-i 不区分大小写<br>&emsp;&emsp;&emsp;&emsp;-m 使用指定的pattern匹配方法<br>&emsp;&emsp;&emsp;&emsp;-n 不做DNS解析<br>&emsp;&emsp;&emsp;&emsp;-u 禁止acl重名，否则多个同名ACL匹配或关系</p><h5 id="ACL-operator"><a href="#ACL-operator" class="headerlink" title="ACL-operator"></a>ACL-operator</h5><p>&emsp;&emsp;ACL 操作符</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">整数比较：eq、ge、gt、le、lt</span><br><span class="line">字符比较：</span><br><span class="line">  exact match (-m str) :字符串必须完全匹配模式</span><br><span class="line">  substring match (-m sub) :在提取的字符串中查找模式，如果其中任何一个被发现，ACL将匹配</span><br><span class="line"> <span class="built_in"> prefix </span>match (-m beg) :在提取的字符串首部中查找模式，如果其中任何一个被发现，ACL将匹配</span><br><span class="line">  suffix match (-m end) :将模式与提取字符串的尾部进行比较，如果其中任何一个匹配，则ACL进行匹配</span><br><span class="line">  subdir match (-m dir) :查看提取出来的用斜线分隔（“/”）的字符串，如果其中任何一个匹配，则ACL进行匹配</span><br><span class="line">  domain match (-m dom) :查找提取的用点（“.”）分隔字符串，如果其中任何一个匹配，则ACL进行匹配</span><br></pre></td></tr></table></figure><h5 id="ACL-value"><a href="#ACL-value" class="headerlink" title="ACL-value"></a>ACL-value</h5><p>&emsp;&emsp;value的类型</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">The ACL engine can match these types against patterns of the following types :</span><br><span class="line">  Boolean #布尔值</span><br><span class="line">  integer <span class="keyword">or</span> integer range #整数或整数范围，比如用于匹配端口范围</span><br><span class="line"> <span class="built_in"> IP address </span>/<span class="built_in"> network </span>#IP地址或IP范围, 192.168.0.1 ,192.168.0.1/24</span><br><span class="line">  string</span><br><span class="line">      exact –精确比较</span><br><span class="line">      substring—子串 www.example.com</span><br><span class="line">      suffix-后缀比较</span><br><span class="line">      prefix-前缀比较</span><br><span class="line">      subdir-路径， /wp-includes/js/jquery/jquery.js</span><br><span class="line">      domain-域名，www.example.com</span><br><span class="line">  regular expression #正则表达式</span><br><span class="line">  hex block #16进制</span><br></pre></td></tr></table></figure><h4 id="ACL调用方式"><a href="#ACL调用方式" class="headerlink" title="ACL调用方式"></a>ACL调用方式</h4><p>&emsp;&emsp;ACL调用方式：</p><ul><li>与：隐式（默认）使用</li><li>或：使用“or” 或 “||”表示</li><li>否定：使用“!“ 表示</li></ul><p>&emsp;&emsp;示例：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> valid_src valid_port <span class="comment">#与关系</span></span><br><span class="line"><span class="keyword">if</span> invalid_src <span class="params">||</span> invalid_port <span class="comment">#或</span></span><br><span class="line"><span class="keyword">if</span> ! invalid_src <span class="comment">#非</span></span><br></pre></td></tr></table></figure><h4 id="ACL具体示例"><a href="#ACL具体示例" class="headerlink" title="ACL具体示例"></a>ACL具体示例</h4><h5 id="域名匹配"><a href="#域名匹配" class="headerlink" title="域名匹配:"></a>域名匹配:</h5><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line">    bind <span class="number">172.18</span><span class="number">.32</span><span class="number">.249</span>:<span class="number">80</span></span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    log global</span><br><span class="line">    option httplog</span><br><span class="line">    acl web_host hdr_dom(host) www.example.net</span><br><span class="line">    use_backend example_host <span class="keyword">if</span> web_host</span><br><span class="line">    default_backend default_web</span><br><span class="line">backend example_host</span><br><span class="line">    mode http</span><br><span class="line">    server web1 <span class="number">192.168</span><span class="number">.32</span><span class="number">.81</span>:<span class="number">80</span> check <span class="built_in">int</span>er <span class="number">2000</span> fall <span class="number">3</span> rise <span class="number">5</span></span><br><span class="line">    backend default_web</span><br><span class="line">    mode http</span><br><span class="line">    server web2 <span class="number">192.168</span><span class="number">.32</span><span class="number">.82</span>:<span class="number">80</span> check <span class="built_in">int</span>er <span class="number">2000</span> fall <span class="number">3</span> rise <span class="number">5</span></span><br></pre></td></tr></table></figure><h5 id="匹配浏览器类型"><a href="#匹配浏览器类型" class="headerlink" title="匹配浏览器类型:"></a>匹配浏览器类型:</h5><p>&emsp;&emsp;匹配客户端浏览器，将不同类型的浏览器调动至不同的服务器组</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line">    bind 172.18.32.249:80</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    log global</span><br><span class="line">    option httplog</span><br><span class="line">    acl web_host hdr_dom(host) www.example.net</span><br><span class="line">    use_backend example_host<span class="built_in"> if </span>web_host</span><br><span class="line">    acl redirect_test hdr(User-Agent) -m<span class="built_in"> sub </span>-i <span class="string">"Mozilla/5.0 (Windows NT 6.1; WOW64;Trident/7.0; rv:11.0) like Gecko"</span></span><br><span class="line">    redirect prefix http://192.168.7.103<span class="built_in"> if </span>redirect_test</span><br><span class="line">    default_backend default_web</span><br><span class="line">backend example_host</span><br><span class="line">    mode http</span><br><span class="line">    server web1 192.168.32.81:80<span class="built_in"> check </span>inter 2000 fall 3 rise 5</span><br><span class="line">backend default_web</span><br><span class="line">    mode http</span><br><span class="line">    server web2 192.168.32.82:80<span class="built_in"> check </span>inter 2000 fall 3 rise 5</span><br></pre></td></tr></table></figure><h5 id="基于文件后缀名实现动静分离"><a href="#基于文件后缀名实现动静分离" class="headerlink" title="基于文件后缀名实现动静分离:"></a>基于文件后缀名实现动静分离:</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line">    bind 172.18.32.249:80</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    log global</span><br><span class="line">    option httplog</span><br><span class="line">    acl php_server path_end -i .php</span><br><span class="line">    use_backend php_server_host <span class="keyword">if</span> php_server</span><br><span class="line">    acl image_server path_end -i .jpg .png .jpeg .gif</span><br><span class="line">    use_backend image_server_host <span class="keyword">if</span> image_server</span><br><span class="line">    default_backend default_web</span><br><span class="line">backend php_server_host</span><br><span class="line">    mode http</span><br><span class="line">   <span class="built_in"> server </span>web1 192.168.32.81 check inter 2000 fall 3 rise 5</span><br><span class="line">backend image_server_host</span><br><span class="line">    mode http</span><br><span class="line">   <span class="built_in"> server </span>web1 192.168.32.82 check inter 2000 fall 3 rise 5</span><br><span class="line">backend default_web</span><br><span class="line">    mode http</span><br><span class="line">   <span class="built_in"> server </span>web1 192.168.32.8:80 check inter 2000 fall 3 rise 5</span><br></pre></td></tr></table></figure><h5 id="匹配访问路径实现动静分离"><a href="#匹配访问路径实现动静分离" class="headerlink" title="匹配访问路径实现动静分离:"></a>匹配访问路径实现动静分离:</h5><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line">    bind 172.18.32.249:80</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    log global</span><br><span class="line">    option httplog</span><br><span class="line">    acl<span class="keyword"> static</span>_path path_beg -i /static /images /javascript</span><br><span class="line">    use_backend<span class="keyword"> static</span>_path_host<span class="built_in"> if </span>static_path</span><br><span class="line">    default_backend default_web</span><br><span class="line">backend<span class="keyword"> static</span>_path_host</span><br><span class="line">    mode http</span><br><span class="line">    server web1 192.168.32.81<span class="built_in"> check </span>inter 2000 fall 3 rise 5</span><br><span class="line">backend default_web</span><br><span class="line">    mode http</span><br><span class="line">    server web1 192.168.32.8:80<span class="built_in"> check </span>inter 2000 fall 3 rise 5</span><br></pre></td></tr></table></figure><h5 id="预定义ACL"><a href="#预定义ACL" class="headerlink" title="预定义ACL"></a>预定义ACL</h5><p>预定义ACL：</p><table><thead><tr><th>ACLname</th><th>Equivalent to</th><th>Usage</th></tr></thead><tbody><tr><td>FALSE</td><td>always_false</td><td>never match</td></tr><tr><td>HTTP</td><td>req_proto_http</td><td>match if protocol is valid HTTP</td></tr><tr><td>HTTP_1.0</td><td>req_ver 1.0</td><td>match HTTP version 1.0</td></tr><tr><td>HTTP_1.1</td><td>req_ver 1.1</td><td>match HTTP version 1.1</td></tr><tr><td>HTTP_CONTENT</td><td>hdr_val(content-length) gt 0</td><td>match an existing content-length</td></tr><tr><td>HTTP_URL_ABS</td><td>url_reg ^[^/:]*: //</td><td>match absolute URL with scheme</td></tr><tr><td>HTTP_URL_SLASH</td><td>url_beg /</td><td>match URL beginning with “/“</td></tr><tr><td>HTTP_URL_STAR</td><td>url *</td><td>match URL equal to “*”</td></tr><tr><td>LOCALHOST</td><td>src 127.0.0.1/8</td><td>match connection from local host</td></tr><tr><td>METH_CONNECT</td><td>method CONNECT</td><td>match HTTP CONNECT method</td></tr><tr><td>METH_DELETE</td><td>method DELETE</td><td>match HTTP DELETE method</td></tr><tr><td>METH_GET</td><td>method GET HEAD</td><td>match HTTP GET or HEAD method</td></tr><tr><td>METH_HEAD</td><td>method HEAD</td><td>match HTTP HEAD method</td></tr><tr><td>METH_OPTIONS</td><td>method OPTIONS</td><td>match HTTP OPTIONS method</td></tr><tr><td>METH_POST</td><td>method POST</td><td>match HTTP POST method</td></tr><tr><td>METH_PUT</td><td>method PUT</td><td>match HTTP PUT method</td></tr><tr><td>METH_TRACE</td><td>method TRACE match</td><td>HTTP TRACE method</td></tr><tr><td>RDP_COOKIE</td><td>req_rdp_cookie_cnt gt 0</td><td>match presence of an RDP cookie</td></tr><tr><td>REQ_CONTENT</td><td>req_len gt 0</td><td>match data in the request buffer</td></tr><tr><td>TRUE</td><td>always_true</td><td>always match</td></tr><tr><td>WAIT_END</td><td>wait_end</td><td>wait for end of content analysis</td></tr></tbody></table><p>&emsp;&emsp;预定义ACL使用示例</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line">    bind 172.18.32.249:80</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    log global</span><br><span class="line">    option httplog</span><br><span class="line">    acl<span class="keyword"> static</span>_path path_beg -i /static /images /javascript</span><br><span class="line">    use_backend<span class="keyword"> static</span>_path_host<span class="built_in"> if </span>HTTP_1.1 TRUE<span class="keyword"> static</span>_path</span><br><span class="line">    default_backend default_web</span><br><span class="line">backend php_server_host</span><br><span class="line">    mode http</span><br><span class="line">    server web1 192.168.32.81<span class="built_in"> check </span>inter 2000 fall 3 rise 5</span><br><span class="line">backend<span class="keyword"> static</span>_path_host</span><br><span class="line">    mode http</span><br><span class="line">    server web1 192.168.32.82<span class="built_in"> check </span>inter 2000 fall 3 rise 5</span><br><span class="line">backend default_web</span><br><span class="line">    mode http</span><br><span class="line">    server web1 192.168.32.8:80<span class="built_in"> check </span>inter 2000 fall 3 rise 5</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;详细信息查看官网<a href="http://cbonte.github.io/haproxy-dconv/2.0/configuration.html#7.4" rel="noopener" target="_blank">http://cbonte.github.io/haproxy-dconv/2.0/configuration.html#7.4</a></p>]]></content>
      
      
      <categories>
          
          <category> linux进阶 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 企业级应用 </tag>
            
            <tag> 高可用 </tag>
            
            <tag> HAProxy </tag>
            
            <tag> 负载均衡 </tag>
            
            <tag> 调度算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>企业级应用：负载均衡层——haproxy(一)</title>
      <link href="//blog/5aeb7732.html"/>
      <url>//blog/5aeb7732.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;HAProxy是法国开发者 威利塔罗(Willy Tarreau) 在2000年使用C语言开发的一个开源软件，是一款具备高并发(一万以上)、高性能的TCP&gt;和HTTP负载均衡器，支持基于cookie的持久性，自动故障切换，支持正则表达式及web状态统计。<br>&emsp;&emsp;HAProxy特别适用于那些负载特大的web站点，这些站点通常又需要会话保持或七层处理。HAProxy运行在当前的硬件上，完全可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的web服务器不被暴露到网络上。<br>&emsp;&emsp;包括 GitHub、Bitbucket、Stack Overflow、Reddit、Tumblr、Twitter和 Tuenti[7]在内的知名网站，及亚马逊网络服务系统都使用了HAProxy。</p><a id="more"></a><h3 id="HAProxy功能"><a href="#HAProxy功能" class="headerlink" title="HAProxy功能"></a>HAProxy功能</h3><h4 id="HAProxy功能："><a href="#HAProxy功能：" class="headerlink" title="HAProxy功能："></a>HAProxy功能：</h4><ul><li>TCP和HTTP反向代理</li><li>SSL/TSL服务器</li><li>可以针对HTTP请求添加cookie，进行路由后端服务器</li><li>可平衡负载至后端服务器，并支持持久连接</li><li>支持所有主服务器故障切换至备用服务器</li><li>支持专用端口实现监控服务</li><li>支持不影响现有连接情况下停止接受新连接请求</li><li>可以在双向添加，修改或删除HTTP报文首部</li><li>响应报文压缩</li><li>支持基于pattern实现连接请求的访问控制</li><li>通过特定的URI为授权用户提供详细的状态信息</li></ul><h4 id="不具备的功能："><a href="#不具备的功能：" class="headerlink" title="不具备的功能："></a>不具备的功能：</h4><ul><li>正向代理–squid，nginx</li><li>缓存代理–varnish</li><li>web服务–nginx、tengine、apache、php、tomcat</li><li>UDP–目前不支持UDP协议，2.1版本会支持UDP协议代理</li><li>单机性能–LVS</li></ul><h3 id="HAProxy安装"><a href="#HAProxy安装" class="headerlink" title="HAProxy安装"></a>HAProxy安装</h3><p>&emsp;&emsp;HAProxy 支持基于lua实现功能扩展，lua是一种小巧的脚本语言，于1993年由巴西里约热内卢天主教大学（Pontifical Catholic University of Rio de Janeiro）里的一个研究小组开发，其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。<br>&emsp;&emsp;由于centos自带的lua版本比较低并不符合HAProxy要求的lua最低版本(5.3)的要求，因此需要编译安装较新版本的lua环境，然后才能编译安装HAProxy。</p><h4 id="安装lua环境"><a href="#安装lua环境" class="headerlink" title="安装lua环境"></a>安装lua环境</h4><p>&emsp;&emsp;配置lua环境</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> libtermcap-devel ncurses-devel libevent-devel readline-devel gcc make</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;下载lua源码tar包</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="regexp">//</span>www.lua.org<span class="regexp">/ftp/</span>lua-<span class="number">5.3</span>.<span class="number">5</span>.tar.gz</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;编译安装lua</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">tar</span> <span class="selector-tag">xvf</span> <span class="selector-tag">lua-5</span><span class="selector-class">.3</span><span class="selector-class">.5</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line"><span class="selector-tag">cd</span> <span class="selector-tag">lua-5</span><span class="selector-class">.3</span><span class="selector-class">.5</span></span><br><span class="line"><span class="selector-tag">make</span> <span class="selector-tag">linux</span> <span class="selector-tag">test</span></span><br></pre></td></tr></table></figure><h4 id="安装HAProxy"><a href="#安装HAProxy" class="headerlink" title="安装HAProxy"></a>安装HAProxy</h4><p>&emsp;&emsp;下载haproxy源码包</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="regexp">//</span>www.haproxy.org<span class="regexp">/download/</span><span class="number">2.0</span><span class="regexp">/src/</span>haproxy-<span class="number">2.0</span>.<span class="number">8</span>.tar.gz</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;安装依赖包</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">yum</span> <span class="comment">install</span> <span class="comment">gcc</span> <span class="comment">gcc</span><span class="literal">-</span><span class="comment">c</span><span class="literal">+</span><span class="literal">+</span> <span class="comment">glibc</span> <span class="comment">glibc</span><span class="literal">-</span><span class="comment">devel</span> <span class="comment">pcre</span> <span class="comment">pcre</span><span class="literal">-</span><span class="comment">devel</span> <span class="comment">openssl</span> <span class="comment">openssl</span><span class="literal">-</span><span class="comment">devel</span> <span class="comment">systemd</span><span class="literal">-</span><span class="comment">devel</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;（附加工具包<code>net-tools vim iotop bc zip unzip zlib-devel lrzsz tree screen lsof tcpdump wget ntpdate</code>）<br>&emsp;&emsp;编译安装haproxy<br>&emsp;&emsp;<code>cd haproxy-2.0.8</code><br>&emsp;&emsp;HAProxy 1.8及1.9版本编译参数：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">make <span class="attribute">ARCH</span>=x86_64 \</span><br><span class="line"><span class="attribute">TARGET</span>=linux2628 \</span><br><span class="line"><span class="attribute">USE_PCRE</span>=1 \</span><br><span class="line"><span class="attribute">USE_OPENSSL</span>=1 \</span><br><span class="line"><span class="attribute">USE_ZLIB</span>=1 \</span><br><span class="line"><span class="attribute">USE_SYSTEMD</span>=1 \</span><br><span class="line"><span class="attribute">USE_CPU_AFFINITY</span>=1 \</span><br><span class="line"><span class="attribute">PREFIX</span>=/apps/haproxy</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;HAProxy 2.0编译参数：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">make <span class="attribute">ARCH</span>=x86_64 \</span><br><span class="line"><span class="attribute">TARGET</span>=linux-glibc <span class="attribute">USE_PCRE</span>=1 \</span><br><span class="line"><span class="attribute">USE_OPENSSL</span>=1 \</span><br><span class="line"><span class="attribute">USE_ZLIB</span>=1 \</span><br><span class="line"><span class="attribute">USE_SYSTEMD</span>=1 \</span><br><span class="line"><span class="attribute">USE_CPU_AFFINITY</span>=1 \</span><br><span class="line"><span class="attribute">USE_LUA</span>=1 \</span><br><span class="line"><span class="attribute">LUA_INC</span>=/data/tar/lua-5.3.5/src/ \</span><br><span class="line"><span class="attribute">LUA_LIB</span>=/data/tar/lua-5.3.5/src/ \</span><br><span class="line"><span class="attribute">PREFIX</span>=/apps/haproxy</span><br></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make install PREFIX=<span class="regexp">/apps/</span>haproxy</span><br><span class="line">cp haproxy <span class="regexp">/usr/</span>sbin<span class="regexp">/</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;haproxy启动脚本<br>&emsp;&emsp;<code>vim /usr/lib/systemd/system/haproxy.service</code></p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=HAProxy Load Balancer</span><br><span class="line">After=syslog.target network.target</span><br><span class="line">[Service]</span><br><span class="line">ExecStartPre=<span class="regexp">/usr/sbin</span><span class="regexp">/haproxy -f /etc</span><span class="regexp">/haproxy/haproxy</span>.cfg -c -q</span><br><span class="line">ExecStart=<span class="regexp">/usr/sbin</span><span class="regexp">/haproxy -Ws -f /etc</span><span class="regexp">/haproxy/haproxy</span>.cfg -p /var/<span class="class"><span class="keyword">lib</span>/<span class="title">haproxy</span>/<span class="title">haproxy</span>.<span class="title">pid</span></span></span><br><span class="line">ExecReload=<span class="regexp">/bin/kill</span> -USR2 $MAINPID</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target\</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;haproxy配置文件(基本配置文件)<br>&emsp;&emsp;<code>mkdir /etc/haproxy</code><br>&emsp;&emsp;<code>vim /etc/haproxy/haproxy.cfg</code></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">    chroot /apps/haproxy   #锁定运行目录</span><br><span class="line">    stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin   #socket文件</span><br><span class="line">    uid 99       #运行haproxy的用户身份，也可设user，group</span><br><span class="line">    gid 99</span><br><span class="line">    daemon    #以守护进程运行</span><br><span class="line"><span class="comment">#    nbproc 4    #指定每个haproxy进程开启的线程数，默认为每个进程一个线程</span></span><br><span class="line"><span class="comment">#    cpu-map 1 0    #绑定haproxy 进程至指定CPU</span></span><br><span class="line"><span class="comment">#    cpu-map 2 1</span></span><br><span class="line"><span class="comment">#    cpu-map 3 2</span></span><br><span class="line"><span class="comment">#    cpu-map 4 3</span></span><br><span class="line">maxconn 100000   #每个haproxy进程的最大并发连接数</span><br><span class="line"><span class="comment">#maxsslconn          #每个haproxy进程ssl最大连接数,用于haproxy配置了证书的场景下</span></span><br><span class="line"><span class="comment">#spread-checks      #后端server状态check随机提前或延迟百分比时间，建议2-5(20%-50%)之间</span></span><br><span class="line">pidfile /var/lib/haproxy/haproxy.pid</span><br><span class="line">log 127.0.0.1 local3 <span class="builtin-name">info</span>   #定义全局的syslog服务器；最多可以定义两个</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    option http-keep-alive</span><br><span class="line">    option forwardfor</span><br><span class="line">    maxconn 100000</span><br><span class="line">    mode http</span><br><span class="line">    timeout connect 300000ms</span><br><span class="line">    timeout<span class="built_in"> client </span>300000ms</span><br><span class="line">    timeout<span class="built_in"> server </span>300000ms</span><br><span class="line"></span><br><span class="line">listen stats</span><br><span class="line">    mode http</span><br><span class="line">    bind 0.0.0.0:9999</span><br><span class="line">    stats enable</span><br><span class="line">    log global</span><br><span class="line">    stats uri /haproxy-status</span><br><span class="line">    stats auth haadmin:q1w2e3r4ys</span><br><span class="line">listen web_port</span><br><span class="line">    bind 192.168.32.84:80</span><br><span class="line">    mode http</span><br><span class="line">    log global</span><br><span class="line">   <span class="built_in"> server </span>web1 127.0.0.1:8080 check inter 3000 fall 2 rise 5</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;设置haproxypid及socket创建权限<br>&emsp;&emsp;<code>useradd -s /sbin/nologin -r -u 99 haproxy</code><br>&emsp;&emsp;<code>mkdir /var/lib/haproxy</code><br>&emsp;&emsp;<code>chown 99.99 /var/lib/haproxy/ -R</code></p><p>&emsp;&emsp;至此，才完成haproxy的安装与配置,启动并查看haproxy的状态是否正常吧。<br>&emsp;&emsp;<code>systemctl enable --now haproxy</code><br>&emsp;&emsp;<code>systemctl status haproxy</code></p><h3 id="配置web均衡"><a href="#配置web均衡" class="headerlink" title="配置web均衡"></a>配置web均衡</h3><p>&emsp;&emsp;haproxy最主要的功能就是为后端服务器做反向代理，例如我们要为后面的四个web服务器做反向代理，配置文件如下：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">    maxconn <span class="number">100000</span></span><br><span class="line">    chroot /apps/haproxy</span><br><span class="line">    stats socket /var/lib/haproxy/haproxy.sock1 mode <span class="number">600</span> level admin process <span class="number">1</span></span><br><span class="line">    stats socket /var/lib/haproxy/haproxy.sock2 mode <span class="number">600</span> level admin process <span class="number">2</span></span><br><span class="line">    uid <span class="number">99</span></span><br><span class="line">    gid <span class="number">99</span></span><br><span class="line">    daemon</span><br><span class="line">    nbproc <span class="number">2</span>       #指定每个haproxy进程开启的线程数，默认为每个进程一个线程</span><br><span class="line">    cpu-map <span class="number">1</span> <span class="number">0</span>    #cpu工作线程绑定</span><br><span class="line">    cpu-map <span class="number">2</span> <span class="number">1</span></span><br><span class="line">#    cpu-map <span class="number">3</span> <span class="number">2</span></span><br><span class="line">#    cpu-map <span class="number">4</span> <span class="number">3</span></span><br><span class="line">    pidfile /var/lib/haproxy/haproxy.pid</span><br><span class="line">    log <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> local3 info</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    option redispatch      #当server Id对应的服务器挂掉后，强制定向到其他健康的服务器</span><br><span class="line">    option abortonclose    #当服务器负载很高的时候，自动结束掉当前队列处理比较久的链接</span><br><span class="line">    option http-keep-alive #开启与客户端的会话保持</span><br><span class="line">    option  forwardfor     #透传客户端真实IP至后端web服务器</span><br><span class="line">    mode http #默认工作类型</span><br><span class="line">    timeout connect <span class="number">600</span>s  #客户端请求到后端server的最长连接等待时间(TCP之前)</span><br><span class="line">    timeout server  <span class="number">600</span>s  #客户端请求到后端服务端的超时超时时长（TCP之后）</span><br><span class="line">    timeout client  <span class="number">600</span>s  #与客户端的最长非活动时间</span><br><span class="line">    timeout http-keep-alive <span class="number">120</span>s #session会话保持超时时间，范围内会转发到相同的后端服务器</span><br><span class="line">    timeout  check   <span class="number">50</span>s   #对后端服务器的检测超时时间option http-keep-alive</span><br><span class="line"></span><br><span class="line">#frontend WEB_PORT_80</span><br><span class="line">#    bind <span class="number">192.168</span><span class="number">.32</span><span class="number">.84</span>:<span class="number">80</span></span><br><span class="line">#    mode http</span><br><span class="line">#    use_backend web_prot_http_nodes</span><br><span class="line"></span><br><span class="line">#backend web_prot_http_nodes</span><br><span class="line">#    mode http</span><br><span class="line">#    option forwardfor</span><br><span class="line">#    balance static-rr</span><br><span class="line">#    server web0 <span class="number">192.168</span><span class="number">.32</span><span class="number">.8</span>:<span class="number">80</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">3</span> rise <span class="number">5</span></span><br><span class="line">#    server web3 <span class="number">192.168</span><span class="number">.32</span><span class="number">.83</span>:<span class="number">80</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">3</span> rise <span class="number">5</span></span><br><span class="line">#    server web2 <span class="number">192.168</span><span class="number">.32</span><span class="number">.82</span>:<span class="number">80</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">3</span> rise <span class="number">5</span></span><br><span class="line">#    server web1 <span class="number">192.168</span><span class="number">.32</span><span class="number">.81</span>:<span class="number">80</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">3</span> rise <span class="number">5</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">listen stats</span><br><span class="line">    bind <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">9999</span></span><br><span class="line">    mode http</span><br><span class="line">    stats enable</span><br><span class="line">    log global</span><br><span class="line">    stats uri /proxy_status         #进入后台状态页url路径</span><br><span class="line">    stats auth haadmin:hapasswd     #进入后台的账号密码</span><br><span class="line"></span><br><span class="line">listen web_host       #使用listen替换frontend+backend的配置方式</span><br><span class="line">    bind <span class="number">192.168</span><span class="number">.32</span><span class="number">.84</span>:<span class="number">80</span></span><br><span class="line">    mode http</span><br><span class="line">    log global</span><br><span class="line">    balance roundrobin  #定义调度算法为roundrobin</span><br><span class="line">    server web0 <span class="number">192.168</span><span class="number">.32</span><span class="number">.8</span>:<span class="number">80</span> weight <span class="number">1</span> check  addr <span class="number">192.168</span><span class="number">.32</span><span class="number">.8</span> port <span class="number">9000</span> <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br><span class="line">    server web1 <span class="number">192.168</span><span class="number">.32</span><span class="number">.81</span>:<span class="number">80</span> weight <span class="number">1</span> check addr <span class="number">192.168</span><span class="number">.32</span><span class="number">.81</span> port <span class="number">9000</span> <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br><span class="line">    server web2 <span class="number">192.168</span><span class="number">.32</span><span class="number">.82</span>:<span class="number">80</span> weight <span class="number">1</span> check addr <span class="number">192.168</span><span class="number">.32</span><span class="number">.82</span> port <span class="number">9000</span> <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br><span class="line">    server web3 <span class="number">192.168</span><span class="number">.32</span><span class="number">.83</span>:<span class="number">80</span> weight <span class="number">1</span> check addr <span class="number">192.168</span><span class="number">.32</span><span class="number">.83</span> port <span class="number">9000</span> <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;重启服务<code>systemctl restart haproxy</code>,便可登陆本机的状态页(haadmin:hapasswd)查看后端服务器状态。</p><p><img src="https://img-blog.csdnimg.cn/20191104184953377.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;刷新几次可以看到，不同pid也就是不同线程提供的status页面。<br><img src="https://img-blog.csdnimg.cn/20191104185004804.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h4 id="配置详解"><a href="#配置详解" class="headerlink" title="配置详解"></a>配置详解</h4><h5 id="globe-全局配置段"><a href="#globe-全局配置段" class="headerlink" title="globe 全局配置段"></a>globe 全局配置段</h5><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">进程及安全配置相关的参数</span><br><span class="line">性能调整相关参数</span><br><span class="line"><span class="keyword">Debug</span>参数</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;全局配置一般大多类似不用多说，须注意的是nbproc若开启多线程，socket设置最好也分开设置，最好每个线程用process #指定固定的socket，方便后期用命令行socat工具管理(<code>echo &quot;disable server web_host/web1&quot; | socat stdio /var/lib/haproxy/haproxy.sock2</code>)，例如：</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">maxconn <span class="number">100000</span></span><br><span class="line">chroot /apps/haproxy</span><br><span class="line">stats socket /var/<span class="class"><span class="keyword">lib</span>/<span class="title">haproxy</span>/<span class="title">haproxy</span>.<span class="title">sock1</span> <span class="title">mode</span> 600 <span class="title">level</span> <span class="title">admin</span> <span class="title">process</span> 1</span></span><br><span class="line">stats socket /var/<span class="class"><span class="keyword">lib</span>/<span class="title">haproxy</span>/<span class="title">haproxy</span>.<span class="title">sock2</span> <span class="title">mode</span> 600 <span class="title">level</span> <span class="title">admin</span> <span class="title">process</span> 2</span></span><br><span class="line">uid <span class="number">99</span></span><br><span class="line">gid <span class="number">99</span></span><br><span class="line">daemon</span><br><span class="line">nbproc <span class="number">2</span>       <span class="comment">#指定每个haproxy进程开启的线程数，默认为每个进程一个线程</span></span><br><span class="line">cpu-map <span class="number">1</span> <span class="number">0</span>    <span class="comment">#cpu工作线程绑定</span></span><br><span class="line">cpu-map <span class="number">2</span> <span class="number">1</span></span><br><span class="line">pidfile /var/<span class="class"><span class="keyword">lib</span>/<span class="title">haproxy</span>/<span class="title">haproxy</span>.<span class="title">pid</span></span></span><br><span class="line">log <span class="number">127.0</span>.<span class="number">0.1</span> local3 info</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;其他详细信息参见官方文档：<a href="https://cbonte.github.io/haproxy-dconv/2.0/intro.html" rel="noopener" target="_blank">https://cbonte.github.io/haproxy-dconv/2.0/intro.html</a></p><h5 id="proxies：代理配置段"><a href="#proxies：代理配置段" class="headerlink" title="proxies：代理配置段"></a>proxies：代理配置段</h5><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">defaults [<span class="variable">&amp;ltname</span><span class="variable">&amp;gt</span>]  <span class="meta">#默认配置项，针对以下的frontend、backend和lsiten生效，可以多个name</span></span><br><span class="line">frontend <span class="variable">&amp;ltname</span><span class="variable">&amp;gt</span>  <span class="meta">#前端servername，类似于Nginx的一个虚拟主机 server。</span></span><br><span class="line">backend <span class="variable">&amp;ltname</span><span class="variable">&amp;gt</span>  <span class="meta">#后端服务器组，等于nginx的upstream</span></span><br><span class="line">listen <span class="variable">&amp;ltname</span><span class="variable">&amp;gt</span>  <span class="meta">#将frontend和backend合并在一起配置</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;注：name字段只能使用”-”、”_”、”.”、和”:”，并且严格区分大小写，例如：Web和web是完全不同的两组服务器。</p><ul><li><strong>defaults</strong></li></ul><p><strong>option redispatch</strong> #当server Id对应的服务器挂掉后，强制定向到其他健康的服务器<br><strong>option abortonclose</strong> #当服务器负载很高的时候，自动结束掉当前队列处理比较久的链接<br><strong>option http-keep-alive</strong> #开启与客户端的会话保持<br><strong>option forwardfor</strong> #透传客户端真实IP至后端web服务器<br><strong>mode http</strong> #默认工作类型<br>timeout connect 120s #客户端请求到后端server的最长连接等待时间(TCP之前)<br>timeout server 600s #客户端请求到后端服务端的超时超时时长（TCP之后）<br>timeout client 600s #与客户端的最长非活动时间<br>timeout http-keep-alive 120s #session 会话保持超时时间，范围内会转发到相同的后端服务器<br>timeout check 5s #对后端服务器的检测超时时间</p><ul><li><strong>frontend</strong></li></ul><p><strong>bind</strong>：指定HAProxy的监听地址，可以是IPV4或IPV6，可以同时监听多个IP或端口，可同时用于listen字段中</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bind [<span class="variable">&amp;ltaddress</span><span class="variable">&amp;gt</span>]:<span class="variable">&amp;ltport_range</span><span class="variable">&amp;gt</span> [, ...] [param*]</span><br></pre></td></tr></table></figure><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">listen http_proxy #监听http的多个IP的多个端口和sock文件</span><br><span class="line">    bind :<span class="number">80</span>,:<span class="number">443</span>,:<span class="number">8801</span><span class="number">-8810</span></span><br><span class="line">    bind <span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">10080</span>,<span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">10443</span></span><br><span class="line">    bind /var/run/ssl-frontend.sock user root mode <span class="number">600</span> accept-proxy</span><br></pre></td></tr></table></figure><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">listen</span> http_https_proxy <span class="comment">#https监听</span></span><br><span class="line">    <span class="keyword">bind</span> :<span class="number">80</span></span><br><span class="line">    <span class="keyword">bind</span> :<span class="number">443</span> ssl crt /etc/haproxy/site.pem</span><br></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">listen http_https_proxy_explicit #监听ipv6、ipv4和unix sock文件</span><br><span class="line">    bind ipv6@:80</span><br><span class="line">    bind ipv4@public_ssl:443 ssl crt /etc/haproxy/site.pem</span><br><span class="line">    bind unix@ssl-frontend.sock<span class="built_in"> user </span>root mode 600 accept-proxy</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">listen external_bind_app1 <span class="comment">#监听file descriptor</span></span><br><span class="line">    <span class="built_in">bind</span> <span class="string">"fd@<span class="variable">$&#123;FD_APP1&#125;</span>"</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;<strong>企业生产示例：</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">frontend WEB_PORT</span><br><span class="line">    bind :<span class="number">80</span>,:<span class="number">8080</span></span><br><span class="line">    bind <span class="number">192.168</span><span class="number">.7</span><span class="number">.102</span>:<span class="number">10080</span>,:<span class="number">8801</span><span class="number">-8810</span>,<span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span>:<span class="number">9001</span><span class="number">-9010</span></span><br><span class="line">    mode http/tcp #指定负载协议类型</span><br><span class="line">    use_backend backend_name #调用的后端服务器组名称</span><br></pre></td></tr></table></figure><ul><li><strong>backend</strong><br>定义一组后端服务器，backend服务器将被frontend进行调用。<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mode http/tcp #指定负载协议类型</span><br><span class="line">option #配置选项</span><br><span class="line">server #定义后端real server</span><br></pre></td></tr></table></figure></li></ul><p>&emsp;&emsp;注意：<strong>mode要与frontend一致</strong>。option后面加httpchk，smtpchk,mysql-check,pgsql-check，ssl-hello-chk方法，可用于实现更多应用层检测功能。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">check</span> <span class="comment">#对指定real进行健康状态检查，默认不开启</span></span><br><span class="line">    addr IP <span class="comment">#可指定的健康状态监测IP</span></span><br><span class="line">    port <span class="keyword">num</span> <span class="comment">#指定的健康状态监测端口</span></span><br><span class="line">    inter <span class="keyword">num</span> <span class="comment">#健康状态检查间隔时间，默认2000 ms</span></span><br><span class="line">    fall <span class="keyword">num</span> <span class="comment">#后端服务器失效检查次数，默认为3</span></span><br><span class="line">    rise <span class="keyword">num</span> <span class="comment">#后端服务器从下线恢复检查次数，默认为2</span></span><br><span class="line">weight <span class="comment">#默认为1，最大值为256，0表示不参与负载均衡</span></span><br><span class="line"><span class="keyword">backup</span> <span class="comment">#将后端服务器标记为备份状态</span></span><br><span class="line">disabled <span class="comment">#将后端服务器标记为不可用状态</span></span><br><span class="line">redirect prefix <span class="keyword">http</span>://www.example.net/ <span class="comment">#将请求临时重定向至其它URL，只适用于http模式</span></span><br><span class="line">maxconn &amp;ltmaxconn&amp;gt：当前后端<span class="keyword">server</span>的最大并发连接数</span><br><span class="line">backlog &amp;ltbacklog&amp;gt：当<span class="keyword">server</span>的连接数达到上限后的后援队列长度</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;<strong>frontend+backend配置实例：</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#官网业务访问入口======================================</span><br><span class="line">frontend WEB_PORT_80</span><br><span class="line">    bind <span class="number">192.168</span><span class="number">.7</span><span class="number">.248</span>:<span class="number">80</span></span><br><span class="line">    mode http</span><br><span class="line">    use_backend web_prot_http_nodes</span><br><span class="line">backend web_prot_http_nodes</span><br><span class="line">    mode http</span><br><span class="line">    option forwardfor</span><br><span class="line">    server <span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span> <span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span>:<span class="number">8080</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">3</span> rise <span class="number">5</span></span><br><span class="line">    server <span class="number">192.168</span><span class="number">.7</span><span class="number">.102</span> <span class="number">192.168</span><span class="number">.7</span><span class="number">.102</span>:<span class="number">8080</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">3</span> rise <span class="number">5</span></span><br></pre></td></tr></table></figure><ul><li><strong>listen</strong><br>listen相当于frontend+backend的结合，即定义前端监听代理，又定义了后端服务器，例如上面的frontend+backend组合可用下面这种listen方式代替：<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#官网业务访问入口=====================================</span></span><br><span class="line">listen WEB_PORT_80</span><br><span class="line">    bind 192.168.7.102:80</span><br><span class="line">    mode http</span><br><span class="line">    option forwardfor</span><br><span class="line">   <span class="built_in"> server </span>web1 192.168.7.101:80 check inter 3000 fall 3 rise 5</span><br><span class="line">   <span class="built_in"> server </span>web2 192.168.7.101:80 check inter 3000 fall 3 rise 5</span><br></pre></td></tr></table></figure></li></ul><h3 id="haproxy调度算法"><a href="#haproxy调度算法" class="headerlink" title="haproxy调度算法"></a>haproxy调度算法</h3><p>&emsp;&emsp;HAProxy通过固定参数balance指明对后端服务器的调度算法，该参数可以配置在<strong>listen或backend选项中</strong>。<br>&emsp;&emsp;HAProxy的调度算法分为静态和动态调度算法，但是有些算法可以根据参数在静态和动态算法中相互转换。</p><h4 id="静态算法"><a href="#静态算法" class="headerlink" title="静态算法"></a>静态算法</h4><ul><li>static-rr<br>基于权重的轮询调度，不支持权重的运行时调整及后端服务器慢启动，其后端主机数量没有限制</li><li>first<br>根据服务器在列表中的位置，自上而下进行调度，但是其只会当第一台服务器的连接数达到上限，新请求才会分配给下一台服务，因此会忽略服务器的权重设置。（生产不常用）</li></ul><h4 id="动态算法"><a href="#动态算法" class="headerlink" title="动态算法"></a>动态算法</h4><ul><li>roundrobin<br>基于权重的轮询动态调度算法，支持权重的运行时调整，不完全等于lvs中的rr轮训模式，HAProxy中的roundrobin支持慢启动(新加的服务器会逐渐增加转发数)，其每个后端backend中最多支持4095个real server，roundrobin为<strong>默认调度算法</strong>，且支持对real server权重动态调整。</li><li>leastconn<br>加权的最少连接的动态，支持权重的运行时调整和慢启动，即当前后端服务器连接最少的优先调度(新客户端连接)，比较适合长连接的场景使用，比如MySQL等场景。</li></ul><h4 id="其他算法"><a href="#其他算法" class="headerlink" title="其他算法"></a>其他算法</h4><h5 id="source"><a href="#source" class="headerlink" title="source"></a>source</h5><p>&emsp;&emsp;源地址hash，基于用户源地址hash并将请求转发到后端服务器，默认为静态即取模方式，但是可以通过hash-type支持的选项更改，后续同一个源地址请求将被转发至同一个后端web服务器，比较适用于session保持/缓存业务等场景。<br>&emsp;&emsp;源地址有两种转发客户端请求到后端服务器的服务器选取计算方式，分别是取模法和一致性hash</p><ul><li><p>map-base取模法<br>&emsp;&emsp;map-based：取模法，基于服务器总权重的hash数组取模，该hash是静态的即不支持在线调整权重，不支持慢启动，其对后端服务器调度均衡，缺点是当服务器的总权重发生变化时，即有服务器上线或下线，都会因权重发生变化而导致调度结果整体改变。<br>&emsp;&emsp;所谓取模运算，就是计算两个数相除之后的余数，10%7=3, 7%4=3，(2^32-1)%(1+1+2)<br>&emsp;&emsp;取模法示意图：<br><img src="https://img-blog.csdnimg.cn/201911042153353.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">取模法配置示例：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line">    bind <span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span>:<span class="number">80</span>,:<span class="number">8801</span><span class="number">-8810</span>,<span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span>:<span class="number">9001</span><span class="number">-9010</span></span><br><span class="line">    mode tcp</span><br><span class="line">    log global</span><br><span class="line">    balance source</span><br><span class="line">    server web1 <span class="number">192.168</span><span class="number">.7</span><span class="number">.103</span>:<span class="number">80</span> weight <span class="number">1</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br><span class="line">    server web2 <span class="number">192.168</span><span class="number">.7</span><span class="number">.104</span>:<span class="number">80</span> weight <span class="number">1</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br></pre></td></tr></table></figure></li><li><p>一致性hash<br>&emsp;&emsp;一致性哈希，该hash是动态的，支持在线调整权重，支持慢启动，优点在于当服务器的总权重发生变化时，对调度结果影响是局部的，不会引起大的变动，hash（o）mod n 。<br>&emsp;&emsp;Hash对象到后端服务器的映射关系：<br><img src="https://img-blog.csdnimg.cn/20191104221807725.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">&emsp;&emsp;一致性hash后端服务器在线与离线的调度方式示意图：<br><img src="https://img-blog.csdnimg.cn/20191104221921281.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;一致性hash配置示例：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line">    bind <span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span>:<span class="number">80</span>,:<span class="number">8801</span><span class="number">-8810</span>,<span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span>:<span class="number">9001</span><span class="number">-9010</span></span><br><span class="line">    mode tcp</span><br><span class="line">    log global</span><br><span class="line">    balance source</span><br><span class="line">    hash-type consistent</span><br><span class="line">    server web1 <span class="number">192.168</span><span class="number">.7</span><span class="number">.103</span>:<span class="number">80</span> weight <span class="number">1</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br><span class="line">    server web2 <span class="number">192.168</span><span class="number">.7</span><span class="number">.104</span>:<span class="number">80</span> weight <span class="number">1</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br></pre></td></tr></table></figure></li></ul><h5 id="uri"><a href="#uri" class="headerlink" title="uri"></a>uri</h5><p>&emsp;&emsp;基于对用户请求的uri做hash并将请求转发到后端指定服务器，也可以通过map-based和consistent定义使用取模法还是一致性hash。<br>&emsp;&emsp;uri 取模法配置示例：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line">    bind <span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span>:<span class="number">80</span>,:<span class="number">8801</span><span class="number">-8810</span>,<span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span>:<span class="number">9001</span><span class="number">-9010</span></span><br><span class="line">    mode http</span><br><span class="line">    log global</span><br><span class="line">    balance uri</span><br><span class="line">    server web1 <span class="number">192.168</span><span class="number">.7</span><span class="number">.103</span>:<span class="number">80</span> weight <span class="number">1</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br><span class="line">    server web2 <span class="number">192.168</span><span class="number">.7</span><span class="number">.104</span>:<span class="number">80</span> weight <span class="number">1</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;uri 一致性hash配置示例：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line">    bind <span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span>:<span class="number">80</span>,:<span class="number">8801</span><span class="number">-8810</span>,<span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span>:<span class="number">9001</span><span class="number">-9010</span></span><br><span class="line">    mode http</span><br><span class="line">    log global</span><br><span class="line">    balance uri</span><br><span class="line">    hash-type consistent</span><br><span class="line">    server web1 <span class="number">192.168</span><span class="number">.7</span><span class="number">.103</span>:<span class="number">80</span> weight <span class="number">1</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br><span class="line">    server web2 <span class="number">192.168</span><span class="number">.7</span><span class="number">.104</span>:<span class="number">80</span> weight <span class="number">1</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br></pre></td></tr></table></figure><h5 id="url-param"><a href="#url-param" class="headerlink" title="url_param"></a>url_param</h5><p>&emsp;&emsp;url_param对用户请求的url中的 params 部分中的参数name作hash计算，并由服务器总权重相除以后派发至某挑出的服务器；通常用于追踪用户，以确保来自同一个用户的请求始终发往同一个real server</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">假设url = http://www.example.com/foo/bar/index.php?k1=v1&amp;k2=v2</span><br><span class="line">则：</span><br><span class="line">host = <span class="string">"www.example.com"</span></span><br><span class="line">url_param = <span class="string">"k1=v1&amp;k2=v2"</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;url_param取模法配置示例:</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line">    bind <span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span>:<span class="number">80</span>,:<span class="number">8801</span><span class="number">-8810</span>,<span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span>:<span class="number">9001</span><span class="number">-9010</span></span><br><span class="line">    mode http</span><br><span class="line">    log global</span><br><span class="line">    balance url_param name,age #支持对单个及多个url_param 值hash</span><br><span class="line">    server web1 <span class="number">192.168</span><span class="number">.7</span><span class="number">.103</span>:<span class="number">80</span> weight <span class="number">1</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br><span class="line">    server web2 <span class="number">192.168</span><span class="number">.7</span><span class="number">.104</span>:<span class="number">80</span> weight <span class="number">1</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;url_param一致性hash配置示例：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line">    bind <span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span>:<span class="number">80</span>,:<span class="number">8801</span><span class="number">-8810</span>,<span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span>:<span class="number">9001</span><span class="number">-9010</span></span><br><span class="line">    mode http</span><br><span class="line">    log global</span><br><span class="line">    balance url_param name,age #支持对单个及多个url_param 值hash</span><br><span class="line">    hash-type consistent</span><br><span class="line">    server web1 <span class="number">192.168</span><span class="number">.7</span><span class="number">.103</span>:<span class="number">80</span> weight <span class="number">1</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br><span class="line">    server web2 <span class="number">192.168</span><span class="number">.7</span><span class="number">.104</span>:<span class="number">80</span> weight <span class="number">1</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br></pre></td></tr></table></figure><h5 id="hdr"><a href="#hdr" class="headerlink" title="hdr"></a>hdr</h5><p>&emsp;&emsp;针对用户每个http头部(header)请求中的指定信息做hash，此处由 name 指定的http首部将会被取出并做hash计算，然后由服务器总权重相除以后派发至某挑出的服务器，假如无有效的值，则会使用默认的轮询调度。<br>&emsp;&emsp;hdr取模法配置示例：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line">    bind <span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span>:<span class="number">80</span>,:<span class="number">8801</span><span class="number">-8810</span>,<span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span>:<span class="number">9001</span><span class="number">-9010</span></span><br><span class="line">    mode http</span><br><span class="line">    log global</span><br><span class="line">    balance hdr(User-Agent)</span><br><span class="line">    server web1 <span class="number">192.168</span><span class="number">.7</span><span class="number">.103</span>:<span class="number">80</span> weight <span class="number">1</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br><span class="line">    server web2 <span class="number">192.168</span><span class="number">.7</span><span class="number">.104</span>:<span class="number">80</span> weight <span class="number">1</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br></pre></td></tr></table></figure><p>一致性hash配置示例：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line">    bind <span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span>:<span class="number">80</span>,:<span class="number">8801</span><span class="number">-8810</span>,<span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span>:<span class="number">9001</span><span class="number">-9010</span></span><br><span class="line">    mode http</span><br><span class="line">    log global</span><br><span class="line">    balance hdr(User-Agent)</span><br><span class="line">    hash-type consistent</span><br><span class="line">    server web1 <span class="number">192.168</span><span class="number">.7</span><span class="number">.103</span>:<span class="number">80</span> weight <span class="number">1</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br><span class="line">    server web2 <span class="number">192.168</span><span class="number">.7</span><span class="number">.104</span>:<span class="number">80</span> weight <span class="number">1</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br></pre></td></tr></table></figure><h5 id="rdp-cookie"><a href="#rdp-cookie" class="headerlink" title="rdp-cookie"></a>rdp-cookie</h5><p>&emsp;&emsp;rdp-cookie对远程桌面的负载，使用cookie保持会话<br>&emsp;&emsp;rdp-cookie取模法配置示例：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">listen RDP</span><br><span class="line">    bind <span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span>:<span class="number">3389</span></span><br><span class="line">    balance rdp-cookie</span><br><span class="line">    mode tcp</span><br><span class="line">    server rdp0 <span class="number">172.18</span><span class="number">.132</span><span class="number">.20</span>:<span class="number">3389</span> check fall <span class="number">3</span> rise <span class="number">5</span> <span class="built_in">int</span>er <span class="number">2000</span> weight <span class="number">1</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;rdp-cookie一致性hash配置示例：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">listen RDP</span><br><span class="line">    bind <span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span>:<span class="number">3389</span></span><br><span class="line">    balance rdp-cookie</span><br><span class="line">    hash-type consistent</span><br><span class="line">    mode tcp</span><br><span class="line">    server rdp0 <span class="number">172.18</span><span class="number">.132</span><span class="number">.20</span>:<span class="number">3389</span> check fall <span class="number">3</span> rise <span class="number">5</span> <span class="built_in">int</span>er <span class="number">2000</span> weight <span class="number">1</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;基于iptables实现：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.ip_forward = <span class="number">1</span></span><br><span class="line"># iptables -t nat -A PREROUTING -d <span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span> -p tcp --dport <span class="number">3389</span> -j DNAT --todestination <span class="number">172.18</span><span class="number">.139</span><span class="number">.20</span>:<span class="number">3389</span></span><br><span class="line"># iptables -t nat -A POSTROUTING -s <span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">21</span> -j SNAT --to-source <span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span></span><br></pre></td></tr></table></figure><h5 id="random"><a href="#random" class="headerlink" title="random"></a>random</h5><p>&emsp;&emsp;在1.9版本开始增加一个叫做random的负载平衡算法，其基于一个随机数作为一致性hash的key，随机负载平衡对于大型服务器场或经常添加或删除服务器非常有用，因为它可以避免在这种情况下由roundrobin或leastconn导致的锤击效应。<br>&emsp;&emsp;random配置实例：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line">    bind <span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span>:<span class="number">80</span>,:<span class="number">8801</span><span class="number">-8810</span>,<span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span>:<span class="number">9001</span><span class="number">-9010</span></span><br><span class="line">    mode http</span><br><span class="line">    log global</span><br><span class="line">    balance random</span><br><span class="line">    server web1 <span class="number">192.168</span><span class="number">.7</span><span class="number">.103</span>:<span class="number">80</span> weight <span class="number">1</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br><span class="line">    server web2 <span class="number">192.168</span><span class="number">.7</span><span class="number">.104</span>:<span class="number">80</span> weight <span class="number">1</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br></pre></td></tr></table></figure><h4 id="算法总结"><a href="#算法总结" class="headerlink" title="算法总结"></a>算法总结</h4><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">static</span>-rr---------&gt;</span>tcp/http 静态</span><br><span class="line"><span class="function"><span class="title">first</span>-------------&gt;</span>tcp/http 静态</span><br><span class="line"><span class="function"><span class="title">roundrobin</span>--------&gt;</span>tcp/http 动态</span><br><span class="line"><span class="function"><span class="title">leastconn</span>---------&gt;</span>tcp/http 动态</span><br><span class="line"><span class="function"><span class="title">random</span>------------&gt;</span>tcp/http 动态</span><br><span class="line"><span class="function"><span class="title">source</span>------------&gt;</span>tcp/http</span><br><span class="line">U<span class="function"><span class="title">ri</span>---------------&gt;</span>http</span><br><span class="line"><span class="function"><span class="title">url_param</span>---------&gt;</span>http 取决于hash_type是否consistent</span><br><span class="line"><span class="function"><span class="title">hdr</span>---------------&gt;</span>http</span><br><span class="line"><span class="function"><span class="title">rdp</span>-cookie--------&gt;</span>tcp</span><br></pre></td></tr></table></figure><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">first</span> <span class="comment">#使用较少</span></span><br><span class="line">static-rr <span class="comment">#做了session共享的web集群</span></span><br><span class="line">roundrobin</span><br><span class="line"><span class="built_in">random</span></span><br><span class="line">leastconn <span class="comment">#数据库</span></span><br><span class="line">source <span class="comment">#基于客户端公网IP的会话保持</span></span><br><span class="line">Uri<span class="comment">---------------&gt;http #缓存服务器，CDN服务商，蓝汛、百度、阿里云、腾讯</span></span><br><span class="line">url_param<span class="comment">---------&gt;http</span></span><br><span class="line">hdr <span class="comment">#基于客户端请求报文头部做下一步处理</span></span><br><span class="line">rdp-cookie <span class="comment">#很少使用</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;详细可参见官方文档：<a href="https://cbonte.github.io/haproxy-dconv/2.0/configuration.html#4" rel="noopener" target="_blank">https://cbonte.github.io/haproxy-dconv/2.0/configuration.html#4</a> </p><h3 id="haproxy工作模式"><a href="#haproxy工作模式" class="headerlink" title="haproxy工作模式"></a>haproxy工作模式</h3><h4 id="tcp：四层负载"><a href="#tcp：四层负载" class="headerlink" title="tcp：四层负载"></a>tcp：四层负载</h4><p>&emsp;&emsp;在四层负载设备中，把client发送的报文目标地址(原来是负载均衡设备的IP地址)，根据均衡设备设置的选择web服务器的规则选择对应的web服务器IP地址，这样client就可以直接跟此服务器建立TCP连接并发送数据。</p><h5 id="四层工作模式的IP透传："><a href="#四层工作模式的IP透传：" class="headerlink" title="四层工作模式的IP透传："></a>四层工作模式的IP透传：</h5><p>&emsp;&emsp;haproxy配置中在后端服务器定义中加入关键字<code>send-proxy</code>（注意不要加在check关键字属性的中间了），并重启服务。<br>&emsp;&emsp;在后端nginx服务器配置中监听端口处也加上协议名<code>proxy_protocol</code>,并修改日志格式，在开头加入变量<code>$proxy_protocol_addr</code>，重启服务后即可在日志中看到访问的源地址。<br>&emsp;&emsp;<code>send-proxy</code>是haproxy后端设置的关键字，写错会报错，可以用来启用代理协议<code>Proxy protocol</code>。Proxy protocol是HAProxy的作者Willy Tarreau于2010年开发和设计的一个Internet协议，通过为tcp添加一个很小的头信息，来方便的传递客户端信息（协议栈、源IP、目的IP、源端口、目的端口等)，在网络情况复杂又需要获取用户真实IP时非常有用。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">haproxy</span> 配置：</span><br><span class="line">listen web_prot_http_nodes</span><br><span class="line">    bind <span class="number">172.18.32.249:80</span></span><br><span class="line">    mode tcp</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server web1 <span class="number">192.168.32.81:80</span> send-proxy check inter <span class="number">3000</span> fall <span class="number">3</span> rise <span class="number">5</span></span><br><span class="line"></span><br><span class="line">nginx配置：</span><br><span class="line">http &#123;</span><br><span class="line">    <span class="attribute">log_format</span>  main  <span class="string">'<span class="variable">$proxy_protocol_addr</span>  <span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">                      <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">                      <span class="string">'"<span class="variable">$http_user_agent</span>" '</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span> proxy_protocol; </span><br><span class="line">    <span class="comment">#listen 80;</span></span><br></pre></td></tr></table></figure><h5 id="内核参数优化"><a href="#内核参数优化" class="headerlink" title="内核参数优化"></a>内核参数优化</h5><p>&emsp;&emsp;haproxy在做四层负载时，如果要监听bind由keepalived生成的虚拟IP（VIP）时，需要修改内核参数，支持监听非本机IP，否则监听VIP的80端口时会导致haproxy服务无法启动。。<br>&emsp;&emsp;<code>vim /etc/sysctl.conf</code></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.ip_nonlocal_bind</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;如果多网卡，且VIP与后端VIP不在一个网段，还需要加上地址转发参数。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.ip_forward</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;然后<code>sysctl -p</code>使配置文件生效。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS8 ~]<span class="selector-id">#sysctl</span> -p</span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.ip_nonlocal_bind</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.ip_forward</span> = <span class="number">1</span></span><br><span class="line">[root@CentOS8 ~]#</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;当然，也可以将haproxy改为监听0.0.0.0:80，表示监听本机所有网卡的IP的80端口，当keepalived的VIP漂到本机是，自然也可以被haproxy监听，没有时也不影响启动。不过这样的话，haproxy只能对一个项目集群做负载均衡了，而我们实际生产中，都是同时代理多个服务项目集群的转发，需通过bind不同IP的80/443端口来实现，如果直接一个服务bind0.0.0.0：80，占用了所有的80/443端口，显然就没法和其他项目共存了。<br>&emsp;&emsp;<strong>所以我们建议在四层负载工作模式下，不要监听0.0.0.0:80，而是监听指定的VIP。</strong></p><h4 id="http：七层代理"><a href="#http：七层代理" class="headerlink" title="http：七层代理"></a>http：七层代理</h4><p>&emsp;&emsp;七层负载均衡服务器起了一个反向代理服务器的作用，服务器建立一次TCP连接要三次握手，而client要访问webserver要先与七层负载设备进行三次握手后建立TCP连接，把要访问的报文信息发送给七层负载均衡；然后七层负载均衡再根据设置的均衡规则选择特定的webserver，然后通过三次握手与此台webserver建立TCP连接，然后webserver把需要的数据发送给七层负载均衡设备，负载均衡设备再把数据发送给client；所以，七层负载均衡设备起到了代理服务器的作用。</p><h5 id="七层工作模式的IP透传："><a href="#七层工作模式的IP透传：" class="headerlink" title="七层工作模式的IP透传："></a>七层工作模式的IP透传：</h5><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">haproxy 配置：</span><br><span class="line">defaults</span><br><span class="line">    option forwardfor</span><br><span class="line">或者：</span><br><span class="line">    option forwardfor header X-Forwarded-xxx #自定义传递IP参数,后端web服务器写X-Forwardedxxx</span><br><span class="line">    #如果写option forwardfor则后端服务器web格式为X-Forwarded-For</span><br><span class="line">listen配置：</span><br><span class="line">listen web_host</span><br><span class="line">    bind <span class="number">192.168</span><span class="number">.7</span><span class="number">.101</span>:<span class="number">80</span></span><br><span class="line">    mode http</span><br><span class="line">    log global</span><br><span class="line">    balance random</span><br><span class="line">    server web1 <span class="number">192.168</span><span class="number">.32</span><span class="number">.81</span>:<span class="number">80</span> weight <span class="number">1</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br><span class="line">    server web2 <span class="number">192.168</span><span class="number">.32</span><span class="number">.82</span>:<span class="number">80</span> weight <span class="number">1</span> check <span class="built_in">int</span>er <span class="number">3000</span> fall <span class="number">2</span> rise <span class="number">5</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;配置web服务器，记录负载均衡透传的客户端IP地址</p><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#apache 配置：</span></span><br><span class="line">    LogFormat <span class="string">"%&#123;X-Forwarded-For&#125;i %a %l %u %t \"</span>%r\<span class="string">" %&gt;s %b \"</span>%&#123;Referer&#125;i\<span class="string">" \"</span>%&#123;UserAgent&#125;i\<span class="string">""</span> combined</span><br><span class="line"><span class="comment">#tomcat 配置：</span></span><br><span class="line">    pattern=<span class="string">'%&#123;X-Forwarded-For&#125;i %l %T %t &amp;quot;%r&amp;quot; %s %b &amp;quot;%&#123;UserAgent&#125;i&amp;quot;'</span>/&gt;</span><br><span class="line"><span class="comment">#nginx 日志格式：</span></span><br><span class="line">    http &#123;</span><br><span class="line">        log_format  main  <span class="string">'"<span class="variable">$http_x_forwarded_For</span>" - <span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">                      <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">                      <span class="string">'"<span class="variable">$http_user_agent</span>" '</span><span class="comment">;</span></span><br></pre></td></tr></table></figure><h3 id="haproxy功能实现"><a href="#haproxy功能实现" class="headerlink" title="haproxy功能实现"></a>haproxy功能实现</h3><p>&emsp;&emsp;初步调整好haproxy的配置文件之后，启动haproxy服务，就已经可以对后端服务器进行代理来实现负载均衡了，不过很多情况下我们需要对后端服务器进行动态操作，例如修改某些主机的负载权重，对某些主机上线或下线等等，而这时，再不影响业务正常访问的情况下，对haproxy动态操作方式一般有两种：在图形界面status状态页下操作，以及使用socat命令行工具通过socket通信。</p><h4 id="图形界面"><a href="#图形界面" class="headerlink" title="图形界面"></a>图形界面</h4><p>&emsp;&emsp;想实现在status界面拥有修改权限，需在配置文件中加入选项<code>stats admin if TRUE</code>。注意，TRUE要大写，否则服务起不来会报错<code>parsing [/etc/haproxy/haproxy.cfg:52] : error detected while parsing a &#39;stats admin&#39; rule : no such ACL : &#39;true&#39;.</code><br>&emsp;&emsp;最终如下面所示</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">listen</span> <span class="string">stats</span></span><br><span class="line">    <span class="attr">mode</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">bind</span> <span class="string">0.0.0.0:9999</span></span><br><span class="line">    <span class="attr">stats</span> <span class="string">enable</span></span><br><span class="line">    <span class="attr">log</span> <span class="string">global</span></span><br><span class="line">    <span class="attr">stats</span> <span class="string">uri /proxy_status</span></span><br><span class="line">    <span class="attr">stats</span> <span class="string">auth haadmin:hapasswd</span></span><br><span class="line">    <span class="attr">stats</span> <span class="string">admin if TRUE</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;这是再刷新status界面，就可以看到界面已经发生了变化<br><img src="https://img-blog.csdnimg.cn/20191106151518987.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20191106151645858.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;就可以对选择的主机进行操作了。</p><h4 id="命令行方式"><a href="#命令行方式" class="headerlink" title="命令行方式"></a>命令行方式</h4><p>&emsp;&emsp;这是通过直接与haproxy的socekt通信，socket路径就是配置文件中指定的socket路径了，只支持本地通信。而且这需要借主socat的工具，需要先进行安装socat工具。</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> socat</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;用echo信息的方式通过管道传递给socat工具指定haproxy的socket，就可以发送与接收haproxy的信息了。<br>&emsp;&emsp;查看haproxy工作的详细信息</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="string">"show info"</span> | socat stdio /var/<span class="class"><span class="keyword">lib</span>/<span class="title">haproxy</span>/<span class="title">haproxy</span>.<span class="title">sock1</span></span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;查看haproxy控制命令</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="string">"help"</span> | socat stdio /var/<span class="class"><span class="keyword">lib</span>/<span class="title">haproxy</span>/<span class="title">haproxy</span>.<span class="title">sock1</span></span></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">help</span>           : this message</span><br><span class="line"><span class="keyword">prompt</span>         : toggle interactive <span class="keyword">mode</span> <span class="keyword">with</span> <span class="keyword">prompt</span></span><br><span class="line">quit           : <span class="keyword">disconnect</span></span><br><span class="line"><span class="keyword">show</span> tls-<span class="keyword">keys</span> [<span class="keyword">id</span>|*]: <span class="keyword">show</span> tls <span class="keyword">keys</span> <span class="keyword">references</span> <span class="keyword">or</span> dump tls ticket <span class="keyword">keys</span> <span class="keyword">when</span> <span class="keyword">id</span> specified</span><br><span class="line"><span class="keyword">set</span> ssl tls-<span class="keyword">key</span> [<span class="keyword">id</span>|keyfile] &amp;lttlskey&amp;gt: <span class="keyword">set</span> the <span class="keyword">next</span> TLS <span class="keyword">key</span> <span class="keyword">for</span> the &amp;ltid&amp;gt <span class="keyword">or</span> &amp;ltkeyfile&amp;gt listener <span class="keyword">to</span> &amp;lttlskey&amp;gt</span><br><span class="line"><span class="keyword">show</span> sess [<span class="keyword">id</span>] : report the <span class="keyword">list</span> <span class="keyword">of</span> <span class="keyword">current</span> sessions <span class="keyword">or</span> dump this <span class="keyword">session</span></span><br><span class="line"><span class="keyword">shutdown</span> <span class="keyword">session</span> : <span class="keyword">kill</span> a specific <span class="keyword">session</span></span><br><span class="line"><span class="keyword">shutdown</span> sessions <span class="keyword">server</span> : <span class="keyword">kill</span> sessions <span class="keyword">on</span> a <span class="keyword">server</span></span><br><span class="line"><span class="keyword">clear</span> counters : <span class="keyword">clear</span> <span class="keyword">max</span> <span class="keyword">statistics</span> counters (<span class="keyword">add</span> <span class="string">'all'</span> <span class="keyword">for</span> <span class="keyword">all</span> counters)</span><br><span class="line"><span class="keyword">show</span> info      : report information about the running process [<span class="keyword">json</span>|typed]</span><br><span class="line"><span class="keyword">show</span> stat      : report counters <span class="keyword">for</span> <span class="keyword">each</span> proxy <span class="keyword">and</span> <span class="keyword">server</span> [<span class="keyword">json</span>|typed]</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">schema</span> <span class="keyword">json</span> : report <span class="keyword">schema</span> used <span class="keyword">for</span> stats</span><br><span class="line"><span class="keyword">disable</span> <span class="keyword">agent</span>  : <span class="keyword">disable</span> <span class="keyword">agent</span> checks (<span class="keyword">use</span> <span class="string">'set server'</span> instead)</span><br><span class="line"><span class="keyword">disable</span> health : <span class="keyword">disable</span> health checks (<span class="keyword">use</span> <span class="string">'set server'</span> instead)</span><br><span class="line"><span class="keyword">disable</span> <span class="keyword">server</span> : <span class="keyword">disable</span> a <span class="keyword">server</span> <span class="keyword">for</span> maintenance (<span class="keyword">use</span> <span class="string">'set server'</span> instead)</span><br><span class="line"><span class="keyword">enable</span> <span class="keyword">agent</span>   : <span class="keyword">enable</span> <span class="keyword">agent</span> checks (<span class="keyword">use</span> <span class="string">'set server'</span> instead)</span><br><span class="line"><span class="keyword">enable</span> health  : <span class="keyword">enable</span> health checks (<span class="keyword">use</span> <span class="string">'set server'</span> instead)</span><br><span class="line"><span class="keyword">enable</span> <span class="keyword">server</span>  : <span class="keyword">enable</span> a disabled <span class="keyword">server</span> (<span class="keyword">use</span> <span class="string">'set server'</span> instead)</span><br><span class="line"><span class="keyword">set</span> maxconn <span class="keyword">server</span> : <span class="keyword">change</span> a <span class="keyword">server</span><span class="string">'s maxconn setting</span></span><br><span class="line"><span class="string">set server     : change a server'</span>s state, weight <span class="keyword">or</span> address</span><br><span class="line"><span class="keyword">get</span> weight     : report a <span class="keyword">server</span><span class="string">'s current weight</span></span><br><span class="line"><span class="string">set weight     : change a server'</span>s weight (deprecated)</span><br><span class="line"><span class="keyword">show</span> resolvers [<span class="keyword">id</span>]: dumps counters <span class="keyword">from</span> <span class="keyword">all</span> resolvers <span class="keyword">section</span> <span class="keyword">and</span> associated <span class="keyword">name</span> servers</span><br><span class="line"><span class="keyword">clear</span> <span class="keyword">table</span>    : remove an entry <span class="keyword">from</span> a <span class="keyword">table</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">table</span> [<span class="keyword">id</span>] : <span class="keyword">update</span> <span class="keyword">or</span> <span class="keyword">create</span> a <span class="keyword">table</span> entry<span class="string">'s data</span></span><br><span class="line"><span class="string">show table [id]: report table usage stats or dump this table'</span>s <span class="keyword">contents</span></span><br><span class="line"><span class="keyword">show</span> peers [peers <span class="keyword">section</span>]: dump <span class="keyword">some</span> information about <span class="keyword">all</span> the peers <span class="keyword">or</span> this peers <span class="keyword">section</span></span><br><span class="line"><span class="keyword">disable</span> frontend : temporarily <span class="keyword">disable</span> specific frontend</span><br><span class="line"><span class="keyword">enable</span> frontend : re-<span class="keyword">enable</span> specific frontend</span><br><span class="line"><span class="keyword">set</span> maxconn frontend : <span class="keyword">change</span> a frontend<span class="string">'s maxconn setting</span></span><br><span class="line"><span class="string">show servers state [id]: dump volatile server information (for backend &amp;ltid&amp;gt)</span></span><br><span class="line"><span class="string">show backend   : list backends in the current running config</span></span><br><span class="line"><span class="string">shutdown frontend : stop a specific frontend</span></span><br><span class="line"><span class="string">set dynamic-cookie-key backend : change a backend secret key for dynamic cookies</span></span><br><span class="line"><span class="string">enable dynamic-cookie backend : enable dynamic cookies on a specific backend</span></span><br><span class="line"><span class="string">disable dynamic-cookie backend : disable dynamic cookies on a specific backend</span></span><br><span class="line"><span class="string">show errors    : report last request and response errors for each proxy</span></span><br><span class="line"><span class="string">set maxconn global : change the per-process maxconn setting</span></span><br><span class="line"><span class="string">set rate-limit : change a rate limiting value</span></span><br><span class="line"><span class="string">set severity-output [none|number|string] : set presence of severity level in feedback information</span></span><br><span class="line"><span class="string">set timeout    : change a timeout setting</span></span><br><span class="line"><span class="string">show env [var] : dump environment variables known to the process</span></span><br><span class="line"><span class="string">show cli sockets : dump list of cli sockets</span></span><br><span class="line"><span class="string">show cli level   : display the level of the current CLI session</span></span><br><span class="line"><span class="string">show fd [num] : dump list of file descriptors in use</span></span><br><span class="line"><span class="string">show activity : show per-thread activity stats (for support/developers)</span></span><br><span class="line"><span class="string">operator       : lower the level of the current CLI session to operator</span></span><br><span class="line"><span class="string">user           : lower the level of the current CLI session to user</span></span><br><span class="line"><span class="string">show startup-logs : report logs emitted during HAProxy startup</span></span><br><span class="line"><span class="string">show cache     : show cache status</span></span><br><span class="line"><span class="string">add acl        : add acl entry</span></span><br><span class="line"><span class="string">clear acl &amp;ltid&amp;gt : clear the content of this acl</span></span><br><span class="line"><span class="string">del acl        : delete acl entry</span></span><br><span class="line"><span class="string">get acl        : report the patterns matching a sample for an ACL</span></span><br><span class="line"><span class="string">show acl [id]  : report available acls or dump an acl'</span>s <span class="keyword">contents</span></span><br><span class="line"><span class="keyword">add</span> <span class="keyword">map</span>        : <span class="keyword">add</span> <span class="keyword">map</span> entry</span><br><span class="line"><span class="keyword">clear</span> <span class="keyword">map</span> &amp;ltid&amp;gt : <span class="keyword">clear</span> the <span class="keyword">content</span> <span class="keyword">of</span> this <span class="keyword">map</span></span><br><span class="line">del <span class="keyword">map</span>        : <span class="keyword">delete</span> <span class="keyword">map</span> entry</span><br><span class="line"><span class="keyword">get</span> <span class="keyword">map</span>        : report the <span class="keyword">keys</span> <span class="keyword">and</span> <span class="keyword">values</span> matching a <span class="keyword">sample</span> <span class="keyword">for</span> a <span class="keyword">map</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">map</span>        : <span class="keyword">modify</span> <span class="keyword">map</span> entry</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">map</span> [<span class="keyword">id</span>]  : report available maps <span class="keyword">or</span> dump a <span class="keyword">map</span><span class="string">'s contents</span></span><br><span class="line"><span class="string">show pools     : report information about the memory pools usage</span></span><br><span class="line"><span class="string">show profiling : show CPU profiling options</span></span><br><span class="line"><span class="string">set  profiling : enable/disable CPU profiling</span></span><br><span class="line"><span class="string">show threads   : show some threads debugging information</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;查看线程1工作下的web_host集群中web1主机的权重</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@CentOS8</span> ~]<span class="meta">#echo <span class="string">"get weight web_host/web1"</span> | socat stdio /var/lib/haproxy/haproxy.sock1</span></span><br><span class="line"><span class="number">1</span> (initial <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">[root<span class="symbol">@CentOS8</span> ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;设置线程2工作下的web_host集群中web1主机的权重为2。设置时，不回应信息，说明设置成功。</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@CentOS8</span> ~]<span class="meta">#echo <span class="string">"set weight web_host/web1 2"</span> | socat stdio /var/lib/haproxy/haproxy.sock2</span></span><br><span class="line"></span><br><span class="line">[root<span class="symbol">@CentOS8</span> ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;需要注意的一点就是，多线程工作模式下，<strong>每个线程是独立的</strong>，设置1线程的权重，在其他线程上并不生效。这就意味着，如果想将某个服务器下线的话，需要在每个线程上都分别下线，上线是，也需要在每个线程中enable server。可以用脚本写一个循环来实现。</p>]]></content>
      
      
      <categories>
          
          <category> linux进阶 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 企业级应用 </tag>
            
            <tag> 高可用 </tag>
            
            <tag> HAProxy </tag>
            
            <tag> 负载均衡 </tag>
            
            <tag> 调度算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>报错：Header V3 RSA_SHA256 Signature, key ID 2f86d6a1_ NOKEY</title>
      <link href="//blog/5da16ceb.html"/>
      <url>//blog/5da16ceb.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;博主在CentOS8上dnf安装PHP的依赖包libmcrypt-devel的时候，死活装不上，一直报错。看了下说是依赖项libmcrypt装不上，报错原因说的是是秘钥校验时缺少主机名。这很奇怪，因为用的是阿里的epel源，之前安装各种软件包都没问题，这次突然就秘钥验证不过了。</p><a id="more"></a><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>CentOS8 php<span class="number">-7.3</span><span class="number">.10</span>]#yum install libmcrypt-devel -y</span><br><span class="line">Last metadata expiration check: <span class="number">0</span>:<span class="number">01</span>:<span class="number">31</span> ago on Sat <span class="number">02</span> Nov <span class="number">2019</span> <span class="number">07</span>:<span class="number">47</span>:<span class="number">12</span> PM CST.</span><br><span class="line">Dependencies resolved.</span><br><span class="line">=====================================================================================================================================</span><br><span class="line"> Package                             Arch                       Version                             Repository                  Size</span><br><span class="line">=====================================================================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> libmcrypt-devel                     x86_64                     <span class="number">2.5</span><span class="number">.8</span><span class="number">-26.</span>el8                        aliyun                      <span class="number">18</span> k</span><br><span class="line">Installing dependencies:</span><br><span class="line"> libmcrypt                           x86_64                     <span class="number">2.5</span><span class="number">.8</span><span class="number">-26.</span>el8                        aliyun                     <span class="number">109</span> k</span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">=====================================================================================================================================</span><br><span class="line">Install  <span class="number">2</span> Packages</span><br><span class="line"></span><br><span class="line">Total size: <span class="number">127</span> k</span><br><span class="line">Installed size: <span class="number">320</span> k</span><br><span class="line">Downloading Packages:</span><br><span class="line">[SKIPPED] libmcrypt<span class="number">-2.5</span><span class="number">.8</span><span class="number">-26.</span>el8.x86_64.rpm: Already downloaded                                                                     </span><br><span class="line">[SKIPPED] libmcrypt-devel<span class="number">-2.5</span><span class="number">.8</span><span class="number">-26.</span>el8.x86_64.rpm: Already downloaded                                                               </span><br><span class="line">warning: /var/cache/dnf/aliyun-a19d7e5a690d289a/packages/libmcrypt<span class="number">-2.5</span><span class="number">.8</span><span class="number">-26.</span>el8.x86_64.rpm: Header V3 RSA/SHA256 Signature, key ID <span class="number">2f</span>86d6a1: NOKEY</span><br><span class="line">aliyun                                                                                               <span class="number">0.0</span>  B/s |   <span class="number">0</span>  B     <span class="number">00</span>:<span class="number">00</span>    </span><br><span class="line">Curl error (<span class="number">3</span>): URL using bad/illegal format <span class="keyword">or</span> missing URL <span class="keyword">for</span> file:<span class="comment">//https://mirrors.aliyun.com/epel/RPM-GPG-KEY-EPEL-8 [Invalid file://hostname/, expected localhost or 127.0.0.1 or none]</span></span><br><span class="line">The downloaded packages were saved <span class="keyword">in</span> cache until the next successful transaction.</span><br><span class="line">You can remove cached packages by executing <span class="string">'dnf clean packages'</span>.</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;查了下网上很多说法，不过都没有解决疑问。解决方案也五花八门，类似<code>rpm --import  /etc/pki/rpm-gpg/RPM*</code>导入秘钥的，也有建议安装时加选项<code>--force --nodeps</code>忽略依赖关系的。秘钥导入没用，我本身yum源仓库配置文件也填写了阿里云镜像源的秘钥路径的。忽略依赖关系强制安装的话，担心会不按依赖项，导致其他别的问题，而且这个选项本身也报错了。<br>&emsp;&emsp;后来只能干脆把秘钥检查关了，确实能装上了。<br>&emsp;&emsp;<code>vim /etc/yum.repos.d/aliyun.repo</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">name=aliyun</span><br><span class="line">baseurl=https://mirrors.aliyun.com/epel/$releasever/Everything/$basearch/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=file://https://mirrors.aliyun.com/epel/RPM-GPG-KEY-EPEL-$releasever</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;希望不是因为阿里的安装包被人动过而导致秘钥检查不通过吧，姑且相信吧。记录一下，等后期如果有问题或者有空再来排查原因。<br>&emsp;&emsp;<br>&emsp;&emsp;<br>——————————————后记 ———————————–<br>&emsp;&emsp;原来当时配置yum源文件的时候不小心画蛇添足了，导致gpgkey文件路径不对，应为<code>gpgkey=https://mirrors.aliyun.com/epel/RPM-GPG-KEY-EPEL-$releaseve</code>，用file://的话，就不需要加协议了，直接写主机名或IP加路径。<br>&emsp;&emsp;要时刻提醒自己还是要仔细，一直不出错不代表没错。<br>&emsp;&emsp;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;2019.11.10</p>]]></content>
      
      
      <categories>
          
          <category> 故障记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 故障 </tag>
            
            <tag> 记录 </tag>
            
            <tag> 排错 </tag>
            
            <tag> epel </tag>
            
            <tag> 阿里云 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginx防盗链设置的一些细节</title>
      <link href="//blog/e4415633.html"/>
      <url>//blog/e4415633.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;防盗链的必要性，我这里就不再赘述了，这是网站设计的最基本要求。而在nginx中，一般比较容易实现的防盗链手段就是通过ungx_http_referer_module模块<a href="https://nginx.org/en/docs/http/ngx_http_referer_module.html#valid_referers" rel="noopener" target="_blank">（查看官方文档）</a> 检查访问请求的referer信息是否有效来实现防盗链功能。<br>&emsp;&emsp;所谓referer检查，举个例子来说，在正常情况下当用户在浏览<code>http://example.com/abc.html</code>时点击一个链接去到<code>http://example.com/123.mp3</code>文件时，浏览器在发出请求123.mp3 资源时还会附带当刻浏览器所处的页面地址（即<code>http://example.com/abc.html</code>），所以当你的网站程序接收到下载 jacky.mp3 资源请求的时候，先判断http的referer字段的值，如果是从 自己的域名（example.com）过来的，则可以认为是合法的连接请求，否则就返回一个错误的提示信息。</p><a id="more"></a><p>&emsp;&emsp;这种方法通常用于图片、mp3这种容易被人用html“嵌入”到其他网站的资源，使用这种方法可以防止你的图片直接出现在别人的网页里（或者防止mp3直接被其他网站嵌入到flash播放器里），不过访客使用下载工具还是可以轻松下载，因为现在的下载工具一般会自动用你的域名构造一个引用地址，所以如果想再进一步防范的话，可以使用一个对应表限制每个资源的引用地址，例如将 123.mp3 的引用地址限制为<code>http://example.com/abc.htmlid=123456</code>，这样下载工具就不太可能构造一个“正确”的引用地址了。</p><h3 id="referer"><a href="#referer" class="headerlink" title="referer"></a>referer</h3><p>&emsp;&emsp;要过滤掉盗链访问的referer信息，首先要明确知道，正常访问的referer有哪些。一般来说，正常的referer信息有以下四种：</p><ul><li>none：请求报文首部没有referer首部，比如用户直接在浏览器输入域名访问web网站，就没有referer信息。</li><li>blocked：请求报文有referer首部，但无有效值，比如为空。</li><li>本站链接：referer首部中包含本站域名。</li><li>搜索引擎跳转：referer中为 * .baidu. *  、 * .google. * 、及其他搜索引擎（如360、必应）（具体图片或mp3媒体文件，不希望被搜索引擎引用，可单独设置，主页等html页面建议允许搜索引擎跳转）<br>&emsp;&emsp;所以根据官方文档,我们只需制定合适的匹配规则，将正常的访问放过，对那些“非正常的”盗链访问，返回403错误代码，即可实现防盗链。<blockquote>undefined</blockquote><h3 id="过滤规则设置"><a href="#过滤规则设置" class="headerlink" title="过滤规则设置"></a>过滤规则设置</h3>&emsp;&emsp;打开nginx配置文件，找到想要定义的location下，加入下面设置<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span>  /blog/ &#123;</span><br><span class="line">    <span class="attribute">root</span> /apps/nginx/html/;    <span class="comment">#定义路径</span></span><br><span class="line">    <span class="attribute">valid_referers</span> <span class="literal">none</span> <span class="literal">blocked</span> server_names <span class="regexp">*.example.com</span>  ~\.google\. ~\.baidu\.;  </span><br><span class="line">    <span class="comment">#设置允许访问的匹配规则,匹配规则可以写在一行，也可以分行写。</span></span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$invalid_referer</span>) &#123;     <span class="comment">#设置条件判断，不符合上述规则的，返回403状态码</span></span><br><span class="line">        <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /mp3/ &#123;</span><br><span class="line">    <span class="attribute">alias</span> /apps/nginx/html/blog/mp3/;    <span class="comment">#定义路径，也可用root</span></span><br><span class="line">    <span class="attribute">valid_referers</span> <span class="literal">none</span> <span class="literal">blocked</span> server_names <span class="regexp">*.example.com</span> ;   </span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$invalid_referer</span>) &#123;     <span class="comment">#设置条件判断，不符合上述规则的，返回403状态码</span></span><br><span class="line">        <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>&emsp;&emsp;也可在全局配置server中做设置，不过还是建议每个location单独设置，因为对于图片和或者音频视频文件本身，还是不希望直接被搜索引擎所引用，造成网站资源的无意义的消耗。</p><h3 id="跳转设置"><a href="#跳转设置" class="headerlink" title="跳转设置"></a>跳转设置</h3><p>&emsp;&emsp;对于盗链者，也可以予以反击，允许他们请求我们的资源，不过，只给他们我们指定的资源，例如百度使用的防盗链图：</p><p>&emsp;&emsp;<img src="https://img-blog.csdnimg.cn/20191030165321571.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;配置上只需将<code>return 403</code>;改为<code>rewrite ^/ http://www.example/images/return.jpg</code>; 例如：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span>  <span class="regexp">~ return\.jpg$</span> &#123;</span><br><span class="line">    <span class="attribute">root</span> /apps/nginx/html/blog/images/</span><br><span class="line">｝</span><br><span class="line">location  <span class="regexp">~ .*\.(gif|jpg|jpeg|png|bmp|swf)$</span> &#123;</span><br><span class="line">    <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">root</span> /apps/nginx/html/blog/images/; </span><br><span class="line">    <span class="attribute">valid_referers</span> <span class="literal">none</span> <span class="literal">blocked</span> server_names <span class="regexp">*.example.com</span>  ~\.google\. ~\.baidu\.; </span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$invalid_referer</span>) &#123; </span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/</span> http://www.example/images/return.jpg;</span><br><span class="line">                    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;<strong>PS：return.jpg要设置规则优先匹配到，这个图片不能被防盗链，不然会无限重定向，导致显示不正常。</strong></p><h3 id="规则细节"><a href="#规则细节" class="headerlink" title="规则细节"></a>规则细节</h3><p>&emsp;&emsp;设置匹配规则时，根据官方文档，只有none、blocked、server_names、arbitrary string和regular expression五种规则。</p><blockquote><p> Parameters can be as follows:</p><p><strong>none</strong><br>&emsp;&emsp;the “Referer” field is missing in the request header;<br><strong>blocked</strong><br>&emsp;&emsp;the “Referer” field is present in the request header, but its value has  been deleted by a firewall or proxy server; such values are strings that do  not start with “http://” or “https://”;<br><strong>server_names</strong><br>&emsp;&emsp;the “Referer” request header field contains one of the server names;<br><strong>arbitrary string</strong><br>&emsp;&emsp;defines a server name and an optional URI prefix. A server name can  have an “* ” at the beginning or end. During the checking, the server’s port in the “Referer” field is ignored;<br><strong>regular expression</strong><br>&emsp;&emsp;the first symbol should be a “~”. It should be noted that an expression  will be matched against the text starting after the “http://” or “https://”. </p></blockquote><p>&emsp;&emsp;这就要求我们在设置匹配规则的时候，要按照这个五种方式来，none、blocked直接写上就可以了，没有什么可说的，我们重点理解下剩下三种。</p><h4 id="server-names"><a href="#server-names" class="headerlink" title="server_names"></a>server_names</h4><p>&emsp;&emsp;server names字面上理解很容易，就是匹配的域名。注意：<strong>这里的域名，指本服务器上所有监听的域名</strong>。而且这是一个包含的关系，只要referer头部信息中包含有本服务器的监听的任意域名，即可通过匹配。</p><h4 id="arbitrary-string"><a href="#arbitrary-string" class="headerlink" title="arbitrary string"></a>arbitrary string</h4><p>&emsp;&emsp;翻译过来是任意字符串，其实就是任意可以匹配到到字符串，这里支持通配符。大致有2种写法：</p><ul><li><p>直接写域名<br>例如可以写<code>*.example.com</code>,也可写为<code>www.example.*</code>，可问题是为什么就偏偏<strong>不支持 * .example. * 呢</strong>。这我也很费解，不过确实不支持，有兴趣的朋友可以去试一下，也希望能有大佬告知这其中的原理是什么。</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS8 ~]<span class="meta">#/apps/nginx/sbin/nginx -t</span></span><br><span class="line"><span class="symbol">nginx:</span> [emerg] invalid hostname or wildcard <span class="string">"*.example.*"</span> in <span class="meta-keyword">/apps/</span>nginx<span class="meta-keyword">/conf/</span>nginx.conf:<span class="number">95</span></span><br><span class="line"><span class="symbol">nginx:</span> configuration file <span class="meta-keyword">/apps/</span>nginx<span class="meta-keyword">/conf/</span>nginx.conf test failed</span><br></pre></td></tr></table></figure></li><li><p>定义匹配域名加路径<br>&emsp;&emsp;例如：<code>www.example.com/blog</code>;<br>&emsp;&emsp;而博主试验过很很多次，如果写成例如<code>www.example.com/*</code>，在<code>www.example.com/blog/</code>页面下去引用页面下的<code>/apps/nginx/html/mp3/123.mp3</code>文件时就会报403错误，而写域名加确切地址如<code>www.example.com/blog</code>时才可以访问。仔细查阅了官方文档，才知道，有个很关键的细节就是，<strong>这个通配符的位置，只能在域名里</strong>。可以再看一下官方文档，</p><blockquote><p>&emsp;&emsp;defines a server name and an optional URI prefix. A server name can have an “*” at the beginning or end. During the checking, the server’s port in the “Referer” field is ignored; </p></blockquote></li></ul><p>&emsp;&emsp;我们可以得知，只可以在域名的开头和结尾用 * 的通配符，而不是URI中，这也就是为什么我发现<code>www.examlpe.com/*</code>无法匹配通过的原因。<br>&emsp;&emsp;跟server_names一样，只要<strong>包含</strong>自定义字符串就可以,例如匹配规则写成<code>www.example.com/mp3/</code>，在<code>www.example.com/mp3/</code>页面下就可以引用的<code>/apps/nginx/html/mp3/123.mp3</code>文件了，在<code>www.example.com/mp3/abc/efg/</code>页面下是同样可以跳转访问<code>/apps/nginx/html/mp3/123.mp3</code>文件的。</p><h4 id="regular-expression"><a href="#regular-expression" class="headerlink" title="regular expression"></a>regular expression</h4><p>&emsp;&emsp;被指定的正则表达式模式匹配到的字符串,要使用 ~ 开头，例如：~.*.google.com。这要严格按照正则表达式匹配到的referer写，否则就会无法访问。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>&emsp;&emsp;设置匹配规则时，必须符合其中的某一种，而不能想当然的把几种规则混合起来使用，想要放行的链接，一定要考虑好，到底确切适用于哪一种规则，才不会出现“误伤“、“漏网”的情况。</p>]]></content>
      
      
      <categories>
          
          <category> linux进阶 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
            <tag> 防盗链 </tag>
            
            <tag> referer </tag>
            
            <tag> 配置文件 </tag>
            
            <tag> 细节 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>企业级应用：负载均衡层——LVS调度器详解</title>
      <link href="//blog/159ef64c.html"/>
      <url>//blog/159ef64c.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;所谓LVS，是Linux Virtual Server的缩写，直译就是linux虚拟服务器。LVS说是虚拟服务器，并不是说这个服务器本身不存在，而是指一般用户访问企业web网站时，访问的都是LVS，而LVS本身上面没有任何web界面资源，真实的界面以及服务都在后端web服务器上，LVS服务器起到的是一个指引分流的作用，所以相对来说，后端的web服务器是real server,而LVS就被称为是virtual server（虚拟服务器）了。<br>&emsp;&emsp;既然这个服务器上没有页面资源，又无法提供服务，那为什么还有必要部署它来多此一举呢？因为通常来说，我们访问的web服务，都不是由单一服务器主机来支撑的，背后都有好几台、甚至成百上千台web服务器集群共同提供，一台单一主机是无法支撑大的访问并发的，需要很多台服务器来共同分担压力，这时就需要一个专门的服务器来进行调度，将大量访问请求分配到不同的web服务器上，减小每台服务器的压力，实现负载均衡。<br>&emsp;&emsp;本文将详细介绍LVS调度器的工作模式及配置实例。</p><a id="more"></a><h3 id="集群和分布式"><a href="#集群和分布式" class="headerlink" title="集群和分布式"></a>集群和分布式</h3><p>&emsp;&emsp;集群：同一个业务系统，部署在多台服务器上。集群中，每一台服务器实现的功能没有差别，数据和代码都是一样的。<br>&emsp;&emsp;分布式：一个业务被拆成多个子业务，或者本身就是不同的业务，部署在多台服务器上。分布式中，每一台服务器实现的功能是有差别的，数据和代码也是不一样的，分布式每台服务器功能加起来，才是完整的业务。<br>&emsp;&emsp;分布式是以缩短单个任务的执行时间来提升效率的，而集群则是通过提高单位时间内执行的任务数来提升效率。<br>&emsp;&emsp;对于大型网站，访问用户很多，实现一个群集，在前面部署一个负载均衡服务器，后面几台服务器完成同一业务。如果有用户进行相应业务访问时，负载均衡器根据后端哪台服务器的负载情况，决定由给哪一台去完成响应，并且一台服务器垮了，其它的服务器可以顶上来。分布式的每一个节点，都完成不同的业务，如果一个节点垮了，那这个业务可能就会失败。</p><h4 id="Cluster概念"><a href="#Cluster概念" class="headerlink" title="Cluster概念"></a>Cluster概念</h4><p>&emsp;&emsp;Cluster：集群,为解决某个特定问题将多台计算机组合起来形成的单个系统。<br>;Linux Cluster类型：</p><ul><li>LB：Load Balancing，负载均衡</li><li>HA：High Availiablity，高可用，SPOF（single Point Of failure）<br>MTBF:Mean Time Between Failure 平均无故障时间<br>MTTR:Mean Time To Restoration（ repair）平均恢复前时间<br>A=MTBF/（MTBF+MTTR(0,1)：99%,99.5%,99.9%,99.99%,99.999%</li><li>HPC：High-performance computing，高性能</li></ul><h5 id="LB-Cluster的实现"><a href="#LB-Cluster的实现" class="headerlink" title="LB Cluster的实现"></a>LB Cluster的实现</h5><ul><li>硬件<br>F5 Big-IP<br>Citrix Netscaler<br>A10 A10</li><li>软件<br>lvs：Linux Virtual Server，阿里四层SLB (Server Load Balance)使用网络传输的下四层,不支持应用层等数据的调度内核级:功能虽然弱,性能好,一般最为最前端的调度器.<br>nginx：支持七层调度，阿里七层SLB使用Tengine<br>haproxy：支持七层调度<br>ats：Apache Traffic Server，yahoo捐助给apache<br>perlbal：Perl 编写<br>pound</li></ul><h5 id="LB-Cluster基于工作的协议层次划分："><a href="#LB-Cluster基于工作的协议层次划分：" class="headerlink" title="LB Cluster基于工作的协议层次划分："></a>LB Cluster基于工作的协议层次划分：</h5><ul><li>传输层（通用）：DPORT<br>LVS：<br>nginx：stream<br>haproxy：mode tcp</li><li>应用层（专用）：针对特定协议，自定义的请求模型分类<br>proxy server：<br>http：nginx, httpd, haproxy(mode http), …<br>fastcgi：nginx, httpd, …<br>mysql：mysql-proxy, …</li></ul><h5 id="LB-Cluster中用户的会话保持"><a href="#LB-Cluster中用户的会话保持" class="headerlink" title="LB Cluster中用户的会话保持"></a>LB Cluster中用户的会话保持</h5><p>&emsp;&emsp;负载均衡之后，用户会话保持的解决方案：<br>&emsp;&emsp;(1) session sticky：同一用户调度固定服务器<br>&emsp;&emsp;      Source IP：LVS sh算法（对某一特定服务而言）(固定IP)<br>&emsp;&emsp;      Cookie   (LVS四层调度,无法识别cookie)<br>&emsp;&emsp;(2) session replication：每台服务器拥有全部session<br>&emsp;&emsp;      session multicast cluster<br>&emsp;&emsp;(3) session server：专门的session服务器，如Memcached，Redis</p><h4 id="分布式系统："><a href="#分布式系统：" class="headerlink" title="分布式系统："></a>分布式系统：</h4><p>常见的分布式存储： Ceph，GlusterFS，FastDFS，MogileFS<br>常见的分布式计算：hadoop，Spark<br>这里不多介绍。</p><h3 id="LVS介绍"><a href="#LVS介绍" class="headerlink" title="LVS介绍"></a>LVS介绍</h3><p>&emsp;&emsp;LVS：Linux Virtual Server，负载调度器，在linux内核集成。LVS项目在1998年5月由章文嵩博士成立，是中国国内最早出现的自由软件项目之一。<br>&emsp;&emsp;LVS实现负载均衡,自身的单点失败问题由keepalived解决(vrrp协议).<br>&emsp;&emsp;keepalived还可以实现检查后端服务器状态.</p><h4 id="lvs集群类型中的术语："><a href="#lvs集群类型中的术语：" class="headerlink" title="lvs集群类型中的术语："></a>lvs集群类型中的术语：</h4><ul><li>VS：Virtual Server，Director Server(DS)，Dispatcher(调度器)，Load Balancer</li><li>RS：Real Server(lvs),，upstream server(nginx)，backend server(haproxy)</li><li>CIP：Client IP</li><li>VIP: Virtual serve IP VS外网的IP  (一般也是内网IP,由防火墙DNAT指向)</li><li>DIP: Director IP VS内网的IP</li><li>RIP: Real server IP<br>&emsp;&emsp;访问流程：CIP &lt;–&gt; VIP == DIP &lt;–&gt; RIP    </li><li>lvs: ipvsadm/ipvs<br>&emsp;&emsp;ipvsadm：用户空间的命令行工具，规则管理器，用于管理集群服务及RealServer<br>&emsp;&emsp;ipvs：工作于内核空间netfilter的INPUT钩子上的框架</li></ul><h4 id="lvs的模式："><a href="#lvs的模式：" class="headerlink" title="lvs的模式："></a>lvs的模式：</h4><p>&emsp;&emsp;<strong>lvs-nat</strong>：修改请求报文的目标IP,多目标IP的DNAT<br>&emsp;&emsp;<strong>lvs-dr</strong>：操纵封装新的MAC地址<br>&emsp;&emsp;<strong>lvs-tun</strong>：在原请求IP报文之外新加一个IP首部<br>&emsp;&emsp;<strong>lvs-fullnat</strong>：修改请求报文的源和目标IP</p><h5 id="lvs-nat："><a href="#lvs-nat：" class="headerlink" title="lvs-nat："></a>lvs-nat：</h5><p>&emsp;&emsp;本质是多目标IP的DNAT，通过将请求报文中的目标地址和目标端口修改为某挑出的RS的RIP和PORT实现转发<br>    （1）RIP和DIP应在同一个IP网络，且应使用私网地址；RS的网关要指向DIP<br>    （2）请求报文和响应报文都必须经由Director转发，Director易于成为系统瓶颈<br>    （3）支持端口映射，可修改请求报文的目标PORT<br>    （4）VS必须是Linux系统，RS可以是任意OS系统</p><h5 id="LVS-DR："><a href="#LVS-DR：" class="headerlink" title="LVS-DR："></a>LVS-DR：</h5><p>&emsp;&emsp;Direct Routing，直接路由，LVS默认模式,应用最广泛,通过为请求报文重新封装一个MAC首部进行转发，源MAC是DIP所在的接口的MAC，目标MAC是某挑选出的RS的RIP所在接口的MAC地址；源IP/PORT，以及目标IP/PORT均保持不变<br>    （1） Director和各RS都配置有VIP<br>    （2） 确保前端路由器将目标IP为VIP的请求报文发往Director<br>        &emsp;&emsp;在前端网关做静态绑定VIP和Director的MAC地址<br>         &emsp;&emsp;在RS上使用arptables工具<br>            <code>arptables -A IN -d $VIP -j DROP</code><br>            <code>arptables -A OUT -s $VIP -j mangle --mangle-ip-s $RIP</code><br>         &emsp;&emsp;在RS上修改内核参数以限制arp通告及应答级别<br>            <code>/proc/sys/net/ipv4/conf/all/arp_ignore</code><br>            <code>/proc/sys/net/ipv4/conf/all/arp_announce</code><br>    （3）RS的RIP可以使用私网地址，也可以是公网地址；RIP与DIP在同一IP网络；RIP的网关不能指向DIP，以确保响应报文不会经由Director<br>    （4）RS和Director要在同一个物理网络<br>    （5）请求报文要经由Director，但响应报文不经由Director，而由RS直接发往Client<br>    （6）不支持端口映射（端口不能修败）<br>    （7）RS可使用大多数OS系统</p><h5 id="lvs-tun："><a href="#lvs-tun：" class="headerlink" title="lvs-tun："></a>lvs-tun：</h5><p>&emsp;&emsp;转发方式：不修改请求报文的IP首部（源IP为CIP，目标IP为VIP），而在原IP报文之外再封装一个IP首部（源IP是DIP，目标IP是RIP），将报文发往挑选出的目标RS；RS直接响应给客户端（源IP是VIP，目标IP是CIP）<br>&emsp;&emsp;    (1) DIP, VIP, RIP都应该是公网地址<br>&emsp;&emsp;    (2) RS的网关一般不能指向DIP<br>&emsp;&emsp;    (3) 请求报文要经由Director，但响应不经由Director<br>&emsp;&emsp;    (4) 不支持端口映射<br>&emsp;&emsp;    (5) RS的OS须支持隧道功能</p><h5 id="lvs-fullnat：通过同时修改请求报文的源IP地址和目标IP地址进行转发"><a href="#lvs-fullnat：通过同时修改请求报文的源IP地址和目标IP地址进行转发" class="headerlink" title="lvs-fullnat：通过同时修改请求报文的源IP地址和目标IP地址进行转发"></a>lvs-fullnat：通过同时修改请求报文的源IP地址和目标IP地址进行转发</h5><p>&emsp;&emsp;CIP –&gt; DIP<br>&emsp;&emsp;VIP –&gt; RIP<br>    (1) VIP是公网地址，RIP和DIP是私网地址，且通常不在同一IP网络；因此，RIP的网关一般不会指向DIP<br>    (2) RS收到的请求报文源地址是DIP，因此，只需响应给DIP；但Director还要将其发往Client<br>    (3) 请求和响应报文都经由Director<br>    (4) 支持端口映射<br><strong>注意：此类型kernel默认不支持</strong></p><h4 id="LVS调度算法"><a href="#LVS调度算法" class="headerlink" title="LVS调度算法"></a>LVS调度算法</h4><p>ipvs scheduler：<br>&emsp;&emsp;根据其调度时是否考虑各RS当前的负载状态分为两种：静态方法和动态方法</p><ul><li><p>静态方法：仅根据算法本身进行调度</p><pre><code>1、RR：roundrobin，轮询2、WRR：Weighted RR，加权轮询3、SH：Source Hashing，实现session sticky，源IP地址hash；将来自于同一个IP地址的请求始终发往第一次挑中的RS，从而实现会话绑定4、DH：Destination Hashing；目标地址哈希，第一次轮询调度至RS，后续将发往同一个目标地址的请求始终转发至第一次挑中的RS，典型使用场景是正向代理缓存场景中的负载均衡，如：宽带运营商</code></pre></li><li><p>动态方法：主要根据每RS当前的负载状态及调度算法进行调度Overhead=value较小的RS将被调度</p><pre><code>1、LC：least connections 适用于长连接应用Overhead=activeconns*256+inactiveconns2、WLC：Weighted LC，默认调度方法Overhead=(activeconns*256+inactiveconns)/weight3、SED：Shortest Expection Delay,初始连接高权重优先Overhead=(activeconns+1)*256/weight4、NQ：Never Queue，第一轮均匀分配，后续SED5、LBLC：Locality-Based LC，动态的DH算法，使用场景：根据负载状态实现正向代理6、LBLCR：LBLC with Replication，带复制功能的LBLC，解决LBLC负载不均衡问题，从负载重的复制到负载轻的RS</code></pre></li></ul><h4 id="ipvsadm-ipvs："><a href="#ipvsadm-ipvs：" class="headerlink" title="ipvsadm/ipvs："></a>ipvsadm/ipvs：</h4><h5 id="ipvs："><a href="#ipvs：" class="headerlink" title="ipvs："></a>ipvs：</h5><p>&emsp;&emsp;<code>grep -i -A 10 &quot;ipvs&quot; /boot/config-VERSION-RELEASE.x86_64</code><br>&emsp;&emsp;支持的协议：TCP， UDP， AH， ESP， AH_ESP, SCTP<br>ipvs集群：<br>&emsp;&emsp;管理集群服务<br>&emsp;&emsp;管理服务上的RS</p><h5 id="ipvsadm："><a href="#ipvsadm：" class="headerlink" title="ipvsadm："></a>ipvsadm：</h5><p>&emsp;&emsp;程序包：ipvsadm<br>&emsp;&emsp;Unit File: ipvsadm.service<br>&emsp;&emsp;主程序：/usr/sbin/ipvsadm<br>&emsp;&emsp;规则保存工具：/usr/sbin/ipvsadm-save<br>&emsp;&emsp;规则重载工具：/usr/sbin/ipvsadm-restore<br>&emsp;&emsp;配置文件：/etc/sysconfig/ipvsadm-config<br><strong>ipvsadm命令</strong>：<br>核心功能：</p><ul><li>集群服务管理：增、删、改</li><li>集群服务的RS管理：增、删、改</li><li>查看</li></ul><p>&emsp;&emsp;例：命令总结：</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -A|<span class="type">E</span> -t|<span class="type">u</span>|<span class="type">f</span> service-address [-s scheduler] [-p [<span class="built_in">timeout</span>]] [-M netmask] [--pepersistence_engine] [-b sched-flags]</span><br><span class="line">ipvsadm -D -t|<span class="type">u</span>|<span class="type">f</span> service-address 删除</span><br><span class="line">ipvsadm –C 清空</span><br><span class="line">ipvsadm –R 重载</span><br><span class="line">ipvsadm -S [-n] 保存</span><br><span class="line">ipvsadm -a|<span class="type">e</span> -t|<span class="type">u</span>|<span class="type">f</span> service-address -r server-address [options]</span><br><span class="line">ipvsadm -d -t|<span class="type">u</span>|<span class="type">f</span> service-address -r server-address</span><br><span class="line">ipvsadm -L|<span class="type">l</span> [options]</span><br><span class="line">ipvsadm -Z [-t|<span class="type">u</span>|<span class="type">f</span> service-address]</span><br></pre></td></tr></table></figure><h6 id="管理集群服务：增、改、删"><a href="#管理集群服务：增、改、删" class="headerlink" title="管理集群服务：增、改、删"></a>管理集群服务：增、改、删</h6><p>&emsp;&emsp;增、改：<br><code>ipvsadm -A|E -t|u|f service-address [-s scheduler] [-p [timeout]]</code><br>&emsp;&emsp;删除：<br><code>ipvsadm -D -t|u|f service-address</code><br>service-address： VIP<br>&emsp;&emsp;    -t|u|f：<br>&emsp;&emsp;    -t: TCP协议的端口，VIP:TCP_PORT<br>&emsp;&emsp;    -u: UDP协议的端口，VIP:UDP_PORT<br>&emsp;&emsp;    -f：firewall MARK，标记，一个数字<br>&emsp;&emsp;[-s scheduler]：指定集群的调度算法，默认为wlc</p><h6 id="管理集群上的RS：增、改、删"><a href="#管理集群上的RS：增、改、删" class="headerlink" title="管理集群上的RS：增、改、删"></a>管理集群上的RS：增、改、删</h6><p>&emsp;&emsp;增、改：<br><code>ipvsadm -a|e -t|u|f service-address -r server-address [-g|i|m] [-w    weight]</code><br>&emsp;&emsp;删：<br><code>ipvsadm -d -t|u|f service-address -r server-addressserver-address</code><br>&emsp;&emsp;rip[:port] 如省略port，不作端口映射<br>选项：<br>&emsp;&emsp;lvs类型：<br>&emsp;&emsp;-g: gateway, dr类型，默认<br>&emsp;&emsp;-i: ipip, tun类型<br>&emsp;&emsp;-m: masquerade, nat类型<br>&emsp;&emsp;-w weight：权重</p><p>&emsp;&emsp;清空定义的所有内容：<br><code>ipvsadm –C</code><br>清空计数器：<br><code>ipvsadm -Z [-t|u|f service-address]</code></p><h6 id="查看："><a href="#查看：" class="headerlink" title="查看："></a>查看：</h6><p><code>ipvsadm -L|l [options]</code><br>&emsp;&emsp;–numeric, -n：以数字形式输出地址和端口号<br>&emsp;&emsp;–exact：扩展信息，精确值<br>&emsp;&emsp;–connection，-c：当前IPVS连接输出<br>&emsp;&emsp;–stats：统计信息<br>&emsp;&emsp;–rate ：输出速率信息</p><p>ipvs规则：/proc/net/ip_vs<br>ipvs连接：/proc/net/ip_vs_conn</p><h4 id="保存及重载规则"><a href="#保存及重载规则" class="headerlink" title="保存及重载规则"></a>保存及重载规则</h4><p>&emsp;&emsp;保存：建议保存至/etc/sysconfig/ipvsadm<br><code>ipvsadm-save &gt; /PATH/TO/IPVSADM_FILE</code><br><code>ipvsadm -S &gt; /PATH/TO/IPVSADM_FILE</code><br><code>systemctl stop ipvsadm.service</code><br>&emsp;&emsp;重载：<br><code>ipvsadm-restore &lt; /PATH/FROM/IPVSADM_FILE</code><br><code>systemctl restart ipvsadm.service</code></p><h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><p>负载均衡集群设计时要注意的问题<br>&emsp;&emsp;(1) 是否需要会话保持<br>&emsp;&emsp;(2) 是否需要共享存储<br>    共享存储：NAS， SAN， DS（分布式存储）<br>    数据同步：</p><h4 id="lvs-nat：-1"><a href="#lvs-nat：-1" class="headerlink" title="lvs-nat："></a>lvs-nat：</h4><p>设计要点：<br>&emsp;&emsp;(1) RIP与DIP在同一IP网络, RIP的网关要指向DIP<br>&emsp;&emsp;(2) 支持端口映射<br>&emsp;&emsp;(3) Director要打开核心转发功能</p><h4 id="LVS-DR"><a href="#LVS-DR" class="headerlink" title="LVS-DR"></a>LVS-DR</h4><p>DR模型中各主机上均需要配置VIP，解决地址冲突的方式有三种：</p><ul><li>(1) 在前端网关做静态绑定</li><li>(2) 在各RS使用arptables</li><li>(3) 在各RS修改内核参数，来限制arp响应和通告的级别<br>限制响应级别：arp_ignore<br>  0：默认值，表示可使用本地任意接口上配置的任意地址进行响应<br>  1: 仅在请求的目标IP配置在本地主机的接收到请求报文的接口上时，才给予响应<br>限制通告级别：arp_announce<br>  0：默认值，把本机所有接口的所有信息向每个接口的网络进行通告<br>  1：尽量避免将接口信息向非直接连接网络进行通告<br>  2：必须避免将接口信息向非本网络进行通告</li></ul><h5 id="附："><a href="#附：" class="headerlink" title="附："></a>附：</h5><p>&emsp;&emsp;RS的配置脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">vip=10.0.0.100</span><br><span class="line">mask=<span class="string">'255.255.255.255'</span></span><br><span class="line">dev=lo:1</span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line"><span class="built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">ifconfig <span class="variable">$dev</span> <span class="variable">$vip</span> netmask <span class="variable">$mask</span> <span class="comment">#broadcast $vip up</span></span><br><span class="line"><span class="comment">#route add -host $vip dev $dev</span></span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">ifconfig <span class="variable">$dev</span> down</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Usage: <span class="variable">$(basename $0)</span> start|stop"</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line">;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;VS的配置脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">vip=<span class="string">'10.0.0.100'</span></span><br><span class="line">iface=<span class="string">'lo:1'</span></span><br><span class="line">mask=<span class="string">'255.255.255.255'</span></span><br><span class="line">port=<span class="string">'80'</span></span><br><span class="line">rs1=<span class="string">'192.168.0.101'</span></span><br><span class="line">rs2=<span class="string">'192.168.0.102'</span></span><br><span class="line">scheduler=<span class="string">'wrr'</span></span><br><span class="line"><span class="built_in">type</span>=<span class="string">'-g'</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">ifconfig <span class="variable">$iface</span> <span class="variable">$vip</span> netmask <span class="variable">$mask</span> <span class="comment">#broadcast $vip up</span></span><br><span class="line">iptables -F</span><br><span class="line">ipvsadm -A -t <span class="variable">$&#123;vip&#125;</span>:<span class="variable">$&#123;port&#125;</span> -s <span class="variable">$scheduler</span></span><br><span class="line">ipvsadm -a -t <span class="variable">$&#123;vip&#125;</span>:<span class="variable">$&#123;port&#125;</span> -r <span class="variable">$&#123;rs1&#125;</span> <span class="variable">$type</span> -w 1</span><br><span class="line">ipvsadm -a -t <span class="variable">$&#123;vip&#125;</span>:<span class="variable">$&#123;port&#125;</span> -r <span class="variable">$&#123;rs2&#125;</span> <span class="variable">$type</span> -w 1</span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">ipvsadm -C</span><br><span class="line">ifconfig <span class="variable">$iface</span> down</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Usage <span class="variable">$(basename $0)</span> start|stop“</span></span><br><span class="line"><span class="string">exit 1</span></span><br><span class="line"><span class="string">esac</span></span><br></pre></td></tr></table></figure><h3 id="FireWall-Mark"><a href="#FireWall-Mark" class="headerlink" title="FireWall Mark"></a>FireWall Mark</h3><p>&emsp;&emsp;FWM：FireWall Mark<br>&emsp;&emsp;MARK target 可用于给特定的报文打标记<br>&emsp;&emsp;–set-mark value<br>其中：value 可为0xffff格式，表示十六进制数字<br>&emsp;&emsp;借助于防火墙标记来分类报文，而后基于标记定义集群服务；可将多个不同的应用使用同一个集群服务进行调度<br>&emsp;&emsp;实现方法：<br>&emsp;&emsp;在Director主机打标记：<br><code>iptables -t mangle -A PREROUTING -d $vip -p $proto –m multiport --dports $port1,$port2,… -j MARK --set-mark NUMBER</code><br>&emsp;&emsp;在Director主机基于标记定义集群服务：<br><code>ipvsadm -A -f NUMBER [options]</code></p><h4 id="持久连接"><a href="#持久连接" class="headerlink" title="持久连接"></a>持久连接</h4><p>&emsp;&emsp;session 绑定：对共享同一组RS的多个集群服务，需要统一进行绑定，lvs sh算法无法实现<br>&emsp;&emsp;持久连接（ lvs persistence ）模板：实现无论使用任何调度算法，在一段时间内（默认360s ），能够实现将来自同一个地址的请求始终发往同一个RS<br><code>ipvsadm -A|E -t|u|f service-address [-s scheduler] [-p [timeout]]</code><br>&emsp;&emsp;持久连接实现方式：<br>&emsp;&emsp;每端口持久（PPC）：每个端口定义为一个集群服务，每集群服务单独调度<br>&emsp;&emsp;每防火墙标记持久（PFWMC）：基于防火墙标记定义集群服务；可实现将多个端口上的应用统一调度，即所谓的port Affinity<br>&emsp;&emsp;每客户端持久（PCC）：基于0端口（表示所有服务）定义集群服务，即将客户端对所有应用的请求都调度至后端主机，必须定义为持久模式</p><h3 id="LVS高可用性"><a href="#LVS高可用性" class="headerlink" title="LVS高可用性"></a>LVS高可用性</h3><ul><li>Director不可用，整个系统将不可用；SPoF Single Point of Failure<br>&emsp;&emsp;解决方案：高可用<br>&emsp;&emsp;keepalived heartbeat/corosync</li><li>某RS不可用时，Director依然会调度请求至此RS<br>&emsp;&emsp;解决方案： 由Director对各RS健康状态进行检查，失败时禁用，成功时启用keepalived heartbeat/corosync ldirectord<br>&emsp;&emsp;检测方式：<br>&emsp;&emsp;(a) 网络层检测，icmp<br>&emsp;&emsp;(b) 传输层检测，端口探测<br>&emsp;&emsp;(c) 应用层检测，请求某关键资源<br>&emsp;&emsp;RS全不用时：backup server, sorry server</li></ul><h4 id="ldirectord"><a href="#ldirectord" class="headerlink" title="ldirectord"></a>ldirectord</h4><p>&emsp;&emsp;ldirectord：监控和控制LVS守护进程，可管理LVS规则<br>&emsp;&emsp;包名：ldirectord-3.9.6-0rc1.1.1.x86_64.rpm<br>&emsp;&emsp;下载：<a href="http://download.opensuse.org/repositories/network:/haclustering:/Stable/CentOS_CentOS-7/x86_64/" rel="noopener" target="_blank">http://download.opensuse.org/repositories/network:/haclustering:/Stable/CentOS_CentOS-7/x86_64/</a><br>&emsp;&emsp;文件：<br>&emsp;&emsp;/etc/ha.d/ldirectord.cf 主配置文件<br>&emsp;&emsp;/usr/share/doc/ldirectord-3.9.6/ldirectord.cf 配置模版<br>&emsp;&emsp;/usr/lib/systemd/system/ldirectord.service 服务<br>&emsp;&emsp;/usr/sbin/ldirectord 主程序,Perl实现<br>&emsp;&emsp;/var/log/ldirectord.log 日志<br>&emsp;&emsp;/var/run/ldirectord.ldirectord.pid pid文件</p><p>&emsp;&emsp;Ldirectord配置文件示例</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">checktimeout</span>=3</span><br><span class="line"><span class="attribute">checkinterval</span>=1</span><br><span class="line"><span class="attribute">autoreload</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attribute">logfile</span>=“/var/log/ldirectord.log“ #日志文件</span><br><span class="line"><span class="attribute">quiescent</span>=<span class="literal">no</span>   #down时<span class="literal">yes</span>权重为0，<span class="literal">no</span>为删除</span><br><span class="line"><span class="attribute">virtual</span>=5      #指定VS的FWM 或 IP:PORT</span><br><span class="line"><span class="attribute">real</span>=172.16.0.7:80 gate 2    #DR模型，权重为 2</span><br><span class="line"><span class="attribute">real</span>=172.16.0.8:80 gate 1</span><br><span class="line"><span class="attribute">fallback</span>=127.0.0.1:80 gate   #sorry server</span><br><span class="line"><span class="attribute">service</span>=http</span><br><span class="line"><span class="attribute">scheduler</span>=wrr</span><br><span class="line"><span class="attribute">checktype</span>=negotiate</span><br><span class="line"><span class="attribute">checkport</span>=80</span><br><span class="line"><span class="attribute">request</span>=<span class="string">"index.html"</span></span><br><span class="line"><span class="attribute">receive</span>=“Test Ldirectord<span class="string">"</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> linux进阶 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 企业级应用 </tag>
            
            <tag> 负载均衡 </tag>
            
            <tag> 调度算法 </tag>
            
            <tag> 集群 </tag>
            
            <tag> LVS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>源码编译Apache和PHP实现lamp架构</title>
      <link href="//blog/dcaccc5a.html"/>
      <url>//blog/dcaccc5a.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;所谓LAMP架构，是指：<br>&emsp;&emsp;&emsp;&emsp;<strong>L</strong>：linux<br>&emsp;&emsp;&emsp;&emsp;<strong>A</strong>：apache (httpd)<br>&emsp;&emsp;&emsp;&emsp;<strong>M</strong>：mysql, mariadb<br>&emsp;&emsp;&emsp;&emsp;（或M：memcached）<br>&emsp;&emsp;&emsp;&emsp;<strong>P</strong>：php, perl, python<br>&emsp;&emsp;WEB资源类型：<br>&emsp;&emsp;&emsp;&emsp;静态资源：原始形式与响应内容一致，在客户端浏览器执行<br>&emsp;&emsp;&emsp;&emsp;动态资源：原始形式通常为程序文件，需要在服务器端执行之后，将执行结果返回给客户端</p><a id="more"></a><h3 id="LAMP工作原理"><a href="#LAMP工作原理" class="headerlink" title="LAMP工作原理"></a>LAMP工作原理</h3><p><img src="https://img-blog.csdnimg.cn/20191018193028582.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;httpd：接收用户的web请求；静态资源则直接响应；动态资源为php脚本，对此类资源的请求将交由php来运行<br>&emsp;&emsp;php：运行php程序<br>&emsp;&emsp;MariaDB：数据管理系统</p><h3 id="httpd与php结合的方式"><a href="#httpd与php结合的方式" class="headerlink" title="httpd与php结合的方式"></a>httpd与php结合的方式</h3><p>1、modules (将php编译成为httpd的模块,默认方式)<br> MPM:<br>prefork: libphp5.so<br>event, worker: libphp5-zts.so<br>2、FastCGI</p><p>&emsp;&emsp;本文将分别展示以模块方式以及FCGI的方式，源码编译apache、php、mariadb来实现LAMP架构。</p><h3 id="编译部署"><a href="#编译部署" class="headerlink" title="编译部署"></a>编译部署</h3><h4 id="编译安装mariadb"><a href="#编译安装mariadb" class="headerlink" title="编译安装mariadb"></a>编译安装mariadb</h4><p>&emsp;&emsp;之前曾<a href="https://hewanyue.com/blog/b124800c.html">详细介绍</a>，这里就不再赘述。</p><h4 id="编译安装apache"><a href="#编译安装apache" class="headerlink" title="编译安装apache"></a>编译安装apache</h4><p>&emsp;&emsp;先安装依赖包<code>yum install gcc pcre-devel openssl-devel expat-devel autoconf libtool gcc-c++</code><br>&emsp;&emsp;下载apache源码包以及apr包</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget <span class="string">https:</span><span class="comment">//archive.apache.org/dist/httpd/httpd-2.4.39.tar.gz</span></span><br><span class="line">wget <span class="string">https:</span><span class="comment">//www-us.apache.org/dist//apr/apr-1.7.0.tar.gz</span></span><br><span class="line">wget <span class="string">https:</span><span class="comment">//www-us.apache.org/dist//apr/apr-util-1.6.1.tar.gz</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;替换apr、apr-util文件</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar xf apr<span class="number">-1.7</span><span class="number">.0</span>.tar.gz -C httpd<span class="number">-2.4</span><span class="number">.39</span>/srclib/ </span><br><span class="line">tar xf apr-util<span class="number">-1.6</span><span class="number">.1</span>.tar.gz -C httpd<span class="number">-2.4</span><span class="number">.39</span>/srclib/ </span><br><span class="line">cd httpd<span class="number">-2.4</span><span class="number">.39</span>/srclib/</span><br><span class="line">mv apr<span class="number">-1.7</span><span class="number">.0</span> apr</span><br><span class="line">mv apr-util<span class="number">-1.6</span><span class="number">.1</span> apr-util</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;编译安装</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/data/httpd24 <span class="string">\</span></span><br><span class="line">--enable-so <span class="string">\</span></span><br><span class="line">--enable-ssl <span class="string">\</span></span><br><span class="line">--enable-cgi <span class="string">\</span></span><br><span class="line">--enable-rewrite <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-zlib <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-pcre <span class="string">\</span></span><br><span class="line">--enable-modules=most <span class="string">\</span></span><br><span class="line">--enable-mpms-shared=all <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-mpm=prefork <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-included-apr</span><br></pre></td></tr></table></figure><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">make</span> -j <span class="number">4</span> &amp;&amp; <span class="built_in">make</span> install</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;写入PATH变量,并生效</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vim</span> /etc/<span class="keyword">profile</span>.d/httpd.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">export</span> PATH=/data/httpd24/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">source</span> /etc/<span class="keyword">profile</span>.d/httpd.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure><h4 id="编译安装php"><a href="#编译安装php" class="headerlink" title="编译安装php"></a>编译安装php</h4><h5 id="模块方式"><a href="#模块方式" class="headerlink" title="模块方式"></a>模块方式</h5><p>&emsp;&emsp;先安装依赖包</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> -y libxml2-devel</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;在官网下载php最新版php-7.3.10.tar.xz包并解压</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="comment">//www.php.net/distributions/php-7.3.10.tar.xz</span></span><br><span class="line">tar xvf php-<span class="number">7.3</span>.<span class="number">10</span><span class="selector-class">.tar</span><span class="selector-class">.xz</span></span><br><span class="line">cd php-<span class="number">7.3</span>.<span class="number">10</span><span class="selector-class">.tar</span><span class="selector-class">.xz</span></span><br></pre></td></tr></table></figure><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.<span class="regexp">/configure --prefix=/data/php/</span> <span class="string">\</span></span><br><span class="line">--enable-mysqlnd <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-mysqli=mysqlnd <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-openssl <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-pdo-mysql=mysqlnd <span class="string">\</span></span><br><span class="line">--enable-mbstring <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-freetype-dir <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-jpeg-dir <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-png-dir <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-zlib <span class="string">\</span></span><br><span class="line">--enable-xml <span class="string">\</span></span><br><span class="line">--enable-sockets <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-apxs2=/data/httpd24/bin/apxs <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-config-file-path=/data/php/etc <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-config-file-scan-dir=/data/php/etc/php.d <span class="string">\</span></span><br><span class="line">--enable-maintainer-zts <span class="string">\</span></span><br><span class="line">--disable-fileinfo</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;PS:如果apache是之前yum装的，很有可能没有apxs文件，只需要<code>dnf install httpd-devel -y</code>命令安装httpd-devel包，即可生成/usr/bin/apxs工具，如果是以前编译安装的，也要改为正确apxs2对应路径。<br>&emsp;&emsp;编译安装</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">make</span> -j <span class="number">4</span> &amp;&amp; <span class="built_in">make</span> install</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;复制配置文件模版至配置文件目录</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp php.ini-production <span class="regexp">/data/</span>php<span class="regexp">/etc/</span>php.ini</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;修改apache配置文件,设置默认php页面，增加PHP模块</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vim</span> /etc/httpd/<span class="keyword">conf</span>/httpd.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&amp;ltIfModule</span> <span class="string">dir_module&amp;gt</span></span><br><span class="line">    <span class="string">DirectoryIndex</span> <span class="string">index.php</span> <span class="string">index.html</span>                <span class="comment">#增加php页面</span></span><br><span class="line"><span class="string">&amp;lt/IfModule&amp;gt</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span><span class="meta">---</span></span><br><span class="line"><span class="meta">&amp;ltIfModule</span> <span class="string">mime_module&amp;gt</span></span><br><span class="line"></span><br><span class="line">    <span class="string">AddType</span> <span class="string">application/x-compress</span> <span class="string">.Z</span></span><br><span class="line">    <span class="string">AddType</span> <span class="string">application/x-gzip</span> <span class="string">.gz</span> <span class="string">.tgz</span></span><br><span class="line">    </span><br><span class="line">    <span class="string">AddType</span> <span class="string">application/x-httpd-php</span> <span class="string">.php</span>                <span class="comment">#增加模块</span></span><br><span class="line">    <span class="string">AddType</span> <span class="string">application/x-httpd-php-source</span> <span class="string">.phps</span>        <span class="comment">#增加模块</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&amp;lt/IfModule&amp;gt</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;添加php测试页</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim <span class="regexp">/data/</span>httpd24<span class="regexp">/htdocs/i</span>ndex.php</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt?php</span><br><span class="line">phpinfo() </span><br><span class="line">?&amp;gt</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;重启apache服务</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apachectl restart</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;访问php测试页进行测试,便可看到php设置已经成功</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">curl HOSTIP</span></span><br></pre></td></tr></table></figure><h5 id="FCGI方式"><a href="#FCGI方式" class="headerlink" title="FCGI方式"></a>FCGI方式</h5><p>&emsp;&emsp;也要先安装依赖包</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install </span>libxml2-devel <span class="keyword">bzip2-devel </span>libmcrypt-devel</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;同样下载tar包，解压并进入编译目录<br>&emsp;&emsp;开始编译安装</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/data/php <span class="string">\</span></span><br><span class="line">--enable-mysqlnd <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-mysqli=mysqlnd <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-pdo-mysql=mysqlnd <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-openssl <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-freetype-dir <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-jpeg-dir <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-png-dir <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-zlib <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-libxml-dir=/usr <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-config-file-path=/etc <span class="string">\</span></span><br><span class="line">--<span class="keyword">with</span>-config-file-scan-dir=/etc/php.d <span class="string">\</span></span><br><span class="line">--enable-mbstring <span class="string">\</span></span><br><span class="line">--enable-xml <span class="string">\</span></span><br><span class="line">--enable-sockets <span class="string">\</span></span><br><span class="line">--enable-fpm <span class="string">\</span></span><br><span class="line">--enable-maintainer-zts <span class="string">\</span></span><br><span class="line">--disable-fileinfo</span><br></pre></td></tr></table></figure><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">make</span> -j <span class="number">4</span> &amp;&amp; <span class="built_in">make</span> install</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;复制模版文件当配置文件</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /data/php<span class="number">-7.3</span><span class="number">.10</span>/php.ini-production  /etc/php.ini</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;因为php-fpm模式相当于单独的一个服务，将服务配置文件放至/usr/lib/systemd/system/目录</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /data/php-<span class="number">7.3</span>.<span class="number">10</span>/sapi/fpm/php-fpm.service /usr/<span class="class"><span class="keyword">lib</span>/<span class="title">systemd</span>/<span class="title">system</span>/</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;生成fpm配置文件，并修改进程属主属组为apache</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /data/php/etc</span><br><span class="line">cp php-fpm<span class="selector-class">.conf</span><span class="selector-class">.default</span>  php-fpm.conf</span><br><span class="line">cd php-fpm.d/</span><br><span class="line">cp www<span class="selector-class">.conf</span><span class="selector-class">.default</span> www.conf</span><br></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim www.conf</span><br><span class="line"></span><br><span class="line">user apache</span><br><span class="line">group apache</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;加载配置文件并启动进程</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="keyword">enable</span> <span class="comment">--now  php-fpm.service</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;修改配置httpd.conf 支持php-fpm<br>&emsp;&emsp;取消下面两行的注释</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute"><span class="nomarkup">LoadModule</span></span> proxy_module modules/mod_proxy.so</span><br><span class="line"><span class="attribute"><span class="nomarkup">LoadModule</span></span> proxy_fcgi_module modules/mod_proxy_fcgi.so</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;修改下面行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&amp;ltIfModule dir_module&amp;gt</span><br><span class="line">DirectoryIndex index.php index.html</span><br><span class="line">&amp;lt/IfModule&amp;gt</span><br><span class="line">加下面四行</span><br><span class="line">AddType application/x-httpd-php .php</span><br><span class="line">AddType application/x-httpd-php-source .phps</span><br><span class="line">ProxyRequests Off</span><br><span class="line">ProxyPassMatch ^/(.*\.php)$ fcgi://127.0.0.1:9000/data/httpd24/htdocs/$1</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;也可修改php监听端口9000 为socket路径，下面代理转发命令为为</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ProxyRequests Off</span><br><span class="line">ProxyPassMatch ^<span class="regexp">/(.*\.php)$ unix:/</span>var<span class="regexp">/run/</span>php-fpm<span class="regexp">/php-fpm.sock|fcgi:/</span><span class="regexp">/localhost/</span>data<span class="regexp">/httpd24/</span>htdocs<span class="regexp">/$1</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;重启apache服务</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apachectl restart</span></span><br></pre></td></tr></table></figure><p>至此，php页面就可以正常访问了</p>]]></content>
      
      
      <categories>
          
          <category> linux进阶 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 编译安装 </tag>
            
            <tag> LAMP </tag>
            
            <tag> 总结 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LAMP架构实现PowerDNS</title>
      <link href="//blog/57d66c4.html"/>
      <url>//blog/57d66c4.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;PowerDNS 是一个跨平台的开源DNS服务组件，它是高性能的域名服务器，除了支持普通的BIND配置文件，PowerDNS还可以从MySQL,Oracle,PostgreSQL等的数据库读取数据。PowerDNS安装了Poweradmin(基于php实现)，能实现Web管理DNS记录，非常方便。<br>&emsp;&emsp;ps:本次过程是在centos7系统上完成。</p><a id="more"></a><h3 id="配置安装pdns"><a href="#配置安装pdns" class="headerlink" title="配置安装pdns"></a>配置安装pdns</h3><h4 id="安装pdns包"><a href="#安装pdns包" class="headerlink" title="安装pdns包"></a>安装pdns包</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y pdns pdns-backend-mysql</span><br></pre></td></tr></table></figure><h4 id="创建pdns数据库"><a href="#创建pdns数据库" class="headerlink" title="创建pdns数据库"></a>创建pdns数据库</h4><p>&emsp;&emsp;搭建好mariadb数据库了，启动数据库服务，参考官方文档创建powerdns数据库及其中的表，参看下面文档 <a href="https://doc.powerdns.com/md/authoritative/backend-generic-mysql/" rel="noopener" target="_blank">https://doc.powerdns.com/md/authoritative/backend-generic-mysql/</a><br><code>vim powerdns.sql</code></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> powerdns;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">ON</span> powerdns.* <span class="keyword">TO</span> <span class="string">'powerdns'</span>@<span class="string">'127.0.0.1'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'powerdns'</span>;</span><br><span class="line"><span class="keyword">use</span> powerdns;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> domains (</span><br><span class="line">  <span class="keyword">id</span>                    <span class="built_in">INT</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="keyword">name</span>                  <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="keyword">master</span>                <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  last_check            <span class="built_in">INT</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="keyword">type</span>                  <span class="built_in">VARCHAR</span>(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  notified_serial       <span class="built_in">INT</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="keyword">account</span>               <span class="built_in">VARCHAR</span>(<span class="number">40</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>)</span><br><span class="line">) <span class="keyword">Engine</span>=<span class="keyword">InnoDB</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> name_index <span class="keyword">ON</span> domains(<span class="keyword">name</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">records</span> (</span><br><span class="line">  <span class="keyword">id</span>                    <span class="built_in">BIGINT</span> AUTO_INCREMENT,</span><br><span class="line">  domain_id             <span class="built_in">INT</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="keyword">name</span>                  <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="keyword">type</span>                  <span class="built_in">VARCHAR</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="keyword">content</span>               <span class="built_in">VARCHAR</span>(<span class="number">64000</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  ttl                   <span class="built_in">INT</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  prio                  <span class="built_in">INT</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  change_date           <span class="built_in">INT</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  disabled              <span class="built_in">TINYINT</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">  ordername             <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="built_in">BINARY</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  auth                  <span class="built_in">TINYINT</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="number">1</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>)</span><br><span class="line">) <span class="keyword">Engine</span>=<span class="keyword">InnoDB</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> nametype_index <span class="keyword">ON</span> <span class="keyword">records</span>(<span class="keyword">name</span>,<span class="keyword">type</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> domain_id <span class="keyword">ON</span> <span class="keyword">records</span>(domain_id);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> recordorder <span class="keyword">ON</span> <span class="keyword">records</span> (domain_id, ordername);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> supermasters (</span><br><span class="line">  ip                    <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  nameserver            <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="keyword">account</span>               <span class="built_in">VARCHAR</span>(<span class="number">40</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (ip, nameserver)</span><br><span class="line">) <span class="keyword">Engine</span>=<span class="keyword">InnoDB</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> comments (</span><br><span class="line">  <span class="keyword">id</span>                    <span class="built_in">INT</span> AUTO_INCREMENT,</span><br><span class="line">  domain_id             <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="keyword">name</span>                  <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="keyword">type</span>                  <span class="built_in">VARCHAR</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  modified_at           <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="keyword">account</span>               <span class="built_in">VARCHAR</span>(<span class="number">40</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="keyword">comment</span>               <span class="built_in">VARCHAR</span>(<span class="number">64000</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>)</span><br><span class="line">) <span class="keyword">Engine</span>=<span class="keyword">InnoDB</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> comments_domain_id_idx <span class="keyword">ON</span> comments (domain_id);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> comments_name_type_idx <span class="keyword">ON</span> comments (<span class="keyword">name</span>, <span class="keyword">type</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> comments_order_idx <span class="keyword">ON</span> comments (domain_id, modified_at);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> domainmetadata (</span><br><span class="line">  <span class="keyword">id</span>                    <span class="built_in">INT</span> AUTO_INCREMENT,</span><br><span class="line">  domain_id             <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  kind                  <span class="built_in">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">  <span class="keyword">content</span>               <span class="built_in">TEXT</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>)</span><br><span class="line">) <span class="keyword">Engine</span>=<span class="keyword">InnoDB</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> domainmetadata_idx <span class="keyword">ON</span> domainmetadata (domain_id, kind);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> cryptokeys (</span><br><span class="line">  <span class="keyword">id</span>                    <span class="built_in">INT</span> AUTO_INCREMENT,</span><br><span class="line">  domain_id             <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  flags                 <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  active                <span class="built_in">BOOL</span>,</span><br><span class="line">  <span class="keyword">content</span>               <span class="built_in">TEXT</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span>(<span class="keyword">id</span>)</span><br><span class="line">) <span class="keyword">Engine</span>=<span class="keyword">InnoDB</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> domainidindex <span class="keyword">ON</span> cryptokeys(domain_id);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tsigkeys (</span><br><span class="line">  <span class="keyword">id</span>                    <span class="built_in">INT</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="keyword">name</span>                  <span class="built_in">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">  algorithm             <span class="built_in">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">  secret                <span class="built_in">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>)</span><br><span class="line">) <span class="keyword">Engine</span>=<span class="keyword">InnoDB</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> namealgoindex <span class="keyword">ON</span> tsigkeys(<span class="keyword">name</span>, algorithm);</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;以上参数设置为官方文档默认值，如果参数数值大小不对，可自行修改调整。数据库名、主机名、用户名及密码自行修改。<br>&emsp;&emsp;导入SQL语句<code>mysql -uroot -ppassword &lt; power.sql</code>，此时powerdns数据库就创建好了。</p><h4 id="配置PowerDNS使用mariadb作为后台数据存储"><a href="#配置PowerDNS使用mariadb作为后台数据存储" class="headerlink" title="配置PowerDNS使用mariadb作为后台数据存储"></a>配置PowerDNS使用mariadb作为后台数据存储</h4><p>可参见官方文档的设置参数：</p><blockquote><p><strong>gmysql-host</strong><br>Host (ip address) to connect to. Mutually exclusive with gmysql-socket.<br>WARNING: When specified as a hostname a chicken/egg situation might arise where the database is needed to resolve the IP address of the database. It is best to supply an IP address of the database here.<br><strong>gmysql-port</strong><br>The port to connect to on gmysql-host. Default: 3306<br><strong>gmysql-socket</strong><br>Connect to the UNIX socket at this path. Mutually exclusive with gmysql-host.<br><strong>gmysql-dbname</strong><br>Name of the database to connect to. Default: “pdns”.<br><strong>gmysql-user</strong><br>User to connect as. Default: “powerdns”.<br><strong>gmysql-group</strong><br>Group to connect as. Default: “client”.<br><strong>gmysql-password</strong><br>The password to for gmysql-user.<br><strong>gmysql-dnssec</strong><br>Enable DNSSEC processing for this backend. Default=no.<br><strong>gmysql-innodb-read-committed</strong><br>Use the InnoDB READ-COMMITTED transaction isolation level.<br>Default=yes.<br><strong>gmysql-timeout</strong><br>The timeout in seconds for each attempt to read from, or write to the server. A value of 0 will disable the timeout. Default: 10</p></blockquote><p>&emsp;&emsp;官方文档第一条写的很清楚，gmysql-localhost那一项最好填ip，或者你的hostname为localhost也可以解析成127.0.0.1，所以虽然我是本机数据库，也选择直接使用127.0.0.1（我试了localhost，提示无法连接数据库，应该是因为我改了hostname导致没法解析成127.0.0.1了，干脆直接用ip就成功连接了）</p><p><code>vim /etc/pdns/pdns.conf</code><br>&emsp;&emsp;用/搜索到”launch=”将值修改为gmysql，并在下面添加mysql的相关信息设置：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">launch</span>=gmysql</span><br><span class="line"><span class="attr">gmysql-host</span>=<span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">gmysql-port</span>=<span class="number">3306</span></span><br><span class="line"><span class="attr">gmysql-dbname</span>=powerdns</span><br><span class="line"><span class="attr">gmysql-user</span>=powerdns</span><br><span class="line"><span class="attr">gmysql-password</span>=powerdns</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;好了pdns服务就配置好了，启动服务.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start pdns</span><br><span class="line">systemctl enable pdns</span><br></pre></td></tr></table></figure><h3 id="搭建LAP架构用web界面实现pdns服务"><a href="#搭建LAP架构用web界面实现pdns服务" class="headerlink" title="搭建LAP架构用web界面实现pdns服务"></a>搭建LAP架构用web界面实现pdns服务</h3><h4 id="安装httpd和php相关包并启动httpd服务"><a href="#安装httpd和php相关包并启动httpd服务" class="headerlink" title="安装httpd和php相关包并启动httpd服务"></a>安装httpd和php相关包并启动httpd服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install httpd php php-devel php-gd php-mcrypt php-imap php-ldap php-mysql php-odbc php-pear php-xml php-xmlrpc php-mbstring php-mcrypt php-mhash gettext</span><br><span class="line">systemctl start httpd</span><br><span class="line">systemctl enable httpd</span><br></pre></td></tr></table></figure><h4 id="下载PowerAdmin程序，并解压缩到相应目录"><a href="#下载PowerAdmin程序，并解压缩到相应目录" class="headerlink" title="下载PowerAdmin程序，并解压缩到相应目录"></a>下载PowerAdmin程序，并解压缩到相应目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://downloads.sourceforge.net/project/poweradmin/poweradmin-2.1.7.tgz</span><br><span class="line">tar xvf poweradmin-2.1.7.tgz -C /var/www/html</span><br><span class="line">cd /var/www/html</span><br><span class="line">mv poweradmin-2.1.7 poweradmin</span><br></pre></td></tr></table></figure><h4 id="登陆web界面安装PowerAdmin"><a href="#登陆web界面安装PowerAdmin" class="headerlink" title="登陆web界面安装PowerAdmin"></a>登陆web界面安装PowerAdmin</h4><p>&emsp;&emsp;浏览器输入<a href="http://powerdns服务器IP/poweradmin/install/" rel="noopener" target="_blank">http://powerdns服务器IP/poweradmin/install/</a> 进入安装向导界面。<br><img src="https://img-blog.csdnimg.cn/20191014132102422.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;1.选择语言<br><img src="https://img-blog.csdnimg.cn/20191014132109107.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;2. 确认powerdns服务已连接好数据库，如果之前已经有相关记录，本次安装将会清除之前的数据，时候确定安装。<br><img src="https://img-blog.csdnimg.cn/20191014132114800.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;3.填写数据库相关信息<br><img src="https://img-blog.csdnimg.cn/20191014132120662.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;4.为Poweradmin创建一个受限用户<br>&emsp;&emsp;说明：<br>&emsp;&emsp;&emsp;&emsp; Username：PowerAdmin用户名<br>&emsp;&emsp;&emsp;&emsp; Password：上述用户的密码<br>&emsp;&emsp;&emsp;&emsp; Hostmaster：当创建SOA记录指定默认主机管理员<br>&emsp;&emsp;&emsp;&emsp; Primary nameserver：主域名服务器<br>&emsp;&emsp;&emsp;&emsp; Secondary namesever:辅域名服务器<br><img src="https://img-blog.csdnimg.cn/20191014132126802.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;5.按照下面页面说明，在数据库中创建用户并授权</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, <span class="keyword">INSERT</span>, <span class="keyword">UPDATE</span>, <span class="keyword">DELETE</span></span><br><span class="line"><span class="keyword">ON</span> powerdns.*</span><br><span class="line"><span class="keyword">TO</span> <span class="string">'powerdns'</span>@<span class="string">'127.0.0.1'</span></span><br><span class="line"><span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'powerdns'</span>;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20191014132137177.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;6.按下面页面说明，创建config.in.php文件内容<br>&emsp;&emsp;<code>vim /var/www/html/poweradmin/inc/config.inc.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt?php</span><br><span class="line"></span><br><span class="line">$db_host                = <span class="string">'127.0.0.1'</span>;</span><br><span class="line">$db_user                = <span class="string">'powerdns'</span>;</span><br><span class="line">$db_pass                = <span class="string">'powerdns'</span>;</span><br><span class="line">$db_name                = <span class="string">'powerdns'</span>;</span><br><span class="line">$db_type                = <span class="string">'mysql'</span>;</span><br><span class="line">$db_layer               = <span class="string">'PDO'</span>;</span><br><span class="line"></span><br><span class="line">$session_key            = <span class="string">'Kae&#125;LCI!&amp;^Ew6(5eyd6B~!SVHRHhu+t(svkGqb1S&#123;C0&#125;TP'</span>;</span><br><span class="line"></span><br><span class="line">$iface_lang             = <span class="string">'en_EN'</span>;</span><br><span class="line"></span><br><span class="line">$dns_hostmaster         = <span class="string">'powerdns'</span>;</span><br><span class="line">$dns_ns1                = <span class="string">'192.168.32.7'</span>;</span><br><span class="line">$dns_ns2                = <span class="string">'192.168.32.7'</span>;`</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20191014135839135.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;7.设置完成，删除install目录<br>&emsp;&emsp;<code>\rm -rf install</code><br><img src="https://img-blog.csdnimg.cn/20191014132142570.png" alt="在这里插入图片描述"><br>&emsp;&emsp;如果不进行第6、7步就会报错，如上图所示。<br><img src="https://img-blog.csdnimg.cn/2019101413425982.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;8.输入用户名密码登陆<br><img src="https://img-blog.csdnimg.cn/20191014134306107.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;9.进入主页面。至此PowerDNS在web上展示就实现了~</p>]]></content>
      
      
      <categories>
          
          <category> linux进阶 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> LAMP </tag>
            
            <tag> 经验分享 </tag>
            
            <tag> PowerDNS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>yum/dnf 安装mariadb10.4.8（最新版）</title>
      <link href="//blog/72c5296a.html"/>
      <url>//blog/72c5296a.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;近期想在新出的CentOS8上安装一下最新版的mariadb10.4.8，不过又嫌源码编译太麻烦费时间。就想去找找有没有yum源可用。<br>&emsp;&emsp;果然官网上已经放出了yum安装的repo源了，也支持到CentOS8了——<a href="http://mirror.aarnet.edu.au/pub/MariaDB//mariadb-10.4.8/yum/centos/8/x86_64/" rel="noopener" target="_blank">http://mirror.aarnet.edu.au/pub/MariaDB//mariadb-10.4.8/yum/centos/8/x86_64/</a><br>&emsp;&emsp;那就手动加一个yum源吧。<br>&emsp;&emsp;<code>vim /etc/yum.repos.d/mariadb1048.repo</code></p><a id="more"></a><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mariadb10.4.8]</span></span><br><span class="line"><span class="attr">name</span>=Mariadb10.<span class="number">4.8</span> RPM repository for  Linux <span class="variable">$releasever</span> - <span class="variable">$basearch</span></span><br><span class="line"><span class="attr">baseurl</span>=http://mirror.aarnet.edu.au/pub/MariaDB//mariadb-<span class="number">10.4</span>.<span class="number">8</span>/yum/centos/<span class="variable">$releasever</span>/<span class="variable">$basearch</span>/</span><br><span class="line"><span class="attr">enabled</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">gpgcheck</span>=<span class="number">0</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;加好yum源后，执行安装<code>dnf install mariadb-server -y</code></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">aliyun                                                                                               <span class="number">4.7</span> kB/s | <span class="number">5.3</span> kB     <span class="number">00</span>:<span class="number">01</span>    </span><br><span class="line">cdrom-AppStream                                                                                      <span class="number">4.1</span> MB/s | <span class="number">4.3</span> kB     <span class="number">00</span>:<span class="number">00</span>    </span><br><span class="line">cdrom-base                                                                                           <span class="number">3.8</span> MB/s | <span class="number">3.9</span> kB     <span class="number">00</span>:<span class="number">00</span>    </span><br><span class="line">Mariadb10<span class="number">.4</span><span class="number">.8</span> RPM repository <span class="keyword">for</span>  Linux <span class="number">8</span> - x86_64                                                   <span class="number">1.8</span> kB/s | <span class="number">2.9</span> kB     <span class="number">00</span>:<span class="number">01</span>    </span><br><span class="line">Dependencies resolved.</span><br><span class="line">=====================================================================================================================================</span><br><span class="line"> Package                          Arch             Version                                           Repository                 Size</span><br><span class="line">=====================================================================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> mariadb-server                   x86_64           <span class="number">3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed            cdrom-AppStream            <span class="number">16</span> M</span><br><span class="line">Installing dependencies:</span><br><span class="line"> mariadb                          x86_64           <span class="number">3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed            cdrom-AppStream           <span class="number">6.2</span> M</span><br><span class="line"> mariadb-common                   x86_64           <span class="number">3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed            cdrom-AppStream            <span class="number">62</span> k</span><br><span class="line"> mariadb-connector-c              x86_64           <span class="number">3.0</span><span class="number">.7</span><span class="number">-1.</span>el8                                       cdrom-AppStream           <span class="number">148</span> k</span><br><span class="line"> mariadb-errmsg                   x86_64           <span class="number">3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed            cdrom-AppStream           <span class="number">232</span> k</span><br><span class="line"> perl-DBD-MySQL                   x86_64           <span class="number">4.046</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">72</span>+<span class="number">668237</span>d8                cdrom-AppStream           <span class="number">156</span> k</span><br><span class="line"> perl-DBI                         x86_64           <span class="number">1.641</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">66</span>+fe1eca09                cdrom-AppStream           <span class="number">740</span> k</span><br><span class="line"> perl-Digest                      noarch           <span class="number">1.17</span><span class="number">-395.</span>el8                                      cdrom-AppStream            <span class="number">27</span> k</span><br><span class="line"> perl-Digest-MD5                  x86_64           <span class="number">2.55</span><span class="number">-396.</span>el8                                      cdrom-AppStream            <span class="number">37</span> k</span><br><span class="line"> perl-Net-SSLeay                  x86_64           <span class="number">1.85</span><span class="number">-6.</span>el8                                        cdrom-AppStream           <span class="number">358</span> k</span><br><span class="line"> perl-URI                         noarch           <span class="number">1.73</span><span class="number">-3.</span>el8                                        cdrom-AppStream           <span class="number">116</span> k</span><br><span class="line"> perl-libnet                      noarch           <span class="number">3.11</span><span class="number">-3.</span>el8                                        cdrom-AppStream           <span class="number">121</span> k</span><br><span class="line"> perl-Carp                        noarch           <span class="number">1.42</span><span class="number">-396.</span>el8                                      cdrom-base                 <span class="number">30</span> k</span><br><span class="line"> perl-Data-Dumper                 x86_64           <span class="number">2.167</span><span class="number">-399.</span>el8                                     cdrom-base                 <span class="number">58</span> k</span><br><span class="line"> perl-Encode                      x86_64           <span class="number">4</span>:<span class="number">2.97</span><span class="number">-3.</span>el8                                      cdrom-base                <span class="number">1.5</span> M</span><br><span class="line"> perl-Errno                       x86_64           <span class="number">1.28</span><span class="number">-416.</span>el8                                      cdrom-base                 <span class="number">76</span> k</span><br><span class="line"> perl-Exporter                    noarch           <span class="number">5.72</span><span class="number">-396.</span>el8                                      cdrom-base                 <span class="number">34</span> k</span><br><span class="line"> perl-File-Path                   noarch           <span class="number">2.15</span><span class="number">-2.</span>el8                                        cdrom-base                 <span class="number">38</span> k</span><br><span class="line"> perl-File-Temp                   noarch           <span class="number">0.230</span><span class="number">.600</span><span class="number">-1.</span>el8                                   cdrom-base                 <span class="number">63</span> k</span><br><span class="line"> perl-Getopt-Long                 noarch           <span class="number">1</span>:<span class="number">2.50</span><span class="number">-4.</span>el8                                      cdrom-base                 <span class="number">63</span> k</span><br><span class="line"> perl-HTTP-Tiny                   noarch           <span class="number">0.074</span><span class="number">-1.</span>el8                                       cdrom-base                 <span class="number">58</span> k</span><br><span class="line"> perl-IO                          x86_64           <span class="number">1.38</span><span class="number">-416.</span>el8                                      cdrom-base                <span class="number">141</span> k</span><br><span class="line"> perl-MIME-Base64                 x86_64           <span class="number">3.15</span><span class="number">-396.</span>el8                                      cdrom-base                 <span class="number">31</span> k</span><br><span class="line"> perl-Math-BigInt                 noarch           <span class="number">1</span>:<span class="number">1.9998</span><span class="number">.11</span><span class="number">-5.</span>el8                                 cdrom-base                <span class="number">195</span> k</span><br><span class="line"> perl-Math-Complex                noarch           <span class="number">1.59</span><span class="number">-416.</span>el8                                      cdrom-base                <span class="number">108</span> k</span><br><span class="line"> perl-PathTools                   x86_64           <span class="number">3.74</span><span class="number">-1.</span>el8                                        cdrom-base                 <span class="number">90</span> k</span><br><span class="line"> perl-Pod-Escapes                 noarch           <span class="number">1</span>:<span class="number">1.07</span><span class="number">-395.</span>el8                                    cdrom-base                 <span class="number">20</span> k</span><br><span class="line"> perl-Pod-Perldoc                 noarch           <span class="number">3.28</span><span class="number">-396.</span>el8                                      cdrom-base                 <span class="number">86</span> k</span><br><span class="line"> perl-Pod-Simple                  noarch           <span class="number">1</span>:<span class="number">3.35</span><span class="number">-395.</span>el8                                    cdrom-base                <span class="number">213</span> k</span><br><span class="line"> perl-Pod-Usage                   noarch           <span class="number">4</span>:<span class="number">1.69</span><span class="number">-395.</span>el8                                    cdrom-base                 <span class="number">34</span> k</span><br><span class="line"> perl-Scalar-List-Utils           x86_64           <span class="number">3</span>:<span class="number">1.49</span><span class="number">-2.</span>el8                                      cdrom-base                 <span class="number">68</span> k</span><br><span class="line"> perl-Socket                      x86_64           <span class="number">4</span>:<span class="number">2.027</span><span class="number">-2.</span>el8                                     cdrom-base                 <span class="number">59</span> k</span><br><span class="line"> perl-Storable                    x86_64           <span class="number">1</span>:<span class="number">3.11</span><span class="number">-3.</span>el8                                      cdrom-base                 <span class="number">98</span> k</span><br><span class="line"> perl-Term-ANSIColor              noarch           <span class="number">4.06</span><span class="number">-396.</span>el8                                      cdrom-base                 <span class="number">46</span> k</span><br><span class="line"> perl-Term-Cap                    noarch           <span class="number">1.17</span><span class="number">-395.</span>el8                                      cdrom-base                 <span class="number">23</span> k</span><br><span class="line"> perl-Text-ParseWords             noarch           <span class="number">3.30</span><span class="number">-395.</span>el8                                      cdrom-base                 <span class="number">18</span> k</span><br><span class="line"> perl-Text-Tabs+Wrap              noarch           <span class="number">2013.0523</span><span class="number">-395.</span>el8                                 cdrom-base                 <span class="number">24</span> k</span><br><span class="line"> perl-Time-Local                  noarch           <span class="number">1</span>:<span class="number">1.280</span><span class="number">-1.</span>el8                                     cdrom-base                 <span class="number">34</span> k</span><br><span class="line"> perl-Unicode-Normalize           x86_64           <span class="number">1.25</span><span class="number">-396.</span>el8                                      cdrom-base                 <span class="number">82</span> k</span><br><span class="line"> perl-constant                    noarch           <span class="number">1.33</span><span class="number">-396.</span>el8                                      cdrom-base                 <span class="number">25</span> k</span><br><span class="line"> perl-<span class="built_in">int</span>erpreter                 x86_64           <span class="number">4</span>:<span class="number">5.26</span><span class="number">.3</span><span class="number">-416.</span>el8                                  cdrom-base                <span class="number">6.3</span> M</span><br><span class="line"> perl-libs                        x86_64           <span class="number">4</span>:<span class="number">5.26</span><span class="number">.3</span><span class="number">-416.</span>el8                                  cdrom-base                <span class="number">1.6</span> M</span><br><span class="line"> perl-macros                      x86_64           <span class="number">4</span>:<span class="number">5.26</span><span class="number">.3</span><span class="number">-416.</span>el8                                  cdrom-base                 <span class="number">72</span> k</span><br><span class="line"> perl-parent                      noarch           <span class="number">1</span>:<span class="number">0.237</span><span class="number">-1.</span>el8                                     cdrom-base                 <span class="number">20</span> k</span><br><span class="line"> perl-podlators                   noarch           <span class="number">4.11</span><span class="number">-1.</span>el8                                        cdrom-base                <span class="number">118</span> k</span><br><span class="line"> perl-threads                     x86_64           <span class="number">1</span>:<span class="number">2.21</span><span class="number">-2.</span>el8                                      cdrom-base                 <span class="number">61</span> k</span><br><span class="line"> perl-threads-<span class="keyword">shared</span>              x86_64           <span class="number">1.58</span><span class="number">-2.</span>el8                                        cdrom-base                 <span class="number">48</span> k</span><br><span class="line"> psmisc                           x86_64           <span class="number">23.1</span><span class="number">-3.</span>el8                                        cdrom-base                <span class="number">151</span> k</span><br><span class="line"> MariaDB-client                   x86_64           <span class="number">10.4</span><span class="number">.8</span><span class="number">-1.</span>el8                                      mariadb10<span class="number">.4</span><span class="number">.8</span>              <span class="number">12</span> M</span><br><span class="line"> MariaDB-common                   x86_64           <span class="number">10.4</span><span class="number">.8</span><span class="number">-1.</span>el8                                      mariadb10<span class="number">.4</span><span class="number">.8</span>              <span class="number">87</span> k</span><br><span class="line">Installing weak dependencies:</span><br><span class="line"> mariadb-backup                   x86_64           <span class="number">3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed            cdrom-AppStream           <span class="number">6.2</span> M</span><br><span class="line"> mariadb-gssapi-server            x86_64           <span class="number">3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed            cdrom-AppStream            <span class="number">49</span> k</span><br><span class="line"> mariadb-server-utils             x86_64           <span class="number">3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed            cdrom-AppStream           <span class="number">1.6</span> M</span><br><span class="line"> perl-IO-Socket-IP                noarch           <span class="number">0.39</span><span class="number">-5.</span>el8                                        cdrom-AppStream            <span class="number">47</span> k</span><br><span class="line"> perl-IO-Socket-SSL               noarch           <span class="number">2.060</span><span class="number">-2.</span>el8                                       cdrom-AppStream           <span class="number">289</span> k</span><br><span class="line"> perl-Mozilla-CA                  noarch           <span class="number">20160104</span><span class="number">-7.</span>el8                                    cdrom-AppStream            <span class="number">15</span> k</span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">=====================================================================================================================================</span><br><span class="line">Install  <span class="number">56</span> Packages</span><br><span class="line"></span><br><span class="line">Total size: <span class="number">56</span> M</span><br><span class="line">Total download size: <span class="number">12</span> M</span><br><span class="line">Installed size: <span class="number">260</span> M</span><br><span class="line">Is <span class="keyword">this</span> ok [y/N]: y</span><br><span class="line">Downloading Packages:</span><br><span class="line">(<span class="number">1</span>/<span class="number">2</span>): MariaDB-common<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64.rpm                                                         <span class="number">35</span> kB/s |  <span class="number">87</span> kB     <span class="number">00</span>:<span class="number">02</span>    </span><br><span class="line">(<span class="number">2</span>/<span class="number">2</span>): MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64.rpm                                                        <span class="number">195</span> kB/s |  <span class="number">12</span> MB     <span class="number">01</span>:<span class="number">02</span>    </span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">Total                                                                                                <span class="number">197</span> kB/s |  <span class="number">12</span> MB     <span class="number">01</span>:<span class="number">02</span>     </span><br><span class="line">Running transaction check</span><br><span class="line">Transaction check succeeded.</span><br><span class="line">Running transaction test</span><br><span class="line">The downloaded packages were saved <span class="keyword">in</span> cache until the next successful transaction.</span><br><span class="line">You can remove cached packages by executing <span class="string">'dnf clean packages'</span>.</span><br><span class="line">Error: Transaction check error:</span><br><span class="line">  file /usr/bin/msql2mysql conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/bin/mysql conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/bin/mysql_find_rows conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/bin/mysql_plugin conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/bin/mysql_waitpid conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/bin/mysqlaccess conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/bin/mysqladmin conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/bin/mysqlbinlog conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/bin/mysqlcheck conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/bin/mysqldump conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/bin/mysqlimport conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/bin/mysqlshow conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/bin/mysqlslap conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/share/man/man1/msql2mysql<span class="number">.1</span>.gz conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/share/man/man1/mysql<span class="number">.1</span>.gz conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/share/man/man1/mysql_find_rows<span class="number">.1</span>.gz conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/share/man/man1/mysql_plugin<span class="number">.1</span>.gz conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/share/man/man1/mysql_waitpid<span class="number">.1</span>.gz conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/share/man/man1/mysqlaccess<span class="number">.1</span>.gz conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/share/man/man1/mysqladmin<span class="number">.1</span>.gz conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/share/man/man1/mysqlbinlog<span class="number">.1</span>.gz conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/share/man/man1/mysqlcheck<span class="number">.1</span>.gz conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/share/man/man1/mysqldump<span class="number">.1</span>.gz conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/share/man/man1/mysqlimport<span class="number">.1</span>.gz conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/share/man/man1/mysqlshow<span class="number">.1</span>.gz conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  file /usr/share/man/man1/mysqlslap<span class="number">.1</span>.gz conflicts between attempted installs of mariadb<span class="number">-3</span>:<span class="number">10.3</span><span class="number">.11</span><span class="number">-2.</span>module_el8<span class="number">.0</span><span class="number">.0</span>+<span class="number">35</span>+<span class="number">6f</span>2527ed.x86_64 <span class="keyword">and</span> MariaDB-client<span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line"></span><br><span class="line">Error Summary</span><br><span class="line">-------------</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;竟然报错了，说是版本冲突。仔细一看，装的是本地光盘的mariadb-sever 3:10.3.11-2.module_el8.0.0+35+6f2527ed.用的是本地yum光盘yum源，看了下mariadb官网上的软件名称叫MariaDB-server-10.4.8-1.el8.x86_64.rpm，那就重新换成大写，<code>dnf install MariaDB-server</code>.还是报错：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS8 ~]<span class="comment">#yum install MariaDB-server</span></span><br><span class="line">Last metadata expiration <span class="keyword">check</span>: <span class="number">0</span>:<span class="number">05</span>:<span class="number">33</span> ago <span class="keyword">on</span> Sat <span class="number">12</span> <span class="keyword">Oct</span> <span class="number">2019</span> <span class="number">10</span>:<span class="number">19</span>:<span class="number">15</span> AM CST.</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">match</span> <span class="keyword">for</span> argument: MariaDB-<span class="keyword">server</span></span><br><span class="line">  * Maybe you meant: mariadb-<span class="keyword">server</span></span><br><span class="line"><span class="keyword">Error</span>: Unable <span class="keyword">to</span> find a <span class="keyword">match</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;那没办法，把本地光盘yum源禁用掉再试试吧</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS8 ~]<span class="comment">#vim /etc/yum.repos.d/cdrom.repo </span></span><br><span class="line">[root@CentOS8 ~]<span class="comment">#yum install mariadb-server</span></span><br><span class="line">Last metadata expiration <span class="keyword">check</span>: <span class="number">0</span>:<span class="number">13</span>:<span class="number">24</span> ago <span class="keyword">on</span> Sat <span class="number">12</span> <span class="keyword">Oct</span> <span class="number">2019</span> <span class="number">10</span>:<span class="number">34</span>:<span class="number">12</span> AM CST.</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">match</span> <span class="keyword">for</span> argument: mariadb-<span class="keyword">server</span></span><br><span class="line">  * Maybe you meant: MariaDB-<span class="keyword">server</span></span><br><span class="line"><span class="keyword">Error</span>: Unable <span class="keyword">to</span> find a <span class="keyword">match</span></span><br><span class="line">[root@CentOS8 ~]<span class="comment">#yum install MariaDB-server</span></span><br><span class="line"><span class="keyword">Last</span> metadata expiration <span class="keyword">check</span>: <span class="number">0</span>:<span class="number">13</span>:<span class="number">36</span> ago <span class="keyword">on</span> Sat <span class="number">12</span> <span class="keyword">Oct</span> <span class="number">2019</span> <span class="number">10</span>:<span class="number">34</span>:<span class="number">12</span> AM CST.</span><br><span class="line"><span class="keyword">Error</span>: </span><br><span class="line"> Problem: cannot <span class="keyword">install</span> the best candidate <span class="keyword">for</span> the job</span><br><span class="line">  - <span class="keyword">nothing</span> provides rsync needed <span class="keyword">by</span> MariaDB-<span class="keyword">server</span><span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  - <span class="keyword">nothing</span> provides perl(<span class="keyword">strict</span>) needed <span class="keyword">by</span> MariaDB-<span class="keyword">server</span><span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  - <span class="keyword">nothing</span> provides /usr/<span class="keyword">bin</span>/perl needed <span class="keyword">by</span> MariaDB-<span class="keyword">server</span><span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  - <span class="keyword">nothing</span> provides perl(vars) needed <span class="keyword">by</span> MariaDB-<span class="keyword">server</span><span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  - <span class="keyword">nothing</span> provides perl(Getopt::<span class="keyword">Long</span>) needed <span class="keyword">by</span> MariaDB-<span class="keyword">server</span><span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  - <span class="keyword">nothing</span> provides perl(POSIX) needed <span class="keyword">by</span> MariaDB-<span class="keyword">server</span><span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  - <span class="keyword">nothing</span> provides perl(<span class="keyword">File</span>::Basename) needed <span class="keyword">by</span> MariaDB-<span class="keyword">server</span><span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  - <span class="keyword">nothing</span> provides perl(<span class="keyword">File</span>::<span class="keyword">Path</span>) needed <span class="keyword">by</span> MariaDB-<span class="keyword">server</span><span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  - <span class="keyword">nothing</span> provides perl(<span class="keyword">Data</span>::Dumper) needed <span class="keyword">by</span> MariaDB-<span class="keyword">server</span><span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  - <span class="keyword">nothing</span> provides perl(<span class="keyword">File</span>::Temp) needed <span class="keyword">by</span> MariaDB-<span class="keyword">server</span><span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  - <span class="keyword">nothing</span> provides perl(<span class="keyword">File</span>::Copy) needed <span class="keyword">by</span> MariaDB-<span class="keyword">server</span><span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  - <span class="keyword">nothing</span> provides perl(DBI) needed <span class="keyword">by</span> MariaDB-<span class="keyword">server</span><span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  - <span class="keyword">nothing</span> provides perl(<span class="keyword">Sys</span>::Hostname) needed <span class="keyword">by</span> MariaDB-<span class="keyword">server</span><span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">  - <span class="keyword">nothing</span> provides lsof needed <span class="keyword">by</span> MariaDB-<span class="keyword">server</span><span class="number">-10.4</span><span class="number">.8</span><span class="number">-1.</span>el8.x86_64</span><br><span class="line">(try <span class="keyword">to</span> <span class="keyword">add</span> <span class="string">'--skip-broken'</span> <span class="keyword">to</span> <span class="keyword">skip</span> uninstallable packages <span class="keyword">or</span> <span class="string">'--nobest'</span> <span class="keyword">to</span> <span class="keyword">use</span> <span class="keyword">not</span> <span class="keyword">only</span> best candidate packages)</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;这次倒是不能识别小写mariadb，只能识别大写了MariaDB。不过没有了本地光盘yum源，我这是最小安装的系统，也没法安装依赖了啊。这就陷入两难问题了。如果开启本地光盘yum源，无论后跟版本号或是大写都会提示找不到匹配项，小写的话就会去装mariadb-server3XXX版本，不开启本地光盘yum源的话，就没法装所需依赖了。<br>&emsp;&emsp;<strong>突然想起可以直接用包管理工具安装rpm包来解决依赖性的问题，还可以指定要按的主程序包</strong>。那就试试直接看：</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS8 ~]#dnf install http://mirror.aarnet.edu.au/pub/MariaDB//mariadb<span class="string">-10</span>.4.8/yum/centos/8/x86_64/rpms/MariaDB-server<span class="string">-10</span>.4.8<span class="string">-1</span>.el8.x86_64.rpm</span><br><span class="line">Last metadata expiration check: 0:00:25 ago on Sat 12 Oct 2019 10:51:11 AM CST.</span><br><span class="line">MariaDB-server<span class="string">-10</span>.4.8<span class="string">-1</span>.el8.x86_64.rpm                                                               197 kB/s |  26 MB     02:14    </span><br><span class="line">Dependencies resolved.</span><br><span class="line">=====================================================================================================================================</span><br><span class="line"> Package                           Arch              Version                                        Repository                  Size</span><br><span class="line">=====================================================================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> MariaDB-server                    x86_64            10.4.8<span class="string">-1</span>.el8                                   @commandline                26 M</span><br><span class="line">Installing dependencies:</span><br><span class="line"> boost-program-options             x86_64            1.66.0<span class="string">-6</span>.el8                                   cdrom-AppStream            143 k</span><br><span class="line"> perl-DBI                          x86_64            1.641<span class="string">-2</span>.module_el8.0.0<span class="string">+66</span>+fe1eca09             cdrom-AppStream            740 k</span><br><span class="line"> perl-Digest                       noarch            1.17<span class="string">-395</span>.el8                                   cdrom-AppStream             27 k</span><br><span class="line"> perl-Digest-MD5                   x86_64            2.55<span class="string">-396</span>.el8                                   cdrom-AppStream             37 k</span><br><span class="line"> perl-Net-SSLeay                   x86_64            1.85<span class="string">-6</span>.el8                                     cdrom-AppStream            358 k</span><br><span class="line"> perl-URI                          noarch            1.73<span class="string">-3</span>.el8                                     cdrom-AppStream            116 k</span><br><span class="line"> perl-libnet                       noarch            3.11<span class="string">-3</span>.el8                                     cdrom-AppStream            121 k</span><br><span class="line"> lsof                              x86_64            4.91<span class="string">-2</span>.el8                                     cdrom-base                 253 k</span><br><span class="line"> perl-Carp                         noarch            1.42<span class="string">-396</span>.el8                                   cdrom-base                  30 k</span><br><span class="line"> perl-Data-Dumper                  x86_64            2.167<span class="string">-399</span>.el8                                  cdrom-base                  58 k</span><br><span class="line"> perl-Encode                       x86_64            4:2.97<span class="string">-3</span>.el8                                   cdrom-base                 1.5 M</span><br><span class="line"> perl-Errno                        x86_64            1.28<span class="string">-416</span>.el8                                   cdrom-base                  76 k</span><br><span class="line"> perl-Exporter                     noarch            5.72<span class="string">-396</span>.el8                                   cdrom-base                  34 k</span><br><span class="line"> perl-File-Path                    noarch            2.15<span class="string">-2</span>.el8                                     cdrom-base                  38 k</span><br><span class="line"> perl-File-Temp                    noarch            0.230.600<span class="string">-1</span>.el8                                cdrom-base                  63 k</span><br><span class="line"> perl-Getopt-Long                  noarch            1:2.50<span class="string">-4</span>.el8                                   cdrom-base                  63 k</span><br><span class="line"> perl-HTTP-Tiny                    noarch            0.074<span class="string">-1</span>.el8                                    cdrom-base                  58 k</span><br><span class="line"> perl-IO                           x86_64            1.38<span class="string">-416</span>.el8                                   cdrom-base                 141 k</span><br><span class="line"> perl-MIME-Base64                  x86_64            3.15<span class="string">-396</span>.el8                                   cdrom-base                  31 k</span><br><span class="line"> perl-Math-BigInt                  noarch            1:1.9998.11<span class="string">-5</span>.el8                              cdrom-base                 195 k</span><br><span class="line"> perl-Math-Complex                 noarch            1.59<span class="string">-416</span>.el8                                   cdrom-base                 108 k</span><br><span class="line"> perl-PathTools                    x86_64            3.74<span class="string">-1</span>.el8                                     cdrom-base                  90 k</span><br><span class="line"> perl-Pod-Escapes                  noarch            1:1.07<span class="string">-395</span>.el8                                 cdrom-base                  20 k</span><br><span class="line"> perl-Pod-Perldoc                  noarch            3.28<span class="string">-396</span>.el8                                   cdrom-base                  86 k</span><br><span class="line"> perl-Pod-Simple                   noarch            1:3.35<span class="string">-395</span>.el8                                 cdrom-base                 213 k</span><br><span class="line"> perl-Pod-Usage                    noarch            4:1.69<span class="string">-395</span>.el8                                 cdrom-base                  34 k</span><br><span class="line"> perl-Scalar-List-Utils            x86_64            3:1.49<span class="string">-2</span>.el8                                   cdrom-base                  68 k</span><br><span class="line"> perl-Socket                       x86_64            4:2.027<span class="string">-2</span>.el8                                  cdrom-base                  59 k</span><br><span class="line"> perl-Storable                     x86_64            1:3.11<span class="string">-3</span>.el8                                   cdrom-base                  98 k</span><br><span class="line"> perl-Term-ANSIColor               noarch            4.06<span class="string">-396</span>.el8                                   cdrom-base                  46 k</span><br><span class="line"> perl-Term-Cap                     noarch            1.17<span class="string">-395</span>.el8                                   cdrom-base                  23 k</span><br><span class="line"> perl-Text-ParseWords              noarch            3.30<span class="string">-395</span>.el8                                   cdrom-base                  18 k</span><br><span class="line"> perl-Text-Tabs+Wrap               noarch            2013.0523<span class="string">-395</span>.el8                              cdrom-base                  24 k</span><br><span class="line"> perl-Time-Local                   noarch            1:1.280<span class="string">-1</span>.el8                                  cdrom-base                  34 k</span><br><span class="line"> perl-Unicode-Normalize            x86_64            1.25<span class="string">-396</span>.el8                                   cdrom-base                  82 k</span><br><span class="line"> perl-constant                     noarch            1.33<span class="string">-396</span>.el8                                   cdrom-base                  25 k</span><br><span class="line"> perl-interpreter                  x86_64            4:5.26.3<span class="string">-416</span>.el8                               cdrom-base                 6.3 M</span><br><span class="line"> perl-libs                         x86_64            4:5.26.3<span class="string">-416</span>.el8                               cdrom-base                 1.6 M</span><br><span class="line"> perl-macros                       x86_64            4:5.26.3<span class="string">-416</span>.el8                               cdrom-base                  72 k</span><br><span class="line"> perl-parent                       noarch            1:0.237<span class="string">-1</span>.el8                                  cdrom-base                  20 k</span><br><span class="line"> perl-podlators                    noarch            4.11<span class="string">-1</span>.el8                                     cdrom-base                 118 k</span><br><span class="line"> perl-threads                      x86_64            1:2.21<span class="string">-2</span>.el8                                   cdrom-base                  61 k</span><br><span class="line"> perl-threads-shared               x86_64            1.58<span class="string">-2</span>.el8                                     cdrom-base                  48 k</span><br><span class="line"> rsync                             x86_64            3.1.3<span class="string">-4</span>.el8                                    cdrom-base                 404 k</span><br><span class="line"> MariaDB-client                    x86_64            10.4.8<span class="string">-1</span>.el8                                   mariadb10.4.8               12 M</span><br><span class="line"> MariaDB-common                    x86_64            10.4.8<span class="string">-1</span>.el8                                   mariadb10.4.8               87 k</span><br><span class="line"> galera<span class="string">-4</span>                          x86_64            26.4.2<span class="string">-1</span>.rhel8.0.el8                           mariadb10.4.8               13 M</span><br><span class="line">Installing weak dependencies:</span><br><span class="line"> perl-IO-Socket-IP                 noarch            0.39<span class="string">-5</span>.el8                                     cdrom-AppStream             47 k</span><br><span class="line"> perl-IO-Socket-SSL                noarch            2.060<span class="string">-2</span>.el8                                    cdrom-AppStream            289 k</span><br><span class="line"> perl-Mozilla-CA                   noarch            20160104<span class="string">-7</span>.el8                                 cdrom-AppStream             15 k</span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">=====================================================================================================================================</span><br><span class="line">Install  51 Packages</span><br><span class="line"></span><br><span class="line">Total size: 65 M</span><br><span class="line">Total download size: 25 M</span><br><span class="line">Installed size: 236 M</span><br><span class="line">Is this ok [y/N]: y</span><br><span class="line">Downloading Packages:</span><br><span class="line">(1/3): MariaDB-common<span class="string">-10</span>.4.8<span class="string">-1</span>.el8.x86_64.rpm                                                         35 kB/s |  87 kB     00:02    </span><br><span class="line">(2/3): MariaDB-client<span class="string">-10</span>.4.8<span class="string">-1</span>.el8.x86_64.rpm                                                        203 kB/s |  12 MB     00:59    </span><br><span class="line">(3/3): galera<span class="string">-4</span><span class="string">-26</span>.4.2<span class="string">-1</span>.rhel8.0.el8.x86_64.rpm                                                      198 kB/s |  13 MB     01:08    </span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">Total                                                                                                376 kB/s |  25 MB     01:08     </span><br><span class="line">Running transaction check</span><br><span class="line">Transaction check succeeded.</span><br><span class="line">Running transaction test</span><br><span class="line">Transaction test succeeded.</span><br><span class="line">Running transaction</span><br><span class="line">  Preparing        :                                                                                                             1/1 </span><br><span class="line">  Installing       : perl-Exporter<span class="string">-5</span>.72<span class="string">-396</span>.el8.noarch                                                                          1/51 </span><br><span class="line">  Installing       : perl-libs<span class="string">-4</span>:5.26.3<span class="string">-416</span>.el8.x86_64                                                                          2/51 </span><br><span class="line">  Installing       : perl-Carp<span class="string">-1</span>.42<span class="string">-396</span>.el8.noarch                                                                              3/51 </span><br><span class="line">  Installing       : perl-Scalar-List-Utils<span class="string">-3</span>:1.49<span class="string">-2</span>.el8.x86_64                                                                 4/51 </span><br><span class="line">  Installing       : perl-parent<span class="string">-1</span>:0.237<span class="string">-1</span>.el8.noarch                                                                           5/51 </span><br><span class="line">  Installing       : perl-Text-ParseWords<span class="string">-3</span>.30<span class="string">-395</span>.el8.noarch                                                                   6/51 </span><br><span class="line">  Running scriptlet: MariaDB-common<span class="string">-10</span>.4.8<span class="string">-1</span>.el8.x86_64                                                                         7/51 </span><br><span class="line">  Installing       : MariaDB-common<span class="string">-10</span>.4.8<span class="string">-1</span>.el8.x86_64                                                                         7/51 </span><br><span class="line">  Running scriptlet: MariaDB-common<span class="string">-10</span>.4.8<span class="string">-1</span>.el8.x86_64                                                                         7/51 </span><br><span class="line">  Installing       : perl-Term-ANSIColor<span class="string">-4</span>.06<span class="string">-396</span>.el8.noarch                                                                    8/51 </span><br><span class="line">  Installing       : perl-macros<span class="string">-4</span>:5.26.3<span class="string">-416</span>.el8.x86_64                                                                        9/51 </span><br><span class="line">  Installing       : perl-Errno<span class="string">-1</span>.28<span class="string">-416</span>.el8.x86_64                                                                            10/51 </span><br><span class="line">  Installing       : perl-Socket<span class="string">-4</span>:2.027<span class="string">-2</span>.el8.x86_64                                                                          11/51 </span><br><span class="line">  Installing       : perl-Text-Tabs+Wrap<span class="string">-2013</span>.0523<span class="string">-395</span>.el8.noarch                                                              12/51 </span><br><span class="line">  Installing       : perl-Unicode-Normalize<span class="string">-1</span>.25<span class="string">-396</span>.el8.x86_64                                                                13/51 </span><br><span class="line">  Installing       : perl-File-Path<span class="string">-2</span>.15<span class="string">-2</span>.el8.noarch                                                                          14/51 </span><br><span class="line">  Installing       : perl-IO<span class="string">-1</span>.38<span class="string">-416</span>.el8.x86_64                                                                               15/51 </span><br><span class="line">  Installing       : perl-PathTools<span class="string">-3</span>.74<span class="string">-1</span>.el8.x86_64                                                                          16/51 </span><br><span class="line">  Installing       : perl-constant<span class="string">-1</span>.33<span class="string">-396</span>.el8.noarch                                                                         17/51 </span><br><span class="line">  Installing       : perl-threads<span class="string">-1</span>:2.21<span class="string">-2</span>.el8.x86_64                                                                          18/51 </span><br><span class="line">  Installing       : perl-threads-shared<span class="string">-1</span>.58<span class="string">-2</span>.el8.x86_64                                                                     19/51 </span><br><span class="line">  Installing       : perl-interpreter<span class="string">-4</span>:5.26.3<span class="string">-416</span>.el8.x86_64                                                                  20/51 </span><br><span class="line">  Installing       : perl-MIME-Base64<span class="string">-3</span>.15<span class="string">-396</span>.el8.x86_64                                                                      21/51 </span><br><span class="line">  Installing       : perl-IO-Socket-IP<span class="string">-0</span>.39<span class="string">-5</span>.el8.noarch                                                                       22/51 </span><br><span class="line">  Installing       : perl-Data-Dumper<span class="string">-2</span>.167<span class="string">-399</span>.el8.x86_64                                                                     23/51 </span><br><span class="line">  Installing       : perl-File-Temp<span class="string">-0</span>.230.600<span class="string">-1</span>.el8.noarch                                                                     24/51 </span><br><span class="line">  Installing       : perl-Storable<span class="string">-1</span>:3.11<span class="string">-3</span>.el8.x86_64                                                                         25/51 </span><br><span class="line">  Installing       : perl-Time-Local<span class="string">-1</span>:1.280<span class="string">-1</span>.el8.noarch                                                                      26/51 </span><br><span class="line">  Installing       : perl-Digest<span class="string">-1</span>.17<span class="string">-395</span>.el8.noarch                                                                           27/51 </span><br><span class="line">  Installing       : perl-Digest-MD5<span class="string">-2</span>.55<span class="string">-396</span>.el8.x86_64                                                                       28/51 </span><br><span class="line">  Installing       : perl-Net-SSLeay<span class="string">-1</span>.85<span class="string">-6</span>.el8.x86_64                                                                         29/51 </span><br><span class="line">  Installing       : perl-Math-Complex<span class="string">-1</span>.59<span class="string">-416</span>.el8.noarch                                                                     30/51 </span><br><span class="line">  Installing       : perl-Math-BigInt<span class="string">-1</span>:1.9998.11<span class="string">-5</span>.el8.noarch                                                                 31/51 </span><br><span class="line">  Installing       : perl-Pod-Escapes<span class="string">-1</span>:1.07<span class="string">-395</span>.el8.noarch                                                                    32/51 </span><br><span class="line">  Installing       : perl-Term-Cap<span class="string">-1</span>.17<span class="string">-395</span>.el8.noarch                                                                         33/51 </span><br><span class="line">  Installing       : perl-Mozilla-CA<span class="string">-20160104</span><span class="string">-7</span>.el8.noarch                                                                     34/51 </span><br><span class="line">  Installing       : perl-Encode<span class="string">-4</span>:2.97<span class="string">-3</span>.el8.x86_64                                                                           35/51 </span><br><span class="line">  Installing       : perl-Pod-Simple<span class="string">-1</span>:3.35<span class="string">-395</span>.el8.noarch                                                                     36/51 </span><br><span class="line">  Installing       : perl-Getopt-Long<span class="string">-1</span>:2.50<span class="string">-4</span>.el8.noarch                                                                      37/51 </span><br><span class="line">  Installing       : perl-podlators<span class="string">-4</span>.11<span class="string">-1</span>.el8.noarch                                                                          38/51 </span><br><span class="line">  Installing       : perl-Pod-Usage<span class="string">-4</span>:1.69<span class="string">-395</span>.el8.noarch                                                                      39/51 </span><br><span class="line">  Installing       : perl-Pod-Perldoc<span class="string">-3</span>.28<span class="string">-396</span>.el8.noarch                                                                      40/51 </span><br><span class="line">  Installing       : perl-HTTP-Tiny<span class="string">-0</span>.074<span class="string">-1</span>.el8.noarch                                                                         41/51 </span><br><span class="line">  Installing       : perl-IO-Socket-SSL<span class="string">-2</span>.060<span class="string">-2</span>.el8.noarch                                                                     42/51 </span><br><span class="line">  Installing       : perl-libnet<span class="string">-3</span>.11<span class="string">-3</span>.el8.noarch                                                                             43/51 </span><br><span class="line">  Installing       : perl-URI<span class="string">-1</span>.73<span class="string">-3</span>.el8.noarch                                                                                44/51 </span><br><span class="line">  Installing       : perl-DBI<span class="string">-1</span>.641<span class="string">-2</span>.module_el8.0.0<span class="string">+66</span>+fe1eca09.x86_64                                                        45/51 </span><br><span class="line">  Running scriptlet: MariaDB-client<span class="string">-10</span>.4.8<span class="string">-1</span>.el8.x86_64                                                                        46/51 </span><br><span class="line">  Installing       : MariaDB-client<span class="string">-10</span>.4.8<span class="string">-1</span>.el8.x86_64                                                                        46/51 </span><br><span class="line">  Running scriptlet: MariaDB-client<span class="string">-10</span>.4.8<span class="string">-1</span>.el8.x86_64                                                                        46/51 </span><br><span class="line">  Installing       : rsync<span class="string">-3</span>.1.3<span class="string">-4</span>.el8.x86_64                                                                                  47/51 </span><br><span class="line">  Installing       : lsof<span class="string">-4</span>.91<span class="string">-2</span>.el8.x86_64                                                                                    48/51 </span><br><span class="line">  Installing       : boost-program-options<span class="string">-1</span>.66.0<span class="string">-6</span>.el8.x86_64                                                                 49/51 </span><br><span class="line">  Running scriptlet: boost-program-options<span class="string">-1</span>.66.0<span class="string">-6</span>.el8.x86_64                                                                 49/51 </span><br><span class="line">  Running scriptlet: galera<span class="string">-4</span><span class="string">-26</span>.4.2<span class="string">-1</span>.rhel8.0.el8.x86_64                                                                      50/51 </span><br><span class="line">  Installing       : galera<span class="string">-4</span><span class="string">-26</span>.4.2<span class="string">-1</span>.rhel8.0.el8.x86_64                                                                      50/51 </span><br><span class="line">  Running scriptlet: galera<span class="string">-4</span><span class="string">-26</span>.4.2<span class="string">-1</span>.rhel8.0.el8.x86_64                                                                      50/51 </span><br><span class="line">  Running scriptlet: MariaDB-server<span class="string">-10</span>.4.8<span class="string">-1</span>.el8.x86_64                                                                        51/51 </span><br><span class="line">  Installing       : MariaDB-server<span class="string">-10</span>.4.8<span class="string">-1</span>.el8.x86_64                                                                        51/51 </span><br><span class="line">  Running scriptlet: MariaDB-server<span class="string">-10</span>.4.8<span class="string">-1</span>.el8.x86_64                                                                        51/51 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Two all-privilege accounts were created.</span><br><span class="line">One is root@localhost, it has no password, but you need to</span><br><span class="line">be system 'root' user to connect. Use, for example, sudo mysql</span><br><span class="line">The second is mysql@localhost, it has no password either, but</span><br><span class="line">you need to be the system 'mysql' user to connect.</span><br><span class="line">After connecting you can set the password, if you would need to be</span><br><span class="line">able to connect as any of these users with a password and without sudo</span><br><span class="line"></span><br><span class="line">See the MariaDB Knowledgebase at http://mariadb.com/kb or the</span><br><span class="line">MySQL manual for more instructions.</span><br><span class="line"></span><br><span class="line">Please report any problems at http://mariadb.org/jira</span><br><span class="line"></span><br><span class="line">The latest information about MariaDB is available at http://mariadb.org/.</span><br><span class="line">You can find additional information about the MySQL part at:</span><br><span class="line">http://dev.mysql.com</span><br><span class="line">Consider joining MariaDB's strong and vibrant community:</span><br><span class="line">https://mariadb.org/get-involved/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  Verifying        : boost-program-options<span class="string">-1</span>.66.0<span class="string">-6</span>.el8.x86_64                                                                  1/51 </span><br><span class="line">  Verifying        : perl-DBI<span class="string">-1</span>.641<span class="string">-2</span>.module_el8.0.0<span class="string">+66</span>+fe1eca09.x86_64                                                         2/51 </span><br><span class="line">  Verifying        : perl-Digest<span class="string">-1</span>.17<span class="string">-395</span>.el8.noarch                                                                            3/51 </span><br><span class="line">  Verifying        : perl-Digest-MD5<span class="string">-2</span>.55<span class="string">-396</span>.el8.x86_64                                                                        4/51 </span><br><span class="line">  Verifying        : perl-IO-Socket-IP<span class="string">-0</span>.39<span class="string">-5</span>.el8.noarch                                                                        5/51 </span><br><span class="line">  Verifying        : perl-IO-Socket-SSL<span class="string">-2</span>.060<span class="string">-2</span>.el8.noarch                                                                      6/51 </span><br><span class="line">  Verifying        : perl-Mozilla-CA<span class="string">-20160104</span><span class="string">-7</span>.el8.noarch                                                                      7/51 </span><br><span class="line">  Verifying        : perl-Net-SSLeay<span class="string">-1</span>.85<span class="string">-6</span>.el8.x86_64                                                                          8/51 </span><br><span class="line">  Verifying        : perl-URI<span class="string">-1</span>.73<span class="string">-3</span>.el8.noarch                                                                                 9/51 </span><br><span class="line">  Verifying        : perl-libnet<span class="string">-3</span>.11<span class="string">-3</span>.el8.noarch                                                                             10/51 </span><br><span class="line">  Verifying        : lsof<span class="string">-4</span>.91<span class="string">-2</span>.el8.x86_64                                                                                    11/51 </span><br><span class="line">  Verifying        : perl-Carp<span class="string">-1</span>.42<span class="string">-396</span>.el8.noarch                                                                             12/51 </span><br><span class="line">  Verifying        : perl-Data-Dumper<span class="string">-2</span>.167<span class="string">-399</span>.el8.x86_64                                                                     13/51 </span><br><span class="line">  Verifying        : perl-Encode<span class="string">-4</span>:2.97<span class="string">-3</span>.el8.x86_64                                                                           14/51 </span><br><span class="line">  Verifying        : perl-Errno<span class="string">-1</span>.28<span class="string">-416</span>.el8.x86_64                                                                            15/51 </span><br><span class="line">  Verifying        : perl-Exporter<span class="string">-5</span>.72<span class="string">-396</span>.el8.noarch                                                                         16/51 </span><br><span class="line">  Verifying        : perl-File-Path<span class="string">-2</span>.15<span class="string">-2</span>.el8.noarch                                                                          17/51 </span><br><span class="line">  Verifying        : perl-File-Temp<span class="string">-0</span>.230.600<span class="string">-1</span>.el8.noarch                                                                     18/51 </span><br><span class="line">  Verifying        : perl-Getopt-Long<span class="string">-1</span>:2.50<span class="string">-4</span>.el8.noarch                                                                      19/51 </span><br><span class="line">  Verifying        : perl-HTTP-Tiny<span class="string">-0</span>.074<span class="string">-1</span>.el8.noarch                                                                         20/51 </span><br><span class="line">  Verifying        : perl-IO<span class="string">-1</span>.38<span class="string">-416</span>.el8.x86_64                                                                               21/51 </span><br><span class="line">  Verifying        : perl-MIME-Base64<span class="string">-3</span>.15<span class="string">-396</span>.el8.x86_64                                                                      22/51 </span><br><span class="line">  Verifying        : perl-Math-BigInt<span class="string">-1</span>:1.9998.11<span class="string">-5</span>.el8.noarch                                                                 23/51 </span><br><span class="line">  Verifying        : perl-Math-Complex<span class="string">-1</span>.59<span class="string">-416</span>.el8.noarch                                                                     24/51 </span><br><span class="line">  Verifying        : perl-PathTools<span class="string">-3</span>.74<span class="string">-1</span>.el8.x86_64                                                                          25/51 </span><br><span class="line">  Verifying        : perl-Pod-Escapes<span class="string">-1</span>:1.07<span class="string">-395</span>.el8.noarch                                                                    26/51 </span><br><span class="line">  Verifying        : perl-Pod-Perldoc<span class="string">-3</span>.28<span class="string">-396</span>.el8.noarch                                                                      27/51 </span><br><span class="line">  Verifying        : perl-Pod-Simple<span class="string">-1</span>:3.35<span class="string">-395</span>.el8.noarch                                                                     28/51 </span><br><span class="line">  Verifying        : perl-Pod-Usage<span class="string">-4</span>:1.69<span class="string">-395</span>.el8.noarch                                                                      29/51 </span><br><span class="line">  Verifying        : perl-Scalar-List-Utils<span class="string">-3</span>:1.49<span class="string">-2</span>.el8.x86_64                                                                30/51 </span><br><span class="line">  Verifying        : perl-Socket<span class="string">-4</span>:2.027<span class="string">-2</span>.el8.x86_64                                                                          31/51 </span><br><span class="line">  Verifying        : perl-Storable<span class="string">-1</span>:3.11<span class="string">-3</span>.el8.x86_64                                                                         32/51 </span><br><span class="line">  Verifying        : perl-Term-ANSIColor<span class="string">-4</span>.06<span class="string">-396</span>.el8.noarch                                                                   33/51 </span><br><span class="line">  Verifying        : perl-Term-Cap<span class="string">-1</span>.17<span class="string">-395</span>.el8.noarch                                                                         34/51 </span><br><span class="line">  Verifying        : perl-Text-ParseWords<span class="string">-3</span>.30<span class="string">-395</span>.el8.noarch                                                                  35/51 </span><br><span class="line">  Verifying        : perl-Text-Tabs+Wrap<span class="string">-2013</span>.0523<span class="string">-395</span>.el8.noarch                                                              36/51 </span><br><span class="line">  Verifying        : perl-Time-Local<span class="string">-1</span>:1.280<span class="string">-1</span>.el8.noarch                                                                      37/51 </span><br><span class="line">  Verifying        : perl-Unicode-Normalize<span class="string">-1</span>.25<span class="string">-396</span>.el8.x86_64                                                                38/51 </span><br><span class="line">  Verifying        : perl-constant<span class="string">-1</span>.33<span class="string">-396</span>.el8.noarch                                                                         39/51 </span><br><span class="line">  Verifying        : perl-interpreter<span class="string">-4</span>:5.26.3<span class="string">-416</span>.el8.x86_64                                                                  40/51 </span><br><span class="line">  Verifying        : perl-libs<span class="string">-4</span>:5.26.3<span class="string">-416</span>.el8.x86_64                                                                         41/51 </span><br><span class="line">  Verifying        : perl-macros<span class="string">-4</span>:5.26.3<span class="string">-416</span>.el8.x86_64                                                                       42/51 </span><br><span class="line">  Verifying        : perl-parent<span class="string">-1</span>:0.237<span class="string">-1</span>.el8.noarch                                                                          43/51 </span><br><span class="line">  Verifying        : perl-podlators<span class="string">-4</span>.11<span class="string">-1</span>.el8.noarch                                                                          44/51 </span><br><span class="line">  Verifying        : perl-threads<span class="string">-1</span>:2.21<span class="string">-2</span>.el8.x86_64                                                                          45/51 </span><br><span class="line">  Verifying        : perl-threads-shared<span class="string">-1</span>.58<span class="string">-2</span>.el8.x86_64                                                                     46/51 </span><br><span class="line">  Verifying        : rsync<span class="string">-3</span>.1.3<span class="string">-4</span>.el8.x86_64                                                                                  47/51 </span><br><span class="line">  Verifying        : MariaDB-client<span class="string">-10</span>.4.8<span class="string">-1</span>.el8.x86_64                                                                        48/51 </span><br><span class="line">  Verifying        : MariaDB-common<span class="string">-10</span>.4.8<span class="string">-1</span>.el8.x86_64                                                                        49/51 </span><br><span class="line">  Verifying        : galera<span class="string">-4</span><span class="string">-26</span>.4.2<span class="string">-1</span>.rhel8.0.el8.x86_64                                                                      50/51 </span><br><span class="line">  Verifying        : MariaDB-server<span class="string">-10</span>.4.8<span class="string">-1</span>.el8.x86_64                                                                        51/51 </span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line">  MariaDB-server<span class="string">-10</span>.4.8<span class="string">-1</span>.el8.x86_64                             perl-IO-Socket-IP<span class="string">-0</span>.39<span class="string">-5</span>.el8.noarch                                 </span><br><span class="line">  perl-IO-Socket-SSL<span class="string">-2</span>.060<span class="string">-2</span>.el8.noarch                          perl-Mozilla-CA<span class="string">-20160104</span><span class="string">-7</span>.el8.noarch                               </span><br><span class="line">  boost-program-options<span class="string">-1</span>.66.0<span class="string">-6</span>.el8.x86_64                      perl-DBI<span class="string">-1</span>.641<span class="string">-2</span>.module_el8.0.0<span class="string">+66</span>+fe1eca09.x86_64                  </span><br><span class="line">  perl-Digest<span class="string">-1</span>.17<span class="string">-395</span>.el8.noarch                                perl-Digest-MD5<span class="string">-2</span>.55<span class="string">-396</span>.el8.x86_64                                 </span><br><span class="line">  perl-Net-SSLeay<span class="string">-1</span>.85<span class="string">-6</span>.el8.x86_64                              perl-URI<span class="string">-1</span>.73<span class="string">-3</span>.el8.noarch                                          </span><br><span class="line">  perl-libnet<span class="string">-3</span>.11<span class="string">-3</span>.el8.noarch                                  lsof<span class="string">-4</span>.91<span class="string">-2</span>.el8.x86_64                                              </span><br><span class="line">  perl-Carp<span class="string">-1</span>.42<span class="string">-396</span>.el8.noarch                                  perl-Data-Dumper<span class="string">-2</span>.167<span class="string">-399</span>.el8.x86_64                               </span><br><span class="line">  perl-Encode<span class="string">-4</span>:2.97<span class="string">-3</span>.el8.x86_64                                perl-Errno<span class="string">-1</span>.28<span class="string">-416</span>.el8.x86_64                                      </span><br><span class="line">  perl-Exporter<span class="string">-5</span>.72<span class="string">-396</span>.el8.noarch                              perl-File-Path<span class="string">-2</span>.15<span class="string">-2</span>.el8.noarch                                    </span><br><span class="line">  perl-File-Temp<span class="string">-0</span>.230.600<span class="string">-1</span>.el8.noarch                          perl-Getopt-Long<span class="string">-1</span>:2.50<span class="string">-4</span>.el8.noarch                                </span><br><span class="line">  perl-HTTP-Tiny<span class="string">-0</span>.074<span class="string">-1</span>.el8.noarch                              perl-IO<span class="string">-1</span>.38<span class="string">-416</span>.el8.x86_64                                         </span><br><span class="line">  perl-MIME-Base64<span class="string">-3</span>.15<span class="string">-396</span>.el8.x86_64                           perl-Math-BigInt<span class="string">-1</span>:1.9998.11<span class="string">-5</span>.el8.noarch                           </span><br><span class="line">  perl-Math-Complex<span class="string">-1</span>.59<span class="string">-416</span>.el8.noarch                          perl-PathTools<span class="string">-3</span>.74<span class="string">-1</span>.el8.x86_64                                    </span><br><span class="line">  perl-Pod-Escapes<span class="string">-1</span>:1.07<span class="string">-395</span>.el8.noarch                         perl-Pod-Perldoc<span class="string">-3</span>.28<span class="string">-396</span>.el8.noarch                                </span><br><span class="line">  perl-Pod-Simple<span class="string">-1</span>:3.35<span class="string">-395</span>.el8.noarch                          perl-Pod-Usage<span class="string">-4</span>:1.69<span class="string">-395</span>.el8.noarch                                </span><br><span class="line">  perl-Scalar-List-Utils<span class="string">-3</span>:1.49<span class="string">-2</span>.el8.x86_64                     perl-Socket<span class="string">-4</span>:2.027<span class="string">-2</span>.el8.x86_64                                    </span><br><span class="line">  perl-Storable<span class="string">-1</span>:3.11<span class="string">-3</span>.el8.x86_64                              perl-Term-ANSIColor<span class="string">-4</span>.06<span class="string">-396</span>.el8.noarch                             </span><br><span class="line">  perl-Term-Cap<span class="string">-1</span>.17<span class="string">-395</span>.el8.noarch                              perl-Text-ParseWords<span class="string">-3</span>.30<span class="string">-395</span>.el8.noarch                            </span><br><span class="line">  perl-Text-Tabs+Wrap<span class="string">-2013</span>.0523<span class="string">-395</span>.el8.noarch                   perl-Time-Local<span class="string">-1</span>:1.280<span class="string">-1</span>.el8.noarch                                </span><br><span class="line">  perl-Unicode-Normalize<span class="string">-1</span>.25<span class="string">-396</span>.el8.x86_64                     perl-constant<span class="string">-1</span>.33<span class="string">-396</span>.el8.noarch                                   </span><br><span class="line">  perl-interpreter<span class="string">-4</span>:5.26.3<span class="string">-416</span>.el8.x86_64                       perl-libs<span class="string">-4</span>:5.26.3<span class="string">-416</span>.el8.x86_64                                   </span><br><span class="line">  perl-macros<span class="string">-4</span>:5.26.3<span class="string">-416</span>.el8.x86_64                            perl-parent<span class="string">-1</span>:0.237<span class="string">-1</span>.el8.noarch                                    </span><br><span class="line">  perl-podlators<span class="string">-4</span>.11<span class="string">-1</span>.el8.noarch                               perl-threads<span class="string">-1</span>:2.21<span class="string">-2</span>.el8.x86_64                                    </span><br><span class="line">  perl-threads-shared<span class="string">-1</span>.58<span class="string">-2</span>.el8.x86_64                          rsync<span class="string">-3</span>.1.3<span class="string">-4</span>.el8.x86_64                                            </span><br><span class="line">  MariaDB-client<span class="string">-10</span>.4.8<span class="string">-1</span>.el8.x86_64                             MariaDB-common<span class="string">-10</span>.4.8<span class="string">-1</span>.el8.x86_64                                  </span><br><span class="line">  galera<span class="string">-4</span><span class="string">-26</span>.4.2<span class="string">-1</span>.rhel8.0.el8.x86_64                          </span><br><span class="line"></span><br><span class="line">Complete!</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;果然成功了。问题解决。</p>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 经验分享 </tag>
            
            <tag> mariadb </tag>
            
            <tag> yum源 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自动化运维之Ansible</title>
      <link href="//blog/8a189dcf.html"/>
      <url>//blog/8a189dcf.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="企业实际应用场景分析"><a href="#企业实际应用场景分析" class="headerlink" title="企业实际应用场景分析"></a>企业实际应用场景分析</h3><ul><li>Dev开发环境<br>&emsp;&emsp;使用者：程序员<br>&emsp;&emsp;功能：程序员开发软件，测试BUG的环境<br>&emsp;&emsp;管理者：程序员</li><li>测试环境<br>&emsp;&emsp;使用者：QA测试工程师<br>&emsp;&emsp;功能：测试经过Dev环境测试通过的软件的功能<br>&emsp;&emsp;管理者：运维<br>&emsp;&emsp;说明：测试环境往往有多套,测试环境满足测试功能即可，不宜过多<br>&emsp;&emsp;1、测试人员希望测试环境有多套,公司的产品多产品线并发，即多个版本，<br>意味着多个版本同步测试<br>&emsp;&emsp;2、通常测试环境有多少套和产品线数量保持一样<a id="more"></a></li><li>发布环境：代码发布机,有些公司为堡垒机（安全屏障）<br>&emsp;&emsp;使用者：运维<br>&emsp;&emsp;功能：发布代码至生产环境<br>&emsp;&emsp;管理者：运维（有经验）<br>&emsp;&emsp;发布机：往往需要有2台（主备）</li><li>生产环境<br>&emsp;&emsp;使用者：运维，少数情况开放权限给核心开发人员，极少数公司将权限完全<br>开放给开发人员并其维护<br>&emsp;&emsp;功能：对用户提供公司产品的服务<br>&emsp;&emsp;管理者：只能是运维<br>&emsp;&emsp;生产环境服务器数量：一般比较多，且应用非常重要。往往需要自动工具协<br>助部署配置应用</li><li>灰度环境（生产环境的一部分）<br>&emsp;&emsp;使用者：运维<br>&emsp;&emsp;功能：在全量发布代码前将代码的功能面向少量精准用户发布的环境,可基<br>于主机或用户执行灰度发布<br>&emsp;&emsp;案例：共100台生产服务器，先发布其中的10台服务器，这10台服务器就<br>是灰度服务器<br>&emsp;&emsp;管理者：运维<br>&emsp;&emsp;灰度环境：往往该版本功能变更较大，为保险起见特意先让一部分用户优化<br>体验该功能，待这部分用户使用没有重大问题的时候，再全量发布至所有服务器<h3 id="程序发布"><a href="#程序发布" class="headerlink" title="程序发布"></a>程序发布</h3></li><li>程序发布要求：<br>&emsp;&emsp;不能导致系统故障或造成系统完全不可用<br>&emsp;&emsp;不能影响用户体验</li><li>预发布验证：<br>&emsp;&emsp;新版本的代码先发布到服务器（跟线上环境配置完全相同，只是未接入到调度器）</li><li>灰度发布：<br>&emsp;&emsp;基于主机，用户，业务</li><li>发布路径：<br>&emsp;&emsp;/webapp/tuangou<br>&emsp;&emsp;/webapp/tuangou-1.1<br>&emsp;&emsp;/webapp/tuangou-1.2<ul><li>发布过程：在调度器上下线一批主机(标记为maintenance 状态) –&gt; 关闭服务 –&gt; 部<br>署新版本的应用程序 –&gt; 启动服务 –&gt; 在调度器上启用这一批服务器</li></ul></li><li>自动化灰度发布：脚本、发布平台<h3 id="自动化运维应用场景"><a href="#自动化运维应用场景" class="headerlink" title="自动化运维应用场景"></a>自动化运维应用场景</h3></li><li>文件传输</li><li>应用部署</li><li>配置管理</li><li>任务流编排<h3 id="常用自动化运维工具"><a href="#常用自动化运维工具" class="headerlink" title="常用自动化运维工具"></a>常用自动化运维工具</h3></li><li>Ansible：python，Agentless，中小型应用环境</li><li>Saltstack：python，一般需部署agent，执行效率更高</li><li>Puppet：ruby, 功能强大，配置复杂，重型,适合大型环境</li><li>Fabric：python，agentless</li><li>Chef：ruby，国内应用少</li><li>Cfengine</li><li>func<h3 id="Ansible简介"><a href="#Ansible简介" class="headerlink" title="Ansible简介"></a>Ansible简介</h3>        <div id="aplayer-aorDRFIR" class="aplayer aplayer-tag-marker" style="margin-bottom: 20px;">            <pre class="aplayer-lrc-content"></pre>        </div>        <script>          var ap = new APlayer({            element: document.getElementById("aplayer-aorDRFIR"),            narrow: false,            autoplay: true,            showlrc: false,            music: {              title: "Coming Home",              author: "Peter Jeremias",              url: "https://hewanyue.com/mp3/ComingHome.mp3",              pic: "https://hewanyue.com/mp3/cover/ComingHome.jpg",              lrc: ""            }          });          window.aplayers || (window.aplayers = []);          window.aplayers.push(ap);        </script><h4 id="Ansible特性"><a href="#Ansible特性" class="headerlink" title="Ansible特性"></a>Ansible特性</h4></li><li>模块化：调用特定的模块，完成特定任务</li><li>Paramiko（python对ssh的实现），PyYAML，Jinja2（模板语言）三个关键模块</li><li>支持自定义模块</li><li>基于Python语言实现</li><li>部署简单，基于python和SSH(默认已安装)，agentless</li><li>安全，基于OpenSSH</li><li>支持playbook编排任务</li><li>幂等性：一个任务执行1遍和执行n遍效果一样，不因重复执行带来意外情况</li><li>无需代理不依赖PKI（无需ssl）</li><li>可使用任何编程语言写模块</li><li>YAML格式，编排任务，支持丰富的数据结构</li><li>较强大的多层解决方案<h4 id="Ansible架构"><a href="#Ansible架构" class="headerlink" title="Ansible架构"></a>Ansible架构</h4><img src="https://img-blog.csdnimg.cn/20191007171143415.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><h4 id="Ansible工作原理"><a href="#Ansible工作原理" class="headerlink" title="Ansible工作原理"></a>Ansible工作原理</h4><img src="https://img-blog.csdnimg.cn/20191007171304635.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><h4 id="Ansible主要组成部分"><a href="#Ansible主要组成部分" class="headerlink" title="Ansible主要组成部分"></a>Ansible主要组成部分</h4></li><li>ANSIBLE PLAYBOOKS：任务剧本（任务集），编排定义Ansible任务集的配置<br>文件，由Ansible顺序依次执行，通常是JSON格式的YML文件</li><li>INVENTORY：Ansible管理主机的清单/etc/anaible/hosts</li><li>MODULES：Ansible执行命令的功能模块，多数为内置核心模块，也可自定义</li><li>PLUGINS：模块功能的补充，如连接类型插件、循环插件、变量插件、过滤插<br>件等，该功能不常用</li><li>API：供第三方程序调用的应用程序编程接口</li><li>ANSIBLE：组合INVENTORY、API、MODULES、PLUGINS的绿框，可以理解<br>为是ansible命令工具，其为核心执行工具<h4 id="Ansible命令执行来源："><a href="#Ansible命令执行来源：" class="headerlink" title="Ansible命令执行来源："></a>Ansible命令执行来源：</h4></li><li>USER，普通用户，即SYSTEM ADMINISTRATOR</li><li>CMDB（配置管理数据库） API 调用</li><li>PUBLIC/PRIVATE CLOUD API调用</li><li>USER-&gt; Ansible Playbook -&gt; Ansibile<h4 id="利用ansible实现管理的方式："><a href="#利用ansible实现管理的方式：" class="headerlink" title="利用ansible实现管理的方式："></a>利用ansible实现管理的方式：</h4></li><li>Ad-Hoc 即ansible命令，主要用于临时命令使用场景</li><li>Ansible-playbook 主要用于长期规划好的，大型项目的场景，需要有前期<br>的规划过程</li></ul><h4 id="Ansible-playbook（剧本）执行过程"><a href="#Ansible-playbook（剧本）执行过程" class="headerlink" title="Ansible-playbook（剧本）执行过程"></a>Ansible-playbook（剧本）执行过程</h4><ul><li>将已有编排好的任务集写入Ansible-Playbook</li><li>通过ansible-playbook命令分拆任务集至逐条ansible命令，按预定规则逐<br>条执行<h4 id="Ansible主要操作对象"><a href="#Ansible主要操作对象" class="headerlink" title="Ansible主要操作对象"></a>Ansible主要操作对象</h4></li><li>HOSTS主机</li><li>NETWORKING网络设备<h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4>&emsp;&emsp;执行ansible的主机一般称为主控端，中控，master或堡垒机<br>&emsp;&emsp;主控端Python版本需要2.6或以上<br>&emsp;&emsp;被控端Python版本小于2.4需要安装python-simplejson<br>&emsp;&emsp;被控端如开启SELinux需要安装libselinux-python<br>&emsp;&emsp;windows不能做为主控端</li></ul><h3 id="安装Ansible"><a href="#安装Ansible" class="headerlink" title="安装Ansible"></a>安装Ansible</h3><h4 id="rpm包安装-EPEL源"><a href="#rpm包安装-EPEL源" class="headerlink" title="rpm包安装: EPEL源"></a>rpm包安装: EPEL源</h4><p><code>yum install ansible</code></p><h4 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装:"></a>编译安装:</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum -y install python-jinja2 PyYAML python-paramiko python-babel python-crypto</span><br><span class="line">wget https://releases.ansible.com/ansible/ansible-1.5.4.tar.gz</span><br><span class="line">tar xf ansible-1.5.4.tar.gz</span><br><span class="line">cd ansible-1.5.4</span><br><span class="line">python setup.py build</span><br><span class="line">python setup.py install</span><br><span class="line">mkdir /etc/ansible</span><br><span class="line">cp -r examples/* /etc/ansible</span><br></pre></td></tr></table></figure><h4 id="Git方式"><a href="#Git方式" class="headerlink" title="Git方式:"></a>Git方式:</h4> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone git://github.com/ansible/ansible.git --recursive</span><br><span class="line">cd ./ansible</span><br><span class="line">source ./hacking/env-setup</span><br></pre></td></tr></table></figure><h4 id="pip安装：-pip是安装Python包的管理器，类似yum"><a href="#pip安装：-pip是安装Python包的管理器，类似yum" class="headerlink" title="pip安装： pip是安装Python包的管理器，类似yum"></a>pip安装： pip是安装Python包的管理器，类似yum</h4> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install python-pip python-devel</span><br><span class="line">yum install gcc glibc-devel zibl-devel rpm-bulid openssl-devel</span><br><span class="line">pip install --upgrade pip</span><br><span class="line">pip install ansible --upgrade</span><br></pre></td></tr></table></figure><h4 id="确认安装："><a href="#确认安装：" class="headerlink" title="确认安装："></a>确认安装：</h4><p> <code>ansible --version</code></p><h3 id="配置Ansible"><a href="#配置Ansible" class="headerlink" title="配置Ansible"></a>配置Ansible</h3><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>&emsp;&emsp;<strong>/etc/ansible/ansible.cfg 主配置文件，配置ansible工作特性（一般保持默认）</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line"><span class="meta">#</span><span class="bash">inventory = /etc/ansible/hosts <span class="comment"># 主机列表配置文件</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">library = /usr/share/my_modules/ <span class="comment"># 库文件存放目录</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">remote_tmp = <span class="variable">$HOME</span>/.ansible/tmp <span class="comment">#临时py命令文件存放在远程主机目录</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">local_tmp = <span class="variable">$HOME</span>/.ansible/tmp <span class="comment"># 本机的临时命令执行目录</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">forks = 5 <span class="comment"># 默认并发数</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">sudo_user = root <span class="comment"># 默认sudo 用户</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ask_sudo_pass = True <span class="comment">#每次执行ansible命令是否询问ssh密码</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">ask_pass = True</span></span><br><span class="line"><span class="meta">#</span><span class="bash">remote_port = 22</span></span><br><span class="line"><span class="meta">#</span><span class="bash">host_key_checking = False <span class="comment"># 检查对应服务器的host_key，建议取消注释</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">log_path=/var/<span class="built_in">log</span>/ansible.log <span class="comment">#日志文件</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">module_name = <span class="built_in">command</span> <span class="comment">#默认模块</span></span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;<strong>/etc/ansible/hosts Inventory 主机清单</strong><br>&emsp;&emsp;ansible的主要功用在于批量主机操作，为了便捷地使用其中的部分主机，可以在inventory file中将其分组命名</p><ul><li>默认的inventory file为/etc/ansible/hosts</li><li>inventory file可以有多个，且也可以通过Dynamic Inventory来动态生成<br>文件格式</li><li>inventory文件遵循INI文件风格，中括号中的字符为组名。可以将同一个主机<br>同时归并到多个不同的组中；此外，当如若目标主机使用了非默认的SSH端口，<br>还可以在主机名称之后使用冒号加端口号来标明<br>ntp.servers.com<br>[webservers]<br>www1.webservers.com:2222<br>www2.webservers.com<br>[dbservers]<br>db1.dbservers.com<br>db2.dbservers.com<br>db3.dbservers.com<br>主机清单inventory</li><li>如果主机名称遵循相似的命名模式，还可以使用列表的方式标识各主机</li><li>示例：<br>[websrvs]<br>www[1:100].example.com<br>[dbsrvs]<br>db-[a:f].example.com</li></ul><p>&emsp;&emsp;<strong>/etc/ansible/roles/ 存放角色的目录</strong></p><h4 id="程序"><a href="#程序" class="headerlink" title="程序"></a>程序</h4><p>&emsp;&emsp;/usr/bin/ansible 主程序，临时命令执行工具<br>&emsp;&emsp;/usr/bin/ansible-doc 查看配置文档，模块功能查看工具<br>&emsp;&emsp;/usr/bin/ansible-galaxy 下载/上传优秀代码或Roles模块的官网平台<br>&emsp;&emsp;/usr/bin/ansible-playbook 定制自动化任务，编排剧本工具<br>&emsp;&emsp;/usr/bin/ansible-pull 远程执行命令的工具<br>&emsp;&emsp;/usr/bin/ansible-vault 文件加密工具<br>&emsp;&emsp;/usr/bin/ansible-console 基于Console界面与用户交互的执行工具</p><h3 id="Ansible命令"><a href="#Ansible命令" class="headerlink" title="Ansible命令"></a>Ansible命令</h3><ul><li>ansible </li><li>ansible-doc</li><li>ansible-playbook</li><li>ansible-vault</li><li>ansible-console</li><li>ansible-galaxy</li><li>ansible-pull<h4 id="ansible-doc-显示模块帮助"><a href="#ansible-doc-显示模块帮助" class="headerlink" title="ansible-doc: 显示模块帮助"></a>ansible-doc: 显示模块帮助</h4><code>ansible-doc [options] [module...]</code><br>&emsp;&emsp;-l, –list 列出可用模块<br>&emsp;&emsp;-s, –snippet显示指定模块的playbook片段<br>示例：<br>&emsp;&emsp;ansible-doc -l 列出所有模块<br>&emsp;&emsp;ansible-doc ping 查看指定模块帮助用法<br>&emsp;&emsp;ansible-doc -s ping 查看指定模块帮助用法<h4 id="ansible"><a href="#ansible" class="headerlink" title="ansible"></a>ansible</h4>&emsp;&emsp;ansible通过ssh实现配置管理、应用部署、任务执行等功能，建议配置ansible端能基于密钥认证的方式联系各被管理节点<br><code>ansible &amp;lthost-pattern&amp;gt [-m module_name] [-a args]</code><h5 id="ansible选项"><a href="#ansible选项" class="headerlink" title="ansible选项"></a>ansible选项</h5>&emsp;&emsp;–version 显示版本<br>&emsp;&emsp;-m module 指定模块，默认为command<br>&emsp;&emsp;-v 详细过程 –vv -vvv更详细<br>&emsp;&emsp;–list-hosts 显示主机列表，可简写 –list<br>&emsp;&emsp;-k, –ask-pass 提示输入ssh连接密码，默认Key验证<br>&emsp;&emsp;-C, –check 检查，并不执行<br>&emsp;&emsp;-T, –timeout=TIMEOUT 执行命令的超时时间，默认10s<br>&emsp;&emsp;-u, –user=REMOTE_USER 执行远程执行的用户<br>&emsp;&emsp;-b, –become 代替旧版的sudo 切换<br>&emsp;&emsp;–become-user=USERNAME 指定sudo的runas用户，默认为root<br>&emsp;&emsp;-K, –ask-become-pass 提示输入sudo时的口令</li></ul><h5 id="ansible的Host-pattern"><a href="#ansible的Host-pattern" class="headerlink" title="ansible的Host-pattern"></a>ansible的Host-pattern</h5><p>匹配主机的列表</p><ul><li>All ：表示所有Inventory中的所有主机<br><code>ansible all –m ping</code></li><li>* :通配符<br><code>ansible &quot;*&quot; -m ping</code><br><code>ansible 192.168.1.* -m ping</code><br><code>ansible &quot;*srvs&quot; -m ping</code></li><li>或关系<br><code>ansible &quot;websrvs:appsrvs&quot; -m ping</code><br><code>ansible &quot;192.168.1.10:192.168.1.20&quot; -m ping</code></li><li>逻辑与<br><code>ansible &quot;websrvs:&amp;dbsrvs&quot; –m ping</code><br>在websrvs组并且在dbsrvs组中的主机</li><li>逻辑非<br><code>ansible &#39;websrvs:!dbsrvs&#39; –m ping</code><br>在websrvs组，但不在dbsrvs组中的主机<br>注意：此处为单引号</li><li>综合逻辑<br><code>ansible &#39;websrvs:dbsrvs:&amp;appsrvs:!ftpsrvs&#39; –m ping</code></li><li>正则表达式<br><code>ansible &quot;websrvs:&amp;dbsrvs&quot; –m ping</code><br><code>ansible &quot;~(web|db).*.servers.com&quot; –m ping</code><h5 id="ansible常用模块"><a href="#ansible常用模块" class="headerlink" title="ansible常用模块"></a>ansible常用模块</h5>模块文档：<a href="https://docs.ansible.com/ansible/latest/modules/modules_by_category.html" rel="noopener" target="_blank">https://docs.ansible.com/ansible/latest/modules/modules_by_category.html</a></li><li>Command：在远程主机执行命令，<strong>默认模块，可忽略-m选项</strong><br><code>ansible srvs -m command -a &#39;service vsftpd start&#39;</code><br><code>ansible srvs -m command -a &#39;echo passwd |passwd --stdin user&#39;</code><strong>此命令不支持 $VARNAME &amp;lt &amp;gt | ; &amp; 等，须用shell模块实现</strong></li><li>Shell：和command相似，用shell执行命令<br><code>ansible srv -m shell -a ‘echo passwd |passwd –stdin user’</code><br>&emsp;&emsp;调用bash执行命令 类似<code>cat /tmp/stanley.md | awk -F&#39;|&#39; &#39;{print $1,$2}&#39;&amp;&gt; /tmp/example.txt</code>这些复杂命令，即使使用shell也可能会失败，解决办法：写到脚本时，copy到远程，执行，再把需要的结果拉回执行命令的机器</li><li>Script：在远程主机上运行ansible服务器上的脚本<br><code>ansible &amp;lthost-pattern&amp;gt -m script -a &quot;/PATH/TO/SCRIPT_FILE&quot;</code><br><code>ansible websrvs -m script -a /data/test.sh</code></li><li>Copy：从主控端复制文件到远程主机<br><code>ansible srv -m copy -a &quot;src=/root/test1.sh dest=/tmp/test2.showner=wang mode=600 backup=yes&quot;</code><br>如目标存在，默认覆盖，此处指定先备份<br><code>ansible srv -m copy -a &quot;content=&#39;test content\n&#39; dest=/tmp/test.txt&quot;</code><br>指定内容，直接生成目标文件</li><li>Fetch：从远程主机提取文件至主控端，copy相反，目前不支持目录<br><code>ansible srv -m fetch -a &#39;src=/root/test.sh dest=/data/scripts&#39;</code></li><li>File：设置文件属性<br><code>ansible srv -m file -a &quot;path=/root/test.sh owner=wang mode=755&quot;</code><br><code>ansible srv -m file -a &quot;path=/data/testdir state=directory&quot;</code><br><code>ansible srv -m file -a &#39;src=/data/testfile dest=/data/testfile-link state=link&#39;</code></li><li>unarchive：解包解压缩，有两种用法：<br>1、将ansible主机上的压缩包传到远程主机后解压缩至特定目录，设置copy=yes.<br>2、将远程主机上的某个压缩包解压缩到指定路径下，设置copy=no<br>常见参数：<br>copy：默认为yes，当copy=yes，拷贝的文件是从ansible主机复制到远程主机上，如果设置为copy=no，会在远程主机上寻找src源文件<br>src：源路径，可以是ansible主机上的路径，也可以是远程主机上的路径，如果是远程主机上的路径，则需要设置copy=no<br>dest：远程主机上的目标路径<br>mode：设置解压缩后的文件权限<br>示例：<br><code>ansible srv -m unarchive -a &#39;src=/data/foo.tgz dest=/var/lib/foo&#39;</code><br><code>ansible srv -m unarchive -a &#39;src=/tmp/foo.zip dest=/data copy=no mode=0777&#39;</code><br><code>ansible srv -m unarchive -a &#39;src=https://example.com/example.zip dest=/data copy=no&#39;</code></li><li>Archive：打包压缩<br><code>ansible all -m archive -a &#39;path=/etc/sysconfig dest=/data/sysconfig.tar.bz2 format=bz2 owner=wang mode=0777&#39;</code></li><li>Hostname：管理主机名<br><code>ansible node1 -m hostname -a &quot;name=websrv&quot;</code></li><li>Cron：计划任务<br>支持时间：minute，hour，day，month，weekday<br><code>ansible srv -m cron -a &quot;minute=*/5 job=&#39;/usr/sbin/ntpdate 172.16.0.1 &amp;&gt;/dev/null&#39; name=Synctime&quot;</code>创建任务<br><code>ansible srv -m cron -a &#39;state=absent name=Synctime&#39;</code>删除任务</li><li>Yum：管理包<br><code>ansible srv -m yum -a &#39;name=httpd state=present&#39;</code>安装<br><code>ansible srv -m yum -a &#39;name=httpd state=absent&#39;</code>删除<br>ansible常用模块</li><li>Service：管理服务<br><code>ansible srv -m service -a &#39;name=httpd state=stopped&#39;</code><br><code>ansible srv -m service -a &#39;name=httpd state=started enabled=yes&#39;</code><br><code>ansible srv -m service -a &#39;name=httpd state=reloaded&#39;</code><br><code>ansible srv -m service -a &#39;name=httpd state=restarted&#39;</code></li><li>User：管理用户<br><code>ansible srv -m user -a &#39;name=user1 comment=&quot;test user&quot; uid=2048home=/app/user1 group=root&#39;</code><br><code>ansible srv -m user -a &#39;name=sysuser1 system=yes home=/app/sysuser1&#39;</code><br><code>ansible srv -m user -a &#39;name=user1 state=absent remove=yes&#39;</code><br>删除用户及家目录等数据</li><li>Group：管理组<br><code>ansible srv -m group -a &quot;name=testgroup system=yes&quot;</code><br><code>ansible srv -m group -a &quot;name=testgroup state=absent&quot;</code><h5 id="ansible命令执行过程"><a href="#ansible命令执行过程" class="headerlink" title="ansible命令执行过程"></a>ansible命令执行过程</h5>&emsp;&emsp;1. 加载自己的配置文件 默认/etc/ansible/ansible.cfg<br>&emsp;&emsp;2. 加载自己对应的模块文件，如command<br>&emsp;&emsp;3. 通过ansible将模块或命令生成对应的临时py文件，并将该文件传输至远程服<br>务器的对应执行用户$HOME/.ansible/tmp/ansible-tmp-数字/XXX.PY文件<br>&emsp;&emsp;4. 给文件+x执行<br>&emsp;&emsp;5. 执行并返回结果<br>&emsp;&emsp;6. 删除临时py文件，退出<br>&emsp;&emsp;执行状态：<br>&emsp;&emsp;&emsp;&emsp;绿色：执行成功并且不需要做改变的操作<br>&emsp;&emsp;&emsp;&emsp;黄色：执行成功并且对目标主机做变更<br>&emsp;&emsp;&emsp;&emsp;红色：执行失败<h4 id="ansible-galaxy"><a href="#ansible-galaxy" class="headerlink" title="ansible-galaxy"></a>ansible-galaxy</h4>&emsp;&emsp;连接 <a href="https://galaxy.ansible.com" rel="noopener" target="_blank">https://galaxy.ansible.com</a> 下载相应的roles<br><code>ansible-galaxy</code><br>&emsp;&emsp;列出所有已安装的galaxy<br><code>ansible-galaxy list</code><br>&emsp;&emsp;安装galaxy<br><code>ansible-galaxy install geerlingguy.redis</code><br>&emsp;&emsp;删除galaxy<br><code>ansible-galaxy remove geerlingguy.redis</code><h4 id="ansible-pull"><a href="#ansible-pull" class="headerlink" title="ansible-pull"></a>ansible-pull</h4>&emsp;&emsp;推送命令至远程，效率无限提升，对运维要求较高<h4 id="ansible-playbook"><a href="#ansible-playbook" class="headerlink" title="ansible-playbook"></a>ansible-playbook</h4>&emsp;&emsp;执行playbook<br>&emsp;&emsp; 示例：ansible-playbook hello.yml<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#hello world yml file</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">hello</span> <span class="string">world</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">/usr/bin/wall</span> <span class="string">hello</span> <span class="string">world</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="ansible-vault"><a href="#ansible-vault" class="headerlink" title="ansible-vault"></a>ansible-vault</h4><p>&emsp;&emsp;功能：管理加密解密yml文件<br><code>ansible-vault [create|decrypt|edit|encrypt|rekey|view]</code><br><code>ansible-vault encrypt hello.yml</code> 加密<br><code>ansible-vault decrypt hello.yml</code> 解密<br><code>ansible-vault view hello.yml</code> 查看<br><code>ansible-vault edit hello.yml</code> 编辑加密文件<br><code>ansible-vault rekey hello.yml</code> 修改口令<br><code>ansible-vault create new.yml</code> 创建新文件</p><h4 id="Ansible-console"><a href="#Ansible-console" class="headerlink" title="Ansible-console"></a>Ansible-console</h4><p>&emsp;&emsp;ansible终端。2.0+新增，可交互执行命令，支持tab<br><code>root@test (2)[f:10] $</code><br> 执行用户@当前操作的主机组 (当前组的主机数量)[f:并发数]$</p><ul><li>设置并发数： forks n 例如： forks 10</li><li>切换组： cd 主机组 例如： cd web</li><li>列出当前组主机列表： list</li><li>列出所有的内置命令： ?或help</li><li>示例：<br>root@all (2)[f:5]$ list<br>root@all (2)[f:5]$ cd appsrvs<br>root@appsrvs (2)[f:5]$ list<br>root@appsrvs (2)[f:5]$ yum name=httpd state=present<br>root@appsrvs (2)[f:5]$ service name=httpd state=started<h3 id="playbook"><a href="#playbook" class="headerlink" title="playbook"></a>playbook</h3></li><li>playbook是由一个或多个“play”组成的列表</li><li>play的主要功能在于将预定义的一组主机，装扮成事先通过ansible中的task定义好的角色。Task实际是调用ansible的一个module，将多个play组织在一个playbook中，即可以让它们联合起来，按事先编排的机制执行预定义的动作</li><li>Playbook采用YAML语言编写</li></ul><p><img src="https://img-blog.csdnimg.cn/20191007191809637.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h4 id="playbook核心元素"><a href="#playbook核心元素" class="headerlink" title="playbook核心元素"></a>playbook核心元素</h4><ul><li>Hosts 执行的远程主机列表</li><li>Tasks 任务集</li><li>Variables 内置变量或自定义变量在playbook中调用</li><li>Templates 模板，可替换模板文件中的变量并实现一些简单逻辑的文件</li><li>Handlers 和 notify 结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行</li><li>tags 标签 指定某条任务执行，用于选择运行playbook中的部分代码。ansible具有幂等性，因此会自动跳过没有变化的部分，即便如此，有些代码为测试其确实没有发生变化的时间依然会非常地长。此时，如果确信其没有变化，就可以通过tags跳过此些代码片断<br><code>ansible-playbook -t tagsname useradd.yml</code><h4 id="playbook基础组件"><a href="#playbook基础组件" class="headerlink" title="playbook基础组件"></a>playbook基础组件</h4></li><li>Hosts：<br>&emsp;&emsp;playbook中的每一个play的目的都是为了让特定主机以某个指定的用户身份执行任务。hosts用于指定要执行指定任务的主机，须事先定义在主机清单中。可以是如下形式：<br>one.example.com<br>one.example.com:two.example.com</li></ul><p>192.168.1.50<br>192.168.1.*<br>Websrvs:dbsrvs 或者，两个组的并集<br>Websrvs:&amp;dbsrvs 与，两个组的交集<br>webservers:!phoenix 在websrvs组，但不在dbsrvs组<br> 示例: - hosts: websrvs：dbsrvs</p><ul><li><p>remote_user<br>&emsp;&emsp;remote_user: 可用于Host和task中。也可以通过指定其通过sudo的方式在远程主机上执行任务，其可用于play全局或某任务；此外，甚至可以在sudo时使用sudo_user指定sudo时切换的用户</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">test</span> <span class="string">connection</span></span><br><span class="line"><span class="attr">    ping:</span></span><br><span class="line"><span class="attr">    remote_user:</span> <span class="string">user</span></span><br><span class="line"><span class="attr">    sudo:</span> <span class="literal">yes</span>           <span class="string">默认sudo为root</span></span><br><span class="line"><span class="attr">    sudo_user:</span> <span class="string">wang</span>      <span class="string">sudo为wang</span></span><br></pre></td></tr></table></figure></li><li><p>task列表和action<br>&emsp;&emsp;play的主体部分是task list，task list中的各任务按次序逐个在hosts中指定的所有主机上执行，即在所有主机上完成第一个任务后，再开始第二个任务<br>&emsp;&emsp;task的目的是使用指定的参数执行模块，而在模块参数中可以使用变量。模块执行是幂等的，这意味着多次执行是安全的，因为其结果均一致<br>&emsp;&emsp;每个task都应该有其name，用于playbook的执行结果输出，建议其内容能清晰地描述任务执行步骤。如果未提供name，则action的结果将用于输出playbook基础组件<br>&emsp;&emsp;tasks：任务列表<br>&emsp;&emsp;两种格式：<br>(1) action: module arguments<br>(2) module: arguments 建议使用<br>&emsp;&emsp;<strong>注意：shell和command模块后面跟命令，而非key=value</strong><br>&emsp;&emsp;某任务的状态在运行后为changed时，可通过“notify”通知给相应的handlers<br>&emsp;&emsp;任务可以通过”tags“打标签，可在ansible-playbook命令上使用-t指定进行调用<br>示例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr"> - name:</span> <span class="string">disable</span> <span class="string">selinux</span></span><br><span class="line"><span class="attr">   command:</span> <span class="string">/sbin/setenforce</span> <span class="number">0</span></span><br></pre></td></tr></table></figure></li></ul><p>&emsp;&emsp;如果命令或脚本的退出码不为零，可以使用如下方式替代<br> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr"> - name:</span> <span class="string">run</span> <span class="string">this</span> <span class="string">command</span> <span class="string">and</span> <span class="string">ignore</span> <span class="string">the</span> <span class="string">result</span></span><br><span class="line"><span class="attr">   shell:</span> <span class="string">/usr/bin/somecommand</span> <span class="string">||</span> <span class="string">/bin/true</span></span><br></pre></td></tr></table></figure></p><p>&emsp;&emsp;或者使用ignore_errors来忽略错误信息<br> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">run</span> <span class="string">this</span> <span class="string">command</span> <span class="string">and</span> <span class="string">ignore</span> <span class="string">the</span> <span class="string">result</span></span><br><span class="line"><span class="attr">    shell:</span> <span class="string">/usr/bin/somecommand</span></span><br><span class="line"><span class="attr">    ignore_errors:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure></p><h4 id="运行playbook"><a href="#运行playbook" class="headerlink" title="运行playbook"></a>运行playbook</h4><ul><li>运行playbook的方式<br><code>ansible-playbook &amp;ltfilename.yml&amp;gt ... [options]</code></li><li>常见选项</li><li>-check -C 只检测可能会发生的改变，但不真正执行操作</li><li>-list-hosts 列出运行任务的主机</li><li>-list-tags 列出tag</li><li>-list-tasks 列出task</li><li>-limit 主机列表 只针对主机列表中的主机执行</li><li>v -vv -vvv 显示过程</li><li>示例<br><code>ansible-playbook file.yml --check</code> 只检测<br><code>ansible-playbook file.yml</code><br><code>ansible-playbook file.yml --limit websrvs</code><br>&emsp;&emsp;可以<strong>对比下SHELL脚本VSPlaybook</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装Apache</span></span><br><span class="line">yum install --quiet -y httpd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 复制配置文件</span></span><br><span class="line">cp /tmp/httpd.conf /etc/httpd/conf/httpd.conf</span><br><span class="line">cp /tmp/vhosts.conf /etc/httpd/conf.d/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动Apache，并设置开机启动</span></span><br><span class="line">service httpd start</span><br><span class="line">chkconfig httpd on</span><br></pre></td></tr></table></figure></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">"安装Apache"</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">name=httpd</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">"复制配置文件"</span></span><br><span class="line"><span class="attr">    copy:</span> <span class="string">src=/tmp/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">"复制配置文件"</span></span><br><span class="line"><span class="attr">    copy:</span> <span class="string">src=/tmp/vhosts.conf</span> <span class="string">dest=/etc/httpd/conf.d/</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">"启动Apache，并设置开机启动"</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure><p><strong>示例：sysuser.yml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">create</span> <span class="string">mysql</span> <span class="string">user</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">name=mysql</span> <span class="string">system=yes</span> <span class="string">uid=36</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">create</span> <span class="string">a</span> <span class="string">group</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">name=httpd</span> <span class="string">system=yes</span></span><br></pre></td></tr></table></figure><p><strong>示例：httpd.yml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Install</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Install</span> <span class="string">configure</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    copy:</span> <span class="string">src=files/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure><h4 id="handlers和notify结合使用触发条件"><a href="#handlers和notify结合使用触发条件" class="headerlink" title="handlers和notify结合使用触发条件"></a>handlers和notify结合使用触发条件</h4><ul><li>Handlers是task列表，这些task与前述的task并没有本质上的不同,用于当关注的资源发生变化时，才会采取一定的操作</li><li>Notify此action可用于在每个play的最后被触发，这样可避免多次有改变发生时每次都执行指定的操作，仅在所有的变化发生完成后一次性地执行指定操作。<br>在notify中列出的操作称为handler，也即notify中调用handler中定义的操作<h4 id="Playbook中handlers使用"><a href="#Playbook中handlers使用" class="headerlink" title="Playbook中handlers使用"></a>Playbook中handlers使用</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Install</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Install</span> <span class="string">configure</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    copy:</span> <span class="string">src=files/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span></span><br><span class="line"><span class="attr">    notify:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br><span class="line"><span class="attr">    handlers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure></li></ul><p>示例</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">add</span> <span class="string">group</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    tags:</span> <span class="string">user</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">add</span> <span class="string">user</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span> <span class="string">group=nginx</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Install</span> <span class="string">Nginx</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">config</span></span><br><span class="line"><span class="attr">    copy:</span> <span class="string">src=/root/config.txt</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br><span class="line"><span class="attr">    notify:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">Restart</span> <span class="string">Nginx</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">Check</span> <span class="string">Nginx</span> <span class="string">Process</span></span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Restart</span> <span class="string">Nginx</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=nginx</span> <span class="string">state=restarted</span> <span class="string">enabled=yes</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Check</span> <span class="string">Nginx</span> <span class="string">process</span></span><br><span class="line"><span class="attr">      shell:</span> <span class="string">killall</span> <span class="bullet">-0</span> <span class="string">nginx</span> <span class="string">&amp;&gt;</span> <span class="string">/tmp/nginx.log</span></span><br></pre></td></tr></table></figure><h4 id="Playbook中tags使用"><a href="#Playbook中tags使用" class="headerlink" title="Playbook中tags使用"></a>Playbook中tags使用</h4><p>示例：httpd.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Install</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Install</span> <span class="string">configure</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    copy:</span> <span class="string">src=files/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span></span><br><span class="line"><span class="attr">    tags:</span> <span class="string">conf</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">start</span> <span class="string">httpd</span> <span class="string">service</span></span><br><span class="line"><span class="attr">    tags:</span> <span class="string">service</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure><p> <code>ansible-playbook –t conf httpd.yml</code></p><h4 id="Playbook中变量使用"><a href="#Playbook中变量使用" class="headerlink" title="Playbook中变量使用"></a>Playbook中变量使用</h4><h5 id="变量名："><a href="#变量名：" class="headerlink" title="变量名："></a>变量名：</h5><p>&emsp;&emsp;仅能由字母、数字和下划线组成，且只能以字母开头</p><h5 id="变量来源："><a href="#变量来源：" class="headerlink" title="变量来源："></a>变量来源：</h5><ul><li><p>1 ansible setup facts 远程主机的所有变量都可直接调用</p></li><li><p>2 在/etc/ansible/hosts中定义<br>普通变量：主机组中主机单独定义，优先级高于公共变量<br>公共（组）变量：针对主机组中所有主机定义统一变量</p></li><li><p>3 通过命令行指定变量，优先级最高<br>ansible-playbook –e varname=value</p></li><li><p>4 在playbook中定义</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vars:</span><br><span class="line">  - var1: value1</span><br><span class="line">  - var2: value2</span><br></pre></td></tr></table></figure></li><li><p>5 在独立的变量YAML文件中定义</p></li><li><p>6 在role中定义</p></li></ul><h5 id="变量命名"><a href="#变量命名" class="headerlink" title="变量命名:"></a>变量命名:</h5><p>&emsp;&emsp; 变量名仅能由字母、数字和下划线组成，且只能以字母开头</p><h5 id="变量定义："><a href="#变量定义：" class="headerlink" title="变量定义："></a>变量定义：</h5><p>&emsp;&emsp;key=value<br>示例：http_port=80</p><h5 id="变量调用方式："><a href="#变量调用方式：" class="headerlink" title="变量调用方式："></a>变量调用方式：</h5><ul><li>通过 调用变量，且变量名前后必须有空格，有时用“”才生效</li><li>ansible-playbook –e 选项指定<br><code>ansible-playbook test.yml -e &quot;hosts=www user=servers&quot;</code><br>示例：使用setup变量<br>示例：var.yml<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">create</span> <span class="string">log</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    file:</span> <span class="string">name=/var/log/</span> <span class="string">&#123;&#123;</span> <span class="string">ansible_fqdn</span> <span class="string">&#125;&#125;</span> <span class="string">state=touch</span></span><br></pre></td></tr></table></figure></li></ul><p><code>ansible-playbook var.yml</code><br>示例：var.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">pkname</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br></pre></td></tr></table></figure><p><code>ansible-playbook –e pkname=httpd var.yml</code></p><p>示例：var.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">  - username:</span> <span class="string">user1</span></span><br><span class="line"><span class="attr">  - groupname:</span> <span class="string">group1</span></span><br><span class="line"><span class="attr">    tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">create</span> <span class="string">group</span></span><br><span class="line"><span class="attr">      group:</span> <span class="string">name=&#123;&#123;</span> <span class="string">groupname</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">create</span> <span class="string">user</span></span><br><span class="line"><span class="attr">      user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">username</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br></pre></td></tr></table></figure><p> <code>ansible-playbook var.yml</code><br><code>ansible-playbook -e &quot;username=user2 groupname=group2” var2.yml</code></p><h5 id="变量来源"><a href="#变量来源" class="headerlink" title="变量来源:"></a>变量来源:</h5><ul><li><p>主机变量<br>&emsp;&emsp;可以在inventory中定义主机时为其添加主机变量以便于在playbook中使用<br>示例：<br>[websrvs]<br>www1.servers.com http_port=80 maxRequestsPerChild=808<br>www2.servers.com http_port=8080 maxRequestsPerChild=909</p></li><li><p>组变量<br>&emsp;&emsp;组变量是指赋予给指定组内所有主机上的在playbook中可用的变量<br>示例：<br>[websrvs]<br>www1.servers.com<br>www2.servers.com<br>[websrvs:vars]<br>ntp_server=ntp.servers.com<br>nfs_server=nfs.servers.com<br>示例：变量</p></li><li><p>普通变量<br>[websrvs]</p></li></ul><p>192.168.99.101 http_port=8080 hname=www1<br>192.168.99.102 http_port=80 hname=www2</p><ul><li>公共（组）变量<br>[websvrs:vars]<br>http_port=808<br>mark=“-”<br>[websrvs]</li></ul><p>192.168.99.101 http_port=8080 hname=www1<br>192.168.99.102 http_port=80 hname=www2<br>ansible websvrs –m hostname –a ‘name=’</p><ul><li>命令行指定变量：<br><code>ansible websvrs –e http_port=8000 –m hostname –a</code><br><code>&#39;name=&#39;</code></li><li>使用变量文件<br><code>cat vars.yml</code><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">var1:</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">var2:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure></li></ul><p><code>cat var.yml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars_files:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">vars.yml</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">create</span> <span class="string">httpd</span> <span class="string">log</span></span><br><span class="line"><span class="attr">    file:</span> <span class="string">name=/app/&#123;&#123;</span> <span class="string">var1</span> <span class="string">&#125;&#125;.log</span> <span class="string">state=touch</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">create</span> <span class="string">nginx</span> <span class="string">log</span></span><br><span class="line"><span class="attr">    file:</span> <span class="string">name=/app/&#123;&#123;</span> <span class="string">var2</span> <span class="string">&#125;&#125;.log</span> <span class="string">state=touch</span></span><br></pre></td></tr></table></figure><h3 id="模板template"><a href="#模板template" class="headerlink" title="模板template"></a>模板template</h3><ul><li>文本文件，嵌套有脚本（使用模板编程语言编写）</li><li>Jinja2语言，使用字面量，有下面形式<br>字符串：使用单引号或双引号<br>数字：整数，浮点数<br>列表：[item1, item2, …]<br>元组：(item1, item2, …)<br>字典：{key1:value1, key2:value2, …}<br>布尔型：true/false</li><li>算术运算：+, -, <em>, /, //, %, *</em></li><li>比较操作：==, !=, &gt;, &gt;=, &lt;, &lt;=</li><li>逻辑运算：and，or，not</li><li>流表达式：For，If，When</li></ul><h4 id="template功能："><a href="#template功能：" class="headerlink" title="template功能："></a>template功能：</h4><h5 id="根据模块文件动态生成对应的配置文件"><a href="#根据模块文件动态生成对应的配置文件" class="headerlink" title="根据模块文件动态生成对应的配置文件"></a>根据模块文件动态生成对应的配置文件</h5><ul><li>template文件必须存放于templates目录下，且命名为 .j2 结尾</li><li>yaml/yml 文件需和templates目录平级，目录结构如下：<br>./<br>├── temnginx.yml<br>└── templates<br>└── nginx.conf.j2</li></ul><p>template示例<br>示例：利用template 同步nginx配置文件</p><ul><li>准备templates/nginx.conf.j2文件<br><code>vim temnginx.yml</code><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">template</span> <span class="string">config</span> <span class="string">to</span> <span class="string">remote</span> <span class="string">hosts</span></span><br><span class="line"><span class="attr">      template:</span> <span class="string">src=nginx.conf.j2</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br></pre></td></tr></table></figure></li></ul><p><code>ansible-playbook temnginx.yml</code></p><ul><li>Playbook中template变更替换<br>修改文件nginx.conf.j2 下面行为<br><code>worker_processes ;</code><br><code>cat temnginx2.yml</code><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">template</span> <span class="string">config</span> <span class="string">to</span> <span class="string">remote</span> <span class="string">hosts</span></span><br><span class="line"><span class="attr">      template:</span> <span class="string">src=nginx.conf.j2</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br></pre></td></tr></table></figure></li></ul><p><code>ansible-playbook temnginx2.yml</code></p><h5 id="Playbook中template算术运算"><a href="#Playbook中template算术运算" class="headerlink" title="Playbook中template算术运算"></a>Playbook中template算术运算</h5><p>示例：<br><code>vim nginx.conf.j2</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">worker_processes</span> <span class="string">&#123;&#123;</span> <span class="string">ansible_processor_vcpus**2</span> <span class="string">&#125;&#125;;</span></span><br><span class="line"><span class="string">worker_processes</span> <span class="string">&#123;&#123;</span> <span class="string">ansible_processor_vcpus+2</span> <span class="string">&#125;&#125;;</span></span><br></pre></td></tr></table></figure><h4 id="template条件判断"><a href="#template条件判断" class="headerlink" title="template条件判断"></a>template条件判断</h4><h5 id="when"><a href="#when" class="headerlink" title="when"></a>when</h5><p>&emsp;&emsp;条件测试:如果需要根据变量、facts或此前任务的执行结果来做为某task执行与否的前提时要用到条件测试,通过when语句实现，在task中使用，jinja2的语法格式<br>when语句<br>&emsp;&emsp;在task后添加when子句即可使用条件测试；when语句支持Jinja2表达式语法<br>示例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">"shutdown RedHat flavored systems"</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">/sbin/shutdown</span> <span class="bullet">-h</span> <span class="string">now</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"RedHat"</span></span><br></pre></td></tr></table></figure><p>示例：when条件判断</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">add</span> <span class="string">group</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      tags:</span> <span class="string">user</span></span><br><span class="line"><span class="attr">      user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">add</span> <span class="string">user</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span> <span class="string">group=nginx</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Install</span> <span class="string">Nginx</span></span><br><span class="line"><span class="attr">      yum:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">restart</span> <span class="string">Nginx</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=nginx</span> <span class="string">state=restarted</span></span><br><span class="line"><span class="attr">      when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">“6”</span></span><br></pre></td></tr></table></figure><p>示例：when条件判断</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">install</span> <span class="string">conf</span> <span class="string">file</span> <span class="string">to</span> <span class="string">centos7</span></span><br><span class="line"><span class="attr">    template:</span> <span class="string">src=nginx.conf.c7.j2</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">"7"</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">install</span> <span class="string">conf</span> <span class="string">file</span> <span class="string">to</span> <span class="string">centos6</span></span><br><span class="line"><span class="attr">    template:</span> <span class="string">src=nginx.conf.c6.j2</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">"6"</span></span><br></pre></td></tr></table></figure><h5 id="迭代：with-items"><a href="#迭代：with-items" class="headerlink" title="迭代：with_items"></a>迭代：with_items</h5><p>迭代：当有需要重复性执行的任务时，可以使用迭代机制</p><ul><li>对迭代项的引用，固定变量名为”item“</li><li>要在task中使用with_items给定要迭代的元素列表</li><li>列表格式：<br>&emsp;&emsp;字符串<br>&emsp;&emsp;字典<br>示例：<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">add</span> <span class="string">several</span> <span class="string">users</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span> <span class="string">groups=wheel</span></span><br><span class="line"><span class="attr">  with_items:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">testuser1</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">testuser2</span></span><br></pre></td></tr></table></figure></li></ul><p>&emsp;&emsp;上面语句的功能等同于下面的语句：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">add</span> <span class="string">user</span> <span class="string">testuser1</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">name=testuser1</span> <span class="string">state=present</span> <span class="string">groups=wheel</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">add</span> <span class="string">user</span> <span class="string">testuser2</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">name=testuser2</span> <span class="string">state=present</span> <span class="string">groups=wheel</span></span><br></pre></td></tr></table></figure><p>示例：将多个文件进行copy到被控端</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">testsrv</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Create</span> <span class="string">rsyncd</span> <span class="string">config</span></span><br><span class="line"><span class="attr">      copy:</span> <span class="string">src=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">dest=/etc/&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">      with_items:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">rsyncd.secrets</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">rsyncd.conf</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">copy</span> <span class="string">file</span></span><br><span class="line"><span class="attr">      copy:</span> <span class="string">src=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">dest=/tmp/&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">      with_items:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">file1</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">file2</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">file3</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">yum</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">      yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">      with_items:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">apr</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">apr-util</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">httpd</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">install</span> <span class="string">some</span> <span class="string">packages</span></span><br><span class="line"><span class="attr">      yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">      with_items:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">nginx</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">memcached</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">php-fpm</span></span><br></pre></td></tr></table></figure><p>示例：迭代嵌套子变量</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">hosts：websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">add</span> <span class="string">some</span> <span class="string">groups</span></span><br><span class="line"><span class="attr">      group:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">      with_items:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">group1</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">group2</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">group3</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">add</span> <span class="string">some</span> <span class="string">users</span></span><br><span class="line"><span class="attr">      user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item.name</span> <span class="string">&#125;&#125;</span> <span class="string">group=&#123;&#123;</span> <span class="string">item.group</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">      with_items:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'user1'</span><span class="string">,</span> <span class="attr">group:</span> <span class="string">'group1'</span> <span class="string">&#125;</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'user2'</span><span class="string">,</span> <span class="attr">group:</span> <span class="string">'group2'</span> <span class="string">&#125;</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'user3'</span><span class="string">,</span> <span class="attr">group:</span> <span class="string">'group3'</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h5 id="Playbook中template-for-if"><a href="#Playbook中template-for-if" class="headerlink" title="Playbook中template for if"></a>Playbook中template for if</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;%</span> <span class="string">for</span> <span class="string">vhost</span> <span class="string">in</span> <span class="string">nginx_vhosts</span> <span class="string">%&#125;</span></span><br><span class="line"><span class="string">server</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">listen</span> <span class="string">&#123;&#123;</span> <span class="string">vhost.listen</span> <span class="string">| default('80 default_server') &#125;&#125;;</span></span><br><span class="line"><span class="string">&#123;% if vhost.server_name is defined %&#125;</span></span><br><span class="line"><span class="string">server_name <span class="template-variable">&#123;&#123; vhost.server_name &#125;&#125;</span>;</span></span><br><span class="line"><span class="string">&#123;% endif %&#125;</span></span><br><span class="line"><span class="string">&#123;% if vhost.root is defined %&#125;</span></span><br><span class="line"><span class="string">root <span class="template-variable">&#123;&#123; vhost.root &#125;&#125;</span>;</span></span><br><span class="line"><span class="string">&#123;% endif %&#125;</span></span><br><span class="line"><span class="string">&#123;% endfor %&#125;</span></span><br></pre></td></tr></table></figure><h3 id="roles"><a href="#roles" class="headerlink" title="roles"></a>roles</h3><p>&emsp;&emsp;ansible自1.2版本引入的新特性，用于层次性、结构化地组织playbook。roles能够根据层次型结构自动装载变量文件、tasks以及handlers等。要使用roles只需要在playbook中使用include指令即可。简单来讲，roles就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并可以便捷地include它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中。<br>&emsp;&emsp;复杂场景：建议使用roles，代码复用度高</p><ul><li>变更指定主机或主机组</li><li>如命名不规范维护和传承成本大</li><li>某些功能需多个Playbook，通过includes即可实现<h4 id="roles-1"><a href="#roles-1" class="headerlink" title="roles"></a>roles</h4>角色(roles)：角色集合<br>roles/<br>&emsp;mysql/<br>&emsp;httpd/<br>&emsp;nginx/<br>&emsp;memcached/<h4 id="Ansible-Roles目录编排"><a href="#Ansible-Roles目录编排" class="headerlink" title="Ansible Roles目录编排"></a>Ansible Roles目录编排</h4><img src="https://img-blog.csdnimg.cn/20191007213354915.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><h4 id="roles目录结构"><a href="#roles目录结构" class="headerlink" title="roles目录结构"></a>roles目录结构</h4>&emsp;&emsp;每个角色，以特定的层级目录结构进行组织<br>roles目录结构：<br>playbook.yml<br>&emsp;roles/<br>&emsp;project/<br>&emsp;tasks/<br>&emsp;files/<br>&emsp;vars/<br>&emsp;templates/<br>&emsp;handlers/<br>&emsp;default/ 不常用<br>&emsp;meta/ 不常用<h4 id="Roles各目录作用"><a href="#Roles各目录作用" class="headerlink" title="Roles各目录作用"></a>Roles各目录作用</h4></li><li>/roles/project/ :项目名称,有以下子目录</li><li>files/ ：存放由copy或script模块等调用的文件</li><li>templates/：template模块查找所需要模板文件的目录</li><li>tasks/：定义task,role的基本元素，至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含</li><li>handlers/：至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含</li><li>vars/：定义变量，至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含</li><li>meta/：定义当前角色的特殊设定及其依赖关系,至少应该包含一个名为main.yml的文件，其它文件需在此文件中通过include进行包含</li><li>default/：设定默认变量时使用此目录中的main.yml文件<h4 id="创建role"><a href="#创建role" class="headerlink" title="创建role"></a>创建role</h4><h5 id="创建role的步骤"><a href="#创建role的步骤" class="headerlink" title="创建role的步骤"></a>创建role的步骤</h5>(1) 创建以roles命名的目录<br>(2) 在roles目录中分别创建以各角色名称命名的目录，如webservers等<br>(3) 在每个角色命名的目录中分别创建files、handlers、meta、tasks、templates和vars目录；用不到的目录可以创建为空目录，也可以不创建<br>(4) 在playbook文件中，调用各角色<h5 id="针对大型项目使用Roles进行编排"><a href="#针对大型项目使用Roles进行编排" class="headerlink" title="针对大型项目使用Roles进行编排"></a>针对大型项目使用Roles进行编排</h5>roles目录结构：<br>playbook.yml<br>roles/<br>&emsp;project/<br>&emsp;&emsp;tasks/<br>&emsp;&emsp;files/<br>&emsp;&emsp;vars/<br>&emsp;&emsp;templates/<br>&emsp;&emsp;handlers/<br>&emsp;&emsp;default/ # 不经常用<br>&emsp;&emsp;meta/ # 不经常用<br>示例：<br>nginx-role.yml<br>roles/<br>└── nginx<br>├── files<br>│ └── main.yml<br>├── tasks<br>│ ├── groupadd.yml<br>│ ├── install.yml<br>│ ├── main.yml<br>│ ├── restart.yml<br>│ └── useradd.yml<br>└── vars<br>└── main.yml<h4 id="playbook调用角色"><a href="#playbook调用角色" class="headerlink" title="playbook调用角色"></a>playbook调用角色</h4><h5 id="调用角色方法1："><a href="#调用角色方法1：" class="headerlink" title="调用角色方法1："></a>调用角色方法1：</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr"> remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr"> roles:</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">mysql</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">memcached</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure></li></ul><h5 id="调用角色方法2："><a href="#调用角色方法2：" class="headerlink" title="调用角色方法2："></a>调用角色方法2：</h5><p>&emsp;&emsp;传递变量给角色</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span></span><br><span class="line"><span class="attr">  remote_user:</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">mysql</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">nginx,</span> <span class="attr">username:</span> <span class="string">nginx</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 键role用于指定角色名称<br>&emsp;&emsp; 后续的k/v用于传递变量给角色</p><h5 id="调用角色方法3："><a href="#调用角色方法3：" class="headerlink" title="调用角色方法3："></a>调用角色方法3：</h5><p>&emsp;&emsp;还可基于条件测试实现角色调用</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">roles:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">nginx,</span> <span class="attr">username:</span> <span class="string">nginx,</span> <span class="attr">when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">‘7’</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="roles-playbook-tags使用"><a href="#roles-playbook-tags使用" class="headerlink" title="roles playbook tags使用"></a>roles playbook tags使用</h4><p> roles playbook tags使用<br><code>ansible-playbook --tags=&quot;nginx,httpd,mysql&quot; nginx-role.yml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//</span> <span class="string">nginx-role.yml</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">testweb</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">nginx</span> <span class="string">,tags:</span> <span class="string">[</span> <span class="string">'nginx'</span><span class="string">,</span> <span class="string">'web'</span> <span class="string">]</span> <span class="string">,when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">"6“ &#125;</span></span><br><span class="line"><span class="string">    - &#123; role: httpd ,tags: [ 'httpd', 'web' ] &#125;</span></span><br><span class="line"><span class="string">    - &#123; role: mysql ,tags: [ 'mysql', 'db' ] &#125;</span></span><br><span class="line"><span class="string">    - &#123; role: marridb ,tags: [ 'mysql', 'db' ] &#125;</span></span><br><span class="line"><span class="string">    - &#123; role: php &#125;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> linux进阶 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> 总结 </tag>
            
            <tag> Ansible </tag>
            
            <tag> YAML </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>myql数据库MHA实现高可用（多实例间实现）</title>
      <link href="//blog/108203a7.html"/>
      <url>//blog/108203a7.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp; MHA(master high   availability)目前是MySQL高可用方面是一个相对成熟的解决方案。在切换过程中，mha能做到0-30s内自动完成数据库的切换，并且在切换过程中最大的保持数据的一致性，以达到真正意义上的高可用</p><p>&emsp;&emsp; MHA的组成：</p><a id="more"></a><p>&emsp;&emsp; MHA Manager(管理节点)和MHA Node(数据节点)。MHA Manager可以独立部署在一台独立的机器上，管理多个集群，也可以部署在从从库上。</p><p>&emsp;&emsp; 当Master出现故障的时候，它可以自动将最新的数据的Slave提升为新的Master，然后将所有的Slave重新指向新的Master，整个故障转移过程是完全透明的。<br>&emsp;&emsp; 实验演示图如下：<br><img src="https://img-blog.csdnimg.cn/2019092709363970.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp; 操作如下：<br>&emsp;&emsp; 1、在192.168.32.71主机和192.168.32.72主机上搭建好1主3从的主从配置服务器；<br>&emsp;&emsp; 2、在192.168.32.7主机作为监控主机，安装mhamanager包和node包，192.168.32.71主机、192.168.32.72主机只安装node包；<br>&emsp;&emsp; 3、将三台主机的ssh公钥信息互相储存（或公用一个公钥私钥对），设置好相互之间的基于key验证免密登录。<strong>（因为用的是多实例数据库，SSH连通性验证时还会检查各个数据库之间的连通性，这就包括3307、3308、3309端口数据库之间的SSH连接，所以一定要在192.168.32.72主机家目录的.ssh/authorized_keys文件中加入192.168.32.72本机的公钥，否则会报错，切记，已踩坑）</strong><br>&emsp;&emsp; 4、编写mha配置文件，路径随意。<code>vim /etc/mha.cnf</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[server default]</span></span><br><span class="line"><span class="attr">user</span>=mhauser</span><br><span class="line"><span class="attr">password</span>=mhuser</span><br><span class="line"><span class="attr">manager_workdir</span>=/data/mastermha/group1/</span><br><span class="line"><span class="attr">manager_log</span>=/data/mastermha/group1/manager.log</span><br><span class="line"><span class="attr">remote_workdir</span>=/data/mastermha/group1/</span><br><span class="line"><span class="attr">ssh_user</span>=root</span><br><span class="line"><span class="attr">repl_user</span>=repluser</span><br><span class="line"><span class="attr">repl_password</span>=repluser</span><br><span class="line"><span class="attr">ping_interval</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">master_binlog_dir</span>=/data/mysql</span><br><span class="line"><span class="section">[server1]</span></span><br><span class="line"><span class="attr">hostname</span>=<span class="number">192.168</span>.<span class="number">32.71</span></span><br><span class="line"><span class="section">[server2]</span></span><br><span class="line"><span class="attr">hostname</span>=<span class="number">192.168</span>.<span class="number">32.72</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3307</span></span><br><span class="line"><span class="attr">candidate_master</span>=<span class="number">1</span></span><br><span class="line"><span class="section">[server3]</span></span><br><span class="line"><span class="attr">hostname</span>=<span class="number">192.168</span>.<span class="number">32.72</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3308</span></span><br><span class="line"><span class="section">[server4]</span></span><br><span class="line"><span class="attr">hostname</span>=<span class="number">192.168</span>.<span class="number">32.72</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3309</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 5、在主数据库服务器也就是192.168.32.71主机上创建监控账号（user=mhauser password=mhauser）和复制帐号（repl_user=repluser repl_password=repluser）（要和配置文件相同,已有则无需创建，可以用现成的，权限符合即可）</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> mhauser@<span class="string">'192.168.32.7%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'mhauser'</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">REPLICATION</span> <span class="keyword">SLAVE</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'repluser'</span>@<span class="string">'192.168.32.7%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'repluser'</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 6、用MHA包自带工具进行测试<code>usr/bin/masterha_check_ssh --conf=/etc/mha.cnf</code></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>CentOS7 ~]#/usr/bin/masterha_check_ssh --conf=/etc/mha.cnf</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">25</span> <span class="number">2019</span> - [warning] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">25</span> <span class="number">2019</span> - [info] Reading application <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/mha.cnf..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">25</span> <span class="number">2019</span> - [info] Reading server configuration <span class="keyword">from</span> /etc/mha.cnf..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">25</span> <span class="number">2019</span> - [info] Starting SSH connection tests..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">28</span> <span class="number">2019</span> - [debug] </span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">25</span> <span class="number">2019</span> - [debug]  Connecting via SSH <span class="keyword">from</span> <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">22</span>) to <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">22</span>)..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">25</span> <span class="number">2019</span> - [debug]   ok.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">25</span> <span class="number">2019</span> - [debug]  Connecting via SSH <span class="keyword">from</span> <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">22</span>) to <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">22</span>)..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">26</span> <span class="number">2019</span> - [debug]   ok.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">26</span> <span class="number">2019</span> - [debug]  Connecting via SSH <span class="keyword">from</span> <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">22</span>) to <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">22</span>)..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">27</span> <span class="number">2019</span> - [debug]   ok.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">28</span> <span class="number">2019</span> - [debug] </span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">26</span> <span class="number">2019</span> - [debug]  Connecting via SSH <span class="keyword">from</span> <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">22</span>) to <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">22</span>)..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">27</span> <span class="number">2019</span> - [debug]   ok.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">27</span> <span class="number">2019</span> - [debug]  Connecting via SSH <span class="keyword">from</span> <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">22</span>) to <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">22</span>)..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">28</span> <span class="number">2019</span> - [debug]   ok.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">28</span> <span class="number">2019</span> - [debug]  Connecting via SSH <span class="keyword">from</span> <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">22</span>) to <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">22</span>)..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">29</span> <span class="number">2019</span> - [info] All SSH connection tests passed successfully.</span><br></pre></td></tr></table></figure><p><code>usr/bin/masterha_check_repl --conf=/etc/mha.cnf</code></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>CentOS7 ~]#/usr/bin/masterha_check_repl --conf=/etc/mha.cnf</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">12</span> <span class="number">2019</span> - [warning] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">12</span> <span class="number">2019</span> - [info] Reading application <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/mha.cnf..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">12</span> <span class="number">2019</span> - [info] Reading server configuration <span class="keyword">from</span> /etc/mha.cnf..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">12</span> <span class="number">2019</span> - [info] MHA::MasterMonitor version <span class="number">0.56</span>.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info] GTID failover mode = <span class="number">0</span></span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info] Dead Servers:</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info] Alive Servers:</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]   <span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">3306</span>)</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]   <span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">3307</span>)</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]   <span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">3308</span>)</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]   <span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">3309</span>)</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info] Alive Slaves:</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]   <span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">3307</span>)  Version=<span class="number">10.4</span><span class="number">.8</span>-MariaDB-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">3306</span>)</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]   <span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">3308</span>)  Version=<span class="number">10.4</span><span class="number">.8</span>-MariaDB-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">3306</span>)</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]   <span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">3309</span>)  Version=<span class="number">10.4</span><span class="number">.8</span>-MariaDB-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">3306</span>)</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info] Current Alive Master: <span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">3306</span>)</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info] Checking slave configurations..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info] Checking replication filtering settings..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info]  Replication filtering check ok.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info] GTID (with <span class="built_in">auto</span>-pos) <span class="keyword">is</span> <span class="keyword">not</span> supported</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2019</span> - [info] Starting SSH connection tests..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">17</span> <span class="number">2019</span> - [info] All SSH connection tests passed successfully.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">17</span> <span class="number">2019</span> - [info] Checking MHA Node version..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">18</span> <span class="number">2019</span> - [info]  Version check ok.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">18</span> <span class="number">2019</span> - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">18</span> <span class="number">2019</span> - [info] HealthCheck: SSH to <span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">18</span> <span class="number">2019</span> - [info] Master MHA Node version <span class="keyword">is</span> <span class="number">0.56</span>.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">18</span> <span class="number">2019</span> - [info] Checking recovery script configurations on <span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">3306</span>)..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">18</span> <span class="number">2019</span> - [info]   Executing command: save_binary_logs --command=test --start_pos=<span class="number">4</span> --binlog_dir=/data/mysql --output_file=/data/mastermha/group1<span class="comment">//save_binary_logs_test --manager_version=0.56 --start_file=master-bin.000012 </span></span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">18</span> <span class="number">2019</span> - [info]   Connecting to <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">22</span>).. </span><br><span class="line">  Creating /data/mastermha/group1 <span class="keyword">if</span> <span class="keyword">not</span> exists..    ok.</span><br><span class="line">  Checking output directory <span class="keyword">is</span> accessible <span class="keyword">or</span> <span class="keyword">not</span>..</span><br><span class="line">   ok.</span><br><span class="line">  Binlog found at /data/mysql, up to master-bin<span class="number">.000012</span></span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">19</span> <span class="number">2019</span> - [info] Binlog setting check done.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">19</span> <span class="number">2019</span> - [info] Checking SSH publickey authentication <span class="keyword">and</span> checking recovery script configurations on all alive slave servers..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">19</span> <span class="number">2019</span> - [info]   Executing command : apply_diff_relay_logs --command=test --slave_user=<span class="string">'mhauser'</span> --slave_host=<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span> --slave_ip=<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span> --slave_port=<span class="number">3307</span> --workdir=/data/mastermha/group1/ --target_version=<span class="number">10.4</span><span class="number">.8</span>-MariaDB-log --manager_version=<span class="number">0.56</span> --relay_log_info=/data/mysql3307/data/relay-log.info  --relay_dir=/data/mysql3307/data/  --slave_pass=xxx</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">19</span> <span class="number">2019</span> - [info]   Connecting to <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">22</span>).. </span><br><span class="line">  Checking slave recovery environment settings..</span><br><span class="line">    Opening /data/mysql3307/data/relay-log.info ... ok.</span><br><span class="line">    Relay log found at /data/mysql3307/data, up to relay-log<span class="number">.000034</span></span><br><span class="line">    Temporary relay log file <span class="keyword">is</span> /data/mysql3307/data/relay-log<span class="number">.000034</span></span><br><span class="line">    Testing mysql connection <span class="keyword">and</span> privileges.. done.</span><br><span class="line">    Testing mysqlbinlog output.. done.</span><br><span class="line">    Cleaning up test file(s).. done.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">19</span> <span class="number">2019</span> - [info]   Executing command : apply_diff_relay_logs --command=test --slave_user=<span class="string">'mhauser'</span> --slave_host=<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span> --slave_ip=<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span> --slave_port=<span class="number">3308</span> --workdir=/data/mastermha/group1/ --target_version=<span class="number">10.4</span><span class="number">.8</span>-MariaDB-log --manager_version=<span class="number">0.56</span> --relay_log_info=/data/mysql3308/data/relay-log.info  --relay_dir=/data/mysql3308/data/  --slave_pass=xxx</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">19</span> <span class="number">2019</span> - [info]   Connecting to <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">22</span>).. </span><br><span class="line">  Checking slave recovery environment settings..</span><br><span class="line">    Opening /data/mysql3308/data/relay-log.info ... ok.</span><br><span class="line">    Relay log found at /data/mysql3308/data, up to relay-log<span class="number">.000009</span></span><br><span class="line">    Temporary relay log file <span class="keyword">is</span> /data/mysql3308/data/relay-log<span class="number">.000009</span></span><br><span class="line">    Testing mysql connection <span class="keyword">and</span> privileges.. done.</span><br><span class="line">    Testing mysqlbinlog output.. done.</span><br><span class="line">    Cleaning up test file(s).. done.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [info]   Executing command : apply_diff_relay_logs --command=test --slave_user=<span class="string">'mhauser'</span> --slave_host=<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span> --slave_ip=<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span> --slave_port=<span class="number">3309</span> --workdir=/data/mastermha/group1/ --target_version=<span class="number">10.4</span><span class="number">.8</span>-MariaDB-log --manager_version=<span class="number">0.56</span> --relay_log_info=/data/mysql3309/data/relay-log.info  --relay_dir=/data/mysql3309/data/  --slave_pass=xxx</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [info]   Connecting to <span class="symbol">root@</span><span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">22</span>).. </span><br><span class="line">  Checking slave recovery environment settings..</span><br><span class="line">    Opening /data/mysql3309/data/relay-log.info ... ok.</span><br><span class="line">    Relay log found at /data/mysql3309/data, up to relay-log<span class="number">.000009</span></span><br><span class="line">    Temporary relay log file <span class="keyword">is</span> /data/mysql3309/data/relay-log<span class="number">.000009</span></span><br><span class="line">    Testing mysql connection <span class="keyword">and</span> privileges.. done.</span><br><span class="line">    Testing mysqlbinlog output.. done.</span><br><span class="line">    Cleaning up test file(s).. done.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [info] Slaves settings check done.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [info] </span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.71</span>:<span class="number">3306</span>) (current master)</span><br><span class="line"> +-<span class="number">-192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">3307</span>)</span><br><span class="line"> +-<span class="number">-192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">3308</span>)</span><br><span class="line"> +-<span class="number">-192.168</span><span class="number">.32</span><span class="number">.72</span>(<span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>:<span class="number">3309</span>)</span><br><span class="line"></span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [info] Checking replication health on <span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [info]  ok.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [info] Checking replication health on <span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [info]  ok.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [info] Checking replication health on <span class="number">192.168</span><span class="number">.32</span><span class="number">.72</span>..</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [info]  ok.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [warning] master_ip_failover_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri Sep <span class="number">27</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">20</span> <span class="number">2019</span> - [info] Got exit code <span class="number">0</span> (Not master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication Health <span class="keyword">is</span> OK.</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 均显示测试成功~<br>&emsp;&emsp; 可以启动MHAmanager了，注意这是一个前端程序，如果检测到主数据库宕机，则会自动切换从数据为新的主服务器并使其他的从服务器从新的主服务器数据库上面复制数据，此后程序自动终止。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]#/usr/bin/masterha_manager <span class="attribute">--conf</span>=/etc/mha.cnf</span><br><span class="line">Fri Sep 27 11:35:37 2019 - [<span class="builtin-name">warning</span>] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Fri Sep 27 11:35:37 2019 - [<span class="builtin-name">info</span>] Reading application<span class="built_in"> default </span>configuration <span class="keyword">from</span> /etc/mha.cnf<span class="built_in">..</span></span><br><span class="line">Fri Sep 27 11:35:37 2019 - [<span class="builtin-name">info</span>] Reading<span class="built_in"> server </span>configuration <span class="keyword">from</span> /etc/mha.cnf<span class="built_in">..</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 在主数据库上将mysql进程杀掉后，MHA进程自动结束。<br><img src="https://img-blog.csdnimg.cn/20190927123356815.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp; 在3307端口数据库上查询，已经没有从节点信息了。<img src="https://img-blog.csdnimg.cn/20190927124323317.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 在3308端口数据库以及3309端口数据上显示，主数据库已变为更为3307端口数据库，说明转换主从结构成功！<br><img src="https://img-blog.csdnimg.cn/20190927124330490.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp; PS：因为几个数据库都是源码编译安装，数据库路径和二进制文件储存位置都做出了调整，与默认位置不同，而yum安装的MHAmaster中如果配置文件中不写明master_binlog_dir的位置，则会默认去<code>/usr/bin/msyql/</code>目录下找主机二进制文件（当然，mysql数据库也是yum安装的可忽略这些配置，一切默认就好，而配置文件中添加server主机时，如果端口号不是默认3306，一定要记得写明port端口号，如本文中多实例用的不同端口，标记清楚即可。）</p>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 多实例 </tag>
            
            <tag> mysql </tag>
            
            <tag> MHA </tag>
            
            <tag> 高可用 </tag>
            
            <tag> mariadb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysql多实例实现主从级联复制及读写分离</title>
      <link href="//blog/d006fe9f.html"/>
      <url>//blog/d006fe9f.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><strong>一、多实例</strong></p><p>1、概述</p><p>&emsp;&emsp; MySQL多实例就是在一台机器上开启多个不同的服务端口（如：3306,3307），运行多个MySQL服务进程，通过不同的socket监听不同的服务端口来提供各自的服务</p><p>2.1、优点</p><p>1）有效利用服务器资源</p><p>&emsp;&emsp; 当单个服务器资源过剩时，可以充分利用剩余的资源来提供更多的服务；<br>2）节约服务器资源</p><a id="more"></a><p>&emsp;&emsp; 当公司资金紧张，但数据库又需要数据库之间各自提供服务时，并且还想使用主从同步等技术，此时多实例就再好不过了；<br>3）方便后期架构扩展</p><p>&emsp;&emsp; 当公司的某个项目才启动时，启动初期并不一定有很大的用户量，因此可以先用一组物理数据库服务器，在上面部署多个实例，方便后续架构扩展、迁移；</p><p>2.2、缺点</p><p>资源互相抢占问题</p><p>&emsp;&emsp; 当某个服务实例并发很高或者有慢查询时，整个实例会消耗更多的内存、CPU和IO资源，这将导致服务器上的其它实例提供服务的质量下降。这就比如说合租房的各个租客，每当早晨上班时，都会洗漱，此时卫生间的占用率就大，各个租客总会发生等待。</p><p>3、部署mysql多实例的两种方式</p><p>① 基于多配置文件</p><p>&emsp;&emsp; 通过使用多个配置文件来启动不同的进程，以此来实现多实例。</p><p>&emsp;&emsp; 优点：逻辑简单，配置简单</p><p>&emsp;&emsp; 缺点：管理起来不方便</p><p>② 基于mysqld_multi</p><p>&emsp;&emsp; 通过官方自带的 mysqld_multi 工具，使用单独配置文件来实现多实例</p><p>&emsp;&emsp; 优点： 便于集中管理管理</p><p>&emsp;&emsp; 缺点： 不方便针对每个实例配置进行定制</p><p>4、同一开发环境下安装两个数据库，必须处理以下问题</p><p>&emsp;&emsp; （1） 配置文件安装路径不能相同</p><p>&emsp;&emsp; （2）数据库目录不能相同</p><p>&emsp;&emsp; （3）启动脚本不能同名</p><p>&emsp;&emsp; （4）端口不能相同</p><p>&emsp;&emsp; （5）socket文件的生成路径不能相同<br>5、配置搭建<br>&emsp;&emsp; 实现目标：<img src="https://img-blog.csdnimg.cn/20190925114000429.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp; 1、源码编译安装或者二进制安装或者yum安装mysql或mariadb客户端以及server端,若没有创建mysql用户、组则创建。<br>&emsp;&emsp; 2、在指定路径下创建3个数据库目录<br>&emsp;&emsp;mkdir -p /data/mysql330{789}<br>&emsp;&emsp;挂载在不同的三块硬盘上</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mount /dev/sdb /data/mysql3307</span><br><span class="line">mount /dev/sdc /data/mysql3308</span><br><span class="line">mount /dev/sdd /data/mysql3309</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 3、用server端带的初始化脚本生成三个数据库</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scripts/mariadb-install-db --datadir=/data/mysql3307/ --user=mysql</span><br><span class="line">scripts/mariadb-install-db --datadir=/data/mysql3308/ --user=mysql</span><br><span class="line">scripts/mariadb-install-db --datadir=/data/mysql3309/ --user=mysql</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 4、准备三个配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/my.cnf /data/mysql3307/my.cnf</span><br><span class="line">cp /etc/my.cnf /data/mysql3308/my.cnf</span><br><span class="line">cp /etc/my.cnf /data/mysql3309/my.cnf</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 修改分别其中配置（以下以实例3307为例，3308、3309将下面所有数字对应改成自己的端口号）</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line"><span class="comment">#password       = your_password</span></span><br><span class="line">port            = 3307</span><br><span class="line">socket          = /data/mysql3307/mysql.sock</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="attribute">datadir</span>=/data/mysql3307/</span><br><span class="line"><span class="attribute">innodb_file_per-table</span>=on</span><br><span class="line"><span class="attribute">skip_name_resolve</span>=on</span><br><span class="line">port            = 3307</span><br><span class="line">socket          = /data/mysql3307/mysql.sock</span><br><span class="line"><span class="attribute">log-bin</span>=mysql-bin</span><br><span class="line">log-slave-updates</span><br><span class="line">server-id       = 3307        #每个数据库server-id全局唯一</span><br><span class="line"><span class="attribute">default-character-set</span>=utf8</span><br><span class="line"></span><br><span class="line"><span class="attribute">read_only</span>=ON#3307特有选项-开启中继日志</span><br><span class="line"><span class="attribute">relay_log</span>=relay-log#3307特有选项</span><br><span class="line"><span class="attribute">relay_log_index</span>=relay-log.index#3307特有选项</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 5、编写服务启动脚本（并加执行权限和修改PATH路径）</p><p>&emsp;&emsp;vim mysqld</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">port=$1</span><br><span class="line">mysql_user="root"</span><br><span class="line">mysql_pwd="password"</span><br><span class="line">cmd_path="/usr/local/mysql/bin"</span><br><span class="line">mysql_basedir="/data/mysql"</span><br><span class="line">mysql_sock="$&#123;mysql_basedir&#125;$&#123;port&#125;/mysql.sock"</span><br><span class="line"></span><br><span class="line">function_start_mysql()</span><br><span class="line">&#123;</span><br><span class="line">    if [ ! -e "$mysql_sock" ];then</span><br><span class="line">      printf "Starting MySQL...\n"</span><br><span class="line">      $&#123;cmd_path&#125;/mysqld_safe --defaults-file=$&#123;mysql_basedir&#125;$&#123;port&#125;/my.cnf  &amp;&gt; /dev/null  &amp;</span><br><span class="line">    else</span><br><span class="line">      printf "MySQL is running...\n"</span><br><span class="line">      exit</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function_stop_mysql()</span><br><span class="line">&#123;</span><br><span class="line">    if [ ! -e "$mysql_sock" ];then</span><br><span class="line">       printf "MySQL is stopped...\n"</span><br><span class="line">       exit</span><br><span class="line">    else</span><br><span class="line">       printf "Stoping MySQL...\n"</span><br><span class="line">       $&#123;cmd_path&#125;/mysqladmin -u $&#123;mysql_user&#125; -p$&#123;mysql_pwd&#125; -S $&#123;mysql_sock&#125; shutdown</span><br><span class="line">   fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function_restart_mysql()</span><br><span class="line">&#123;</span><br><span class="line">    printf "Restarting MySQL...\n"</span><br><span class="line">    function_stop_mysql</span><br><span class="line">    sleep 1</span><br><span class="line">    function_start_mysql</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if [ ! -n "$2" ];then</span><br><span class="line">printf "Usage: $&#123;mysql_basedir&#125;$&#123;port&#125;/bin/mysqld [PORT] &#123;start|stop|restart&#125;\n"</span><br><span class="line">else</span><br><span class="line">case $2 in</span><br><span class="line">start)</span><br><span class="line">    function_start_mysql</span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">    function_stop_mysql</span><br><span class="line">;;</span><br><span class="line">restart)</span><br><span class="line">    function_restart_mysql</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line">    printf "Usage: $&#123;mysql_basedir&#125;$&#123;port&#125;/bin/mysqld &#123;start|stop|restart&#125;\n"</span><br><span class="line">esac</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 6、现在就可以实现执行mysqld 3307 start启动数据库服务了。启动三台数据库后（可运行安全加固脚本去掉test数据库以及多余账户），在主机数据库及这3个数据库中分别增加主从配置。<br>&emsp;&emsp; 192.168.32.71主机数据库:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; GRANT REPLICATION SLAVE ON *.* TO &apos;repluser&apos;@&apos;192.168.32.72&apos; IDENTIFIED BY &apos;replpasswd&apos;;</span><br><span class="line">MariaDB [(none)]&gt; SHOW MASTER STATUS;</span><br></pre></td></tr></table></figure><p>MariaDB [(none)]&gt; show master status;<br>+———————-+—————–+——————-+————————-+<br>|&emsp;&emsp; &emsp;File&emsp;&emsp;&emsp;&emsp;      | &emsp;Position &emsp;| Binlog_Do_DB | Binlog_Ignore_DB |<br>+———————-+—————–+——————-+————————-+<br>| mysql-bin.000026 | &emsp; 1136 &emsp;&emsp;|&emsp;&emsp; &emsp;&emsp;&emsp;&emsp;&emsp;|&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp; |<br>+———————-+—————–+——————-+————————-+</p><p>&emsp;&emsp; 查看并记录主机当前二进制日志文件信息及位置。<br>&emsp;&emsp; 用mysqldump (或者物理备份)，并还原至3个从节点。<br>&emsp;&emsp; <strong>192.168.32.71主机:</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -ppassword -A --default-character-set=utf8 --master-data=1 --hex-blob  &gt;/data/fullbak_`date +%F`.sql</span><br><span class="line">scp /data/fullbak_`date +%F`.sql 192.168.32.72:/data/</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; <strong>192.168.32.72主机:</strong></p><p>&emsp;&emsp; 启动3个实例的服务</p><p>&emsp;&emsp;mysqld 3307 start；mysqld 3308 start；mysqld 3309 start</p><p>&emsp;&emsp; 连接3307实例</p><p>&emsp;&emsp;mysql -S /data/mysql3307/mysql.sock</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; source /data/fullbak_XXX.sql</span><br><span class="line">MariaDB [(none)]&gt; SHOW MASTER STATUS;</span><br></pre></td></tr></table></figure><p>MariaDB [(none)]&gt; show master status;<br>+———————–+—————-+——————-+————————-+<br>|&emsp;&emsp; &emsp;File&emsp;&emsp;&emsp;&emsp;      | &emsp;Position &emsp;| Binlog_Do_DB | Binlog_Ignore_DB |<br>+———————–+—————-+——————-+————————-+<br>| mysql-bin.000006 | &emsp; 1167 &emsp;&emsp;|&emsp;&emsp; &emsp;&emsp;&emsp;&emsp;&emsp;|&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp; |<br>+———————–+—————-+——————-+————————-+</p><p>&emsp;&emsp; 记录3307实例的当前二进制日志文件信息及位置。</p><p>&emsp;&emsp; 在从节点3307添加主节点配置信息。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; change master <span class="keyword">to</span> <span class="attribute">master_host</span>=<span class="string">'192.168.32.71'</span>,</span><br><span class="line"><span class="attribute">master_user</span>=<span class="string">'repluser'</span>,</span><br><span class="line"><span class="attribute">master_password</span>=<span class="string">'replpasswd'</span>,</span><br><span class="line"><span class="attribute">master_port</span>=3306,</span><br><span class="line"><span class="attribute">master_log_file</span>=<span class="string">'mysql-bin.000026'</span>,master_log_pos=1136;</span><br><span class="line">MariaDB [(none)]&gt;start slave;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 连接3308实例mysql -S /data/mysql3308/mysql.sock<br>&emsp;&emsp; 在从节点3308添加主节点配置信息。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; source /data/fullbak_XXX.sql</span><br><span class="line">MariaDB [(none)]&gt; change master <span class="keyword">to</span> <span class="attribute">master_host</span>=<span class="string">'192.168.32.72,</span></span><br><span class="line"><span class="string">master_user='</span>repluser',</span><br><span class="line"><span class="attribute">master_password</span>=<span class="string">'replpasswd'</span>,</span><br><span class="line"><span class="attribute">master_port</span>=3307,</span><br><span class="line"><span class="attribute">master_log_file</span>=<span class="string">'mysql-bin.000006'</span>,master_log_pos=1167;</span><br><span class="line">MariaDB [(none)]&gt;start slave;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 连接3309实例mysql -S /data/mysql3309/mysql.sock<br>&emsp;&emsp; 在从节点3309添加主节点配置信息。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; source /data/fullbak_XXX.sql</span><br><span class="line">MariaDB [(none)]&gt; change master <span class="keyword">to</span> <span class="attribute">master_host</span>=<span class="string">'192.168.32.72,</span></span><br><span class="line"><span class="string">master_user='</span>repluser',</span><br><span class="line"><span class="attribute">master_password</span>=<span class="string">'replpasswd'</span>,</span><br><span class="line"><span class="attribute">master_port</span>=3307,</span><br><span class="line"><span class="attribute">master_log_file</span>=<span class="string">'mysql-bin.000006'</span>,master_log_pos=1167;</span><br><span class="line">MariaDB [(none)]&gt;start slave;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 三个从节点数据库依次<br>&emsp;&emsp;show slave status\G<br>查看主从状态信息，确认主从配置无误且均已启动，至此，多实例主从级联配置就完成了。<br>&emsp;&emsp;<br><strong>二、读写分离</strong><br>1、什么是读写分离？</p><p>&emsp;&emsp; 读写分离，基本的原理是让主数据库处理事务性增、改、删操作（INSERT、UPDATE、DELETE），而从数据库处理SELECT查询操作。数据库复制被用来把事务性操作导致的变更同步到集群中的从数据库。 </p><p>2、为什么要实现读写分离？</p><p>&emsp;&emsp; 因为数据库的“写”（写10000条数据到oracle可能要3分钟）操作是比较耗时的。<br>&emsp;&emsp; 但是数据库的“读”（从oracle读10000条数据可能只要5秒钟）。<br>所以读写分离，解决的是，数据库的写入，影响了查询的效率。 </p><p> 3、什么时候要读写分离？ </p><p>&emsp;&emsp; 数据库不一定要读写分离，如果程序使用数据库较多时，而更新少，查询多的情况下会考虑使用，利用数据库 主从同步 。可以减少数据库压力，提高性能。当然，数据库也有其它优化方案。memcache 或是 表折分，或是搜索引擎。都是解决方法。 </p><p>4、部署读写分离<br>&emsp;&emsp; 本次使用proxy实现读写分离，最终实现下图所示<br><img src="https://img-blog.csdnimg.cn/20190925164049740.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp; 1、部署代理机ip：192.168.32.70<br>&emsp;&emsp; 安装proxy及mysql客户端</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/yum.repos.d/proxysql.repo &lt;&lt;EOF </span><br><span class="line">[proxysql_repo]</span><br><span class="line">name= ProxySQL YUM repository</span><br><span class="line">baseurl=http://repo.proxysql.com/ProxySQL/proxysql-1.4.x/centos/\$releasever</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://repo.proxysql.com/ProxySQL/repo_pub_key</span><br><span class="line">EOF</span><br><span class="line">yum install proxysql -y</span><br><span class="line">yum install mysql -y</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 修改代理机配置文件端口号 6033 改为 3306（方便客户机连接,其他保持默认）</p><p>&emsp;&emsp;sed -ri ‘s@(interfaces=”0.0.0.0:)6033@\13306@’ /etc/proxysql.cnf</p><p>&emsp;&emsp; 登陆proxysql数据库</p><p>&emsp;&emsp;mysql -uadmin -padmin -P6032 -h127.0.0.1</p><p>&emsp;&emsp; 在代理服务器上增加主机信息</p><p>&emsp;&emsp; MySQL [(none)]&gt; </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">insert into mysql_servers(hostgroup_id,hostname,port) values(10,&apos;192.168.32.71&apos;,3306),</span><br><span class="line">(10,&apos;192.168.32.72&apos;,3307),</span><br><span class="line">(10,&apos;192.168.32.72&apos;,3308),</span><br><span class="line">(10,&apos;192.168.32.72&apos;,3309);</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 加载:MySQL [(none)]&gt; load mysql servers to runtime<br>&emsp;&emsp; 保存:MySQL [(none)]&gt; save mysql servers to disk</p><p>&emsp;&emsp; #设置监控帐号（使用默认监控账号(账号:密码=monitor:monitor)的话，此步可跳过）<br>&emsp;&emsp; MySQL [(none)]&gt;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set mysql-monitor_username=&apos;username&apos;</span><br><span class="line">set mysql-monitor_password=&apos;password&apos;</span><br><span class="line">MySQL [(none)]&gt; load mysql variables to runtime;</span><br><span class="line">MySQL [(none)]&gt; save mysql variables to disk;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 2、在主服务器上增加创建proxy的监控帐号并授权(从节点会自动复制创建，无需再创)</p><p>&emsp;&emsp; MySQL [(none)]&gt; grant replication client on <em>.</em> to monitor@’192.168.32.71’identified by ‘monitor’;</p><p>&emsp;&emsp; 3、在代理机上查看监控连接是否正常的 (对connect指标的监控)：<br>&emsp;&emsp; 如果connect_error的结果为NULL则表示正常<br>&emsp;&emsp; MySQL&gt;select * from mysql_server_connect_log;<br>&emsp;&emsp; 查看监控心跳信息 (对ping指标的监控)：<br>&emsp;&emsp; MySQL&gt; select * from mysql_server_ping_log;<br>&emsp;&emsp; (如果显示连接失败，可尝试在从节点刷新权限<strong>flush privileges;</strong>)<br>&emsp;&emsp; 4、设置分组信息<br>&emsp;&emsp;  需要修改的是main库中的mysql_replication_hostgroups表，该表有3个字段：writer_hostgroup，reader_hostgroup，comment, 指定写组的id为10，读组的id为20<br>&emsp;&emsp; MySQL&gt;insert into mysql_replication_hostgroups values(10,20,”CentOS7”);<br>&emsp;&emsp; 将mysql_replication_hostgroups表的修改加载到RUNTIME生效<br>&emsp;&emsp; MySQL&gt; load mysql servers to runtime;<br>&emsp;&emsp; MySQL&gt; save mysql servers to disk;<br>&emsp;&emsp; Monitor模块监控后端的read_only值，按照read_only的值将节点自动移动到读/写组<br>&emsp;&emsp;查看添加的主机分组表，应该已经自动分组了：<br>&emsp;&emsp;  MySQL&gt;select hostgroup_id,hostname,port,status,weight from mysql_servers;<br><img src="https://img-blog.csdnimg.cn/2019092521480589.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 5、在proxysql上配置路由规则，实现读写分离<br>&emsp;&emsp; 与规则有关的表：mysql_query_rules和mysql_query_rules_fast_routing，后者是前者的扩展表，1.4.7之后支持<br>&emsp;&emsp; 插入路由规则：将select语句分离到20的读组，select语句中有一个特殊语句<br>&emsp;&emsp; SELECT…FOR UPDATE它会申请写锁，应路由到10的写组<br>&emsp;&emsp; MySQL&gt;insert into mysql_query_rules(rule_id,active,match_digest,destination_hostgroup,apply) VALUES(1,1,’^SELECT.<em>FOR UPDATE$’,10,1),(2,1,’^SELECT’,20,1);<br>&emsp;&emsp; MySQL&gt; load mysql query rules to runtime;<br>&emsp;&emsp; MySQL&gt; save mysql query rules to disk;<br>*</em>注意：因ProxySQL根据rule_id顺序进行规则匹配，select … for update规则的rule_id必须要小于普通的select规则的rule_id**</p><p>&emsp;&emsp;在代理机上用命令测试相应读写的是哪个数据库：<br>&emsp;&emsp;mysql -uroot -pPASSWORD -P3306 -h127.0.0.1 -e ‘start transaction;select @@server_id;commit;select @@server_id’<br>+———————+<br>| @@server_id&emsp;  |<br>+———————+<br>|      &emsp; &emsp;   3306&emsp; &emsp;  |<br>+———————+<br>+———————+<br>| @@server_id&emsp;  |<br>+———————+<br>|      &emsp; &emsp;   3307 &emsp; &emsp; |<br>+———————+<br>&emsp;&emsp;说明读写分离，在两个终端上成功实现~</p>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 多实例 </tag>
            
            <tag> mysql </tag>
            
            <tag> 级联复制 </tag>
            
            <tag> 读写分离 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>关于mariadb10.4.8二进制安装及源码编译后设置密码无效的一些发现</title>
      <link href="//blog/4f0efae7.html"/>
      <url>//blog/4f0efae7.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;之前安装了最新版的mariadb10.4.8后，无论是二进制编译安装还是源码编译安装，设定完密码之后启动mysqld服务，结果都不需要密码就可以登陆进去，无论怎么执行<strong>mysql_secure_installation</strong>数据库初始化脚本或者<strong>mysql_secure_installation</strong>安全加固脚本，进入mysql都无需密码，用命令直接设置密码也无效，都是直接一敲mysql就可以进入数据库了。my.cnf配置文件查看了无数遍，也没发现任何蛛丝马迹。今天终于在无意中查看mysql数据库权限时意外有所收获，写出来与大家分享，让大家少走弯路。</p><a id="more"></a><p>&emsp;&emsp;当我进入mysql数据库，打开user表时，查看了下用户没有任何问题。<br><strong>MariaDB [mysql]&gt; select user,host,password from user;</strong><br>+———-+————+———————————————————–+<br>| user &emsp;&emsp;| host &emsp;&emsp;    |  &emsp;  password            &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;      |<br>+———-+————+———————————————————–+<br>| &emsp;root&emsp; | localhost | <em>54D9A58CB44735F80AC5AD29961814D6D12B8746  |<br>| &emsp;root &emsp;| 127.0.0.1 | <em>54D9A58CB44735F80AC5AD29961814D6D12B8746  |<br>| &emsp;root&emsp; | ::1 &emsp;&emsp;&emsp; | *54D9A58CB44735F80AC5AD29961814D6D12B8746 |<br>+———-+————+———————————————————–+<br>3 rows in set (0.001 sec)<br>|user  | host    |password   |<br>|–|–|–|<br>|root  | localhost | *54D9A58CB44735F80AC5AD29961814D6D12B8746 |<br>|root  | 127.0.0.1 | *54D9A58CB44735F80AC5AD29961814D6D12B8746 |<br>|root  |::1| *54D9A58CB44735F80AC5AD29961814D6D12B8746 |<br><img src="https://img-blog.csdnimg.cn/20190918203111766.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;可当我突发奇想打算看看他们这几个用户有什么权限上的区别时，就发现问题了：<br>*</em>MariaDB [mysql]&gt; show grants for ‘root’@’localhost’;**<br>+—————————————————————————————————————+<br>| &emsp;Grants for root@localhost&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp; |<br>+—————————————————————————————————————+<br>| GRANT ALL PRIVILEGES ON *.</em> TO ‘root’@’localhost’ IDENTIFIED VIA mysql_native_password USING ‘invalid’ OR unix_socket WITH GRANT OPTION &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;|<br>| GRANT PROXY ON ‘’@’%’ TO ‘root’@’localhost’ WITH GRANT OPTION                                                                           &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;|<br>+—————————————————————————————————————+<br>2 rows in set (0.000 sec)<br><strong>MariaDB [mysql]&gt; show grants for ‘root’@’127.0.0.1’;</strong><br>ERROR 1141 (42000): There is no such grant defined for user ‘root’ on host ‘127.0.0.1’<br><strong>MariaDB [mysql]&gt; show grants for ‘root’@’::1’;</strong><br>ERROR 1141 (42000): There is no such grant defined for user ‘root’ on host ‘::1’<br>MariaDB [mysql]&gt;<br><img src="https://img-blog.csdnimg.cn/20190918202258915.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;root用户竟然查不到权限，这就很奇怪了。在之前的mariadb10.2.27上尝试了下，都是正常的，如下图所示：<br><img src="https://img-blog.csdnimg.cn/20190918202923735.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;于是我就尝试对那两个异常的用户账号授权。<br><img src="https://img-blog.csdnimg.cn/20190918210814239.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;竟然也无法授权。这种情况跟我之前尝试过的直接用insert命令向user表中加的user条目情况有点相似。当时我用</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert<span class="built_in"> user </span><span class="builtin-name">set</span> <span class="attribute">Host</span>=<span class="string">'192.168.32.7'</span>,User='root',Password='54D9A58CB44735F80AC5AD29961814D6D12B8746',ssl_cipher='',x509_subject='',x509_issuer='',authentication_string='';</span><br></pre></td></tr></table></figure><p>命令在user表中创建了一个用户条目‘root’@’192.168.32.7’。<br><img src="https://img-blog.csdnimg.cn/20190918212605283.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;这个条目看起来和真正的用户一样，可等到授权时就发现没法授权了，且这个用户也没法远程在192.168.32.7主机登录，尝试insert了一个新的非root用户，也是同样的情况。说明create user 命令不单单只是在这个表上创建了新的用户条目，在其他关联的表上也有条目的增加。OK ，话题扯远了，继续说之前的无法加密的问题。<br>&emsp;&emsp;既然是同样的情况，我想到会不会是说明我这个新装好的mariadb上的这两个用户没有创建成功，是不是像上面提到的两个异常用户只是在这表中“徒有其表”呢？<br>&emsp;&emsp;那就尝试创建用户，并查看了下权限。<br><img src="https://img-blog.csdnimg.cn/20190918215852938.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">&emsp;&emsp;竟然创建用户成功了，而且权限也显示出来了（我记得我还没有授权呢啊！！！看来是root用户不用授权）。好像一切都恢复正常了。<br>&emsp;&emsp;赶紧退出看下是不是真的恢复正常了，结果失望的发现还是<strong>一敲mysql就可以登陆进去了！！！</strong><img src="https://img-blog.csdnimg.cn/20190918221520326.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;不过又尝试了下 用127.0.0.1登陆，发现竟然需要密码验证了，且用之前设置的密码才可以登录。我好像发现了什么~<br>&emsp;&emsp;删除用户‘root’@’localhost’，不让删，需要至少一个有CREATE USER权限用户，看来之前的‘root’@’127.0.0.1’用户没有权限。<br><img src="https://img-blog.csdnimg.cn/20190919154941254.png" alt="在这里插入图片描述"><br>&emsp;&emsp;那就先给‘root’@’127.0.0.1’用户授权</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'root'</span>@<span class="string">'127.0.0.1</span></span><br><span class="line"><span class="string">'</span>;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;再删除用户‘root’@’localhost’，成功了，再重新创建‘root’@’localhost’用户并指定密码，再授权。OK，退出重新登陆一下。<br><img src="https://img-blog.csdnimg.cn/20190919155616216.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;果然数据库加密成功了<del>！问题解决！<br>**——————————————-（以上封存，警醒自己的无知</del>）——————————————–**<br>&emsp;&emsp;<br>&emsp;&emsp;<br>&emsp;&emsp;<br>&emsp;&emsp;<strong>后记</strong>：<br>&emsp;&emsp;原来是mariadb10.4.8版本默认是可以本地使用使用unix_socket登陆无需密码，才导致密码无效，在上面的图片里显示得清清楚楚。<br><strong>MariaDB [mysql]&gt; show grants for ‘root’@’localhost’;</strong></p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+---------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| <span class="variable">&amp;emsp</span>;Grants for root@localhost<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>; |</span><br><span class="line">+---------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| GRANT ALL PRIVILEGES <span class="meta">ON</span> <span class="comment">*.* TO 'root'@'localhost' IDENTIFIED VIA mysql_native_password USING 'invalid' **OR unix_socket** WITH GRANT OPTION &amp;emsp;</span><span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;|</span><br><span class="line">| GRANT PROXY <span class="meta">ON</span> <span class="string">''</span>@<span class="string">'%'</span> TO <span class="string">'root'</span>@<span class="string">'localhost'</span> WITH GRANT OPTION                                                                           <span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;<span class="variable">&amp;emsp</span>;|</span><br><span class="line">+---------------------------------------------------------------------------------------------------------------+</span><br><span class="line">2 rows <span class="meta">in</span> <span class="meta">set</span> (0.000 sec)</span><br><span class="line"><span class="comment">**MariaDB [mysql]&gt; show grants for 'root'@'127.0.0.1';</span><span class="comment">**</span></span><br><span class="line"><span class="comment">ERROR 1141 (42000): There is no such grant defined for user 'root' on host '127.0.0.1'</span></span><br><span class="line"><span class="comment">**MariaDB [mysql]&gt; show grants for 'root'@'::1';</span><span class="comment">**</span></span><br><span class="line"><span class="comment">ERROR 1141 (42000): There is no such grant defined for user 'root' on host '::1'</span></span><br></pre></td></tr></table></figure><p>MariaDB [mysql]&gt;<br><img src="https://img-blog.csdnimg.cn/20190918202258915.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;当然，也存在用户不存在，而user表中有条目的情况。所以想最终解决这个问题，实际上最直接的命令是：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'root'</span>@<span class="string">'localhost'</span> <span class="keyword">IDENTIFIED</span> VIA mysql_native_password <span class="keyword">USING</span> <span class="string">'*54D9A58CB44735F80AC5AD29961814D6D12B8746'</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> <span class="keyword">OPTION</span>;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;重新对root@localhost用户授权取消unix_sock登陆，并设置密码。<br>&emsp;&emsp;至此，问题才真正解决。<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;后记写于 2019.9.23。</p>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 踩坑 </tag>
            
            <tag> mysql </tag>
            
            <tag> mariadb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>二进制安装及源码编译安装mariadb数据库</title>
      <link href="//blog/b124800c.html"/>
      <url>//blog/b124800c.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;MariaDB数据库管理系统是MySQL的一个分支，主要由开源社区在维护，采用GPL授权许可 MariaDB的目的是完全兼容MySQL，包括API和命令行，使之能轻松成为MySQL的代替品。在存储引擎方面，使用XtraDB（英语：XtraDB）来代替MySQL的InnoDB。 MariaDB由MySQL的创始人Michael Widenius（英语：Michael Widenius）主导开发，他早前曾以10亿美元的价格，将自己创建的公司MySQL AB卖给了SUN，此后，随着SUN被甲骨文收购，MySQL的所有权也落入Oracle的手中。MariaDB名称来自Michael Widenius的女儿Maria的名字。</p><a id="more"></a><p>&emsp;&emsp;MariaDB基于事务的Maria存储引擎，替换了MySQL的MyISAM存储引擎，它使用了Percona的 XtraDB，InnoDB的变体，分支的开发者希望提供访问即将到来的MySQL 5.4 InnoDB性能。这个版本还包括了 PrimeBase XT (PBXT) 和 FederatedX存储引擎。<br>&emsp;&emsp;开发这个分支的原因之一是：甲骨文公司收购了MySQL后，有将MySQL闭源的潜在风险，因此社区采用分支的方式来避开这个风险。 过去一年中，大型互联网用户以及Linux发行商纷纷抛弃MySQL，转投MariaDB阵营。MariaDB是目前最受关注的MySQL数据库衍生版，也被视为开源数据库MySQL的替代品。<br>&emsp;&emsp;MariaDB虽然被视为MySQL数据库的替代品，但它在扩展功能、存储引擎以及一些新的功能改进方面都强过MySQL。而且从MySQL迁移到MariaDB也是非常简单的：<br>&emsp;&emsp;1、数据和表定义文件（.frm）是二进制兼容的<br>&emsp;&emsp;2、所有客户端API、协议和结构都是完全一致的<br>&emsp;&emsp;3、所有文件名、二进制、路径、端口等都是一致的<br>&emsp;&emsp;4、所有的MySQL连接器，比如PHP、Perl、Python、Java、.NET、MyODBC、Ruby以及MySQL C connector等在MariaDB中都保持不变<br>&emsp;&emsp;5、mysql-client包在MariaDB服务器中也能够正常运行<br>&emsp;&emsp;6、共享的客户端库与MySQL也是二进制兼容的<br>也就是说，在大多数情况下，你完全可以卸载MySQL然后安装MariaDB，然后就可以像之前一样正常的运行。(以上摘自百度百科)<br>&emsp;&emsp;作为目前比较热门的开源数据库软件，一般常见有三种安装方式：yum或rpm包安装、二进制安装以及源码包安装，包安装过于简单，也很难符合一般企业定制需要，故不做叙述，本文详细讲述后两种安装方式。</p><h4 id="二进制安装"><a href="#二进制安装" class="headerlink" title="二进制安装"></a>二进制安装</h4><p>1.先<strong>创建mysql用户及mysql组</strong>，并制定家目录为/data/mysql</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">groupadd -r -g <span class="number">306</span> mysql   #指定属组gid为<span class="number">306</span></span><br><span class="line">useradd -r -g <span class="number">306</span> -u <span class="number">306</span> -d /data/mysql mysql    #指定属主uid为<span class="number">306</span>，家目录为/data/mysql</span><br></pre></td></tr></table></figure><p>2.<strong>准备数据目录(mysq用户家目录)</strong>,并修正权限</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="regexp">/data/</span>mysql;chown <span class="string">mysql:</span>mysql <span class="regexp">/data/</span>mysql</span><br></pre></td></tr></table></figure><p>3.去官网下载mariadb 二进制tar包（链接是CentOS7X86_64的10.4.8稳定版）<br>&emsp;&emsp;<a href="http://ftp.igh.cnrs.fr/pub/mariadb//mariadb-10.4.8/bintar-linux-systemd-x86_64/mariadb-10.4.8-linux-systemd-x86_64.tar.gz" rel="noopener" target="_blank">http://ftp.igh.cnrs.fr/pub/mariadb//mariadb-10.4.8/bintar-linux-systemd-x86_64/mariadb-10.4.8-linux-systemd-x86_64.tar.gz</a><br>4.<strong>解压tar包</strong>指/usr/local目录下,递归改属主为root、属组为mysql，并在/usr/local目录下创建一个名为mysql的软链接指向解压好的mariadb目录</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar xzf mariadb<span class="number">-10.4</span><span class="number">.8</span>-linux-systemd-x86_64.tar.gz -c <span class="regexp">/usr/</span>local</span><br><span class="line">cd <span class="regexp">/usr/</span>local</span><br><span class="line">ln -sv mariadb<span class="number">-10.4</span><span class="number">.8</span>-linux-systemd-x86_64 mysql</span><br><span class="line">`chown -R <span class="string">root:</span>mysql <span class="regexp">/usr/</span>local<span class="regexp">/mysql/</span></span><br></pre></td></tr></table></figure><p>5.<strong>创建配置文件</strong>,并修改</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="string">/etc/mysql/</span></span><br><span class="line">cp <span class="string">/etc/my.cnf</span> <span class="string">/etc/mysql/my.cnf</span></span><br><span class="line">sed -ri '<span class="string">/datadir=</span>\<span class="string">//s</span>@<span class="params">(.*=)</span>.*@\1\<span class="string">/data</span>\<span class="string">/mysql</span>@' <span class="string">/etc/mysql/my.cnf</span>    <span class="comment">#修改配置文件，指定数据库储存路径</span></span><br><span class="line">sed -ri '<span class="string">/datadir/a</span>\innodb_file_per-table=on\nskip_name_resolve=on' <span class="string">/etc/mysql/my.cnf</span>     <span class="comment">#设置每个表独立文件 和 禁用主机名解析</span></span><br></pre></td></tr></table></figure><p>6.<strong>创建数据库文件</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/scripts/mysql_install_db <span class="attribute">--datadir</span>=/data/mysql <span class="attribute">--user</span>=mysql</span><br></pre></td></tr></table></figure><p>7.<strong>创建服务脚本并启动服务</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/support-files/mysql.server /etc/rc.d/init.d/mysqld</span><br><span class="line">chkconfig --<span class="builtin-name">add</span> mysqld</span><br><span class="line">service mysqld start</span><br></pre></td></tr></table></figure><p>8.<strong>增加PATH环境变量</strong>路径,并生效。</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">'PATH=/usr/local/mysql/bin:$PATH'</span> &gt;/etc/<span class="keyword">profile</span>.d/mysql.<span class="keyword">sh</span></span><br><span class="line">. /etc/<span class="keyword">profile</span>.d/mysql.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure><p>9.<strong>运行安全初始化脚本</strong>，设置root口令、禁用匿名登陆、禁用远程主机登陆、删除test数据库，并立即生效(根据提示操作)。</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /var/<span class="class"><span class="keyword">lib</span>/<span class="title">mysql</span>/<span class="title">mysql</span>.<span class="title">sock</span> /<span class="title">tmp</span></span></span><br><span class="line">/usr/local/mysql/bin/mysql_secure_installation</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;至此，二进制安装mariadb数据库就完成了~</p><h4 id="源码编译安装"><a href="#源码编译安装" class="headerlink" title="源码编译安装"></a>源码编译安装</h4><p>1.先<strong>创建mysql用户及mysql组</strong>，并制定家目录为/data/mysql</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">groupadd -r -g <span class="number">306</span> mysql   #指定属组gid为<span class="number">306</span></span><br><span class="line">useradd -r -g <span class="number">306</span> -u <span class="number">306</span> -d /data/mysql mysql    #指定属主uid为<span class="number">306</span>，家目录为/data/mysql</span><br></pre></td></tr></table></figure><p>2.<strong>准备数据目录(mysq用户家目录)</strong>,并修正权限</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="regexp">/data/</span>mysql;chown <span class="string">mysql:</span>mysql <span class="regexp">/data/</span>mysql</span><br></pre></td></tr></table></figure><p>3.去官网<strong>下载mariadb 源码tar包</strong>（链接是CentOS7X86_64的10.4.8稳定版）<br>&emsp;&emsp;<a href="http://ftp.igh.cnrs.fr/pub/mariadb//mariadb-10.4.8/source/mariadb-10.4.8.tar.gz" rel="noopener" target="_blank">http://ftp.igh.cnrs.fr/pub/mariadb//mariadb-10.4.8/source/mariadb-10.4.8.tar.gz</a><br>4.<strong>解压源码包</strong>，并进入源码包目录</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar xvf mariadb<span class="number">-10.4</span><span class="number">.8</span>.tar.gz</span><br><span class="line">cd mariadb<span class="number">-10.4</span><span class="number">.8</span>/l</span><br></pre></td></tr></table></figure><p>5.<strong>CMAKE编译</strong>源码包<br>&emsp;&emsp;需要的依赖包有cmake openssldevel ncurses-devel bison bison-devel zlib-devel libcurl-devel libarchive-devel boostdevel gcc gcc-c++   gnutls-devel libxml2-devel  libevent-devel libaio-devel ，一口气yum装上。</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install </span>cmake openssldevel ncurses-devel <span class="keyword">bison </span><span class="keyword">bison-devel </span>zlib-devel libcurl-devel libarchive-devel <span class="keyword">boostdevel </span>gcc gcc-c++   gnutls-devel libxml2-devel  libevent-devel libaio-devel</span><br></pre></td></tr></table></figure><p>然后编译</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cmake . \</span><br><span class="line"><span class="attribute">-DCMAKE_INSTALL_PREFIX</span>=/data/apps/mysql \</span><br><span class="line"><span class="attribute">-DMYSQL_DATADIR</span>=/data/mysql/ \</span><br><span class="line"><span class="attribute">-DSYSCONFDIR</span>=/etc/ \</span><br><span class="line"><span class="attribute">-DMYSQL_USER</span>=mysql \</span><br><span class="line"><span class="attribute">-DWITH_INNOBASE_STORAGE_ENGINE</span>=1 \</span><br><span class="line"><span class="attribute">-DWITH_ARCHIVE_STORAGE_ENGINE</span>=1 \</span><br><span class="line"><span class="attribute">-DWITH_BLACKHOLE_STORAGE_ENGINE</span>=1 \</span><br><span class="line"><span class="attribute">-DWITH_PARTITION_STORAGE_ENGINE</span>=1 \</span><br><span class="line"><span class="attribute">-DWITHOUT_MROONGA_STORAGE_ENGINE</span>=1 \</span><br><span class="line"><span class="attribute">-DWITH_DEBUG</span>=0 \</span><br><span class="line"><span class="attribute">-DWITH_READLINE</span>=1 \</span><br><span class="line"><span class="attribute">-DWITH_SSL</span>=system \</span><br><span class="line"><span class="attribute">-DWITH_ZLIB</span>=system \</span><br><span class="line"><span class="attribute">-DWITH_LIBWRAP</span>=0 \</span><br><span class="line"><span class="attribute">-DENABLED_LOCAL_INFILE</span>=1 \</span><br><span class="line"><span class="attribute">-DMYSQL_UNIX_ADDR</span>=/data/mysql/mysql.sock \</span><br><span class="line"><span class="attribute">-DDEFAULT_CHARSET</span>=utf8 \</span><br><span class="line"><span class="attribute">-DDEFAULT_COLLATION</span>=utf8_general_ci</span><br></pre></td></tr></table></figure><p>6.<strong>安装</strong></p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">make</span> -j <span class="number">4</span> &amp;&amp; <span class="built_in">make</span> install</span><br></pre></td></tr></table></figure><p>7.<strong>创建配置文件</strong>,并修改</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="string">/etc/mysql/</span></span><br><span class="line">cp <span class="string">/etc/my.cnf</span> <span class="string">/etc/mysql/my.cnf</span></span><br><span class="line">sed -ri '<span class="string">/datadir=</span>\<span class="string">//s</span>@<span class="params">(.*=)</span>.*@\1\<span class="string">/data</span>\<span class="string">/mysql</span>@' <span class="string">/etc/mysql/my.cnf</span>    <span class="comment">#修改配置文件，指定数据库储存路径</span></span><br><span class="line">sed -ri '<span class="string">/datadir/a</span>\innodb_file_per-table=on\nskip_name_resolve=on' <span class="string">/etc/mysql/my.cnf</span>     <span class="comment">#设置每个表独立文件 和 禁用主机名解析</span></span><br></pre></td></tr></table></figure><p>8.<strong>创建数据库文件</strong></p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chown -R <span class="string">root:</span>mysql <span class="regexp">/data/</span>apps<span class="regexp">/mysql/</span></span><br><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/scripts/</span>mysql_install_db --datadir=<span class="regexp">/data/</span>mysql --user=mysql</span><br></pre></td></tr></table></figure><p>9.<strong>创建服务脚本并启动服务</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp /data/apps/mysql/support-files/mysql.server /etc/rc.d/init.d/mysqld</span><br><span class="line">chkconfig --<span class="builtin-name">add</span> mysqld</span><br><span class="line">service mysqld start</span><br></pre></td></tr></table></figure><p>10.<strong>增加PATH环境变量</strong>路径,并生效。</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">'PATH=/data/apps/mysql/bin:$PATH'</span> &gt;/etc/<span class="keyword">profile</span>.d/mysql.<span class="keyword">sh</span></span><br><span class="line">. /etc/<span class="keyword">profile</span>.d/mysql.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure><p>11.<strong>运行安全初始化脚本</strong>，设置root口令、禁用匿名登陆、禁用远程主机登陆、删除test数据库，并立即生效(根据提示操作)。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/data/</span>apps<span class="regexp">/mysql/</span>bin<span class="regexp">/mysql_secure_installation</span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20190915210957797.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;报错：<strong>Can’t connect to local MySQL server through socket ‘/data/mysql/mysql.sock’ (2)</strong><br>&emsp;&emsp;用ll看了下/data/mysql/mysql.sock确实不存在，而我记得我配置文件/etc/mysql/my.cnf中定义的sosck是在   下<br><img src="https://img-blog.csdnimg.cn/20190915211426790.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;那就把/var/lib/mysql/mysql.sock文件创建一个软链接至/data/mysql/目录</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ln -s /var/<span class="class"><span class="keyword">lib</span>/<span class="title">mysql</span>/<span class="title">mysql</span>.<span class="title">sock</span> /<span class="title">data</span>/<span class="title">mysql</span>/</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;再次尝试安全初始化脚本。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/data/</span>apps<span class="regexp">/mysql/</span>bin<span class="regexp">/mysql_secure_installation</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;果然成功了。<br>&emsp;&emsp;至此，源码编译安装mariadb数据库就完成了~</p>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> 编译安装 </tag>
            
            <tag> mysql </tag>
            
            <tag> mariadb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>部署自动化安装及cobber(Http+TFTP+PXE+kickstart无人职守批量安装精简版Linux系统)</title>
      <link href="//blog/8ddda8e.html"/>
      <url>//blog/8ddda8e.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;为了简化每台服务器的系统的装机过程和统一服务器配置，可以采用一键自动化安装系统的方式，实现新机器接上网线开机便可批量安装相同配置的系统，便于以后统一管理。<br>&emsp;&emsp;想要实现自动化安装系统，<br>&emsp;&emsp;1.搭建dhcp服务器，给新机器网卡分配IP地址，并引导机器去搭建好的tftp站点下载引导程序及内核文件；<br>&emsp;&emsp;2.搭建tftp服务器，提供引导程序及内核文件；复制内核文件至服务器目录；<br>&emsp;&emsp;3.搭建http服务器，提供应答kickstart文件、系统安装包程序的下载；挂载光盘或拷贝安装包至目录文件；<br>&emsp;&emsp;4生成ks应答kickstart文件（放置于ftp服务器中）；<br>&emsp;&emsp;5.复制光盘中的/cdrom/isolinux/isolinux.cfg文件至目录pxelinux.cfg/，改名为pxelinux.cfg/fault文件，即为安装菜单（之后目录pxelinux.cfg/整体放入tftp服务器中）。</p><a id="more"></a><p>&emsp;&emsp;<br><strong>演示环境：CentOS7 Kernel Version:    3.10.0-957.el7.x86_64 本机IP:192.168.32.7</strong></p><h2 id="1-配置DHCP服务器"><a href="#1-配置DHCP服务器" class="headerlink" title="1. 配置DHCP服务器"></a>1. 配置DHCP服务器</h2><p>&emsp;&emsp;1.首先安装dhcp服务。</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> dhcp</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;2.启动dhcp服务。但直接启动，会报错，如下图所示，须先修改dhcpd的配置文件。<br><img src="https://img-blog.csdnimg.cn/20190907104911953.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;打开/etc/dhcp/dhcpd.conf配置文件后发现，配置文件是空的，难怪报错，有一行“see /usr/share/doc/dhcpd.conf.example”，原来要我们参考这个模版来自己写配置文件。<br><img src="https://img-blog.csdnimg.cn/20190907104923202.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;于是先复制模版至原配置文件目录。<br><img src="https://img-blog.csdnimg.cn/20190907104932714.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;选择覆盖，再打开配置文件。<br><img src="https://img-blog.csdnimg.cn/20190907104941287.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;修改⑴网段⑵租期时长⑶网关⑷DNS⑸DNS域后缀⑹提供资源下载站点IP⑺需要下载的引导文件<br><img src="https://img-blog.csdnimg.cn/20190907104948374.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;此时重启DHCP服务成功，查看DHCP服务状态，已经启动（状态信息的提示，是指另一块网卡没有被DHCP服务器网段分配地址，分配一个就足够了，可以无视）。<br><img src="https://img-blog.csdnimg.cn/20190907110332532.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="2-搭建tftp服务器"><a href="#2-搭建tftp服务器" class="headerlink" title="2.搭建tftp服务器"></a>2.搭建tftp服务器</h2><p>&emsp;&emsp;1.首先安装tftp服务端</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> tftp-<span class="keyword">server</span> -y</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;2.生成pxelinux.0引导程序，并放入tftp服务器<br>&emsp;&emsp;&emsp;⑴先确定引导程序所在的安装包；</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">yum search pxelinux</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;&emsp;⑵安装syslinux.x86_64；</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> syslinux.x86_64</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;&emsp;⑶找到引导程序pxelinux.0的所在路径；</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ql syslinux.x86_64<span class="string">|grep pxelinux.0</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;&emsp;⑷将引导程序pxelinux.0及菜单背景模版文件menu.c32拷贝到服务器</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/share/syslinux/pxelinux.<span class="number">0</span> /usr/share/syslinux/menu.c32 /var/<span class="class"><span class="keyword">lib</span>/<span class="title">tftpboot</span>/</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;3.将准备好的内核文件和initrd.img文件拷贝到服务器</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /cdrom6/isolinux/vmlinuz  /cdrom6/isolinux/initrd.img  /var/<span class="class"><span class="keyword">lib</span>/<span class="title">tftpboot</span>/6/</span></span><br><span class="line">cp /cdrom7/isolinux/vmlinuz  /cdrom7/isolinux/initrd.img  /var/<span class="class"><span class="keyword">lib</span>/<span class="title">tftpboot</span>/7/</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;最终效果如下：<br><img src="https://img-blog.csdnimg.cn/20190907144353849.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="3-搭建http服务器"><a href="#3-搭建http服务器" class="headerlink" title="3.搭建http服务器"></a>3.搭建http服务器</h2><p>&emsp;&emsp;1.首先安装httpd服务端</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> httpd -y</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;2.启动httpd服务</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="literal">start</span> httpd</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;3.查看httpd服务状态是否启动</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">systemctl status httpd</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;4.创建安装包文件目录</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -pv <span class="regexp">/var/</span>www<span class="regexp">/html/</span>CentOS<span class="regexp">/&#123;6,7&#125;/</span>os<span class="regexp">/x86_64/</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;5.挂载光盘安装包至目录或拷贝安装文件至目录</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mount <span class="regexp">/dev/</span>sr0 <span class="regexp">/var/</span>www<span class="regexp">/html/</span>CentOS<span class="regexp">/7/</span>os<span class="regexp">/x86_64/</span></span><br><span class="line">mount <span class="regexp">/dev/</span>sr1 <span class="regexp">/var/</span>www<span class="regexp">/html/</span>CentOS<span class="regexp">/6/</span>os<span class="regexp">/x86_64/</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;效果图如下：<br><img src="https://img-blog.csdnimg.cn/20190907154338532.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;6.挂载光盘安装包至目录或拷贝安装文件至目录</p><h2 id="4-生成kickstart应答文件"><a href="#4-生成kickstart应答文件" class="headerlink" title="4.生成kickstart应答文件"></a>4.生成kickstart应答文件</h2><p>&emsp;&emsp;ks文件的生成一般有两种方法：<br>&emsp;&emsp;①：之前手动安装后系统自动生成的的记录文件/root/anaconda-ks.cfg文件是可以直接复制过来修改使用的。<br>&emsp;&emsp;②：用kickstart工具生成。<br>我们这里采用第二种。执行命令。（这是一个在图形化界面操作的选项命令，如果用的是Xshell工具连接虚拟机，需要开启Xmanager - Passive，来转发图形化界面）</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">system-<span class="built_in">config</span>-kickstart</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;第一步，选择语言，键盘布局，时区，设置root口令（是否加密存储），安装完成后重启，命令行模式安装；<br><img src="https://img-blog.csdnimg.cn/20190907171743550.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;第二步，选择选择系统安装方式，通过HTTP服务站点安装，输入已经搭好的服务器IP和安装包路径；<br><img src="https://img-blog.csdnimg.cn/20190907171805775.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;第三步，选择安装grub引导安装程序，（先不对grub进行加密了，据说会有加密方式不符的话会有报错），加内核参数net.innames=0实现不更改网卡名称；<br><img src="https://img-blog.csdnimg.cn/20190907171813994.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;第四步，清除原有分区，清除分区标签，设置新分区表；<br><img src="https://img-blog.csdnimg.cn/20190907171820601.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;第五步，设置网卡名eth0，及获取IP方式为DHCP；<br><img src="https://img-blog.csdnimg.cn/2019090717182994.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;第六步，默认关闭SELINUX策略和防火墙；<br><img src="https://img-blog.csdnimg.cn/20190907171836698.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;第七步，选择需要的系统服务；<br>&emsp;&emsp;第八步，附加装机前后脚本；<br><img src="https://img-blog.csdnimg.cn/20190907173136895.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;第九步，将ks应答文件复制到http服务器<br>&emsp;&emsp;</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="regexp">/var/</span>www<span class="regexp">/html/</span>ksdir<span class="regexp">/;cp ~/</span>centos7-ks.cfg <span class="regexp">/var/</span>www<span class="regexp">/html/</span>ksdir<span class="regexp">/</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;（CentOS6的KS同样方式生成）</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ~<span class="regexp">/centos6-ks.cfg /</span>var<span class="regexp">/www/</span>html<span class="regexp">/ksdir/</span></span><br></pre></td></tr></table></figure><h2 id="5-创建安装菜单"><a href="#5-创建安装菜单" class="headerlink" title="5.创建安装菜单"></a>5.创建安装菜单</h2><p>&emsp;&emsp;菜单文件的一般有两种方法：<br>&emsp;&emsp;①：复制修改光盘中的菜单文件/cdrom/isolinux/lisolinux.cfg文件是可以直接复制过来修改使用的。<br>&emsp;&emsp;①：VIM手工输入。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">default <span class="selector-tag">menu</span>.c32</span><br><span class="line">timeout <span class="number">600</span></span><br><span class="line"><span class="selector-tag">menu</span> title Auto Install CentOS</span><br><span class="line"><span class="selector-tag">label</span> linux <span class="number">7</span></span><br><span class="line">        mennu <span class="selector-tag">label</span> Install CentOS^<span class="number">7</span></span><br><span class="line">        <span class="selector-tag">menu</span> default</span><br><span class="line">        kernel <span class="number">7</span>/vmlinuz</span><br><span class="line">        append initrd=<span class="number">7</span>/initrd<span class="selector-class">.img</span> ks=http:<span class="comment">//192.168.32.7/ksdir/centos7-ks.cfg</span></span><br><span class="line"><span class="selector-tag">label</span> linux <span class="number">6</span></span><br><span class="line">        mennu <span class="selector-tag">label</span> Install CentOS^<span class="number">6</span></span><br><span class="line">        kernel <span class="number">6</span>/vmlinuz</span><br><span class="line">        append initrd=<span class="number">6</span>/initrd<span class="selector-class">.img</span> ks=http:<span class="comment">//192.168.32.7/ksdir/centos6-ks.cfg</span></span><br><span class="line"><span class="selector-tag">label</span> linux local</span><br><span class="line">        mennu <span class="selector-tag">label</span> Boot from ^local drive</span><br><span class="line">        localboot Oxffff</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20190907192047527.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;再将菜单文件存入tftp服务器中 <strong>/linux.cfg目录</strong> 下 <strong>重命名</strong>为fault文件。tftp服务器最终目录机构如下图所示：<br><img src="https://img-blog.csdnimg.cn/20190907192456310.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;至此，基于PXE网卡，无人职守批量安装CentOS系统的配置就完成了。</p>]]></content>
      
      
      <categories>
          
          <category> linux基础 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> cobber </tag>
            
            <tag> kickstart </tag>
            
            <tag> pxe </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CentOS6源码编译 安装linunx内核最新版5.2.9</title>
      <link href="//blog/133d68.html"/>
      <url>//blog/133d68.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;之前在CentOS7 上源码编译安装过新内核，不过有次在6上编译就遇到问题了，提示错误如下</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">make</span>[<span class="number">2</span>]: *** [scripts/sign-file] <span class="built_in">Error</span> <span class="number">1</span> <span class="built_in">make</span>[<span class="number">1</span>]: *** [scripts] <span class="built_in">Error</span> <span class="number">2</span> <span class="built_in">make</span></span><br></pre></td></tr></table></figure><p>搞了好久，好像是参数设置不正确。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error: #<span class="builtin-name">error</span> Sorry, your compiler is too old - please<span class="built_in"> upgrade </span>it</span><br></pre></td></tr></table></figure><a id="more"></a><p>&emsp;&emsp;好像是说gcc版本过低。<br>&emsp;&emsp;去epel源找了一下，已经是最新版了啊~<br>&emsp;&emsp;查看了下之前CentOS7的gcc版本，是gcc-4.8.5，再去一查这个CentOS6的gcc版本，是gcc-4.4.7，可能就差在这几个小版本上了。<br>&emsp;&emsp;于是升级gcc版本就成了当务之急。<br>&emsp;&emsp;那就源码编译安装个新版的gcc吧。（后来朋友说可以直接把CentOS7上gcc的rpm包直接拿来用的，未尝试）</p><h2 id="编译安装gcc"><a href="#编译安装gcc" class="headerlink" title="编译安装gcc"></a>编译安装gcc</h2><p>&emsp;&emsp;gcc有三个依赖包gmp、mpfr、mpc,要首先编译安装（虽然原本就有，不过如果编译高版本gcc，这三个依赖包不装新版本的话也会报错）<br>&emsp;&emsp;先去下载好三个依赖包源码包及gcc源码包</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/gcc                                             #创建目录/data/gcc</span><br><span class="line">cd /data/gcc</span><br><span class="line">wget https://gmplib.org/download/gmp/gmp-<span class="number">6.1</span><span class="meta">.2</span>.tar.xz       #下载gmp6<span class="meta">.1</span><span class="meta">.2</span></span><br><span class="line">wget http://www.mpfr.org/mpfr-current/mpfr-<span class="number">3.1</span><span class="meta">.5</span>.tar.gz     #下载mpfr3<span class="meta">.1</span><span class="meta">.5</span></span><br><span class="line">wget ftp://ftp.gnu.org/gnu/mpc/mpc-<span class="number">1.0</span><span class="meta">.3</span>.tar.gz             #下载mpc1<span class="meta">.0</span><span class="meta">.3</span></span><br><span class="line">wget ftp://ftp.gnu.org/gnu/gcc/gcc-<span class="number">6.3</span><span class="meta">.0</span>/gcc-<span class="number">6.3</span><span class="meta">.0</span>.tar.gz   #下载gcc6<span class="meta">.3</span><span class="meta">.0</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;再挨个编译安装三个依赖包（注意这三个依赖包也有依赖关系，需先安装gmp，再安装mpfr，之后再装mpc）</p><h3 id="gmp"><a href="#gmp" class="headerlink" title="gmp"></a>gmp</h3><p>&emsp;&emsp;先来第一个，编译安装装gmp</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -xJf gmp<span class="number">-6.1</span><span class="number">.2</span>.tar.xz gmp<span class="number">-6.1</span><span class="number">.2</span></span><br><span class="line">cd gmp<span class="number">-6.1</span><span class="number">.2</span></span><br><span class="line">./configure --prefix=/usr/local/gcc/gmp --build=x86_64-linux</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;这当时有报错<br>&emsp;&emsp;<code>error: could not find a working compiler</code><br>&emsp;&emsp;当时没有加参数 –build=x86_64-linux，加上之后成功解决，参考: <a href="http://www.voidcn.com/article/p-zsgyngma-ug.html" rel="noopener" target="_blank">原文地址</a>. <a href="http://www.voidcn.com/article/p-zsgyngma-ug.html" rel="noopener" target="_blank">http://www.voidcn.com/article/p-zsgyngma-ug.html</a></p><h3 id="mpfr"><a href="#mpfr" class="headerlink" title="mpfr"></a>mpfr</h3><p>&emsp;&emsp;之后编译安装mpfr</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -xJf mpfr<span class="number">-3.1</span><span class="number">.5</span>.tar.xz mpfr<span class="number">-3.1</span><span class="number">.5</span></span><br><span class="line">cd mpfr<span class="number">-3.1</span><span class="number">.5</span></span><br><span class="line">./configure --prefix=/usr/local/gcc/mpfr --with-gmp=/usr/local/gcc/gmp</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;然后编译安装mpc</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -xzf mpc-<span class="number">1.0</span>.<span class="number">3</span>.tar.gz mpc-<span class="number">1.0</span>.<span class="number">3</span></span><br><span class="line">cd mpc-<span class="number">1.0</span>.<span class="number">3</span></span><br><span class="line">./configure --prefix=<span class="regexp">/usr/local</span><span class="regexp">/gcc/mpc</span> --<span class="keyword">with</span>-gmp=<span class="regexp">/usr/local</span><span class="regexp">/gcc/gmp</span> -<span class="keyword">with</span>-mpfr=<span class="regexp">/usr/local</span><span class="regexp">/gcc/mpfr</span></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h3 id="gcc"><a href="#gcc" class="headerlink" title="gcc"></a>gcc</h3><p>&emsp;&emsp;之后也没有报错，那就开始编译安装gcc。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar xvf gcc-6.3.0.tar.gz</span><br><span class="line">cd gcc-6.3.0</span><br><span class="line">./configure <span class="attribute">--prefix</span>=/usr/local/gcc <span class="attribute">--enable-threads</span>=posix --disable-checking --disable-multilib <span class="attribute">--enable-languages</span>=c,c++ <span class="attribute">--with-gmp</span>=/usr/local/gcc/gmp <span class="attribute">--with-mpfr</span>=/usr/local/gcc/mpfr <span class="attribute">--with-mpc</span>=/usr/local/gcc/mpc</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;gcc中途有几次报错，不过也都解决了。<br>错误提示[1]：</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">make</span>: *** [sub-<span class="built_in">make</span>] <span class="built_in">Error</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;显示这个问题编译不过去。这是因为找不到gmp依赖包导致的，可是我明明装了依赖包的，看来是路径设置有问题，因为当时我是把这三个依赖包都装在gcc下，不过在编译gcc的时候忘记改依赖包的地址了。<br>错误提示[2]：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">configure:</span> <span class="string">error:</span> cannot compute suffix of object <span class="string">files:</span> cannot compile</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;解决办法是：<br>&emsp;&emsp;在/etc/profile里面加上以下内容：</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export LD_LIBRARY_PATH=$<span class="symbol">LD_LIBRARY_PATH:</span>/usr/local/gcc/mpc-<span class="number">0.9</span>/<span class="class"><span class="keyword">lib</span>:/<span class="title">usr</span>/<span class="title">local</span>/<span class="title">gcc</span>/<span class="title">gmp</span>-5.0.1/<span class="title">lib</span>:/<span class="title">usr</span>/<span class="title">local</span>/<span class="title">gcc</span>/<span class="title">mpfr</span>-3.1.0/<span class="title">lib</span></span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;然后重新加载配置文件/etc/profile</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">source</span> <span class="regexp">/etc/</span>profile</span><br></pre></td></tr></table></figure><h3 id="添加变量"><a href="#添加变量" class="headerlink" title="添加变量"></a>添加变量</h3><p>&emsp;&emsp;/usr/local/lib       &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp; #这个是默认系统的变量<br>&emsp;&emsp;/usr/local/gmp/lib<br>&emsp;&emsp;/usr/local/mpfr/lib<br>&emsp;&emsp;/usr/local/mpc/lib<br>&emsp;&emsp;/usr/local/mysql/lib<br>&emsp;&emsp;/usr/local/openssl/lib &emsp; &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;#openssl变量</p><p>&emsp;&emsp;添加保存后记得更新动态库的缓存：<br>&emsp;&emsp;ldconfig -v</p><h3 id="备份系统默认的gcc版本"><a href="#备份系统默认的gcc版本" class="headerlink" title="备份系统默认的gcc版本"></a>备份系统默认的gcc版本</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mv <span class="regexp">/usr/</span>bin<span class="regexp">/gcc /u</span>sr<span class="regexp">/bin/g</span>cc-bak</span><br><span class="line">mv <span class="regexp">/usr/</span>bin<span class="regexp">/g++ /u</span>sr<span class="regexp">/bin/g</span>++-bak</span><br><span class="line">mv <span class="regexp">/usr/</span>bin<span class="regexp">/c++ /u</span>sr<span class="regexp">/bin/</span>c++-bak</span><br></pre></td></tr></table></figure><h3 id="建新的gcc软连接"><a href="#建新的gcc软连接" class="headerlink" title="建新的gcc软连接"></a>建新的gcc软连接</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ln -s <span class="regexp">/usr/</span>local<span class="regexp">/gcc/</span>bin<span class="regexp">/gcc /u</span>sr<span class="regexp">/bin/g</span>cc</span><br><span class="line">ln -s <span class="regexp">/usr/</span>local<span class="regexp">/gcc/</span>bin<span class="regexp">/c++ /u</span>sr<span class="regexp">/bin/</span>c++</span><br><span class="line">ln -s <span class="regexp">/usr/</span>local<span class="regexp">/gcc/</span>bin<span class="regexp">/g++ /u</span>sr<span class="regexp">/bin/g</span>++</span><br><span class="line">ln -s <span class="regexp">/usr/</span>local<span class="regexp">/gcc/</span>lib64<span class="regexp">/libstdc++.so.6.0.22 /u</span>sr<span class="regexp">/lib64/</span>libstdc++.so.<span class="number">6</span></span><br></pre></td></tr></table></figure><h2 id="编译安装linux-kernel-5-2-9"><a href="#编译安装linux-kernel-5-2-9" class="headerlink" title="编译安装linux kernel 5.2.9"></a>编译安装linux kernel 5.2.9</h2><p>&emsp;&emsp;高高兴兴cd linux-5.2.9，进入解压好的内核目录，做好.config配置文件，准备用make menuconfig对内核进行自定义配置的时候，报错了：</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">error </span>while loading shared libraries: libmpc.so.3: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;这又是怎么回事。好像是gcc出问题了。返回去检查。<br>&emsp;&emsp;原来添加完库忘了更新动态库,输入命令:</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ldconfig -v</span></span><br></pre></td></tr></table></figure><p>~<br>结果还报错：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">scripts/kconfig/mconf  Kconfig</span><br><span class="line">Your display is too small <span class="keyword">to</span> <span class="builtin-name">run</span> Menuconfig!</span><br><span class="line">It must be at least 19 lines by 80 columns.</span><br><span class="line">make[2]: *** [menuconfig] <span class="builtin-name">Error</span> 1</span><br><span class="line">make[1]: *** [menuconfig] <span class="builtin-name">Error</span> 2</span><br><span class="line">make: *** [sub-make] <span class="builtin-name">Error</span> 2</span><br></pre></td></tr></table></figure><p>这是因为我的XSELL窗口太小了，把XSHELL放大最大化，果然就打开了熟悉的蓝色界面~<br><img src="https://img-blog.csdnimg.cn/20190829201133861.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>修改一些个性化的设置（例如改名、加NFS文件系统），就可以保存了。</p><h3 id="编译内核"><a href="#编译内核" class="headerlink" title="编译内核"></a>编译内核</h3><p>&emsp;&emsp;因为编译内核时间比较长，为防止发生断网或者断电等意外，我们创建一个SCREEN来编译。<br>&emsp;&emsp;</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">screen</span> -S linuxkernel</span><br><span class="line">yes | <span class="built_in">make</span> -j <span class="number">16</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;用一个yes命令省去一直手动y了，等待他编译完成就好了。<br>&emsp;&emsp;<br>&emsp;&emsp;在这又遇到一个报错，贴出来和大家分享下：</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">You are building kernel <span class="keyword">with</span> non-retpoline compiler.</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;去查了下，网上都说是因为gcc版本过低，或内核版本过高。可我这明显不是gcc版本低的问题（都那么高了），问题是内核版本应该也不是问题，毕竟之前CentOS7编译就没这么多事。正犯愁不知道怎么解决的时候，发现了一篇文章<a href="http://tjtech.me/how-to-run-kernel-in-qemu-for-x86_64.html" rel="noopener" target="_blank">查看原文</a>，发现这个报错可以通过修改参数直接不启用RETPOLINE从而跳过（具体后果未知），于是修改配置文件重新来过：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">make</span> clean</span><br><span class="line">sed -<span class="keyword">ri</span> <span class="string">'s@(CONFIG_RETPOLINE=).*@\1n@'</span> .config</span><br><span class="line"><span class="keyword">make</span> -<span class="keyword">j</span> <span class="number">16</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;果然就顺利编译成功了。</p><h3 id="编译模块"><a href="#编译模块" class="headerlink" title="编译模块"></a>编译模块</h3><p>&emsp;&emsp;然后安装模块：<br>&emsp;&emsp;</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make modules_ <span class="keyword">install</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;安装模块的时候，有报错：<br>&emsp;&emsp;</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ERROR: </span>modinfo: could not find module *</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;不过查了相关文章<a href="https://blog.csdn.net/maokexu123/article/details/42554923?locationNum=12" rel="noopener" target="_blank">查看原文</a>，好像这些模块也都可以正常使用，于是乎无视之~<br>&emsp;&emsp;最后，安装内核相关文件。<br>&emsp;&emsp;</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make <span class="keyword">install</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;至此，新内核就装完啦~重启切换去去体验一下！</p>]]></content>
      
      
      <categories>
          
          <category> linux基础 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> 编译安装 </tag>
            
            <tag> kernel </tag>
            
            <tag> 踩坑 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>for循环实现的小脚本</title>
      <link href="//blog/a96e917a.html"/>
      <url>//blog/a96e917a.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;用for循环写了个小脚本，可以输出不同大小的图案，能力有限，输出了一个不太规则的字符图案，希望可以早日写出一个脚本可以自动填充放大任何ASCII图案。<br>&emsp;&emsp;效果图如下：<br><img src="https://img-blog.csdnimg.cn/20190822214007509.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><a id="more"></a><p><img src="https://img-blog.csdnimg.cn/20190822214020522.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190822214032160.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190822214042568.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;脚本如下：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">read -p <span class="string">"please input the size :"</span>  n</span><br><span class="line">[ <span class="string">"$n"</span> -ge <span class="number">0</span> ] <span class="number">2</span>&gt;<span class="regexp">/dev/null</span> <span class="params">||</span> &#123; echo <span class="string">"please input a right num!"</span>;exit <span class="number">10</span>;&#125;</span><br><span class="line">mkdir -p ~<span class="regexp">/best/best</span></span><br><span class="line">N=<span class="string">`echo $n-1|bc`</span></span><br><span class="line">J=<span class="string">`echo $N/2+1|bc`</span></span><br><span class="line">K=<span class="string">`echo $N/4+1|bc`</span></span><br><span class="line">L=<span class="string">`echo $N/5|bc`</span></span><br><span class="line"><span class="comment">#第一行</span></span><br><span class="line">echo -e <span class="string">'88888\c'</span> &gt;~<span class="regexp">/best/best</span>.f1</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">echo -e <span class="string">'888\c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f1</span><br><span class="line">done</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $L);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'88\c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f1</span><br><span class="line">done</span><br><span class="line">echo <span class="string">'888ba'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f1</span><br><span class="line"><span class="comment">#第二行</span></span><br><span class="line">echo -e <span class="string">'8\c'</span>  &gt;~<span class="regexp">/best/best</span>.f2</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $L);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'8\c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f2</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'8   \c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f2</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'   \c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f2</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'   "8\c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f2</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $L);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'8\c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f2</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'b                        \c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f2</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'     \c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f2</span><br><span class="line">done</span><br><span class="line">echo <span class="string">',d'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f2</span><br><span class="line"><span class="comment">#第三行</span></span><br><span class="line">echo -e <span class="string">'8\c'</span> &gt;~<span class="regexp">/best/best</span>.f3</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $L);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'8\c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f3</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'8   \c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f3</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'   \c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f3</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'   "8\c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f3</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $L);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'8\c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f3</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'P                        \c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f3</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'     \c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f3</span><br><span class="line">done</span><br><span class="line">echo <span class="string">'88'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f3</span><br><span class="line"><span class="comment">#第四行</span></span><br><span class="line">echo -e <span class="string">'8\c'</span> &gt;~<span class="regexp">/best/best</span>.f4</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $L);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'8\c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f4</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'8aaa\c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f4</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'aaa\c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f4</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'aaa8\c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f4</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $L);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'8\c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f4</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'P'</span><span class="string">"'"</span><span class="string">'  ,adP\c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f4</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'PP\c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f4</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'PYba, ,adP\c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f4</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'PP\c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f4</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'PYba, MM\c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f4</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'M\c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f4</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'88MM\c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f4</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'M\c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f4</span><br><span class="line">done</span><br><span class="line">echo <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f4</span><br><span class="line"><span class="comment">#第五行</span></span><br><span class="line">echo -e <span class="string">'8\c'</span>  &gt;~<span class="regexp">/best/best</span>.f5</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $L);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'8\c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f5</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'8   \c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f5</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'   \c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f5</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'   8\c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f5</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $L);<span class="keyword">do</span></span><br><span class="line">echo -e <span class="string">'8\c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f5</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'b, a8P  \c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f5</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'  \c'</span>   <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f5</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'   `8 I8[ \c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f5</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'  \c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f5</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'   "'</span><span class="string">"'"</span><span class="string">'  \c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f5</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">' \c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f5</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">' 88'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f5</span><br><span class="line"><span class="comment">#第六行</span></span><br><span class="line">echo -e <span class="string">'8\c'</span>  &gt;~<span class="regexp">/best/best</span>.f6</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $L);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'8\c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f6</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'8   \c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f6</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'   \c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f6</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'   `8\c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f6</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $L);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'8\c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f6</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'b 8PP""\c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f6</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'""\c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f6</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'"""`'</span><span class="string">"'"</span><span class="string">'  `"Y8\c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f6</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'88\c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f6</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'ba,   \c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f6</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">' \c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f6</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">' 88\c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f6</span><br><span class="line">echo <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f6</span><br><span class="line"><span class="comment">#第七行</span></span><br><span class="line">echo -e <span class="string">'8\c'</span>  &gt;~<span class="regexp">/best/best</span>.f7</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $L);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'8\c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f7</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'8   \c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f7</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'   \c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f7</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'   a8\c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f7</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $L);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'8\c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f7</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'P "8b, \c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f7</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'  \c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f7</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'  ,aa aa  \c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f7</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'  \c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f7</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'  ]8I  \c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f7</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">' \c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f7</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">' 88,'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f7</span><br><span class="line"><span class="comment">#第八行</span></span><br><span class="line">echo -e <span class="string">'88888\c'</span> &gt;~<span class="regexp">/best/best</span>.f8</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'888\c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f8</span><br><span class="line">done</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $L);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'88\c'</span>  <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f8</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'888P"   `"Ybb\c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f8</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'oo\c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f8</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'d8"'</span><span class="string">"'"</span><span class="string">' `"Ybb\c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f8</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'oo\c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f8</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">'dP"'</span><span class="string">"'"</span><span class="string">'  \c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f8</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">' \c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f8</span><br><span class="line">done</span><br><span class="line">echo -e <span class="string">' "Y888\c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f8</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq $N);<span class="keyword">do</span></span><br><span class="line">        echo -e <span class="string">'8\c'</span> <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f8</span><br><span class="line">done</span><br><span class="line">echo <span class="meta">&gt;&gt;</span>~<span class="regexp">/best/best</span>.f8</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> $(seq $K);<span class="keyword">do</span></span><br><span class="line">cat ~<span class="regexp">/best/best</span>.f1</span><br><span class="line">done</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> $(seq $J);<span class="keyword">do</span></span><br><span class="line">cat ~<span class="regexp">/best/best</span>.f2</span><br><span class="line">done</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> $(seq $J);<span class="keyword">do</span></span><br><span class="line">cat ~<span class="regexp">/best/best</span>.f3</span><br><span class="line">done</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> $(seq $K);<span class="keyword">do</span></span><br><span class="line">cat ~<span class="regexp">/best/best</span>.f4</span><br><span class="line">done</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> $(seq $J);<span class="keyword">do</span></span><br><span class="line">cat ~<span class="regexp">/best/best</span>.f5</span><br><span class="line">done</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> $(seq $K);<span class="keyword">do</span></span><br><span class="line">cat ~<span class="regexp">/best/best</span>.f6</span><br><span class="line">done</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> $(seq $J);<span class="keyword">do</span></span><br><span class="line">cat ~<span class="regexp">/best/best</span>.f7</span><br><span class="line">done</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> $(seq $K);<span class="keyword">do</span></span><br><span class="line">cat ~<span class="regexp">/best/best</span>.f8</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\rm -rf ~<span class="regexp">/best/best</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;脚本写的太复杂，可读性太差，等日后水平提升再来改进，留存！</p>]]></content>
      
      
      <categories>
          
          <category> linux基础 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> script </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CentOS7磁盘分区及文件系统</title>
      <link href="//blog/2bae1e5c.html"/>
      <url>//blog/2bae1e5c.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><strong>&emsp;&emsp;一般来说，硬盘上的空间，想要被我们利用，都要经过几个步骤：</strong></p><ul><li>1设备识别</li><li>2磁盘分区</li><li>3创建文件系统（并标记文件系统）</li><li>4挂载新的文件系统</li><li>5在/etc/fstab文件中创建新条目<br>&emsp;</li></ul><p><strong>&emsp;&emsp;只有当设备被挂载到文件系统中，才可以被我们访问且使用。</strong><br>&emsp;</p><a id="more"></a><h2 id="1-设备识别"><a href="#1-设备识别" class="headerlink" title="1 设备识别"></a>1 设备识别</h2><p> 新插入硬盘设备，没法被系统立马识别到，需要手动扫描，才可以发现并识别新设备<br><code>echo &quot;- - -&quot; &gt; /sys/class/scsi_host/host0/scan</code><br>/sys/class/scsi_host/        目录下面有几个host 就扫描几次。<br>&emsp;<br>&emsp;</p><h2 id="2-磁盘分区"><a href="#2-磁盘分区" class="headerlink" title="2 磁盘分区"></a>2 磁盘分区</h2><h3 id="2-1为什么要分区"><a href="#2-1为什么要分区" class="headerlink" title="2.1为什么要分区"></a>2.1为什么要分区</h3><ul><li>优化I/O性能</li><li>实现磁盘空间配额限制</li><li>提高修复速度</li><li>隔离系统和程序</li><li>安装多个OS</li><li>采用不同文件系统</li></ul><h3 id="2-2分区方式"><a href="#2-2分区方式" class="headerlink" title="2.2分区方式"></a>2.2分区方式</h3><p>&emsp;&emsp;一般来说有两种分区方式 ：<strong>MBR</strong>和<strong>GPT</strong>。</p><ul><li><p><strong>MBR</strong>：全程Master Boot Record，1982年，使用32位表示扇区，单个分区不超过2T。</p></li><li><p>如何分区：按柱面</p></li><li><p>0磁道0扇面：512bytes<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;446byets：boot loader<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;64bytes  ： 分区表，其中每16bytes标识一个分区<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;2byetes&emsp;：55AA</p></li><li><p>MBR分区中一块硬盘最多有4个主分区，也可以三主分区+1拓展（N个逻辑分区）<br>&emsp;</p><h4 id="MBR分区结构"><a href="#MBR分区结构" class="headerlink" title="MBR分区结构"></a>MBR分区结构</h4><p><img src="https://img-blog.csdnimg.cn/20190815093309132.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="MBR硬盘分区结构图"></p><h4 id="MBR分区表"><a href="#MBR分区表" class="headerlink" title="MBR分区表"></a>MBR分区表</h4><p>&emsp;&emsp;硬盘主导记录MBR由4个部分组成</p></li><li><p>主引导程序（偏移地址0000H–0088H），它负责从活动分区中装载，并运行系统引导程序</p></li><li><p>出错信息数据区，偏移地址0089H-00E1H为出错信息，00E2H-01BDH全为0字节</p></li><li><p>分区表（DPT,Disk Partition Table）含4个分区项，偏移地址01BEH–01FDH，每个分区表长16个字节，共64字节为分区项1、分区项2、分区项3、分区项4</p></li><li><p>结束标志字，偏移地址01FE–01FF的2个字节值为结束标志55AA<br><img src="https://img-blog.csdnimg.cn/20190815095231719.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="硬盘主导记录MBR"><br>&emsp;</p><ul><li><strong>GPT</strong>：GUID（Globals Unique Identifiers） partition table 支持128个分区，使用64位，支持8Z（ 512Byte/block ）64Z （ 4096Byte/block）</li><li>使用128位UUID(Universally Unique Identifier) 表示磁盘和分区 GPT分区表<br>自动备份在头和尾两份，并有CRC校验位</li><li>UEFI (Unified Extensible Firmware Interface 统一可扩展固件接口)硬件支持<br>GPT，使操作系统启动<br>&emsp;<h4 id="GPT分区结构"><a href="#GPT分区结构" class="headerlink" title="GPT分区结构"></a>GPT分区结构</h4><img src="https://img-blog.csdnimg.cn/20190815100433738.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="GPT分区机构图"><h3 id="2-3管理分区"><a href="#2-3管理分区" class="headerlink" title="2.3管理分区"></a>2.3管理分区</h3><h4 id="2-31列出块设备"><a href="#2-31列出块设备" class="headerlink" title="2.31列出块设备"></a>2.31列出块设备</h4><h4 id="2-32创建新分区"><a href="#2-32创建新分区" class="headerlink" title="2.32创建新分区"></a>2.32创建新分区</h4>&emsp;&emsp;parted命令：parted [选项]… [设备 [命令 [参数]…]…]<br>&emsp;&emsp;parted /dev/sdb mklabel gpt|msdos<br>&emsp;&emsp;parted /dev/sdb print<br>&emsp;&emsp;parted /dev/sdb mkpart primary 1 200 （默认M）<br>&emsp;&emsp;parted /dev/sdb rm 1<br>&emsp;&emsp;parted –l 列出分区信息</li></ul><p><strong>parted的操作都是实时生效的，小心使用</strong><br>&emsp;<br>&emsp;&emsp; fdisk -l [-u] [device…] 查看分区<br>&emsp;&emsp; fdisk /dev/sdb 管理分区<br>子命令：<br>&emsp;&emsp;&emsp;&emsp;&emsp;p 查看分区列表<br>&emsp;&emsp;&emsp;&emsp;&emsp;t 更改分区类型<br>&emsp;&emsp;&emsp;&emsp;&emsp;n 创建新分区<br>&emsp;&emsp;&emsp;&emsp;&emsp;d 删除分区<br>&emsp;&emsp;&emsp;&emsp;&emsp;v 校验分区<br>&emsp;&emsp;&emsp;&emsp;&emsp;u 转换单位<br>&emsp;&emsp;&emsp;&emsp;&emsp;w 保存并退出<br>&emsp;&emsp;&emsp;&emsp;&emsp;q 不保存并退出<br>&emsp;<br>gdisk命令与fdisk用法相同，用于创建GPT分区。</p><h4 id="2-33同步内核与硬盘的分区表"><a href="#2-33同步内核与硬盘的分区表" class="headerlink" title="2.33同步内核与硬盘的分区表"></a>2.33同步内核与硬盘的分区表</h4><p>查看内核是否已经识别新的分区<br>cat /proc/partations<br><strong>centos6</strong>通知内核重新读取硬盘分区表<br>新增分区用<br>partx -a /dev/DEVICE<br>kpartx -a /dev/DEVICE -f: force<br>删除分区用<br>partx -d –nr M-N /dev/DEVICE<br><strong>CentOS 5，7</strong>: 使用partprobe<br>partprobe [/dev/DEVICE]</p><h2 id="3-创建文件系统"><a href="#3-创建文件系统" class="headerlink" title="3 创建文件系统"></a>3 创建文件系统</h2><h3 id="3-1文件系统"><a href="#3-1文件系统" class="headerlink" title="3.1文件系统"></a>3.1文件系统</h3><p>&emsp;&emsp;文件系统是操作系统用于明确存储设备或分区上的文件的方法和数据结构；即在存储设备上组织文件的方法。操作系统中负责管理和存储文件信息的软件结<br>构称为文件管理系统，简称文件系统从系统角度来看，文件系统是对文件存储设备的空间进行组织和分配，负责文件存储并对存入的文件进行保护和检索的系统。具体地说，它负责为用户建立文件，存入、读出、修改、转储文件，控制文件的存取，安全控制，日志，压缩，加密等<br>&emsp;&emsp;&emsp;支持的文件系统：<code>/lib/modules/`uname –r`/kernel/fs</code><br>&emsp;&emsp;&emsp;各种文件系统：<a href="https://en.wikipedia.org/wiki/Comparison_of_file_systems" rel="noopener" target="_blank">https://en.wikipedia.org/wiki/Comparison_of_file_systems</a></p><h4 id="3-11文件系统类型"><a href="#3-11文件系统类型" class="headerlink" title="3.11文件系统类型"></a>3.11文件系统类型</h4><p>Linux文件系统：<br>&emsp;&emsp;ext2(Extended file system)：适用于那些分区容量不是太大，更新也不频繁的情况，例如 /boot 分区<br>&emsp;&emsp;ext3：是 ext2 的改进版本，其支持日志功能，能够帮助系统从非正常关机导致的异常中恢复。它通常被用作通用的文件系统<br>&emsp;&emsp;ext4：是 ext 文件系统的最新版。提供了很多新的特性，包括纳秒级时间戳、创建和使用巨型文件(16TB)、最大1EB的文件系统，以及速度的提升<br>&emsp;&emsp;xfs：SGI，支持最大8EB的文件系统<br>&emsp;&emsp;btrfs（Oracle）, reiserfs, jfs（AIX）, swap<br>光盘：iso9660<br>Windows：FAT32, NTFS，exFAT<br>Unix：FFS（fast）, UFS（unix）, JFS2<br>网络文件系统：NFS, CIFS<br>集群文件系统：GFS2, OCFS2（oracle）<br>分布式文件系统：fastdfs,ceph, moosefs, mogilefs, glusterfs, Lustre<br>RAW：未经处理或者未经格式化产生的文件系统</p></li></ul><h4 id="3-12文件系统分类"><a href="#3-12文件系统分类" class="headerlink" title="3.12文件系统分类"></a>3.12文件系统分类</h4><p>根据其是否支持”journal”功能：<br>&emsp;&emsp;日志型文件系统: ext3, ext4, xfs, …<br>&emsp;&emsp;非日志型文件系统: ext2, vfat<br>文件系统的组成部分：<br>&emsp;&emsp;内核中的模块：ext4, xfs, vfat<br>&emsp;&emsp;用户空间的管理工具：mkfs.ext4, mkfs.xfs,mkfs.vfat<br>Linux的虚拟文件系统：VFS<br><strong>查前支持的文件系统：<code>cat /proc/filesystems</code></strong><br><strong>查前目前的文件系统：<code>lsblk -f</code></strong></p><h3 id="3-2创建文件系统"><a href="#3-2创建文件系统" class="headerlink" title="3.2创建文件系统"></a>3.2创建文件系统</h3><p>mkfs命令：<br>(1) mkfs.FS_TYPE /dev/DEVICE<br>&emsp;&emsp;&emsp;&emsp;ext4<br>&emsp;&emsp;&emsp;&emsp;xfs<br>&emsp;&emsp;&emsp;&emsp;btrfs<br>&emsp;&emsp;&emsp;&emsp;vfat<br>(2) mkfs -t FS_TYPE /dev/DEVICE<br>&emsp;&emsp;&emsp;&emsp;-L ‘LABEL’ 设定卷标<br>&emsp;mke2fs命令：ext系列文件系统专用管理工具<br>&emsp;&emsp;&emsp;-t {ext2|ext3|ext4} 指定文件系统类型<br>&emsp;&emsp;&emsp;-b {1024|2048|4096} 指定块大小<br>&emsp;&emsp;&emsp;-L ‘LABEL’ 设置卷标<br>&emsp;&emsp;&emsp;-j 相当于 -t ext3 <strong>(mkfs.ext3 = mkfs -t ext3 = mke2fs -j = mke2fs -t ext3)`</strong><br>&emsp;&emsp;&emsp;-i # 为数据空间中每多少个字节创建一个inode；不应该小于block大小<br>&emsp;&emsp;&emsp;-N # 指定分区中创建多少个inode<br>&emsp;&emsp;&emsp;-I 一个inode记录占用的磁盘空间大小，128—4096<br>&emsp;&emsp;&emsp;-m # 默认5%,为管理人员预留空间占总空间的百分比<br>&emsp;&emsp;&emsp;-O FEATURE[,…] 启用指定特性<br>&emsp;&emsp;&emsp;-O ^FEATURE 关闭指定特性</p><h3 id="3-3文件系统标签"><a href="#3-3文件系统标签" class="headerlink" title="3.3文件系统标签"></a>3.3文件系统标签</h3><p>文件系统标签是指向设备的另一种方法。与设备无关<br><strong>blkid</strong>：块设备属性信息查看<br>blkid [OPTION]… [DEVICE]<br>&emsp;&emsp;&emsp;-U UUID 根据指定的UUID来查找对应的设备<br>&emsp;&emsp;&emsp;-L LABEL 根据指定的LABEL来查找对应的设备<br><strong>e2label</strong>：管理ext系列文件系统的LABEL<br>e2label DEVICE [LABEL]<br><strong>findfs</strong> ：查找分区<br>findfs [options] LABEL= &lt; label &gt;<br>findfs [options] UUID= &lt; uuid &gt;</p><h3 id="3-4文件系统检测和修复"><a href="#3-4文件系统检测和修复" class="headerlink" title="3.4文件系统检测和修复"></a>3.4文件系统检测和修复</h3><p>文件系统夹故障常发生于死机或者非正常关机之后，挂载为文件系统标记为“no clean”<br> 注意：一定不要在挂载状态下执行下面命令修复<br> <strong>fsck: File System Check</strong><br>&emsp;&emsp;fsck.FS_TYPE<br>&emsp;&emsp;fsck -t FS_TYPE<br>注意：FS_TYPE 一定要与分区上已经文件类型相同<br>-a 自动修复<br>-r 交互式修复错误<br> <strong>e2fsck：ext系列文件专用的检测修复工具</strong><br>-y 自动回答为yes<br>-f 强制修复<br>-p 自动进行安全的修复文件系统问题<br><strong>xfs_repair：xfs文件系统专用检测修复工具</strong><br>-f 修复文件，而设备<br>-n 只检查<br>-d 允许修复只读的挂载设备，在单用户下修复 / 时使用，然后立即reboot</p><h2 id="4-挂载新的文件系统"><a href="#4-挂载新的文件系统" class="headerlink" title="4 挂载新的文件系统"></a>4 挂载新的文件系统</h2><p><strong>挂载：</strong> 将额外文件系统与根文件系统某现存的目录建立起关联关系，进而使得此目录做为其它文件访问入口的行为<br><strong>卸载：</strong> 为解除此关联关系的过程<br>把设备关联挂载点：mount Point<br>&emsp;&emsp;mount  设备名   挂载点<br>卸载时：可使用设备，也可以使用挂载点<br>&emsp;&emsp;umount 设备名|挂载点<br>PS：挂载点下原有文件在挂载完成后会被临时隐藏<br>&emsp;&emsp; 挂载点目录一般为空</p><h3 id="4-1用mount命令挂载文件系统"><a href="#4-1用mount命令挂载文件系统" class="headerlink" title="4.1用mount命令挂载文件系统"></a>4.1用mount命令挂载文件系统</h3><p><strong>挂载方法</strong>：mount DEVICE MOUNT_POINT<br>&emsp;&emsp;mount：通过查看/etc/mtab文件显示当前已挂载的所有设备<br>&emsp;&emsp;mount [-fnrsvw] [-t vfstype] [-o options] device dir<br>device：指明要挂载的设备；<br>&emsp;&emsp;(1) 设备文件：例如/dev/sda5<br>&emsp;&emsp;(2) 卷标：-L ‘LABEL’, 例如 -L ‘MYDATA’<br>&emsp;&emsp;(3) UUID, -U ‘UUID’：例如 -U ‘0c50523c-43f1-45e7-85c0-a126711d406e’<br>&emsp;&emsp;(4) 伪文件系统名称：proc, sysfs, devtmpfs, configfs<br>dir：挂载点需事先存在，建议使用空目录；进程正在使用中的设备无法被卸载。<br><strong>mount常用命令选项</strong><br>&emsp;&emsp;-t vsftype 指定要挂载的设备上的文件系统类型<br>&emsp;&emsp;-r readonly，只读挂载<br>&emsp;&emsp;-w read and write, 读写挂载<br>&emsp;&emsp;-n 不更新/etc/mtab，mount不可见<br>&emsp;&emsp;-a 自动挂载所有支持自动挂载的设备(定义在了/etc/fstab文件中，且挂载选项中有auto功能)<br>&emsp;&emsp;-L ‘LABEL’ 以卷标指定挂载设备<br>&emsp;&emsp;-U ‘UUID’ 以UUID指定要挂载的设备<br>&emsp;&emsp;-B, –bind 绑定目录到另一个目录上<br>&emsp;&emsp;查看内核追踪到的已挂载的所有设备：cat /proc/mounts</p><p>&emsp;&emsp;-o options：(挂载文件系统的选项)，多个选项使用逗号分隔<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;async 异步模式 sync 同步模式,内存更改时，同时写磁盘<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;包含目录和文件<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;diratime/nodiratime 目录的访问时间戳<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;auto/noauto 是否支持自动挂载,是否支持-a选项<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;exec/noexec 是否支持将文件系统上运行应用程序<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;dev/nodev 是否支持在此文件系统上使用设备文件<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;suid/nosuid 是否支持suid和sgid权限<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;remount 重新挂载<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;ro 只读 rw 读写<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;user/nouser 是否允许普通用户挂载此设备，/etc/fstab使用<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;acl 启用此文件系统上的acl功能<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;loop 使用loop设备<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;_netdev 当网络可用时才对网络资源进行挂载，如：NFS文件系统<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;defaults 相当于rw, suid, dev, exec, auto, nouser, async</p><h3 id="4-2卸载命令"><a href="#4-2卸载命令" class="headerlink" title="4.2卸载命令"></a>4.2卸载命令</h3><p>查看挂载情况<br>&emsp;&emsp;findmnt MOUNT_POINT|device<br>查看正在访问指定文件系统的进程<br>&emsp;&emsp;lsof MOUNT_POINT<br>&emsp;&emsp;fuser -v MOUNT_POINT<br>终止所有在正访问指定的文件系统的进程<br>&emsp;&emsp;fuser -km MOUNT_POINT<br>卸载<br>&emsp;&emsp;umount DEVICE<br>&emsp;&emsp;umount MOUNT_POINT</p><h2 id="5-修改-etc-fstab配置文件"><a href="#5-修改-etc-fstab配置文件" class="headerlink" title="5 修改/etc/fstab配置文件"></a>5 修改/etc/fstab配置文件</h2><p>&emsp;&emsp;使用mount命令挂载设备都是临时挂载，每次开机后需要手动重新挂载，比较费时费力，如果需要实现自动挂载，就要修改文件系统挂载配置文件/etc/fstab文件。<br>/etc/fstab文件 下面的每行定义一个要挂载的文件系统<br>&emsp;&emsp;总共六列，分别对应设备、挂载点、文件系统类型、挂载选项、转储频率及是否自检。<br> 1、要挂载的设备或伪文件系统<br>设备文件<br>LABEL：LABEL=””<br>UUID：UUID=””<br>伪文件系统名称：proc, sysfs<br> 2、挂载点  一般为某文件或目录<br> 3、文件系统类型：ext4，xfs，iso9660，nfs，none<br> 4、挂载选项：defaults（包括rw suidi dev exac auto nouser async） ，acl，bind<br> 5、转储频率：0：不做备份 1：每天转储 2：每隔一天转储<br> 6、fsck检查的文件系统的顺序：允许的数字是0 1 2<br>&emsp;&emsp;0：不自检<br>&emsp;&emsp;1：首先自检；一般只有rootfs才用<br>&emsp;&emsp;2：非rootfs使用<br>&emsp;&emsp;可以使用cat 、echo 等命令 将这6个信息 追加至/etc/fstab文件中，也可以用sed 命令 。</p><p>&emsp;&emsp;<strong>使用<code>mount -a</code> 命令可以立即挂载/etc/fstab中的所有文件系统</strong></p>]]></content>
      
      
      <categories>
          
          <category> linux基础 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> filesystem </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>我的一键个性化系统脚本</title>
      <link href="//blog/92724e23.html"/>
      <url>//blog/92724e23.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;经常要把虚拟机上的系统搞崩，总是各种报错，有次yum安装gcc程序都报错，一旦折腾半天解决不了，只好选择最笨却最有效的方法——还原vrm虚拟机的快照！可是还原快照到干净系统，就导致之前做的喜欢的配置又都没了 还要去慢慢设置开机图案、别名以及各种环境变量比较麻烦，于是就费了点时间，写了下面这个脚本，每次都可以一键实现让新系统恢复自己当初个性化的各种设置。<br>&emsp;&emsp;先传效果图：<br><img src="https://img-blog.csdnimg.cn/20190811201614786.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">read -p &quot;please input a name for the address:&quot; USERDIR</span><br><span class="line">#输入用户名，方便在/etc目录下存放生成的配置文件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[ -a /etc/$USERDIR ] &amp;&amp; [ -d /etc/$USERDIR ] ||&#123; \rm -rf /etc/$USERDIR; mkdir /etc/$USERDIR; &#125;</span><br><span class="line">#mkdir /etc/$USERDIR</span><br><span class="line">#生成配置文件目录，若已存在则直接使用此目录</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; /etc/$USERDIR/motd &lt;&lt; END</span><br><span class="line"></span><br><span class="line">oooooooooooo              oooooooooo.               ooooooooooooo oooo                     oooooooooo.                         .  </span><br><span class="line">8&apos;   888   &apos;8              &apos;888&apos;   &apos;Y8b              8&apos;   888   &apos;8 &apos;888                     &apos;888&apos;   &apos;Y8b                      .o8  </span><br><span class="line">     888       &apos;ooooo.      888     888  .ooooo.          888       888 .oo.    .ooooo.      888     888  .ooooo.   .oooo.o .o888oo</span><br><span class="line">     888      d88&apos; &apos;88b     888oooo888&apos; d88&apos; &apos;88b         888       888P&quot;Y88b  d88&apos; &apos;88b     888oooo888&apos; d88&apos; &apos;88b d88(  &quot;8   888  </span><br><span class="line">     888      888   888     888    &apos;88b 888ooo888         888       888   888  888ooo888     888    &apos;88b 888ooo888 &apos;&quot;Y88b.    888  </span><br><span class="line">     888      888   888     888    .88P 888    .o         888       888   888  888    .o     888    .88P 888    .o o.  )88b   888 .</span><br><span class="line">    o888o     &apos;Y8bod8P&apos;    o888bood8P&apos;  &apos;Y8bod8P&apos;        o888o     o888o o888o &apos;Y8bod8P&apos;    o888bood8P&apos;  &apos;Y8bod8P&apos; 8&quot;&apos;888P&apos;   &quot;888&quot;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">#生成开机欢迎动画，可以随意修改</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#创建/etc/$USERDIR/login.sh配置文件</span><br><span class="line">[ -a /etc/$USERDIR ] &amp;&amp; [ -d /etc/$USERDIR ]&amp;&amp; [ -w /etc/$USERDIR ]  ||&#123; \rm -rf /etc/$USERDIR; mkdir /etc/$USERDIR; &#125;</span><br><span class="line">#确认文件目录存在且可用,开始写配置文件。</span><br><span class="line">#因为水平有限，不知道怎么把命令以及变量通过脚本生成到新脚本里</span><br><span class="line">#只能采用最笨的方法——一行一行的写入，希望各位大佬可以指点一二。</span><br><span class="line"></span><br><span class="line">echo &apos;#!/bin/bash &apos;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;cat /etc/$USERDIR/motd&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;date=`date &quot;+%F %T&quot;`&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;head=&quot;System information as of: $date&quot;&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;kernel=`uname -r`&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;hostname=`echo $HOSTNAME`&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;#Cpu load&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;load1=`cat /proc/loadavg | awk &apos;&quot;&apos;&quot;&apos;&#123;print $1&#125;&apos;&quot;&apos;&quot;&apos;`&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;load5=`cat /proc/loadavg | awk &apos;&quot;&apos;&quot;&apos;&#123;print $2&#125;&apos;&quot;&apos;&quot;&apos;`&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;load15=`cat /proc/loadavg | awk &apos;&quot;&apos;&quot;&apos;&#123;print $3&#125;&apos;&quot;&apos;&quot;&apos;`&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;#System uptime&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;uptime=`cat /proc/uptime | cut -f1 -d.`&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;upDays=$((uptime/60/60/24))&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;upHours=$((uptime/60/60%24))&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;upMins=$((uptime/60%60))&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;upSecs=$((uptime%60))&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;up_lastime=`date -d &quot;$(awk -F. &apos;&quot;&apos;&quot;&apos;&#123;print $1&#125;&apos;&quot;&apos;&quot;&apos; /proc/uptime) second ago&quot; +&quot;%Y-%m-%d %H:%M:%S&quot;`&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;#Memory Usage&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;mem_usage=`free -m | awk &apos;&quot;&apos;&quot;&apos;/Mem:/&#123;total=$2&#125; /buffers\/cache/ &#123;used=$3&#125; END &#123;printf(&quot;%3.2f%%&quot;,used/total*100)&#125;&apos;&quot;&apos;&quot;&apos;`&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;swap_usage=`free -m | awk &apos;&quot;&apos;&quot;&apos;/Swap/&#123;printf &quot;%.2f%&quot;,$3/$2*100&#125;&apos;&quot;&apos;&quot;&apos;`&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;#Processes&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;processes=`ps aux | wc -l`&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;#User&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;users=`users | wc -w`&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;USER=`whoami`&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;#System fs usage&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;Filesystem=$(df -h | awk &apos;&quot;&apos;&quot;&apos;/^\/dev/&#123;print $6&#125;&apos;&quot;&apos;&quot;&apos;)&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;#Interfaces&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;INTERFACES=$(ip -4 ad | grep &apos;&quot;&apos;&quot;&apos;state &apos;&quot;&apos;&quot;&apos; | awk -F&quot;:&quot; &apos;&quot;&apos;&quot;&apos;!/^[0-9]*: ?lo/ &#123;print $2&#125;&apos;&quot;&apos;&quot;&apos;|grep e)&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;echo &quot;+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++&quot;&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;echo &quot;$head&quot;&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;echo &quot;----------------------------------------------&quot;&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;printf &quot;Kernel Version:\t%s\n&quot; $kernel&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;printf &quot;HostName:\t%s\n&quot; $hostname&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;printf &quot;System Load:\t%s %s %s\n&quot; $load1, $load5, $load15&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;printf &quot;System Uptime:\t%s &quot;days&quot; %s &quot;hours&quot; %s &quot;min&quot; %s &quot;sec&quot;\n&quot; $upDays $upHours $upMins $upSecs&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;printf &quot;Memory Usage:\t%s\t\t\tSwap Usage:\t%s\n&quot; $mem_usage $swap_usage&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;printf &quot;Login Users:\t%s\t\t\tWhoami:\t\t%s\n&quot; $users $USER&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;printf &quot;Processes:\t%s\n&quot; $processes&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;printf &quot;\n&quot;&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;printf &quot;Filesystem\tUsage\n&quot;&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;for f in $Filesystem&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;do&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;    Usage=$(df -h | awk &apos;&quot;&apos;&quot;&apos;&#123;if($NF==&quot;&apos;&quot;&apos;&quot;&apos;&apos;&quot;&apos;&quot;&apos;&apos;&quot;&apos;&quot;&apos;$f&apos;&quot;&apos;&quot;&apos;&apos;&quot;&apos;&quot;&apos;&apos;&quot;&apos;&quot;&apos;&quot;) print $5&#125;&apos;&quot;&apos;&quot;&apos;)&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;    echo -e &quot;$f\t\t$Usage&quot;&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;done&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;printf &quot;\n&quot;&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;printf &quot;Interface\tMAC Address\t\tIP Address\n&quot;&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;for i in $INTERFACES&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;do&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;    MAC=$(ip ad show dev $i | grep &quot;link/ether&quot; | awk &apos;&quot;&apos;&quot;&apos;&#123;print $2&#125;&apos;&quot;&apos;&quot;&apos;)&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;    IP=$(ip ad show dev $i | awk &apos;&quot;&apos;&quot;&apos;/inet / &#123;print $2&#125;&apos;&quot;&apos;&quot;&apos;)&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;    printf $i&quot;\t\t&quot;$MAC&quot;\t$IP\n&quot;&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;done&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;echo &quot;+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++&quot;&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line">echo &apos;echo&apos;&gt;&gt;/etc/$USERDIR/login.sh</span><br><span class="line"></span><br><span class="line">#生成脚本设置常用命令符以及别名及命令历史</span><br><span class="line">cat &gt; /etc/profile.d/env.sh &lt;&lt; END</span><br><span class="line">PS1=&quot;\e[1;36m[\u@\h \W]\\\\$\e[0m&quot;</span><br><span class="line">HISTTIMEFORMAT=&quot;%F %T &quot;</span><br><span class="line">HISTCONTROL=ignoreboth</span><br><span class="line">alias rm=&apos;mkdir -p /date/delete/`date +%F`;\mv -t /date/delete/`date +%F` -f&apos;</span><br><span class="line">bash /etc/$USERDIR/login.sh</span><br><span class="line">END</span><br><span class="line"></span><br><span class="line">sed -i &apos;s/^alias rm/#&amp;/&apos; ~/.bashrc</span><br><span class="line">#取消用户定义的alias rm。</span><br><span class="line"></span><br><span class="line">#生成VIM的格式脚本</span><br><span class="line">cat &gt; ~/.vimrc &lt;&lt; END</span><br><span class="line">#!/bin/bash</span><br><span class="line">&quot;&quot;新建.c,.h,.sh,.java文件，自动插入文件头 </span><br><span class="line">autocmd BufNewFile *.cpp,*.[ch],*.sh,*.java exec &quot;:call SetTitle()&quot; </span><br><span class="line">&quot;&quot;定义函数SetTitle，自动插入文件头 </span><br><span class="line">func SetTitle()</span><br><span class="line">&quot;&quot;如果文件类型为.sh文件 </span><br><span class="line">if &amp;filetype == &apos;sh&apos;</span><br><span class="line">call setline(1,&quot;\##########################################################################&quot;) </span><br><span class="line">call append(line(&quot;.&quot;), &quot;\# File Name:                  &quot;.expand(&quot;%&quot;))</span><br><span class="line">call append(line(&quot;.&quot;)+1,&quot;\# Author:                       Name &quot;)</span><br><span class="line">call append(line(&quot;.&quot;)+2,&quot;\# QQ:                      xxxxxxxxx&quot;) </span><br><span class="line">call append(line(&quot;.&quot;)+3,&quot;\# mail:                       xxxxxxxxxx@xxx.com&quot;) </span><br><span class="line">call append(line(&quot;.&quot;)+4,&quot;\# Description:                The test script&quot;) </span><br><span class="line">call append(line(&quot;.&quot;)+5,&quot;\# Created Time:               &quot;.strftime(&quot;%F %H:%M:%S&quot;))</span><br><span class="line">call append(line(&quot;.&quot;)+6,&quot;\# Copyright（C）:             &quot;.strftime(&quot;%Y&quot;).&quot; All rights reserved&quot;)</span><br><span class="line">call append(line(&quot;.&quot;)+7,&quot;\##########################################################################&quot;) </span><br><span class="line">call append(line(&quot;.&quot;)+8,&quot;\#!/bin/bash&quot;)</span><br><span class="line">call append(line(&quot;.&quot;)+9,&quot;&quot;)</span><br><span class="line">else </span><br><span class="line">call setline(1, &quot;/*************************************************************************&quot;) </span><br><span class="line">call append(line(&quot;.&quot;), &quot;         &gt; File Name: &quot;.expand(&quot;%&quot;)) </span><br><span class="line">call append(line(&quot;.&quot;)+1, &quot;       &gt; Author:   Name&quot;) </span><br><span class="line">call append(line(&quot;.&quot;)+2, &quot;       &gt; Mail: xxxxxxxxxx@xxx.com&quot;) </span><br><span class="line">call append(line(&quot;.&quot;)+3, &quot;       &gt; Created Time: &quot;.strftime(&quot;%c&quot;)) </span><br><span class="line">call append(line(&quot;.&quot;)+4, &quot;************************************************************************/&quot;) </span><br><span class="line">call append(line(&quot;.&quot;)+5, &quot;&quot;)</span><br><span class="line">endif</span><br><span class="line">if &amp;filetype == &apos;cpp&apos;</span><br><span class="line">call append(line(&quot;.&quot;)+6, &quot;#include&lt;iostream&gt;&quot;)</span><br><span class="line">call append(line(&quot;.&quot;)+7, &quot;using namespace std;&quot;)</span><br><span class="line">call append(line(&quot;.&quot;)+8, &quot;&quot;)</span><br><span class="line">endif</span><br><span class="line">if &amp;filetype == &apos;c&apos;</span><br><span class="line">call append(line(&quot;.&quot;)+6, &quot;#include&lt;stdio.h&gt;&quot;)</span><br><span class="line">call append(line(&quot;.&quot;)+7, &quot;&quot;)</span><br><span class="line">endif</span><br><span class="line">if &amp;filetype == &apos;java&apos;</span><br><span class="line">call append(line(&quot;.&quot;)+6,&quot;public class &quot;.expand(&quot;%&quot;))</span><br><span class="line">call append(line(&quot;.&quot;)+7,&quot;&quot;)</span><br><span class="line">endif</span><br><span class="line">&quot;&quot;新建文件后，自动定位到文件末尾</span><br><span class="line">endfunc</span><br><span class="line">autocmd BufNewFile * normal G</span><br><span class="line">END</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mkdir -p /etc/yum.repos.d/backup</span><br><span class="line">\mv -f /etc/yum.repos.d/*.repo /etc/yum.repos.d/backup/</span><br><span class="line">#禁用已有其他epel源，并做备份。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">umount /dev/cdrom</span><br><span class="line">#[ `cat /etc/fstab|grep -o iso` ]||sed -i &apos;/iso/c\&apos; /etc/fstab   </span><br><span class="line">                                                          #解挂其他光盘</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CDUUID=`blkid|sed -nr &apos;/sr0/s/.*\bUUID=&quot;([^&quot;]+).*&quot;/\1/p&apos;`</span><br><span class="line">CDTYPE=`blkid|sed -nr &apos;/sr0/s/.*\bTYPE=&quot;([^&quot;]+).*&quot;/\1/p&apos;`</span><br><span class="line">[ `cat /etc/fstab|grep -o iso` ]||mkdir -p  /cdrom        #创建光盘目录</span><br><span class="line">[ `cat /etc/fstab|grep -o iso` ]||echo -e &quot;UUID=$CDUUID              /cdrom                  $CDTYPE defaults       0 0&quot; &gt;&gt;/etc/fstab</span><br><span class="line">                                                       #修改fstab文件，方便以后自动挂载光盘</span><br><span class="line">#[ `cat /etc/fstab|grep -o iso` ]|| mount -o ro /dev/sr0  /cdrom   #挂载光盘</span><br><span class="line">#mount -a   #挂载光盘</span><br><span class="line">mount -o ro /dev/sr0  /cdrom   #挂载光盘</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#生成常用yum源和epel源，这里选用阿里云的</span><br><span class="line">cat &gt; /etc/yum.repos.d/cdrom.repo &lt;&lt; END</span><br><span class="line">[cdrom]</span><br><span class="line">name=cdrom-repo</span><br><span class="line">baseurl=file:///cdrom</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">END</span><br><span class="line">cat &gt; /etc/yum.repos.d/aliyun.repo &lt;&lt; &quot;END&quot;</span><br><span class="line">[aliyun]</span><br><span class="line">name=aliyun-epel</span><br><span class="line">baseurl=https://mirrors.aliyun.com/epel/$releasever/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/epel/RPM-GPG-KEY-EPEL-7</span><br><span class="line">enabled=1</span><br><span class="line">END</span><br><span class="line">#新建本地及阿里云epel源.</span><br><span class="line"></span><br><span class="line">#修改网卡配置，根据个人情况修改</span><br><span class="line">cat &gt; /etc/sysconfig/network-scripts/ifcfg-ens33 &lt;&lt; END</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=none</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=ens33</span><br><span class="line">UUID=29126291-418f-4a08-b33e-c5cfa659d9b8</span><br><span class="line">DEVICE=ens33</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=172.18.32.7</span><br><span class="line">PREFIX=16</span><br><span class="line">GATEWAY=172.18.0.1</span><br><span class="line">DNS1=114.114.114.114</span><br><span class="line">END</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl restart network.service</span><br><span class="line">#重启网络服务，让刚才修改的配置生效</span><br><span class="line"></span><br><span class="line">mkdir -p /date/apps</span><br><span class="line"></span><br><span class="line">[ -z `cat ~/.bash_profile|grep apps` ] &amp;&amp; echo &apos;PATH=/date/apps:$PATH&apos; &gt;&gt;~/.bash_profile</span><br><span class="line">#修改PAT变量，方便以后装软件。</span><br><span class="line">``</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;水平有限，都是简单代码，留存记录，方便日后查看整理改进。</p>]]></content>
      
      
      <categories>
          
          <category> linux基础 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> script </tag>
            
            <tag> init </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>由闷骚书生与假正经小姐的古典爱情故事说起</title>
      <link href="//blog/1b0b2a49.html"/>
      <url>//blog/1b0b2a49.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;城南外湖畔边，天气下着小雨，刮起微风，吹起茶铺门前的风铃叮铃作响让人昏昏欲睡，但铺子里舒缓轻柔的抚琴声却给人自然清醒的感觉，立锥之地，瞥一眼便一览无遗，简单的陈设透露出古朴淡雅，一长发清秀女子品一壶热茶望着这淅淅沥沥的小雨。<br><img src="https://img-blog.csdnimg.cn/20190801143110232.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;“姑娘有心事？”一身穿白袍英俊书生抿嘴品茶问到。少女：“公子与城北唐公子可是熟识？”<br>&emsp;&emsp;“书生：“我与他乃世交，有何事？”少女：“那下次你与他一同前来我这品茶可好？”书生：“他不喜品茶。”少女：“无妨，那公子可知他喜欢什么，我可以慢慢学。”书生：“我其实也不喜品茶。”少女：“公子莫说谎，不喜为何天天早晨都跑我这茶铺。”</p><a id="more"></a>        <div id="aplayer-QUZMNgdB" class="aplayer aplayer-tag-marker" style="margin-bottom: 20px;">            <pre class="aplayer-lrc-content"></pre>        </div>        <script>          var ap = new APlayer({            element: document.getElementById("aplayer-QUZMNgdB"),            narrow: false,            autoplay: true,            showlrc: false,            music: {              title: "我又想你了",              author: "陈信喆",              url: "https://hewanyue.com/mp3/woyouxiangnile.mp3",              pic: "https://hewanyue.com/mp3/cover/woyouxiangnile.jpg",              lrc: ""            }          });          window.aplayers || (window.aplayers = []);          window.aplayers.push(ap);        </script><p>&emsp;&emsp;“书生撒下铜钱置于木桌上起身离开，未曾回答。少女见状只心生奇怪，也未曾再问，便转身，从容煎茶。<br><img src="https://img-blog.csdnimg.cn/20190801143154267.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;“书生一路默不作声回到家中书房，文房四宝安静置于桌上，拿起笔挥出：小生不才，未得姑娘青睐，扰姑娘良久，姑娘勿怪，自此所有爱慕之意止于唇齿，匿与年华。饮完这杯酒，还有一杯，就此别过，愿你此生无波澜，敬我余生无悲欢。</p><p>&emsp;&emsp;“谁又懂书生的心意？但凡经历过那种暗恋相思之苦，才会理解。</p><p>&emsp;&emsp;“他生莫作有情痴，人间无地著相思。下辈子不要做个多情的人，在人世间的相思之苦是难以承受的。<br><img src="https://img-blog.csdnimg.cn/20190801143239455.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;我们都曾经为一个得不到的人付出过，心酸过，伤神过。那种滋味充满着酸甜苦辣，叫做喜欢过你的感觉。</p><p>&emsp;&emsp;喜欢一个的人时候，我们每时每刻都会翻看ta的每一条朋友圈动态，也总会把自己给带进去，想看看是不是在说自己，就好像你在做阅读理解一样，做完这些题目后，才发现不是为你准备的。</p><p>&emsp;&emsp;Ta为你点个赞，你可以开心到不行，小鹿乱撞。什么啊，为什么就给我点赞，ta也喜欢我吗？Ta为什么不跟我表白？Ta这是暗示我要去表白吗？戏精这个词在我们身上表现的淋漓尽致，永远都不会想到是不是别人手滑点赞，因为我们接受不了这个事实。<br><img src="https://img-blog.csdnimg.cn/20190801143301421.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;天天傻傻地期盼他心血来潮的问候一句，然后装作平淡和缓不慌不忙的应答，其实心里能开心一整天。要是没有秒回我的信息，我会觉得自卑，会觉得ta不喜欢跟我这样的人聊天。我曾经发了句晚安给ta，一晚上醒来七次看手机信息。就是那种可怕的朦朦胧胧的意识，梦里都梦到ta好像回了我信息，然后意识带我从梦境里挣扎出来立马去翻看手机。你看，这大概就是喜欢深入骨髓，竟连梦境都不愿放过了吧。</p><p>&emsp;&emsp;看到ta跟其他人走得近玩的好开心时心里酸的要命，却发现自己根本没有吃醋的立场。Ta对你说过的每一句都有认认真真记在心里，反复琢磨，却不敢表现出来。偶遇的时候心里高兴得飞了出来，却只能冷静的压抑，给ta一个体面的招呼,我们太过卑微的去追求我认为的爱情，没有去想结果怎样。<br><img src="https://img-blog.csdnimg.cn/20190801143329880.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;<strong>而事实是这样的结果就像一场游戏，你拼命练到满级，可ta却不知何时会删了游戏。</strong></p><p>&emsp;&emsp;但暗恋这种感情模式和对方其实关系并不大，更多是自我感动。和真爱没有什么关系，不管付出再多，忍受的再多，也不会有人看见，一个人的独角戏确实很累，你也会变得越来越不像自己，真爱是建立在双方对彼此深入了解的基础上的。</p><p>&emsp;&emsp;《大话西游》里有一幕：孙悟空与紫霞仙子在围墙上无言告别，围墙下围着一大帮吃瓜群众看戏，曾经我们的喜欢，会让自己误以为是孙悟空或者是至尊宝，其实都不是，我们终究成了围墙下的那帮人，看着别人的爱情，咀嚼着自己的青春。<br><img src="https://img-blog.csdnimg.cn/20190801143343366.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;<strong>不知不觉，时间过了很久，我们已经渐渐明白在机场里等船是不会有结果的，有些人我们也不必再等。换个角度看，彼此幸福或许才是最好的结局，未曾拥有的不是遗憾，相反却是青春的美好。</strong></p><p>&emsp;&emsp;哪一天你回过头看，微笑着对自己说道：那个人，我曾经喜欢过，很喜欢的那种。<br>&emsp;&emsp;<br>&emsp;&emsp;<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;转载自豆瓣<a href="https://www.douban.com/note/662390390/" rel="noopener" target="_blank">情感私塾</a><br>&emsp;&emsp;&emsp;&emsp;<br>&emsp;&emsp;</p>]]></content>
      
      
      <categories>
          
          <category> 情感 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> story </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自动备份配置文件脚本（screen后台执行）</title>
      <link href="//blog/b580c8f5.html"/>
      <url>//blog/b580c8f5.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;Linux中配置文件很多，各种需要设置的各种参数很多，有些自定义选项为了方便使用，都会自己修改使用，不过有时候配置文件或者用户参数属性不小心误删掉或者日后想找回当时的参数设置，没有备份肯定是不行的，所以闲暇之余自己写了一个专门备份/etc目录的脚本，以备不时之需。<br>&emsp;&emsp;下面贴代码~</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Backup is start!"</span>                        <span class="comment">#显示备份开始</span></span><br><span class="line"></span><br><span class="line">ScreenName=$<span class="string">"backup"</span>                           <span class="comment">#设置变量定义窗口名</span></span><br><span class="line">screen -dmS <span class="variable">$ScreenName</span>                        <span class="comment">#创建一个出于断开模式下的窗口并指定名字</span></span><br><span class="line">screen -S <span class="variable">$ScreenName</span> -p 0 -X stuff $<span class="string">"\cp -ap /etc /date/back`date +%F`"</span></span><br><span class="line">                                               <span class="comment">#向窗口传递命令备份/etc目录且命名为当前日期</span></span><br><span class="line">screen -S <span class="variable">$ScreenName</span> -p 0 -X stuff $<span class="string">'\n'</span>      <span class="comment">#执行命令，相当于回车</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"backing up，please wait~"</span>                <span class="comment">#等待备份完成，并提示等待</span></span><br><span class="line"></span><br><span class="line">screen -S <span class="variable">$ScreenName</span> -p 0 -X stuff $<span class="string">'exit'</span>    <span class="comment">#备份完后传递退出窗口命令</span></span><br><span class="line">screen -S <span class="variable">$ScreenName</span> -p 0 -X stuff $<span class="string">'\n'</span>      <span class="comment">#执行命令</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Backup is finshed!"</span>                      <span class="comment">#提示备份完成，脚本结束。</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;之前写的脚本总是在创建完screen就停住了，之后的命令没法自动执行，必须Ctrl+A+D暂离screen之后才可以继续执行，不过这样就没法实现自动的初衷了。后来转换思路打算用screen -X的选项从原shell向screen中传递命令却总是失败，后来是参考了大神关于screen传递命令的方法（<a href="https://blog.csdn.net/u011606714/article/details/53471532" rel="noopener" target="_blank">原文链接</a>），才创建成功的。<br><img src="https://img-blog.csdnimg.cn/20190730112136602.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&emsp;&emsp;此脚本原理大体如下：<br>&emsp;&emsp;脚本中执行screen命令，相当于打开了新的shell，而脚本上的命令都在老shell上，要让备份cp命令在screen上的新shell上跑起来，必须采用向新screen传递命令的方法，才可以实现后台备份，无需担心断网断电的问题。</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">screen -S $ScreenName -p <span class="number">0</span> -X stuff $'cp -ap /etc /<span class="keyword">date</span>/back<span class="string">`date +%F`</span><span class="string">'</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;这条命令单独执行，只会传递在screen中输出cp命令却并不执行，需要<br><code>screen -S $ScreenName -p 0 -X stuff $&#39;\n&#39;</code><br>&emsp;&emsp;命令执行时cp命令才会生效。exit命令亦是如此。<br>&emsp;&emsp;各位大佬如果还有别的更好的方法可以实现功能，希望可以多多交流，不吝赐教。</p>]]></content>
      
      
      <categories>
          
          <category> linux基础 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> script </tag>
            
            <tag> backup </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VIM编辑器的整理总结</title>
      <link href="//blog/8dcd5ad7.html"/>
      <url>//blog/8dcd5ad7.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;VIM是linux中功能强大的文本编辑工具，因为功能强大，所以各种参数快捷键也很复杂，为方便记忆，特整理如下：</p><h3 id="vim命令基本格式与参数"><a href="#vim命令基本格式与参数" class="headerlink" title="vim命令基本格式与参数"></a>vim命令基本格式与参数</h3><p>  <code>vim [OPTION] FILE</code><br>  常见参数：<br>  +#  :打开文件后，让光标处于第#行，(+ 默认为行尾)。<br>  +/PATTERN  :打开文件后，让光标处于第一个被PATTERN匹配到的行的行首。<br>  -b file  :以二进制方式打开文件。<br>  -d file1/file2  :比较多个文件的不同。<br>  -m file  :以只读方式打开文件。<br>  -e file 或 ex file  :直接进入ex模式（扩展命令模式或叫做末行模式）。</p><a id="more"></a><h3 id="vim的几种工作模式"><a href="#vim的几种工作模式" class="headerlink" title="vim的几种工作模式"></a>vim的几种工作模式</h3><p><img src="https://img-blog.csdnimg.cn/20190725151050805.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="VIM几种模式及切换"></p><h3 id="command模式下的光标跳转："><a href="#command模式下的光标跳转：" class="headerlink" title="command模式下的光标跳转："></a>command模式下的光标跳转：</h3><p>字符间跳转：h 左；j下；k 上；l 右。<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;#command 可以执行#次命令。<br>单词间跳转：w：下一个单词的词首；<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;e：当前或下一个单词的词尾。<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;b：当前或前一个单词的词首。<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;#command 可以执行#次命令。<br>当前页跳转：H：跳转至页首。<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;M：跳转至页中间行。<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;L：跳转至页底。<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;zt：将光别所在行移到屏幕顶端；<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;zz：将光标所在行移到屏幕中间；<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;zb：将光标所在行移到屏幕低端。<br>行首行尾跳转：^:跳转至行首的第一个非空的字符；<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;0:跳转至行首；<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;$:跳转至行尾。<br>行间移动：#G :移动至第#行行首。（相当于扩展命令模式下 #）<br>&emsp;&emsp;&emsp;&emsp;&emsp;   G  ：移至最后一行行首。<br>&emsp;&emsp;&emsp;1G 或gg:移至第一行行首。<br>句间移动   :  ) : 下一句；<br>&emsp;&emsp;&emsp;&emsp;&emsp;( : 上一句。<br>段间移动   :  } : 下一段；<br>&emsp;&emsp;&emsp;&emsp;&emsp;{ : 上一段。<br>翻屏操作：Ctrl+f  向文件尾部翻一屏（向前翻屏）；<br>&emsp;&emsp;&emsp;&emsp;&emsp;Ctrl+b 向文件首部翻一屏（向后翻屏）；<br>&emsp;&emsp;&emsp;&emsp;&emsp;Ctrl+d 向文件尾部翻半屏（向下翻屏）；<br>&emsp;&emsp;&emsp;&emsp;&emsp;Ctrl+u 向文件尾部翻半屏（向上翻屏）；</p><h3 id="command模式下的字符编辑："><a href="#command模式下的字符编辑：" class="headerlink" title="command模式下的字符编辑："></a>command模式下的字符编辑：</h3><p><strong>x</strong> ： 删除（可认为是剪切，并非真的删除）光标处的字符；<br><strong>#x</strong>：删除光标处起始的#个字符；<br><strong>p</strong> ：在光标所在处的后面插入储存的字符；<br><strong>xp</strong>：交换光标所在处的字符及后面字符的位置；<br><strong>~</strong> ： 转换大小写；<br><strong>J</strong> ： 删除当前行后的换行符；</p><h4 id="替换命令"><a href="#替换命令" class="headerlink" title="替换命令"></a>替换命令</h4><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">r ： 替换光标所在处的字符（只能替换一个字符）；</span><br><span class="line">R： 切换为<span class="built_in">REPLACE</span>模式，可持续替换多个字符。</span><br></pre></td></tr></table></figure><h4 id="删除命令"><a href="#删除命令" class="headerlink" title="删除命令"></a>删除命令</h4><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">d ： 删除命令（可结合光标跳转字符，实现范围删除）；</span></span><br><span class="line"><span class="attribute">d$</span>:  从光标所在处，删除到行尾；</span><br><span class="line"><span class="attribute">d^</span>:  从光标所在处，删除到非空行首；</span><br><span class="line"><span class="attribute">d0</span>:  从光标所在处，删除到行首；</span><br><span class="line"><span class="attribute">dw</span>:  从光标所在处，删除到下一个单词的词首；</span><br><span class="line"><span class="attribute">de</span>:  从光标所在处，删除到下一个单词的词尾；</span><br><span class="line"><span class="attribute">db</span>:  从光标所在处，删除到前一个单词的词首；</span><br><span class="line"><span class="attribute">dd</span>:  删除光标所在的行；</span><br><span class="line"><span class="comment">#dd：多行删除；</span></span><br><span class="line"><span class="attribute">D ： 从当前光标位置一直删除到行尾，等同于d$。</span></span><br></pre></td></tr></table></figure><h4 id="改变命令"><a href="#改变命令" class="headerlink" title="改变命令"></a>改变命令</h4><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">c ： 改变命令（与d命令类似，执行删除后进入插入模式）；</span></span><br><span class="line"><span class="attribute">c$</span>:  从光标所在处，删除到行尾，并进入插入模式；</span><br><span class="line"><span class="attribute">c^</span>:  从光标所在处，删除到非空行首，并进入插入模式；</span><br><span class="line"><span class="attribute">c0</span>:  从光标所在处，删除到行首，并进入插入模式；</span><br><span class="line"><span class="attribute">cw</span>:  从光标所在处，删除到下一个单词的词首，并进入插入模式；</span><br><span class="line"><span class="attribute">ce</span>:  从光标所在处，删除到下一个单词的词尾，并进入插入模式；</span><br><span class="line"><span class="attribute">cb</span>:  从光标所在处，删除到前一个单词的词首，并进入插入模式；</span><br><span class="line"><span class="attribute">cc</span>:  删除光标所在的行，并进入插入模式；</span><br><span class="line"><span class="comment">#cc：多行删除，并进入插入模式；</span></span><br><span class="line"><span class="attribute">C ： 从当前光标位置一直删除到行尾，并进入插入模式，等同于c$。</span></span><br></pre></td></tr></table></figure><h4 id="复制命令"><a href="#复制命令" class="headerlink" title="复制命令"></a>复制命令</h4><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">y ： 复制(yank)命令（可结合光标跳转字符，实现范围复制）；</span></span><br><span class="line"><span class="attribute">y$</span>:  从光标所在处，复制到行尾；</span><br><span class="line"><span class="attribute">y^</span>:  从光标所在处，复制到非空行首；</span><br><span class="line"><span class="attribute">y0</span>:  从光标所在处，复制到行首；</span><br><span class="line"><span class="attribute">yw</span>:  从光标所在处，复制到下一个单词的词首；</span><br><span class="line"><span class="attribute">ye</span>:  从光标所在处，复制到下一个单词的词尾；</span><br><span class="line"><span class="attribute">yb</span>:  从光标所在处，复制到前一个单词的词首；</span><br><span class="line"><span class="attribute">yy</span>:  复制光标所在的行；</span><br><span class="line"><span class="comment">#yy：多行复制； </span></span><br><span class="line"><span class="attribute">Y ： 从当前光标位置一直复制到行尾，等同于y$。</span></span><br></pre></td></tr></table></figure><table><thead><tr><th>命令模式下常用用法汇总</th><th>效果</th></tr></thead><tbody><tr><td>#ihello[ESC]</td><td>插入“hello”#次</td></tr><tr><td>0y$</td><td>复制本行</td></tr><tr><td>gU</td><td>变为大写</td></tr><tr><td>gu</td><td>变为小写</td></tr><tr><td>di”</td><td>当光标在” “之间时，则删除” “的内容</td></tr><tr><td>yi(</td><td>当光标在( )之间时，则复制( )的内容</td></tr><tr><td>vi[</td><td>当光标在[ ]之间时，则选中[ ]的内容</td></tr><tr><td>dtx</td><td>删除字符直到遇到光标之后的第一个x字符</td></tr><tr><td>ytx</td><td>复制字符直到遇到光标之后的第一个x字符</td></tr></tbody></table><h4 id="撤销更改命令"><a href="#撤销更改命令" class="headerlink" title="撤销更改命令"></a>撤销更改命令</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">u</span> <span class="string">： 撤销命令（可撤销最近的更改）；</span></span><br><span class="line"><span class="comment">#u： 撤销多次之前的更改； </span></span><br><span class="line"><span class="attr">U</span> <span class="string">： 撤销光标落在这行后的所有此行的修改。</span></span><br><span class="line"><span class="meta">Ctrl+r</span>:<span class="string">重做最后的撤销，取消撤销。</span></span><br><span class="line"><span class="meta">.</span> <span class="string">： 重复前一个操作。</span></span><br><span class="line"><span class="comment">#.： 重复前一个操作#次。</span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20190725164028382.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="vim寄存器"><br><img src="https://img-blog.csdnimg.cn/20190725164051873.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="vim标记和宏"><br><img src="https://img-blog.csdnimg.cn/20190725164631359.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="扩展命令模式下地址定界"><br><img src="https://img-blog.csdnimg.cn/20190725164716327.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="扩展命令模式下查找"><br><img src="https://img-blog.csdnimg.cn/2019072516485054.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="扩展命令模式模式下查找替换"></p><h3 id="调整文本颜色"><a href="#调整文本颜色" class="headerlink" title="调整文本颜色"></a>调整文本颜色</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ctrl+v[[<span class="number">031</span>mCOLORCtrl+v[[<span class="number">0</span>m    输出红色COLOR</span><br></pre></td></tr></table></figure><h3 id="取消高亮显示"><a href="#取消高亮显示" class="headerlink" title="取消高亮显示"></a>取消高亮显示</h3><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> nohlsearch    取消搜索后的高亮显示</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20190725165202595.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="使用多个窗口"><br><img src="https://img-blog.csdnimg.cn/201907251652183.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="可视化模式"><br><img src="https://img-blog.csdnimg.cn/20190725165234682.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="编辑二进制文件"><br><img src="https://img-blog.csdnimg.cn/20190725165250630.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="定制vim工作特性"></p>]]></content>
      
      
      <categories>
          
          <category> linux基础 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vim编辑器 </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>不忘初心，方得始终</title>
      <link href="//blog/b84a93e4.html"/>
      <url>//blog/b84a93e4.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><img src="https://img-blog.csdnimg.cn/20190716192014164.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="不忘初心，方得始终"></p><ul><li><h2 id="奔跑吧年轻人"><a href="#奔跑吧年轻人" class="headerlink" title="奔跑吧年轻人"></a>奔跑吧年轻人</h2></li></ul><ul><li>&emsp;&emsp;<strong>你走了几年弯路了，也迷茫了好久了，已经落后很远了，甚至也已不再年轻了，不能再选择安逸了！</strong></li><li>&emsp;&emsp;<strong>你已经不是一个人了，妻子要靠你，孩子也要长大了，父母也要老了，生活上你已经是唯一的支撑了！</strong></li><li>&emsp;&emsp;<strong>生活已经如此了，唯有努力奔跑，才不会被压倒；选择已经如此了，唯有努力学习，才能不虚此行！</strong></li><li>&emsp;&emsp;<strong>现状就是这样了，后悔没用，你得变得更好！</strong><br><img src="https://img-blog.csdnimg.cn/20190716193039155.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="后悔没用，你得变好"></li></ul><a id="more"></a><ul><li><h2 id="拼搏吧挑战者"><a href="#拼搏吧挑战者" class="headerlink" title="拼搏吧挑战者"></a>拼搏吧挑战者</h2><img src="https://img-blog.csdnimg.cn/20190716192809671.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_1,color_FFFFFF,t_70" alt="挑战者"><br>&emsp;&emsp;<strong>你敢于跳出自己的舒适区，来北京从零开始，这已经是一个巨大的成功，同时这也是一个巨大的挑战，爱挑战的你，绝对不会轻易认输，难道不是吗？你会永远相信，你是最棒的，你可以做到你想做好的任何事。</strong><br>&emsp;&emsp;<strong>趁自己还年轻。趁此时还不晚，去拼一下，为了那一切的一切，将来的你，一定会感激现在拼命的自己！</strong><br><img src="https://img-blog.csdnimg.cn/20190716200906787.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="将来的你，一定会感激现在拼命的自己！"></li><li><h2 id="坚持吧追梦人"><a href="#坚持吧追梦人" class="headerlink" title="坚持吧追梦人"></a>坚持吧追梦人</h2>&emsp;&emsp;<strong>从来没有人可以轻易成功，不经历挫折，怎么能成长，不经历磨砺，怎么能成器，不经历风雨，怎能见彩虹！</strong><br><img src="https://img-blog.csdnimg.cn/20190716200716204.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="哪怕未来遇到再多困难也不轻言放弃"><br>&emsp;&emsp;<strong>遇到挫折与痛苦，不要放弃，想一想自己，当初为什么要来这里？</strong><br><img src="https://img-blog.csdnimg.cn/20190716195321538.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><h1 id="emsp-emsp-既然选择了远方，便只顾风雨兼程！"><a href="#emsp-emsp-既然选择了远方，便只顾风雨兼程！" class="headerlink" title="&emsp;&emsp;既然选择了远方，便只顾风雨兼程！"></a><strong>&emsp;&emsp;既然选择了远方，便只顾风雨兼程！</strong></h1><img src="https://img-blog.csdnimg.cn/20190716200024681.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70" alt="不忘初心,继续前行"></li></ul>]]></content>
      
      
      <categories>
          
          <category> 情感 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 初心不负 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux下find命令的一般用法。</title>
      <link href="//blog/bc40fcc0.html"/>
      <url>//blog/bc40fcc0.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><ol><li><p><strong>find和locate介绍</strong><br>在linux中，查找文件一般使用locate和find，locate是根据事先构建好的缩影库或者数据库中的数据查找文件名（非实时，速度快，模糊查找），而find作为一个实时查找命令，通过遍历指定起始路径下文件系统层级结构完成文件查找，功能更加强大（实时查找，速度略慢，精确查找）。</p></li><li><p><strong>find 命令一般用法</strong><br>find [OPTIONS] [查找起始路径] [查找条件] [处理动作]<br>[查找起始路径] ：制定具体搜索目标起始路径；默认为当前目录。<br>[查找条件]：指定的查找标准，可以根据文件名，大小，类型，从属关系，时间戳，权限等标准进行；默认为找出指定目录下的所有文件。<br>[处理动作]：对符合查找条件的文件做出的操作，例如删除等操作；默认为输出至标准输出。</p></li><li><p><strong>查找条件</strong></p></li></ol><a id="more"></a><p> <strong>根据文件名查找</strong>：-name，-iname（不区分文件名中的大小写）<br> ps：不支持正则表达式，支持globe风格的通配符如*、?、[]、[^]</p><pre><code>**根据文件大小查找**：-size (+/-) #UNIT 常用单位：c、k、M、G</code></pre><p>#UNIT :(#-1,#] 为精确查找#大小的文件（大于#-1大小的文件数值显示为#也符合）<br>-#UNIT:[0,#-1] 为查找小于等于#-1大小的文件<br>+#UNTI:(#,∞)为查找大于#大小的文件</p><pre><code>**根据文件类型查找**：-type [文件类型]f：普通文件   </code></pre><p>   d：目录文件<br>   l：符号链接文件<br>   b：块设备文件<br>   c：字符设备文件<br>   p：管道文件<br>   s：套接字文件</p><pre><code>**根据从属关系查找**：-user USERNAME  或  -uid UID-group GROUPNAME  或  -gid GID查找无属主属组文件：-nouser  ,  -nogroup**根据时间戳查找**：以“天”为单位：-atime(访问时间)，-mtime(修改时间)（指文件内容修改），-ctime(改变时间)（指权限及从属关系等修改） 以“分钟”为单位：-amin(访问时间)，-mmin(修改时间)（指文件内容修改），-cmin(改变时间)（指权限及从属关系等修改） -atime (+/-) # ，其中#为以现在开始向过去计时的某时间数值。 #：[#，#-1) -#：(#,0] +#：(-∞,#-1) ![     #：[#，#-1) -#：(#,0] +#：(-∞,#-1)](https://img-blog.csdnimg.cn/20190505164447686.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01pY2VQcm8=,size_16,color_FFFFFF,t_70)</code></pre><p> <strong>根据权限查找</strong><br> -perm mode 指明确定权限；<br> -perm /mode 任何一类用户(u,g,o)的权限中的任何一项(r,w,x)符合条件即满足；<br> -perm -mode 每一个用户(u,g,o)的权限中的每一项(r,w,x)都同时符合条件即满足。</p><table><thead><tr><th>权限</th><th>二进制</th><th>八进制</th></tr></thead><tbody><tr><td>- - -</td><td>0 0 0</td><td>0</td></tr><tr><td>- - x</td><td>0 0 1</td><td>1</td></tr><tr><td>- w -</td><td>0 1 0</td><td>2</td></tr><tr><td>- w x</td><td>0 1 1</td><td>3</td></tr><tr><td>r - -</td><td>1 0 0</td><td>4</td></tr><tr><td>r - x</td><td>1 0 1</td><td>5</td></tr><tr><td>r w -</td><td>1 1 0</td><td>6</td></tr><tr><td>r w x</td><td>1 1 1</td><td>7</td></tr><tr><td>mode形式 &emsp;可以为 -perm /220</td><td></td><td></td></tr><tr><td>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;也可以为-perm /u+w,g+w 或 -perm /u=w,g=w</td><td></td><td></td></tr></tbody></table><p><strong>组合条件查找</strong>：<br>同时满足：与：-a，-and;默认<br>满足任一：或：-o，-or<br>不满足：非：-not，!</p><p>#]find /… ! A -a ! B  →→   #]find /… ! ( A -o B )  或  #]find /… -not ( A -o B )<br>#]find /… ! A -o ! B  →→   #]find /… ! ( A -a B )  或  #]find /… -not ( A -a B )  </p><ol start="4"><li><strong>处理动作</strong></li></ol><p>-print：输出至标准输出；默认动作<br>-ls：类似对查找到的文件执行“ls-l”<br>-delete：删除查找到的文件<br>-fls /PATH/TO/SOMEFILE 将查找到的文件信息长格式保存至指定路径。<br>-ok COMMAND {} ; 对找到的每个文件执行COMMAND命令（可能需要确认）<br>-exec COMMAND {} ; 对找到的每个文件执行COMMAND命定（无需确认）<br>ps：find传递查找到的文件路径之后面的命令时。实现查找出所有符合的文件路径，并一次性传递给后面的命令。但是有些命令不能接受过长的参数，此时命令执行会失效，可用管道find /… | xargs COMMAND执行。</p>]]></content>
      
      
      <categories>
          
          <category> linux基础 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> find命令 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="//blog/4a17b156.html"/>
      <url>//blog/4a17b156.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>Welcome to <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" rel="noopener" target="_blank">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" rel="noopener" target="_blank">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" rel="noopener" target="_blank">GitHub</a>.</p><a id="more"></a><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" rel="noopener" target="_blank">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" rel="noopener" target="_blank">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" rel="noopener" target="_blank">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" rel="noopener" target="_blank">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
    
    
    <entry>
      <title>about</title>
      <link href="/about/index.html"/>
      <url>/about/index.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>title:  BOHC!<br>subtitle: blog of hechao!<br>description: BOHC is just a blog of hechao.<br>keywords: Linux DEVOPS</p>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>categories</title>
      <link href="/categories/index.html"/>
      <url>/categories/index.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>友链</title>
      <link href="/friends/index.html"/>
      <url>/friends/index.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr> <div style="text-align:center;"><span class="with-love" id="animate1">    <i class="fa fa-heart"></i>  </span>欢迎留言互换友链<span class="with-love" id="animate2">    <i class="fa fa-heart"></i>  </span></div><div class="note success">            <p><strong><font color="#5cb85c">友链格式：</font></strong></p><ul><li>网站名称：BOHC!</li><li>网站地址：<a href="https://hewanyue.com">https://hewanyue.com</a></li><li>网站描述：BOHC is just a blog of hechao.</li><li>网站Logo/头像：<a href="https://gravatar.loli.net/avatar/37019f5eb1f0b9951c06bfdc8342afd1" rel="noopener" target="_blank">https://gravatar.loli.net/avatar/37019f5eb1f0b9951c06bfdc8342afd1</a></li></ul>          </div>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>tags</title>
      <link href="/tags/index.html"/>
      <url>/tags/index.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script>]]></content>
      
    </entry>
    
    
  
</search>
